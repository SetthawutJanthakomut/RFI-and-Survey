//Version 3 17/10/2025 13:25
// ===== POSTPONE RFI INSPECTION (Full Version with Team Change Support) =====
// ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô: ‡πÄ‡∏•‡∏∑‡∏≠‡∏ô‡∏ï‡∏£‡∏ß‡∏à RFI ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Calendar ‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏à‡πâ‡∏á (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ó‡∏µ‡∏°)

//const SURVEY_SPREADSHEET_ID = '1rWMUNNDbbLbHljs2GsU6fzrJDjHsutS7nMvElGUNTQk';
const CALENDAR_ID = 'primary';

/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å: ‡πÄ‡∏•‡∏∑‡∏≠‡∏ô‡∏ï‡∏£‡∏ß‡∏à RFI Inspection
 * 
 * @param {string} rfiNumber - RFI Number (‡πÄ‡∏ä‡πà‡∏ô "RFI #123")
 * @param {string} Description - ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢ RFI
 * @param {string} newDate - ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡∏°‡πà (YYYY-MM-DD)
 * @param {string} newStartTime - ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà (HH:MM)
 * @param {string} newEndTime - ‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡πÉ‡∏´‡∏°‡πà (HH:MM)
 * @param {string} postponeReason - ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏ô
 * @param {string} requesterEmail - ‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ú‡∏π‡πâ‡∏Ç‡∏≠
 * @param {string} guestEmails - ‡∏≠‡∏µ‡πÄ‡∏°‡∏• Guests (‡∏Ñ‡∏±‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢ ,)
 * @param {string} newLocation - ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡∏°‡πà
 * @param {string} assignedInspector - ‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à (‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å Assigned_Inspector)
 * @param {boolean} sendEmail - ‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
 * @param {number} searchDays - ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ Calendar
 * @returns {Object} ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏ô‡∏ï‡∏£‡∏ß‡∏à
 */
function postponeRFIInspection(
  rfiNumber, 
  Description, 
  newDate, 
  newStartTime, 
  newEndTime, 
  postponeReason = '', 
  requesterEmail = '',
  guestEmails = '',
  newLocation = '', 
  assignedInspector = '',
  sendEmail = true, 
  searchDays = 60
) {
  Logger.log(`üìÖ [POSTPONE] Starting RFI postponement for: ${rfiNumber}`);
  Logger.log(`üë• Assigned Inspector: ${assignedInspector}`);
  
  const validation = validatePostponeInputs(rfiNumber, Description, newDate, newStartTime, newEndTime);
  if (!validation.valid) {
    Logger.log(`‚ùå Validation failed: ${validation.error}`);
    return {
      success: false,
      error: validation.error,
      rfiNumber: rfiNumber,
      rfiDescription: Description,
      eventsFound: 0,
      eventsUpdated: 0,
      emailsSent: false
    };
  }

  const cleanRfiNumber = rfiNumber.trim();
  const cleanDescription = Description ? Description.trim() : '';
  
  // ‚≠ê ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ result (‡∏ó‡∏µ‡πà‡∏•‡∏∑‡∏°‡πÑ‡∏õ!)
  let result = {
    success: false,
    rfiNumber: cleanRfiNumber,
    rfiDescription: cleanDescription,
    rfiEventsFound: 0,
    rfiEventsUpdated: 0,
    emailsSent: false,
    teamChanged: false,
    participants: [],
    updatedRFIEvents: [],
    error: null,
    message: '',
    originalDate: null,
    newDate: newDate,
    newStartTime: newStartTime,
    newEndTime: newEndTime
  };

  try {
    // Step 1: ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ Calendar Events
    Logger.log("üîç Step 1: Searching Primary Calendar Events...");
    const rfiSearchResult = searchCalendarEventsByRFIAndDescription(cleanRfiNumber, cleanDescription, CALENDAR_ID, searchDays);
    
    if (rfiSearchResult.success && rfiSearchResult.events.length > 0) {
      result.rfiEventsFound = rfiSearchResult.events.length;
      result.originalDate = rfiSearchResult.events[0].startTime.toDateString();
      Logger.log(`‚úÖ Found ${result.rfiEventsFound} RFI calendar events`);
    } else {
      result.error = `No calendar events found for RFI: ${cleanRfiNumber} / ${cleanDescription}`;
      result.message = result.error;
      Logger.log(`‚ö†Ô∏è ${result.error}`);
      return result;
    }

    // Step 2: ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏´‡∏°‡πà
    Logger.log("‚è∞ Step 2: Creating new date/time...");
    const newDateTime = createNewDateTime(newDate, newStartTime, newEndTime);
    
    if (!newDateTime.valid) {
      result.error = newDateTime.error;
      result.message = result.error;
      return result;
    }

    // ‚≠ê Step 3: ‡πÄ‡∏Å‡πá‡∏ö Event IDs ‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏∂‡∏á guests ‡πÉ‡∏´‡∏°‡πà‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á)
    const eventIds = rfiSearchResult.events.map(e => e.eventId);

    // Step 4: ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Primary Calendar Events
    Logger.log("üìù Step 4: Updating Primary Calendar Events...");
    
    let overallTeamChanges = null;
    
    for (let i = 0; i < rfiSearchResult.events.length; i++) {
      const eventInfo = rfiSearchResult.events[i];
      
      try {
        const updateSuccess = updateCalendarEventV2(
          eventInfo,
          CALENDAR_ID,
          newDateTime.startTime,
          newDateTime.endTime,
          postponeReason,
          newLocation,
          assignedInspector
        );
        
        if (updateSuccess.success) {
          result.rfiEventsUpdated++;
          result.updatedRFIEvents.push({
            eventId: eventInfo.eventId,
            title: updateSuccess.newTitle,
            calendarType: 'RFI'
          });
          Logger.log(`‚úÖ Event updated: "${eventInfo.title}"`);
          
          // ‡πÄ‡∏Å‡πá‡∏ö teamChanges ‡∏à‡∏≤‡∏Å event ‡πÅ‡∏£‡∏Å
          if (i === 0 && updateSuccess.teamChanges) {
            overallTeamChanges = updateSuccess.teamChanges;
          }
        }
        
      } catch (updateError) {
        Logger.log(`‚ùå Error updating event: ${updateError.toString()}`);
      }
    }

    // ‚≠ê Step 3.5: ‡∏î‡∏∂‡∏á Guest List ‡πÉ‡∏´‡∏°‡πà‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏•‡πâ‡∏ß
    Logger.log("üë• Step 3.5: Re-extracting UPDATED guest list from calendar...");
    
    const calendar = CalendarApp.getCalendarById(CALENDAR_ID);
    
    const updatedEvents = [];
    for (let i = 0; i < eventIds.length; i++) {
      try {
        const event = calendar.getEventById(eventIds[i]);
        if (event) {
          updatedEvents.push({
            event: event,
            eventId: eventIds[i],
            title: event.getTitle()
          });
        }
      } catch (e) {
        Logger.log(`‚ö†Ô∏è Could not re-fetch event ${eventIds[i]}: ${e.toString()}`);
      }
    }
    
    const calendarGuests = extractGuestsFromEvents(updatedEvents);
    
    Logger.log(`üë• Updated guest list extracted: ${calendarGuests.length} guests`);
    if (calendarGuests.length > 0) {
      Logger.log(`üìß Guest emails: ${calendarGuests.join(', ')}`);
    }
    
    result.participants = calendarGuests;

    // Step 5: ‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•
    if (sendEmail && result.rfiEventsUpdated > 0) {
      Logger.log("üìß Step 5: Sending postponement notification to ALL participants...");
      
      // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Schedule ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡∏≠‡∏µ‡πÄ‡∏°‡∏•
      const scheduleInfo = {
        originalDate: result.originalDate || 'N/A',
        originalTime: rfiSearchResult.events[0] ? 
          `${formatTime(rfiSearchResult.events[0].startTime)} - ${formatTime(rfiSearchResult.events[0].endTime)}` : 'N/A',
        originalLocation: rfiSearchResult.events[0] ? (rfiSearchResult.events[0].location || '') : '',
        originalInspector: rfiSearchResult.events[0] ? extractInspectorFromTitle(rfiSearchResult.events[0].title) : '',
        
        newDate: formatDateThai(newDate),
        newTime: `${newStartTime} - ${newEndTime}`,
        newLocation: newLocation || '',
        newInspector: assignedInspector || ''
      };
      
      Logger.log('üìä Schedule Info:', JSON.stringify(scheduleInfo));
      
      // ‡πÉ‡∏ä‡πâ overallTeamChanges ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å updateCalendarEventV2()
      if (!overallTeamChanges) {
        // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡πÉ‡∏´‡∏°‡πà
        overallTeamChanges = compareTeamChanges(
          scheduleInfo.originalInspector,
          scheduleInfo.newInspector
        );
      }
      
      Logger.log('üë• Team Changes:', JSON.stringify(overallTeamChanges));
      
      // ‚≠ê ‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ calendarGuests ‡∏ó‡∏µ‡πà‡∏î‡∏∂‡∏á‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡πâ‡∏ß
      const emailResult = sendPostponementNotification(
        cleanRfiNumber,
        cleanDescription,
        postponeReason,
        result.updatedRFIEvents,
        requesterEmail,
        calendarGuests,  // ‚Üê ‡πÉ‡∏ä‡πâ guest list ‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏•‡πâ‡∏ß
        scheduleInfo,
        overallTeamChanges
      );
      
      result.emailsSent = emailResult.success;
      result.teamChanged = emailResult.teamChanged || false;
      Logger.log(`üìß Email: ${emailResult.success ? 'SENT' : 'FAILED'}`);
      Logger.log(`üìß Total recipients: ${emailResult.totalRecipients || 0}`);
      
      if (emailResult.teamChanged) {
        Logger.log(`üîÑ Email includes team change notification`);
      }
      
      if (emailResult.recipientsList && emailResult.recipientsList.length > 0) {
        Logger.log(`üìß Recipients: ${emailResult.recipientsList.join(', ')}`);
      }
    }

    // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
    result.success = result.rfiEventsUpdated > 0;
    
    if (result.success) {
      result.message = `Postponed ${result.rfiEventsUpdated} event(s) to ${newDate} ${newStartTime}-${newEndTime}`;
      if (overallTeamChanges && overallTeamChanges.hasChanges) {
        result.message += `\nTeam changed: ${overallTeamChanges.removedTeams.join(', ')} ‚Üí ${overallTeamChanges.addedTeams.join(', ')}`;
      }
    } else {
      result.message = `No appointments were postponed for RFI ${cleanRfiNumber}`;
    }

  } catch (error) {
    result.error = error.toString();
    result.message = `Error postponing RFI ${cleanRfiNumber}: ${result.error}`;
    Logger.log(`‚ùå Unexpected error: ${result.error}`);
  }

  // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•
  Logger.log("\n" + "=".repeat(50));
  Logger.log("üìÖ RFI POSTPONEMENT SUMMARY:");
  Logger.log(`üÜî RFI Number: ${result.rfiNumber}`);
  Logger.log(`üìÖ New Date: ${result.newDate} ${result.newStartTime}-${result.newEndTime}`);
  Logger.log(`üìÖ Events Updated: ${result.rfiEventsUpdated}/${result.rfiEventsFound}`);
  Logger.log(`üë• Participants (Updated): ${result.participants.length}`);
  Logger.log(`üîÑ Team Changed: ${result.teamChanged ? 'YES' : 'NO'}`);
  Logger.log(`üìß Emails Sent: ${result.emailsSent ? 'YES (ALL participants)' : 'NO'}`);
  Logger.log(`‚úÖ Overall Success: ${result.success ? 'YES' : 'NO'}`);

  return result;
}

/**
 * ‚úÖ Validate Postpone Inputs
 */
function validatePostponeInputs(rfiNumber, description, newDate, newStartTime, newEndTime) {
  try {
    Logger.log('üîç Validating postpone inputs...');
    
    const errors = [];
    
    if (!rfiNumber || String(rfiNumber).trim() === '') {
      errors.push('RFI Number is required');
    }
    
    if (!newDate || String(newDate).trim() === '') {
      errors.push('New Date is required');
    } else {
      const dateObj = new Date(newDate + 'T00:00:00');
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      
      if (isNaN(dateObj.getTime())) {
        errors.push('Invalid date format (must be YYYY-MM-DD)');
      } else if (dateObj < today) {
        errors.push('New Date must be today or in the future');
      }
    }
    
    if (!newStartTime || String(newStartTime).trim() === '') {
      errors.push('New Start Time is required');
    } else {
      const timePattern = /^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$/;
      if (!timePattern.test(newStartTime)) {
        errors.push('Invalid Start Time format (must be HH:MM)');
      }
    }
    
    if (!newEndTime || String(newEndTime).trim() === '') {
      errors.push('New End Time is required');
    } else {
      const timePattern = /^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$/;
      if (!timePattern.test(newEndTime)) {
        errors.push('Invalid End Time format (must be HH:MM)');
      }
      
      if (newStartTime) {
        const startMinutes = timeToMinutes(newStartTime);
        const endMinutes = timeToMinutes(newEndTime);
        
        if (endMinutes <= startMinutes) {
          errors.push('End Time must be after Start Time');
        }
      }
    }
    
    if (errors.length > 0) {
      Logger.log('‚ùå Validation failed:');
      errors.forEach(err => Logger.log(`   - ${err}`));
      
      return {
        valid: false,
        error: errors.join('; ')
      };
    }
    
    Logger.log('‚úÖ Validation passed');
    return {
      valid: true,
      error: null
    };
    
  } catch (error) {
    Logger.log(`‚ùå Validation error: ${error.toString()}`);
    return {
      valid: false,
      error: `Validation error: ${error.toString()}`
    };
  }
}

// ===== HELPER FUNCTIONS =====

/**
 * ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ Calendar Events ‡∏ï‡∏≤‡∏° RFI Number ‡πÅ‡∏•‡∏∞ Description
 */
function searchCalendarEventsByRFIAndDescription(rfiNumber, description, calendarId, searchDays = 60) {
  Logger.log(`üîç Searching calendar "${calendarId}" for RFI Number: ${rfiNumber}`);
  
  try {
    const calendar = CalendarApp.getCalendarById(calendarId);
    if (!calendar) {
      throw new Error(`Cannot access calendar: ${calendarId}`);
    }

    const startDate = new Date();
    startDate.setDate(startDate.getDate() - searchDays);
    
    const endDate = new Date();
    endDate.setDate(endDate.getDate() + searchDays);
    
    const allEvents = calendar.getEvents(startDate, endDate);
    Logger.log(`üìä Total events in range: ${allEvents.length}`);
    
    if (allEvents.length === 0) {
      return { success: false, message: 'No events found in date range', events: [] };
    }

    const matchingEvents = [];
    
    const rfiSearchPatterns = [
      `RFI #${rfiNumber}`,
      `RFI-${rfiNumber}`,
      `#${rfiNumber}`,
      rfiNumber
    ];
    
    allEvents.forEach((event, index) => {
      try {
        const title = event.getTitle() || '';
        const eventDescription = event.getDescription() || '';
        const searchableText = (title + ' ' + eventDescription).toLowerCase();
        
        const rfiMatch = rfiSearchPatterns.some(pattern => 
          searchableText.includes(pattern.toLowerCase())
        );
        
        if (rfiMatch) {
          Logger.log(`‚úÖ Found matching event: "${title}"`);
          
          matchingEvents.push({
            event: event,
            eventId: event.getId(),
            title: title,
            description: eventDescription,
            startTime: event.getStartTime(),
            endTime: event.getEndTime(),
            location: event.getLocation() || '',
            created: event.getDateCreated(),
            lastUpdated: event.getLastUpdated()
          });
        }
        
      } catch (eventError) {
        Logger.log(`‚ö†Ô∏è Error processing event ${index + 1}: ${eventError.toString()}`);
      }
    });
    
    matchingEvents.sort((a, b) => b.created - a.created);
    
    return {
      success: matchingEvents.length > 0,
      message: `Found ${matchingEvents.length} events for RFI: ${rfiNumber}`,
      events: matchingEvents
    };
    
  } catch (error) {
    Logger.log(`‚ùå Error searching calendar events: ${error.toString()}`);
    return { success: false, error: error.toString(), events: [] };
  }
}

/**
 * ‚≠ê ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Calendar Event ‡πÅ‡∏ö‡∏ö Delete + Create ‡πÉ‡∏´‡∏°‡πà
 * (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ó‡∏µ‡∏° - ‡πÄ‡∏Å‡πá‡∏ö Guest ‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô ‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô Team ‡πÄ‡∏Å‡πà‡∏≤)
 */
function updateCalendarEventV2(eventInfo, calendarId, newStartTime, newEndTime, postponeReason, newLocation, assignedInspector) {
  Logger.log(`üìù Updating event in "${calendarId}": ${eventInfo.eventId}`);
  Logger.log(`üîÑ Method: Delete old event + Create new event`);
  
  try {
    const calendar = CalendarApp.getCalendarById(calendarId);
    if (!calendar) {
      return { success: false, error: `Cannot access calendar: ${calendarId}` };
    }
    
    const oldEvent = calendar.getEventById(eventInfo.eventId);
    
    if (!oldEvent) {
      return { success: false, error: `Event not found: ${eventInfo.eventId}` };
    }

    // ‚≠ê Step 1: ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô
    const originalStartTime = oldEvent.getStartTime();
    const originalEndTime = oldEvent.getEndTime();
    const originalLocation = oldEvent.getLocation();
    const originalDescription = oldEvent.getDescription() || '';
    const currentTitle = oldEvent.getTitle();
    
    // ‡∏î‡∏∂‡∏á‡∏ó‡∏µ‡∏°‡πÄ‡∏î‡∏¥‡∏°‡∏à‡∏≤‡∏Å title
    const originalTeam = extractInspectorFromTitle(currentTitle);
    Logger.log('üìä Original team from title:', originalTeam);
    Logger.log('üìä New assigned inspector:', assignedInspector);
    
    // ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏ó‡∏µ‡∏°‡πÄ‡∏Å‡πà‡∏≤‡πÅ‡∏•‡∏∞‡πÉ‡∏´‡∏°‡πà
    const teamChanges = compareTeamChanges(originalTeam, assignedInspector);
    Logger.log('üîÑ Team changes detected:', teamChanges.hasChanges);
    
    // ‚≠ê Step 2: ‡∏™‡∏£‡πâ‡∏≤‡∏á Title ‡πÉ‡∏´‡∏°‡πà
    let newTitle = currentTitle;
    
    // ‡πÄ‡∏û‡∏¥‡πà‡∏° "POSTPONED" ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ
    if (!currentTitle.includes('üìÖ POSTPONED')) {
      newTitle = `üìÖ POSTPONED - ${currentTitle}`;
    }
    
    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Team ‡πÉ‡∏ô Title
    // ‡∏•‡∏ö [...] ‡πÄ‡∏Å‡πà‡∏≤‡∏≠‡∏≠‡∏Å
    newTitle = newTitle.replace(/\[([^\]]+)\]$/, '').trim();
    
    // ‡πÄ‡∏û‡∏¥‡πà‡∏° [...] ‡πÉ‡∏´‡∏°‡πà
    if (assignedInspector && String(assignedInspector).trim() !== '') {
      const teams = String(assignedInspector).trim().split(',').map(t => t.trim());
      newTitle += ` [${teams.join(', ')}]`;
    }
    
    Logger.log('üìù New title:', newTitle);
    
// ‚≠ê Step 3: ‡∏™‡∏£‡πâ‡∏≤‡∏á Description ‡πÉ‡∏´‡∏°‡πà (‡∏£‡∏ß‡∏° Postponement Record)

// ‚≠ê 3.1 ‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î Description ‡πÄ‡∏î‡∏¥‡∏° (‡∏•‡∏ö Meeting links)
Logger.log('üßπ Cleaning original description...');
const cleanedOriginalDescription = removeMeetingLinksFromDescription(originalDescription);

const postponementRecord = `
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
üìÖ INSPECTION POSTPONED
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚è∞ Original Schedule:
   üìÖ ${originalStartTime.toLocaleDateString('th-TH', { 
      year: 'numeric', 
      month: 'long', 
      day: 'numeric' 
   })}
   üïê ${originalStartTime.toLocaleTimeString('th-TH', { 
      hour: '2-digit', 
      minute: '2-digit' 
   })} - ${originalEndTime.toLocaleTimeString('th-TH', { 
      hour: '2-digit', 
      minute: '2-digit' 
   })}
   üìç ${originalLocation || 'No location'}
   üë• ${originalTeam || 'No team'}

üîÑ New Schedule:
   üìÖ ${newStartTime.toLocaleDateString('th-TH', { 
      year: 'numeric', 
      month: 'long', 
      day: 'numeric' 
   })}
   üïê ${newStartTime.toLocaleTimeString('th-TH', { 
      hour: '2-digit', 
      minute: '2-digit' 
   })} - ${newEndTime.toLocaleTimeString('th-TH', { 
      hour: '2-digit', 
      minute: '2-digit' 
   })}
   üìç ${newLocation || originalLocation || 'No location'}
   üë• ${assignedInspector || 'No team'}

${teamChanges.hasChanges ? `
üîÑ Team Changes:
   ‚ùå Removed: ${teamChanges.removedTeams.join(', ') || 'None'}
   ‚úÖ Added: ${teamChanges.addedTeams.join(', ') || 'None'}
   ‚ÜîÔ∏è Unchanged: ${teamChanges.unchangedTeams.join(', ') || 'None'}
` : ''}
${postponeReason ? `üí¨ Reason:\n   ${postponeReason}\n` : ''}
üìå Postponed on: ${new Date().toLocaleString('th-TH')}
ü§ñ Updated by: RFI System

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
‚úÖ EVENT INFORMATION (UPDATED):
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

üìã ‡∏á‡∏≤‡∏ô RFI Work Requirement
üë§ ‡∏ú‡∏π‡πâ requirement: Requester
üìù ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î: ${currentTitle.replace(/üìÖ POSTPONED - /, '').replace(/üìã RFI #.*? - /, '').replace(/\[.*?\]/, '').trim()}
üìç ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà: ${newLocation || originalLocation || 'No location'}
‚è∞ ‡πÄ‡∏ß‡∏•‡∏≤: ${newStartTime.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' })} - ${newEndTime.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' })} ‡∏ô.
üë• ‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö: ${assignedInspector || 'No team'}

üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á: ${new Date().toLocaleString('th-TH', { 
  year: 'numeric', 
  month: '2-digit', 
  day: '2-digit',
  hour: '2-digit',
  minute: '2-digit',
  second: '2-digit'
})}

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
‚ö†Ô∏è NOTE: This is a NEW event (old event was deleted)
All original guests are preserved except old team members.
No meeting links included.
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
`;

// ‚úÖ 3.2 ‡πÉ‡∏ä‡πâ‡πÅ‡∏Ñ‡πà Postponement Record (‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏° Description ‡πÄ‡∏î‡∏¥‡∏°)
// ‡πÄ‡∏û‡∏£‡∏≤‡∏∞ Postponement Record ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏°‡∏µ Meeting links
const newDescription = postponementRecord;

Logger.log('‚úÖ New description created (without meeting links)');

    // ‚≠ê Step 4: ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° Guest List ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Event ‡πÉ‡∏´‡∏°‡πà
    const guestEmails = new Set();
    
    // 4.1 ‡∏î‡∏∂‡∏á Guest ‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    const oldGuests = oldEvent.getGuestList(true);
    Logger.log('üìä Total guests in old event:', oldGuests.length);
    
    // 4.2 ‡∏î‡∏∂‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏Ç‡∏≠‡∏á Team ‡πÄ‡∏Å‡πà‡∏≤ (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏≠‡∏á‡∏≠‡∏≠‡∏Å)
    let oldTeamEmails = [];
    if (originalTeam && originalTeam.trim() !== '') {
      const oldTeamMembers = getTeamEmailsByTeamNames(originalTeam);
      if (oldTeamMembers && oldTeamMembers.length > 0) {
        oldTeamEmails = oldTeamMembers.map(t => t.email.toLowerCase());
        Logger.log('üóëÔ∏è Old team emails to exclude:', oldTeamEmails.join(', '));
      }
    }
    
    // 4.3 ‡πÄ‡∏û‡∏¥‡πà‡∏° Guest ‡πÄ‡∏î‡∏¥‡∏° (‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô Team ‡πÄ‡∏Å‡πà‡∏≤)
    oldGuests.forEach(function(guest) {
      const guestEmail = guest.getEmail();
      const guestEmailLower = guestEmail.toLowerCase();
      
      // ‚≠ê ‡πÄ‡∏Å‡πá‡∏ö Guest ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô ‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô Team ‡πÄ‡∏Å‡πà‡∏≤
      if (!oldTeamEmails.includes(guestEmailLower)) {
        guestEmails.add(guestEmail);
        Logger.log('‚úÖ Keeping guest:', guestEmail);
      } else {
        Logger.log('‚ùå Excluding old team member:', guestEmail);
      }
    });
    
    // 4.4 ‡πÄ‡∏û‡∏¥‡πà‡∏° Organizer/Creator (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
    try {
      const creator = oldEvent.getCreators();
      if (creator && creator.length > 0) {
        creator.forEach(function(email) {
          if (email && email.includes('@')) {
            guestEmails.add(email);
            Logger.log('‚úÖ Added creator:', email);
          }
        });
      }
    } catch (e) {
      Logger.log('‚ö†Ô∏è Could not get creator:', e.message);
    }
    
    // 4.5 ‡πÄ‡∏û‡∏¥‡πà‡∏° Team ‡πÉ‡∏´‡∏°‡πà
    if (assignedInspector && String(assignedInspector).trim() !== '') {
      const newTeamEmails = getTeamEmailsByTeamNames(assignedInspector);
      
      if (newTeamEmails && newTeamEmails.length > 0) {
        Logger.log('‚ûï Adding new team members:');
        newTeamEmails.forEach(function(teamMember) {
          if (teamMember.email && teamMember.email.includes('@')) {
            guestEmails.add(teamMember.email);
            Logger.log('‚úÖ Added new team member:', teamMember.name, '->', teamMember.email);
          }
        });
      }
    }
    
    const guestList = Array.from(guestEmails);
    Logger.log('üìä Final guest list for new event:', guestList.length, 'guests');
    Logger.log('üìß Guests:', guestList.join(', '));
    
    // ‚≠ê Step 5: ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏µ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡∏°‡πÅ‡∏£‡∏Å
    let eventColor = CalendarApp.EventColor.BLUE; // default
    if (assignedInspector && String(assignedInspector).trim() !== '') {
      const teams = String(assignedInspector).trim().split(',').map(t => t.trim());
      const teamColors = getTeamColors(assignedInspector);
      
      if (teams.length > 0 && teamColors[teams[0]]) {
        eventColor = teamColors[teams[0]];
        Logger.log('üé® Event color set for team:', teams[0]);
      }
    }
    
    const finalLocation = newLocation && newLocation.trim() !== '' ? newLocation.trim() : originalLocation;
    
    // ‚≠ê Step 6: ‡∏•‡∏ö Event ‡πÄ‡∏Å‡πà‡∏≤
    Logger.log('üóëÔ∏è Deleting old event:', eventInfo.eventId);
    try {
      oldEvent.deleteEvent();
      Logger.log('‚úÖ Old event deleted successfully');
    } catch (deleteError) {
      Logger.log('‚ùå Error deleting old event:', deleteError.toString());
      return {
        success: false,
        error: 'Failed to delete old event: ' + deleteError.toString()
      };
    }
    
    // ‚≠ê Step 7: ‡∏™‡∏£‡πâ‡∏≤‡∏á Event ‡πÉ‡∏´‡∏°‡πà
    Logger.log('üÜï Creating new event...');
    Logger.log('  Title:', newTitle);
    Logger.log('  Start:', newStartTime);
    Logger.log('  End:', newEndTime);
    Logger.log('  Location:', finalLocation);
    Logger.log('  Guests count:', guestList.length);
    
    let newEvent;
    try {
      newEvent = calendar.createEvent(
        newTitle,
        newStartTime,
        newEndTime,
        {
          description: newDescription,
          location: finalLocation,
          guests: guestList.join(','),
          sendInvites: true
        }
      );
      
      // ‡∏ï‡∏±‡πâ‡∏á‡∏™‡∏µ
      try {
        newEvent.setColor(eventColor);
      } catch (colorError) {
        Logger.log('‚ö†Ô∏è Could not set event color:', colorError.message);
      }
      
      Logger.log('‚úÖ New event created successfully!');
      Logger.log('   New Event ID:', newEvent.getId());
      Logger.log('   Guests:', guestList.length, 'guests');
      
    } catch (createError) {
      Logger.log('‚ùå Error creating new event:', createError.toString());
      return {
        success: false,
        error: 'Failed to create new event: ' + createError.toString()
      };
    }
    
    return {
      success: true,
      newTitle: newTitle,
      newLocation: finalLocation,
      newEventId: newEvent.getId(),
      teamChanges: teamChanges,
      guestsCount: guestList.length,
      method: 'delete_and_create'
    };
    
  } catch (error) {
    Logger.log(`‚ùå Error in updateCalendarEventV2: ${error.toString()}`);
    return {
      success: false,
      error: error.toString()
    };
  }
}


/**
 * ‚≠ê ‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏à‡πâ‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏ô‡∏ï‡∏£‡∏ß‡∏à (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ó‡∏µ‡∏°)
 */
function sendPostponementNotification(rfiNumber, Description, postponeReason, updatedEvents, requesterEmail, calendarGuests, scheduleInfo, teamComparison) {
  Logger.log('\n' + '='.repeat(50));
  Logger.log('üìß SENDING POSTPONEMENT NOTIFICATION');
  Logger.log('='.repeat(50));
  
  Logger.log(`üìß Requester Email: ${requesterEmail || 'NOT PROVIDED'}`);
  Logger.log(`üìß Calendar Guests: ${calendarGuests ? calendarGuests.length : 0}`);
  
  try {
    const quota = checkEmailQuota();
    Logger.log(`üìä Email quota remaining: ${quota}`);
    
    if (quota <= 0) {
      Logger.log('‚ùå Email quota exceeded');
      return { success: false, message: "Email quota exceeded" };
    }

    // ‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô: Requester + Guests ‡∏à‡∏≤‡∏Å Calendar
    const allRecipients = new Set();
    
    // ‡πÄ‡∏û‡∏¥‡πà‡∏° Requester
    if (requesterEmail && String(requesterEmail).trim() !== '' && String(requesterEmail).includes('@')) {
      const cleanEmail = String(requesterEmail).trim();
      allRecipients.add(cleanEmail);
      Logger.log(`‚úÖ Added Requester: ${cleanEmail}`);
    }
    
    // ‡πÄ‡∏û‡∏¥‡πà‡∏° Guests ‡∏à‡∏≤‡∏Å Calendar
    if (calendarGuests && Array.isArray(calendarGuests)) {
      calendarGuests.forEach((guestEmail, index) => {
        if (guestEmail && guestEmail.includes('@')) {
          const cleanEmail = String(guestEmail).trim();
          allRecipients.add(cleanEmail);
          Logger.log(`‚úÖ Added Guest: ${cleanEmail}`);
        }
      });
    }
    
    // ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏µ‡∏°‡πÉ‡∏´‡∏°‡πà
    if (scheduleInfo && scheduleInfo.newInspector) {
      Logger.log(`\nüë• Processing New Team: ${scheduleInfo.newInspector}`);
      const newTeamEmails = getTeamEmailsByTeamNames(scheduleInfo.newInspector);
      
      if (newTeamEmails && newTeamEmails.length > 0) {
        newTeamEmails.forEach((teamMember) => {
          const teamEmail = teamMember.email;
          if (teamEmail && teamEmail.includes('@')) {
            allRecipients.add(teamEmail);
            Logger.log(`‚úÖ Added New Team Member: ${teamMember.name} -> ${teamEmail}`);
          }
        });
      }
    }
    
    // ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏µ‡∏°‡πÄ‡∏Å‡πà‡∏≤ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ó‡∏µ‡∏°)
    if (teamComparison && teamComparison.hasChanges && teamComparison.removedTeams.length > 0) {
      Logger.log(`\nüë• Processing Old Team (Removed): ${teamComparison.removedTeams.join(', ')}`);
      const oldTeamEmails = getTeamEmailsByTeamNames(teamComparison.removedTeams.join(','));
      
      if (oldTeamEmails && oldTeamEmails.length > 0) {
        oldTeamEmails.forEach((teamMember) => {
          const teamEmail = teamMember.email;
          if (teamEmail && teamEmail.includes('@')) {
            allRecipients.add(teamEmail);
            Logger.log(`‚úÖ Added Old Team Member: ${teamMember.name} -> ${teamEmail}`);
          }
        });
      }
    }
    
    const finalRecipients = Array.from(allRecipients);
    
    Logger.log(`\nüìä FINAL RECIPIENTS COUNT: ${finalRecipients.length}`);
    
    if (finalRecipients.length === 0) {
      Logger.log('‚ùå ERROR: No recipients found');
      return { 
        success: false, 
        message: "No recipients",
        totalRecipients: 0
      };
    }

    // ‚≠ê ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏≠‡∏µ‡πÄ‡∏°‡∏•
    let subject = `üìÖ ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ï‡∏£‡∏ß‡∏à - RFI #${rfiNumber} Inspection Rescheduled`;
    if (teamComparison && teamComparison.hasChanges) {
      subject = `üìÖ ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ó‡∏µ‡∏° - RFI #${rfiNumber} Inspection Rescheduled`;
    }
    
    let eventsList = '<ul style="margin: 10px 0;">';
    updatedEvents.forEach(evt => {
      eventsList += `<li style="margin: 5px 0;"><strong>${evt.title}</strong></li>`;
    });
    eventsList += '</ul>';
    
    // ‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á
    let scheduleComparisonHtml = '';
    if (scheduleInfo) {
      scheduleComparisonHtml = `
<h3>üìÖ ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ï‡∏£‡∏ß‡∏à:</h3>
<table style="margin: 15px 0; width: 100%;">
<thead>
<tr style="background-color: #f8f9fa;">
  <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
  <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">‡πÄ‡∏î‡∏¥‡∏°</th>
  <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">‡πÉ‡∏´‡∏°‡πà (‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô)</th>
</tr>
</thead>
<tbody>
<tr>
  <td style="padding: 10px; border: 1px solid #ddd;"><strong>üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</strong></td>
  <td style="padding: 10px; border: 1px solid #ddd;">${scheduleInfo.originalDate}</td>
  <td style="padding: 10px; border: 1px solid #ddd; background-color: #e7f3ff;"><strong>${scheduleInfo.newDate}</strong></td>
</tr>
<tr>
  <td style="padding: 10px; border: 1px solid #ddd;"><strong>üïê ‡πÄ‡∏ß‡∏•‡∏≤</strong></td>
  <td style="padding: 10px; border: 1px solid #ddd;">${scheduleInfo.originalTime}</td>
  <td style="padding: 10px; border: 1px solid #ddd; background-color: #e7f3ff;"><strong>${scheduleInfo.newTime}</strong></td>
</tr>
${scheduleInfo.originalLocation || scheduleInfo.newLocation ? `
<tr>
  <td style="padding: 10px; border: 1px solid #ddd;"><strong>üìç ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</strong></td>
  <td style="padding: 10px; border: 1px solid #ddd;">${scheduleInfo.originalLocation || '-'}</td>
  <td style="padding: 10px; border: 1px solid #ddd; background-color: #e7f3ff;"><strong>${scheduleInfo.newLocation || '-'}</strong></td>
</tr>
` : ''}
${scheduleInfo.originalInspector || scheduleInfo.newInspector ? `
<tr>
  <td style="padding: 10px; border: 1px solid #ddd;"><strong>üë• ‡∏ó‡∏µ‡∏°‡∏ï‡∏£‡∏ß‡∏à</strong></td>
  <td style="padding: 10px; border: 1px solid #ddd;">${scheduleInfo.originalInspector || '-'}</td>
  <td style="padding: 10px; border: 1px solid #ddd; background-color: ${teamComparison && teamComparison.hasChanges ? '#fff3cd' : '#e7f3ff'};"><strong>${scheduleInfo.newInspector || '-'}</strong></td>
</tr>
` : ''}
</tbody>
</table>`;
    }
    
    // ‚≠ê ‡πÅ‡∏™‡∏î‡∏á Team Changes (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
    let teamChangesHtml = '';
    if (teamComparison && teamComparison.hasChanges) {
      teamChangesHtml = `
<div style="background-color: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; margin: 15px 0; border-radius: 5px;">
  <strong style="color: #856404;">üîÑ ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô:</strong>
  <table style="margin-top: 10px; width: 100%;">
    ${teamComparison.removedTeams.length > 0 ? `
    <tr>
      <td style="padding: 8px; width: 150px;"><strong>‚ùå ‡∏ó‡∏µ‡∏°‡πÄ‡∏Å‡πà‡∏≤ (‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å):</strong></td>
      <td style="padding: 8px; color: #dc3545;">${teamComparison.removedTeams.join(', ')}</td>
    </tr>
    ` : ''}
    ${teamComparison.addedTeams.length > 0 ? `
    <tr>
      <td style="padding: 8px; width: 150px;"><strong>‚úÖ ‡∏ó‡∏µ‡∏°‡πÉ‡∏´‡∏°‡πà (‡πÄ‡∏û‡∏¥‡πà‡∏°):</strong></td>
      <td style="padding: 8px; color: #28a745;">${teamComparison.addedTeams.join(', ')}</td>
    </tr>
    ` : ''}
    ${teamComparison.unchangedTeams.length > 0 ? `
    <tr>
      <td style="padding: 8px; width: 150px;"><strong>‚ÜîÔ∏è ‡∏ó‡∏µ‡∏°‡πÄ‡∏î‡∏¥‡∏° (‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô):</strong></td>
      <td style="padding: 8px;">${teamComparison.unchangedTeams.join(', ')}</td>
    </tr>
    ` : ''}
  </table>
</div>`;
    }
    
    // ‚úÖ ‡πÅ‡∏™‡∏î‡∏á Reason
    let reasonHtml = '';
    if (postponeReason && String(postponeReason).trim() !== '') {
      reasonHtml = `
<div style="background-color: #fffacd; border-left: 4px solid #ffc107; padding: 15px; margin: 15px 0; border-radius: 5px;">
  <strong style="color: #856404;">üí¨ ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ï‡∏£‡∏ß‡∏à:</strong>
  <p style="margin: 8px 0 0 0; color: #333;">${postponeReason}</p>
</div>`;
    }
    
    // ‚≠ê ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
    let importantNoteHtml = '';
    if (teamComparison && teamComparison.hasChanges) {
      importantNoteHtml = `
<div class="note" style="background-color: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; margin: 15px 0; border-radius: 5px;">
  <strong style="color: #856404;">‚ö†Ô∏è ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç - ‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô:</strong><br><br>
  
  ${teamComparison.addedTeams.length > 0 ? `
  <div style="background-color: #d4edda; padding: 10px; margin: 10px 0; border-radius: 5px;">
    <strong style="color: #155724;">‚úÖ ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏µ‡∏°‡πÉ‡∏´‡∏°‡πà (${teamComparison.addedTeams.join(', ')}):</strong>
    <ul style="margin: 5px 0 0 20px; color: #155724;">
      <li>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏ï‡∏£‡∏ß‡∏à‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô</li>
      <li>‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Google Calendar ‡∏Ç‡∏≠‡∏á‡∏ó‡πà‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢</li>
      <li>‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÅ‡∏•‡∏∞‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô</li>
    </ul>
  </div>
  ` : ''}
  
  ${teamComparison.removedTeams.length > 0 ? `
  <div style="background-color: #f8d7da; padding: 10px; margin: 10px 0; border-radius: 5px;">
    <strong style="color: #721c24;">‚ùå ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏µ‡∏°‡πÄ‡∏Å‡πà‡∏≤ (${teamComparison.removedTeams.join(', ')}):</strong>
    <ul style="margin: 5px 0 0 20px; color: #721c24;">
      <li>‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß - ‡∏°‡∏µ‡∏ó‡∏µ‡∏°‡∏≠‡∏∑‡πà‡∏ô‡∏£‡∏±‡∏ö‡∏ä‡πà‡∏ß‡∏á‡πÅ‡∏ó‡∏ô</li>
      <li>‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡πÉ‡∏ô Google Calendar ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</li>
      <li>‡∏ó‡πà‡∏≤‡∏ô‡∏à‡∏∞‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö RFI ‡∏ô‡∏µ‡πâ</li>
    </ul>
  </div>
  ` : ''}
  
  ${teamComparison.unchangedTeams.length > 0 ? `
  <div style="background-color: #d1ecf1; padding: 10px; margin: 10px 0; border-radius: 5px;">
    <strong style="color: #0c5460;">‚ÜîÔ∏è ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏µ‡∏°‡πÄ‡∏î‡∏¥‡∏° (${teamComparison.unchangedTeams.join(', ')}):</strong>
    <ul style="margin: 5px 0 0 20px; color: #0c5460;">
      <li>‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏´‡∏°‡πà</li>
      <li>‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Google Calendar ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï</li>
    </ul>
  </div>
  ` : ''}
</div>`;
    } else {
      importantNoteHtml = `
<div class="note" style="background-color: #e7f3ff; border-left: 4px solid #1877f2; padding: 15px; margin: 15px 0; border-radius: 5px;">
  <strong>üìå ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç:</strong> 
  <ul style="margin: 10px 0; padding-left: 20px;">
    <li>‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ô‡∏µ‡πâ‡∏™‡πà‡∏á‡∏ñ‡∏∂‡∏á <strong>‡∏ú‡∏π‡πâ‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</strong></li>
    <li>Google Calendar ‡∏Ç‡∏≠‡∏á‡∏ó‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡πâ‡∏ß</li>
    <li>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Calendar ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà</li>
  </ul>
</div>`;
    }
    
    const htmlMessage = `<!DOCTYPE html>
<html>
<head><meta charset="UTF-8"><style>
body { font-family: 'Sarabun', Arial, sans-serif; margin: 20px; line-height: 1.6; }
h2 { color: #ff6b35; margin-bottom: 10px; }
h3 { color: #333; margin-top: 25px; margin-bottom: 12px; }
table { border-collapse: collapse; width: 100%; margin: 10px 0; }
td, th { border: 1px solid #ddd; padding: 10px; text-align: left; }
th { background-color: #f2f2f5; font-weight: 600; }
ul { padding-left: 20px; }
li { margin: 5px 0; }
</style></head>
<body>
<h2>üìÖ ‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à RFI ‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏õ‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏´‡∏°‡πà</h2>

<div style="background-color: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; margin: 15px 0; border-radius: 5px;">
  <strong>‚ö†Ô∏è ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç:</strong> ‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á RFI ‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏õ‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏´‡∏°‡πà
  ${teamComparison && teamComparison.hasChanges ? '<br><strong style="color: #dc3545;">üîÑ ‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô</strong>' : ''}
</div>

<h3>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î RFI:</h3>
<table>
<tr><th style="width: 30%;">RFI Number</th><td><strong>${rfiNumber}</strong></td></tr>
<tr><th>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th><td>${Description}</td></tr>
</table>

${scheduleComparisonHtml}

${teamChangesHtml}

${reasonHtml}

<h3>üìÖ Calendar Events ‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏•‡πâ‡∏ß:</h3>
${eventsList}

${importantNoteHtml}

<hr style="margin: 30px 0; border: none; border-top: 1px solid #ddd;">
<p style="color: #666; font-size: 12px; margin: 5px 0;">
üì® <strong>‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</strong> ${finalRecipients.length} ‡∏Ñ‡∏ô ${teamComparison && teamComparison.hasChanges ? '(‡∏£‡∏ß‡∏°‡∏ó‡∏µ‡∏°‡πÄ‡∏Å‡πà‡∏≤‡πÅ‡∏•‡∏∞‡∏ó‡∏µ‡∏°‡πÉ‡∏´‡∏°‡πà)' : ''}<br>
ü§ñ <strong>‡∏™‡πà‡∏á‡πÇ‡∏î‡∏¢:</strong> RFI System<br>
üïê <strong>‡∏™‡πà‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠:</strong> ${new Date().toLocaleString('th-TH', { timeZone: 'Asia/Bangkok' })}
</p>
</body>
</html>`;
    
    const recipientList = finalRecipients.join(',');
    
    Logger.log(`\nüì§ Sending email...`);
    Logger.log(`üìß Subject: ${subject}`);
    
    const sent = safeSendEmail({
      to: recipientList,
      subject: subject,
      htmlBody: htmlMessage,
      name: 'RFI System - Postponement Notification'
    });
    
    if (sent) {
      Logger.log(`‚úÖ EMAIL SENT to ${finalRecipients.length} recipients`);
    }
    
    return {
      success: sent,
      totalRecipients: finalRecipients.length,
      recipientsList: finalRecipients,
      teamChanged: teamComparison ? teamComparison.hasChanges : false
    };
    
  } catch (error) {
    Logger.log(`‚ùå EMAIL ERROR: ${error.toString()}`);
    return { 
      success: false, 
      error: error.toString(),
      totalRecipients: 0
    };
  }
}

/**
 * ‚≠ê ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏ó‡∏µ‡∏°‡πÄ‡∏Å‡πà‡∏≤‡πÅ‡∏•‡∏∞‡∏ó‡∏µ‡∏°‡πÉ‡∏´‡∏°‡πà
 */
function compareTeamChanges(originalTeams, newTeams) {
  try {
    Logger.log('üîç Comparing teams...');
    Logger.log('Original:', originalTeams);
    Logger.log('New:', newTeams);
    
    if (!originalTeams || !newTeams) {
      return {
        hasChanges: false,
        oldTeams: [],
        newTeams: [],
        removedTeams: [],
        addedTeams: [],
        unchangedTeams: []
      };
    }
    
    const oldTeamList = originalTeams.split(',').map(t => t.trim()).filter(t => t.length > 0);
    const newTeamList = newTeams.split(',').map(t => t.trim()).filter(t => t.length > 0);
    
    const removedTeams = oldTeamList.filter(team => !newTeamList.includes(team));
    const addedTeams = newTeamList.filter(team => !oldTeamList.includes(team));
    const unchangedTeams = oldTeamList.filter(team => newTeamList.includes(team));
    
    const hasChanges = removedTeams.length > 0 || addedTeams.length > 0;
    
    Logger.log('‚úÖ Comparison result:');
    Logger.log('  Has changes:', hasChanges);
    Logger.log('  Removed:', removedTeams.join(', '));
    Logger.log('  Added:', addedTeams.join(', '));
    Logger.log('  Unchanged:', unchangedTeams.join(', '));
    
    return {
      hasChanges: hasChanges,
      oldTeams: oldTeamList,
      newTeams: newTeamList,
      removedTeams: removedTeams,
      addedTeams: addedTeams,
      unchangedTeams: unchangedTeams
    };
    
  } catch (error) {
    Logger.log('‚ùå Error:', error.toString());
    return {
      hasChanges: false,
      oldTeams: [],
      newTeams: [],
      removedTeams: [],
      addedTeams: [],
      unchangedTeams: []
    };
  }
}

/**
 * ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ Guests ‡∏à‡∏≤‡∏Å Calendar Events
 */
function extractGuestsFromEvents(eventInfoList) {
  Logger.log('üë• Extracting guests from calendar events...');
  
  const allGuests = new Set();
  
  try {
    eventInfoList.forEach((eventInfo) => {
      try {
        const event = eventInfo.event;
        if (!event) return;
        
        const guests = event.getGuestList(true);
        
        guests.forEach((guest) => {
          try {
            const guestEmail = guest.getEmail();
            if (guestEmail && guestEmail.includes('@')) {
              allGuests.add(guestEmail);
            }
          } catch (guestError) {
            Logger.log(`‚ùå Error processing guest: ${guestError.toString()}`);
          }
        });
        
        try {
          const creators = event.getCreators();
          creators.forEach(creator => {
            if (creator && creator.includes('@')) {
              allGuests.add(String(creator).trim());
            }
          });
        } catch (creatorError) {
          // Ignore
        }
        
      } catch (eventError) {
        Logger.log(`‚ùå Error: ${eventError.toString()}`);
      }
    });
    
    const guestArray = Array.from(allGuests);
    Logger.log(`üìä Total guests: ${guestArray.length}`);
    
    return guestArray;
    
  } catch (error) {
    Logger.log(`‚ùå Error: ${error.toString()}`);
    return [];
  }
}

/**
 * ‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡∏°‡∏à‡∏≤‡∏Å Title
 * ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö format: [Survey Team A, Lab Team A, Inspector Team A]
 */
function extractInspectorFromTitle(title) {
  if (!title) return '';
  
  // ‡∏´‡∏≤ [...] ‡∏ï‡∏±‡∏ß‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡πÉ‡∏ô title
  const matches = title.match(/\[([^\]]+)\]/g);
  if (matches && matches.length > 0) {
    // ‡πÄ‡∏≠‡∏≤ match ‡∏ï‡∏±‡∏ß‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢
    const lastMatch = matches[matches.length - 1];
    // ‡∏•‡∏ö [ ‡πÅ‡∏•‡∏∞ ] ‡∏≠‡∏≠‡∏Å
    const teamNames = lastMatch.replace(/[\[\]]/g, '');
    Logger.log('Extracted team from title:', teamNames);
    return teamNames;
  }
  
  return '';
}

function createNewDateTime(dateStr, startTimeStr, endTimeStr) {
  try {
    const startDate = new Date(dateStr + 'T00:00:00+07:00');
    const [startHours, startMinutes] = startTimeStr.split(':').map(Number);
    startDate.setHours(startHours, startMinutes, 0, 0);
    
    const endDate = new Date(dateStr + 'T00:00:00+07:00');
    const [endHours, endMinutes] = endTimeStr.split(':').map(Number);
    endDate.setHours(endHours, endMinutes, 0, 0);
    
    return {
      valid: true,
      startTime: startDate,
      endTime: endDate
    };
  } catch (error) {
    return {
      valid: false,
      error: `Invalid date/time: ${error.toString()}`
    };
  }
}

function formatDateThai(dateString) {
  if (!dateString) return '';
  const months = ['‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå', '‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°', '‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô', '‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°', '‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô',
    '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°', '‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô', '‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°', '‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô', '‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'];
  const date = new Date(dateString + 'T00:00:00');
  return date.getDate() + ' ' + months[date.getMonth()] + ' ' + (date.getFullYear() + 543);
}

function formatTime(timeValue) {
  if (!timeValue) return '';
  if (typeof timeValue === 'string') return timeValue;
  if (timeValue instanceof Date) {
    return String(timeValue.getHours()).padStart(2, '0') + ':' + 
           String(timeValue.getMinutes()).padStart(2, '0');
  }
  return timeValue.toString();
}

function timeToMinutes(timeString) {
  if (!timeString) return 0;
  const parts = timeString.split(':');
  return parseInt(parts[0]) * 60 + parseInt(parts[1]);
}

function checkEmailQuota() {
  try {
    return MailApp.getRemainingDailyQuota();
  } catch (error) {
    return 0;
  }
}

function safeSendEmail(emailParams) {
  try {
    const quota = checkEmailQuota();
    if (quota <= 0) return false;
    MailApp.sendEmail(emailParams);
    return true;
  } catch (error) {
    Logger.log('Email error:', error.toString());
    return false;
  }
}

// ===== COLOR FUNCTIONS =====

function getTeamColors(assignedInspector) {
  try {
    if (!assignedInspector) return {};
    const requestedTeams = assignedInspector.split(',').map(t => t.trim());
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Resources');
    if (!sheet) return {};
    const lastRow = sheet.getLastRow();
    if (lastRow <= 1) return {};
    const teamData = sheet.getRange(2, 2, lastRow - 1, 1).getValues();
    const colorData = sheet.getRange(2, 8, lastRow - 1, 1).getValues();
    const teamColors = {};
    for (let i = 0; i < teamData.length; i++) {
      const teamName = String(teamData[i][0] || '').trim();
      const colorValue = String(colorData[i][0] || '').trim();
      if (requestedTeams.includes(teamName) && colorValue) {
        teamColors[teamName] = getCalendarColor(colorValue);
      }
    }
    return teamColors;
  } catch (error) {
    return {};
  }
}

function getCalendarColor(colorHex) {
  const colorNameMap = {
    'PALE_BLUE': CalendarApp.EventColor.PALE_BLUE,
    'PALE_GREEN': CalendarApp.EventColor.PALE_GREEN,
    'MAUVE': CalendarApp.EventColor.MAUVE,
    'PALE_RED': CalendarApp.EventColor.PALE_RED,
    'YELLOW': CalendarApp.EventColor.YELLOW,
    'ORANGE': CalendarApp.EventColor.ORANGE,
    'CYAN': CalendarApp.EventColor.CYAN,
    'GRAY': CalendarApp.EventColor.GRAY,
    'BLUE': CalendarApp.EventColor.BLUE,
    'GREEN': CalendarApp.EventColor.GREEN,
    'RED': CalendarApp.EventColor.RED
  };
  const colorUpper = String(colorHex).toUpperCase();
  if (colorNameMap[colorUpper]) return colorNameMap[colorUpper];
  return CalendarApp.EventColor.BLUE;
}


/**
 * ========================================
 * HOLIDAY MANAGEMENT SYSTEM (CACHED + CONSECUTIVE LOGIC)
 * ========================================
 * ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î - ‡∏û‡∏£‡πâ‡∏≠‡∏° Cache Service
 * üîß UPDATED: ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ô (Consecutive Holidays)
 * ‡∏ï‡πâ‡∏≠‡∏á‡∏à‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô 13:00 ‡∏ô. ‡∏Ç‡∏≠‡∏á "‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î"
 */

const HOLIDAY_CACHE_KEY = 'master_holidays_data';
const HOLIDAY_CACHE_TTL = 21600; 

// ... (‡∏™‡πà‡∏ß‡∏ô Cache Function ‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°) ...

function getActiveHolidays() {
  try {
    const cache = CacheService.getScriptCache();
    const cachedJson = cache.get(HOLIDAY_CACHE_KEY);
    
    if (cachedJson) {
      const holidays = JSON.parse(cachedJson);
      return holidays.map(function(h) {
        return {
          date: h.date,
          name: h.name,
          dateObj: new Date(h.date + 'T00:00:00')
        };
      });
    }
    return loadHolidaysFromSheet();
  } catch (error) {
    console.error('‚ùå Error in getActiveHolidays:', error);
    return loadHolidaysFromSheet();
  }
}

function loadHolidaysFromSheet() {
  try {
    console.log('üì• Reading from Holiday Sheet...');
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Holiday');
    if (!sheet) return [];
    
    const lastRow = sheet.getLastRow();
    if (lastRow <= 1) return [];
    
    const data = sheet.getRange(2, 1, lastRow - 1, 3).getValues();
    const holidays = [];
    
    for (let i = 0; i < data.length; i++) {
      const row = data[i];
      const date = row[0];
      const name = String(row[1] || '').trim();
      const status = String(row[2] || '').trim();
      
      if (status !== 'Active' && status !== 'Activated') continue;
      
      if (date && date instanceof Date) {
        holidays.push({
          date: formatDate(date),
          name: name
        });
      }
    }
    
    holidays.sort(function(a, b) {
      return new Date(a.date).getTime() - new Date(b.date).getTime();
    });
    
    const cache = CacheService.getScriptCache();
    const jsonData = JSON.stringify(holidays);
    cache.put(HOLIDAY_CACHE_KEY, jsonData, HOLIDAY_CACHE_TTL);
    
    if (typeof addToCacheRegistry === 'function') {
      addToCacheRegistry(HOLIDAY_CACHE_KEY, jsonData.length, HOLIDAY_CACHE_TTL);
    }
    
    return holidays.map(function(h) {
      return {
        date: h.date,
        name: h.name,
        dateObj: new Date(h.date + 'T00:00:00')
      };
    });
    
  } catch (error) {
    console.error('‚ùå Error loading holidays:', error);
    return [];
  }
}

function refreshHolidayCache() {
  try {
    const cache = CacheService.getScriptCache();
    cache.remove(HOLIDAY_CACHE_KEY);
    const holidays = loadHolidaysFromSheet();
    return { success: true, count: holidays.length };
  } catch (error) {
    return { success: false, error: error.toString() };
  }
}

function adminRefreshHolidays() {
  const ui = SpreadsheetApp.getUi();
  const result = refreshHolidayCache();
  if (result.success) {
    ui.alert('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ', '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡πÅ‡∏•‡πâ‡∏ß (' + result.count + ' ‡∏ß‡∏±‡∏ô)', ui.ButtonSet.OK);
  } else {
    ui.alert('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‚ùå', result.error, ui.ButtonSet.OK);
  }
}

function autoRefreshHolidayCache() {
  console.log('‚è∞ Trigger: Refreshing Holiday Cache...');
  refreshHolidayCache();
}

// ========================================
// üß© BUSINESS LOGIC HELPER FUNCTIONS
// ========================================

function isHoliday(dateStr) {
  const holidays = getActiveHolidays();
  for (let i = 0; i < holidays.length; i++) {
    if (holidays[i].date === dateStr) return holidays[i];
  }
  return null;
}

/**
 * ‚≠ê [NEW] ‡∏´‡∏≤‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î ‡∏Å‡πà‡∏≠‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î (‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏Ç‡πâ‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î)
 * ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏≤ Deadline ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á
 */
function getDeadlineWorkday(targetDateStr) {
  let checkDate = new Date(targetDateStr + 'T00:00:00');
  checkDate.setDate(checkDate.getDate() - 1); // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏ä‡πá‡∏Ñ‡∏à‡∏≤‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏ô
  
  // ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏∞‡πÄ‡∏à‡∏≠‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î
  while (true) {
    const dateStr = formatDate(checkDate);
    if (!isHoliday(dateStr)) {
      return {
        date: dateStr,
        dateObj: new Date(checkDate),
        dateThai: formatDateThai(dateStr)
      };
    }
    checkDate.setDate(checkDate.getDate() - 1); // ‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á‡πÑ‡∏õ‡∏≠‡∏µ‡∏Å 1 ‡∏ß‡∏±‡∏ô
  }
}

function getNextHoliday(fromDateStr) {
  const holidays = getActiveHolidays();
  const fromDate = new Date(fromDateStr + 'T00:00:00');
  for (let i = 0; i < holidays.length; i++) {
    if (holidays[i].dateObj > fromDate) return holidays[i];
  }
  return null;
}

function getConsecutiveHolidayCount(startDateStr) {
  const holidays = getActiveHolidays();
  const holidayDates = holidays.map(h => h.date);
  let count = 0;
  let checkDate = new Date(startDateStr + 'T00:00:00');
  while (true) {
    const dateStr = formatDate(checkDate);
    if (holidayDates.indexOf(dateStr) !== -1) {
      count++;
      checkDate.setDate(checkDate.getDate() + 1);
    } else {
      break;
    }
  }
  return count;
}

function getNextWorkday(fromDateStr) {
  const holidays = getActiveHolidays();
  const holidayDates = holidays.map(h => h.date);
  let checkDate = new Date(fromDateStr + 'T00:00:00');
  checkDate.setDate(checkDate.getDate() + 1);
  let daysChecked = 0;
  while (daysChecked < 30) {
    const dateStr = formatDate(checkDate);
    if (holidayDates.indexOf(dateStr) === -1) {
      const dayOfWeek = checkDate.getDay();
      const dayName = ['‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå', '‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå', '‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£', '‡∏û‡∏∏‡∏ò', '‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ', '‡∏®‡∏∏‡∏Å‡∏£‡πå', '‡πÄ‡∏™‡∏≤‡∏£‡πå'][dayOfWeek];
      return {
        date: dateStr,
        dateThai: formatDateThai(dateStr),
        dayName: dayName,
        suggest: '‡∏ß‡∏±‡∏ô' + dayName + '‡∏ó‡∏µ‡πà ' + formatDateThai(dateStr)
      };
    }
    checkDate.setDate(checkDate.getDate() + 1);
    daysChecked++;
  }
  return { date: formatDate(checkDate), dateThai: formatDateThai(formatDate(checkDate)), suggest: '‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ó‡∏µ‡∏° QC' };
}


/**
 * ‚≠ê MAIN: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (Fixed for External Skip Logic)
 */
function canBookDate(targetDateStr, inspectionType) {
  try {
    console.log('Checking:', targetDateStr, '| Type:', inspectionType);
    
    const now = new Date();
    const currentHour = now.getHours();
    const currentMinute = now.getMinutes();
    const today = formatDate(now);
    const todayDateObj = new Date(today + 'T00:00:00');
    const targetDateObj = new Date(targetDateStr + 'T00:00:00');

    // 1. ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    const targetHoliday = isHoliday(targetDateStr);

    if (targetHoliday) {
      // ... (Logic ‡∏™‡πà‡∏ß‡∏ô Internal/Survey ‡∏à‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î ‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏° ‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á) ...
      if (inspectionType === 'internal' || inspectionType === 'survey') {
        const holidayToday = isHoliday(today);
        if (holidayToday) {
           const nextWorkday = getNextWorkday(today);
           return { allowed: false, reason: 'today_holiday', title: 'üéâ ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î', message: '‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ', nextWorkday: nextWorkday.date };
        }
        const deadlineWorkday = getDeadlineWorkday(targetDateStr);
        if (today === deadlineWorkday.date) {
          if (currentHour >= 13) {
            const nextWorkday = getNextWorkday(targetDateStr);
            return { allowed: false, reason: 'too_late_deadline', title: '‚è∞ ‡πÄ‡∏•‡∏¢‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î', message: '‡∏ï‡πâ‡∏≠‡∏á‡∏à‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô 13:00 ‡∏ô. ‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î', nextWorkday: nextWorkday.date };
          }
          return { allowed: true, warning: true, title: '‚úÖ ‡∏à‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡πÑ‡∏î‡πâ', message: '‚è∞ ‡∏à‡∏≠‡∏á‡∏ó‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤ (‡∏Å‡πà‡∏≠‡∏ô 13:00 ‡∏ô.) ‚úì' };
        } else if (todayDateObj > deadlineWorkday.dateObj) {
          const nextWorkday = getNextWorkday(targetDateStr);
          return { allowed: false, reason: 'passed_deadline', title: '‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏≠‡∏á‡πÑ‡∏î‡πâ', message: '‡πÄ‡∏•‡∏¢‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß', nextWorkday: nextWorkday.date };
        }
        return { allowed: true, warning: true, title: '‚úÖ ‡∏à‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤', message: '‚è∞ ‡∏à‡∏≠‡∏á‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤ ‚úì' };
      } else {
        // External ‡∏´‡πâ‡∏≤‡∏°‡∏à‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î
        const nextWorkday = getNextWorkday(targetDateStr);
        return { allowed: false, reason: 'target_is_holiday', title: '‚ùå ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î (External)', message: 'üö´ External ‡∏´‡πâ‡∏≤‡∏°‡∏à‡∏≠‡∏á‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î\nüí° ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡∏à‡∏≠‡∏á ' + nextWorkday.suggest, nextWorkday: nextWorkday.date };
      }
    }

    // ----------------------------------------
    // ‚úÖ ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏õ‡∏Å‡∏ï‡∏¥ (Common Days)
    // ----------------------------------------
    
    if (inspectionType === 'internal' || inspectionType === 'survey') {
      // ... (Logic Internal/Survey ‡πÄ‡∏î‡∏¥‡∏° ‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°) ...
      if (targetDateStr === today) {
        if (currentHour >= 16) {
          const nextWorkday = getNextWorkday(today);
          return { allowed: false, reason: 'same_day_cutoff', title: '‚è∞ ‡πÄ‡∏•‡∏¢‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ', message: '‡∏ï‡πâ‡∏≠‡∏á‡∏à‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô 16:00 ‡∏ô.', nextWorkday: nextWorkday.date };
        }
        return { allowed: true, warning: true, title: '‚úÖ ‡∏à‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ', message: '‚è∞ ‡∏à‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô 16:00 ‡∏ô. ‚úì' };
      }
      return { allowed: true };

    } else {
      // ========================================
      // ü§ù EXTERNAL LOGIC (FIXED for 13:00 Rule)
      // ========================================
      
      // 1. ‡∏´‡∏≤‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏ñ‡∏±‡∏î‡πÑ‡∏õ (Next Workday) ‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
      const nextWorkdayInfo = getNextWorkday(today); // ‡πÄ‡∏ä‡πà‡∏ô ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ 24 -> ‡πÑ‡∏î‡πâ 27 (‡∏Ç‡πâ‡∏≤‡∏° 25,26)
      const nextWorkdayStr = nextWorkdayInfo.date;
      
      // 2. ‡∏Å‡∏≥‡∏´‡∏ô‡∏î "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≠‡∏á‡πÑ‡∏î‡πâ‡πÄ‡∏£‡πá‡∏ß‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î" (Earliest Allowed Date)
      let earliestAllowedDateStr = nextWorkdayStr;
      let reasonMsg = '';

      // ‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç Cutoff 13:00 ‡∏ô. ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î
      const isTodayHoliday = isHoliday(today);
      
      if (isTodayHoliday || currentHour >= 13) {
        // ‡∏ñ‡πâ‡∏≤‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏´‡∏¢‡∏∏‡∏î ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏•‡∏¢ 13:00 ‡∏ô. -> ‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡πâ‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡πÑ‡∏õ‡∏≠‡∏µ‡∏Å 1 ‡∏ß‡∏±‡∏ô
        // (‡πÄ‡∏ä‡πà‡∏ô ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ 24 ‡πÄ‡∏Å‡∏¥‡∏ô‡∏ö‡πà‡∏≤‡∏¢‡πÇ‡∏°‡∏á -> 27 ‡πÑ‡∏°‡πà‡∏ó‡∏±‡∏ô -> ‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏õ 28)
        const dayAfterNextInfo = getNextWorkday(nextWorkdayStr);
        earliestAllowedDateStr = dayAfterNextInfo.date;
        
        if (isTodayHoliday) {
          reasonMsg = '‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏ö Lead Time ‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏ñ‡∏±‡∏î‡πÑ‡∏õ';
        } else {
          reasonMsg = '‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏•‡∏±‡∏á 13:00 ‡∏ô. ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô';
        }
      }

      // 3. ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡∏Å‡∏±‡∏ö ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï
      // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô Date Object ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö
      const targetObj = new Date(targetDateStr + 'T00:00:00');
      const earliestObj = new Date(earliestAllowedDateStr + 'T00:00:00');

      if (targetObj < earliestObj) {
        // ‚ùå ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å < ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï (‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å 27 ‡πÅ‡∏ï‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÄ‡∏£‡∏¥‡πà‡∏° 28)
        const suggestInfo = (earliestAllowedDateStr === nextWorkdayInfo.date) ? nextWorkdayInfo : getNextWorkday(nextWorkdayStr); // ‡∏´‡∏≤ info ‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥
        
        return {
          allowed: false,
          reason: 'external_cutoff_rule',
          title: '‚è∞ ‡∏à‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏ó‡∏±‡∏ô‡∏£‡∏≠‡∏ö (External)',
          message: '‚ùå ' + reasonMsg + '\n' +
                   '‚è∞ ‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: ' + currentHour + ':' + String(currentMinute).padStart(2, '0') + ' ‡∏ô.\n' +
                   'üìã External Lead Time: ‡∏ï‡πâ‡∏≠‡∏á‡∏à‡∏≠‡∏á‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏Å‡πà‡∏≠‡∏ô 13:00 ‡∏ô.\n\n' +
                   'üí° ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡∏à‡∏≠‡∏á ' + formatDateThai(earliestAllowedDateStr) + ' ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏ô‡πÑ‡∏õ',
          nextWorkday: earliestAllowedDateStr,
          canBookFromThai: formatDateThai(earliestAllowedDateStr)
        };
      }
      
      // ‚úÖ ‡∏ú‡πà‡∏≤‡∏ô‡∏ó‡∏∏‡∏Å‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç
      return { allowed: true };
    }

  } catch (error) {
    console.error('‚ùå Error checking booking:', error);
    return { allowed: true, error: error.toString() };
  }
}

// Helper Date Functions
function formatDate(date) {
  if (!date) return '';
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  return year + '-' + month + '-' + day;
}

function formatDateThai(dateString) {
  if (!dateString) return '';
  const months = ['‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå', '‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°', '‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô', '‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°', '‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô',
    '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°', '‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô', '‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°', '‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô', '‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'];
  const date = new Date(dateString + 'T00:00:00');
  const day = date.getDate();
  const month = months[date.getMonth()];
  const year = date.getFullYear() + 543;
  return day + ' ' + month + ' ' + year;
}

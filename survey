<!--version 3 - Multi-Step Form with Progress Indicator-->
<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Survey Work Requirement System - Multi-Step</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Kanit', sans-serif;
      min-height: 100vh;
      background: linear-gradient(135deg, #11998e 0%, #38ef7d 25%, #4ade80 50%, #22c55e 75%, #16a34a 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .container {
      width: 100%;
      max-width: 650px;
      background: #ffffff;
      border-radius: 20px;
      padding: 40px 35px;
      box-shadow: 0 20px 60px rgba(22, 163, 74, 0.3);
      animation: fadeIn 0.5s ease-out;
    }
    
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .header-section {
      text-align: center;
      margin-bottom: 30px;
    }
    
    .header-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 65px;
      height: 65px;
      background: linear-gradient(135deg, #16a34a 0%, #22c55e 100%);
      border-radius: 16px;
      margin-bottom: 12px;
      box-shadow: 0 6px 20px rgba(22, 163, 74, 0.3);
      font-size: 36px;
    }
    
    h1 {
      font-size: 32px;
      font-weight: 600;
      background: linear-gradient(135deg, #16a34a 0%, #22c55e 50%, #4ade80 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 10px;
    }
    
    .subtitle {
      font-size: 16px;
      font-weight: 300;
      color: #666;
      margin-bottom: 10px;
    }

    /* ‚≠ê Progress Indicator */
    .progress-container {
      margin: 30px 0;
      padding: 0;
    }

    .progress-steps {
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: relative;
      margin-bottom: 20px;
    }

    .progress-line {
      position: absolute;
      top: 25px;
      left: 0;
      right: 0;
      height: 4px;
      background: #e5e7eb;
      z-index: 1;
    }

    .progress-line-fill {
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      background: linear-gradient(90deg, #16a34a 0%, #22c55e 100%);
      transition: width 0.4s ease;
      width: 0%;
    }

    .progress-step {
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      z-index: 2;
      cursor: pointer;
      flex: 1;
    }

    .progress-step-circle {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      transition: all 0.3s ease;
      border: 3px solid #ffffff;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .progress-step.active .progress-step-circle {
      background: linear-gradient(135deg, #16a34a 0%, #22c55e 100%);
      box-shadow: 0 4px 15px rgba(22, 163, 74, 0.4);
      transform: scale(1.1);
    }

    .progress-step.completed .progress-step-circle {
      background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
      box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
    }

    .progress-step-label {
      margin-top: 8px;
      font-size: 12px;
      font-weight: 500;
      color: #9ca3af;
      text-align: center;
      max-width: 80px;
      line-height: 1.2;
    }

    .progress-step.active .progress-step-label {
      color: #16a34a;
      font-weight: 600;
    }

    .progress-step.completed .progress-step-label {
      color: #10b981;
      font-weight: 600;
    }

    /* ‚≠ê Step Container */
    .step-container {
      display: none;
      animation: slideIn 0.4s ease-out;
    }

    .step-container.active {
      display: block;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(30px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .step-header {
      margin-bottom: 25px;
      padding-bottom: 15px;
      border-bottom: 2px solid #f3f4f6;
    }

    .step-title {
      font-size: 24px;
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .step-description {
      font-size: 14px;
      color: #6b7280;
      line-height: 1.5;
    }

    .info-box {
      background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
      border-left: 4px solid #16a34a;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 25px;
      font-size: 14px;
      color: #065f46;
    }

    .info-box strong {
      color: #16a34a;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    label {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: #333;
      margin-bottom: 8px;
    }
    
    label span {
      color: #16a34a;
    }
    
    input, select, textarea {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e4e6eb;
      background: #ffffff;
      border-radius: 10px;
      font-family: 'Kanit', sans-serif;
      font-size: 15px;
      transition: all 0.3s ease;
      color: #333;
    }
    
    textarea {
      height: 90px;
      resize: vertical;
    }
    
    input:focus, select:focus, textarea:focus {
      outline: none;
      background: white;
      border-color: #16a34a;
      box-shadow: 0 0 0 3px rgba(22, 163, 74, 0.1);
    }
    
    input::placeholder, textarea::placeholder {
      color: #999;
      font-weight: 300;
    }
    
    option {
      color: #333;
      font-weight: 400;
    }
    
    input:disabled, select:disabled, textarea:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      background: #f5f6f7;
    }
    
    .loading-select {
      background-color: #f5f6f7 !important;
      color: #666 !important;
    }
    
    .time-info {
      font-size: 12px;
      color: #16a34a;
      margin-top: 5px;
      font-style: italic;
    }

    /* ‚≠ê Navigation Buttons */
    .step-navigation {
      display: flex;
      gap: 15px;
      margin-top: 30px;
    }

    .btn {
      flex: 1;
      padding: 14px;
      border: none;
      border-radius: 10px;
      font-family: 'Kanit', sans-serif;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn-prev {
      background: #f3f4f6;
      color: #6b7280;
    }

    .btn-prev:hover:not(:disabled) {
      background: #e5e7eb;
      color: #374151;
    }

    .btn-next {
      background: linear-gradient(135deg, #16a34a 0%, #22c55e 100%);
      color: white;
      box-shadow: 0 4px 15px rgba(22, 163, 74, 0.3);
    }

    .btn-next:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 25px rgba(22, 163, 74, 0.4);
    }

    .btn-submit {
      background: linear-gradient(135deg, #16a34a 0%, #22c55e 50%, #4ade80 100%);
      color: white;
      box-shadow: 0 4px 15px rgba(22, 163, 74, 0.3);
    }

    .btn-submit:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 25px rgba(22, 163, 74, 0.4);
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none !important;
    }

    /* ‚≠ê Summary Screen */
    .summary-card {
      background: #f9fafb;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .summary-section {
      margin-bottom: 20px;
    }

    .summary-section:last-child {
      margin-bottom: 0;
    }

    .summary-section-title {
      font-size: 16px;
      font-weight: 600;
      color: #16a34a;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .summary-item {
      display: flex;
      padding: 10px 0;
      border-bottom: 1px solid #e5e7eb;
    }

    .summary-item:last-child {
      border-bottom: none;
    }

    .summary-label {
      font-size: 14px;
      color: #6b7280;
      min-width: 120px;
      font-weight: 500;
    }

    .summary-value {
      font-size: 14px;
      color: #1f2937;
      font-weight: 400;
      flex: 1;
    }

    .summary-value.highlight {
      color: #16a34a;
      font-weight: 600;
    }

    .edit-link {
      color: #3b82f6;
      font-size: 13px;
      cursor: pointer;
      text-decoration: none;
      font-weight: 500;
      transition: color 0.2s;
    }

    .edit-link:hover {
      color: #2563eb;
      text-decoration: underline;
    }

    /* Survey Role Indicator */
    #surveyRoleIndicator {
      display: none;
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      color: white;
      padding: 12px 16px;
      border-radius: 10px;
      margin-bottom: 20px;
      text-align: center;
      font-weight: 500;
      box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);
    }

    /* File Upload */
    #clearFileBtn {
      padding: 0;
      width: 28px;
      height: 28px;
      min-width: 28px;
      background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      line-height: 1;
      transition: all 0.2s ease;
      flex-shrink: 0;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    #clearFileBtn:hover {
      background: linear-gradient(135deg, #b91c1c 0%, #991b1b 100%);
      transform: scale(1.1);
      box-shadow: 0 3px 8px rgba(220, 38, 38, 0.3);
    }

    #fileInfo {
      display: none;
      margin-top: 10px;
      padding: 10px 12px;
      background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
      border-left: 4px solid #10b981;
      border-radius: 8px;
      font-size: 13px;
      color: #065f46;
      animation: slideDown 0.3s ease-out;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Toast Notification */
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      gap: 12px;
      max-width: 400px;
    }

    .toast {
      background: white;
      border-radius: 12px;
      padding: 16px 20px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
      display: flex;
      align-items: flex-start;
      gap: 12px;
      animation: slideInRight 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      position: relative;
      overflow: hidden;
      min-width: 320px;
    }

    .toast::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 4px;
    }

    .toast.success::before { background: #10b981; }
    .toast.error::before { background: #ef4444; }
    .toast.warning::before { background: #f59e0b; }
    .toast.info::before { background: #3b82f6; }

    .toast-icon {
      font-size: 24px;
      flex-shrink: 0;
      line-height: 1;
    }

    .toast-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .toast-title {
      font-weight: 600;
      font-size: 15px;
      color: #1f2937;
    }

    .toast-message {
      font-size: 13px;
      color: #6b7280;
      line-height: 1.4;
      white-space: pre-line;
    }

    .toast-close {
      background: none;
      border: none;
      font-size: 20px;
      color: #9ca3af;
      cursor: pointer;
      padding: 0;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
      transition: all 0.2s;
      flex-shrink: 0;
      margin: 0;
      line-height: 1;
    }

    .toast-close:hover {
      background: #f3f4f6;
      color: #374151;
    }

    .toast-progress {
      position: absolute;
      bottom: 0;
      left: 0;
      height: 3px;
      background: linear-gradient(90deg, rgba(16, 185, 129, 0.3) 0%, rgba(16, 185, 129, 0.8) 100%);
      transition: width 0.1s linear;
    }

    @keyframes slideInRight {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .loading {
      display: none;
      text-align: center;
      margin-top: 20px;
    }
    
    .spinner {
      width: 40px;
      height: 40px;
      margin: 0 auto 10px;
      border: 3px solid rgba(22, 163, 74, 0.2);
      border-top-color: #16a34a;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Calendar & Manual Links */
    .calendar-link-btn, .manual-link-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      width: 100%;
      padding: 14px 20px;
      border-radius: 12px;
      text-decoration: none;
      font-size: 15px;
      font-weight: 500;
      margin-bottom: 25px;
      transition: all 0.3s ease;
    }

    .calendar-link-btn {
      background: linear-gradient(135deg, #16a34a 0%, #22c55e 100%);
      color: white;
      box-shadow: 0 4px 15px rgba(22, 163, 74, 0.25);
    }

    .calendar-link-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(22, 163, 74, 0.35);
    }

    .manual-link-btn {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      color: white;
      box-shadow: 0 4px 15px rgba(245, 158, 11, 0.25);
      display: none;
    }

    .manual-link-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(245, 158, 11, 0.35);
    }
    
    @media (max-width: 768px) {
      .container {
        padding: 30px 20px;
      }
      
      h1 {
        font-size: 26px;
      }

      .progress-step-circle {
        width: 45px;
        height: 45px;
        font-size: 20px;
      }

      .progress-step-label {
        font-size: 11px;
        max-width: 70px;
      }

      .step-title {
        font-size: 20px;
      }

      .summary-label {
        min-width: 100px;
        font-size: 13px;
      }

      .summary-value {
        font-size: 13px;
      }

      .toast-container {
        right: 10px;
        left: 10px;
        max-width: none;
      }
      
      .toast {
        min-width: auto;
      }
    }

    @media (max-width: 480px) {
      .step-navigation {
        flex-direction: column;
      }

      .btn {
        width: 100%;
      }

      .summary-item {
        flex-direction: column;
        gap: 5px;
      }

      .summary-label {
        min-width: auto;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header-section">
      <div class="header-icon">üó∫Ô∏è</div>
      <h1>Survey Work System</h1>
      <p class="subtitle">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á Survey Work Requirement</p>
    </div>

    <!-- Links -->
    <a href="https://calendar.google.com/calendar/u/0/embed?src=developeritd75@gmail.com&ctz=Asia/Bangkok" 
       target="_blank" 
       class="calendar-link-btn">
      <span>üìÖ</span>
      <span>‡∏î‡∏π‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</span>
      <span>‚Üó</span>
    </a>

    <a href="#" 
       id="manualLinkBtn"
       target="_blank" 
       class="manual-link-btn">
      <span>üìñ</span>
      <span>‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô Survey</span>
      <span>‚Üó</span>
    </a>

    <!-- Survey Role Indicator -->
    <div id="surveyRoleIndicator">
      <span style="font-size: 18px; margin-right: 8px;">üë®‚Äçüíº</span>
      <span id="surveyRoleText">Survey Role Mode</span>
    </div>

    <!-- Progress Indicator -->
    <div class="progress-container">
      <div class="progress-steps">
        <div class="progress-line">
          <div class="progress-line-fill" id="progressLineFill"></div>
        </div>
        
        <div class="progress-step active" data-step="1" onclick="goToStep(1)">
          <div class="progress-step-circle">üìÖ</div>
          <div class="progress-step-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤</div>
        </div>
        
        <div class="progress-step" data-step="2" onclick="goToStep(2)">
          <div class="progress-step-circle">üìù</div>
          <div class="progress-step-label">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô</div>
        </div>
        
        <div class="progress-step" data-step="3" onclick="goToStep(3)">
          <div class="progress-step-circle">üë§</div>
          <div class="progress-step-label">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏Ç‡∏≠</div>
        </div>
        
        <div class="progress-step" data-step="4" onclick="goToStep(4)">
          <div class="progress-step-circle">üìé</div>
          <div class="progress-step-label">‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö</div>
        </div>
        
        <div class="progress-step" data-step="5" onclick="goToStep(5)">
          <div class="progress-step-circle">‚úì</div>
          <div class="progress-step-label">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</div>
        </div>
      </div>
    </div>

    <form id="surveyWorkForm">
      <!-- Step 1: Date & Time -->
      <div class="step-container active" id="step1">
        <div class="step-header">
          <div class="step-title">
            <span>üìÖ</span>
            <span>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤</span>
          </div>
          <div class="step-description">
            ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô Survey
          </div>
        </div>

        <div class="info-box">
          <strong>üìå ‡∏Ç‡πâ‡∏≠‡∏Å‡∏≥‡∏´‡∏ô‡∏î:</strong> ‡∏à‡∏≠‡∏á‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 30 ‡∏ô‡∏≤‡∏ó‡∏µ<br>
          <strong>üìÖ ‡∏à‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ:</strong> ‡πÑ‡∏î‡πâ ‡∏ñ‡πâ‡∏≤‡∏à‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô 16:00 ‡∏ô. ‚≠ê<br>
          <strong>‚è∞ ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏Å‡∏≤‡∏£:</strong> 09:00 - 20:00 ‡∏ô.<br>
          <strong>üë• ‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô:</strong> Survey Teams ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
        </div>

        <div class="form-group">
          <label for="requestDate">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ <span>*</span></label>
          <input type="date" id="requestDate" name="requestDate" required>
        </div>
        
        <div class="form-group">
          <label for="workType">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô <span>*</span></label>
          <select id="workType" name="workType" required>
            <option value="">-- ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î... --</option>
          </select>
          <div class="time-info">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô Survey ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£</div>
        </div>
        
        <div class="form-group">
          <label for="startTime">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô <span>*</span></label>
          <select id="startTime" name="startTime" required disabled>
            <option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡πà‡∏≠‡∏ô --</option>
          </select>
          <div class="time-info">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£</div>
        </div>
        
        <div class="form-group">
          <label for="endTime">‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î <span>*</span></label>
          <select id="endTime" name="endTime" required disabled>
            <option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡πà‡∏≠‡∏ô --</option>
          </select>
          <div class="time-info">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô +1 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</div>
        </div>

          <div class="form-group" id="manualTeamSelectionGroup" style="display: none; margin-top: 20px; padding-top: 20px; border-top: 1px dashed #e4e6eb;">
          <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô (‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Survey Role) <span class="required">*</span></label>

          <div id="assignedInspectorContainer" style="border: 2px solid #10b981; border-radius: 10px; padding: 15px; background: #f0fdf4; min-height: 80px; max-height: 200px; overflow-y: auto;">
            <div class="inspector-loading" style="color: #047857; text-align: center; font-style: italic;">
              ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡πà‡∏≠‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏ó‡∏µ‡∏°‡∏ß‡πà‡∏≤‡∏á
            </div>
          </div>

          <input type="hidden" id="assignedInspector" name="assignedInspector">
          <div class="time-info" style="color: #059669;">
            üí° Survey Role ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡∏°‡πÄ‡∏≠‡∏á‡πÑ‡∏î‡πâ (‡∏£‡∏∞‡∏ö‡∏ö Auto ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î)
          </div>
        </div>


        <div class="step-navigation">
          <button type="button" class="btn btn-prev" disabled>
            <span>‚Üê</span>
            <span>‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</span>
          </button>
          <button type="button" class="btn btn-next" onclick="nextStep()">
            <span>‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</span>
            <span>‚Üí</span>
          </button>
        </div>
      </div>

      <!-- Step 2: Work Details -->
      <div class="step-container" id="step2">
        <div class="step-header">
          <div class="step-title">
            <span>üìù</span>
            <span>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô</span>
          </div>
          <div class="step-description">
            ‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô Survey ‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
          </div>
        </div>

        <div class="form-group">
          <label for="description">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î Survey Work <span>*</span></label>
          <textarea id="description" name="description" required placeholder="‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô Survey ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£"></textarea>
        </div>
        
        <div class="form-group">
          <label for="location">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà <span>*</span></label>
          <input type="text" id="location" name="location" required placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà">
        </div>

        <div class="step-navigation">
          <button type="button" class="btn btn-prev" onclick="prevStep()">
            <span>‚Üê</span>
            <span>‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</span>
          </button>
          <button type="button" class="btn btn-next" onclick="nextStep()">
            <span>‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</span>
            <span>‚Üí</span>
          </button>
        </div>
      </div>

      <!-- Step 3: Requester Info -->
      <div class="step-container" id="step3">
        <div class="step-header">
          <div class="step-title">
            <span>üë§</span>
            <span>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏Ç‡∏≠</span>
          </div>
          <div class="step-description">
            ‡∏£‡∏∞‡∏ö‡∏∏‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏Ç‡∏≠‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô Survey
          </div>
        </div>

        <!-- Requester Selection (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Survey Role) -->
        <div class="form-group" id="requesterSelectionGroup" style="display: none;">
          <label for="requesterSelection">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡∏Ç‡∏≠ <span>*</span></label>
          <select id="requesterSelection" name="requesterSelection">
            <option value="">-- ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠... --</option>
          </select>
          <div class="time-info">
            üë®‚Äçüíº Survey Role: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡∏Ç‡∏≠‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏Ç‡∏≠
          </div>
        </div>

        <!-- Original Fields (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Regular User) -->
        <div class="form-group" id="requesterNameGroup">
          <label for="requesterName">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏Ç‡∏≠ <span>*</span></label>
          <input type="text" id="requesterName" name="requesterName" required 
                 placeholder="‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î..." readonly
                 style="background: #ecfdf5; cursor: wait;">
          <div class="time-info" id="nameInfo">üîç ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ...</div>
        </div>

        <div class="form-group" id="requesterEmailGroup">
          <label for="requesterEmail">‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ú‡∏π‡πâ‡∏Ç‡∏≠ <span>*</span></label>
          <input type="email" id="requesterEmail" name="requesterEmail" required readonly 
                 style="background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%); color: #16a34a; font-weight: 500; cursor: not-allowed; border-color: #1877f2;"
                 placeholder="‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì...">
          <div class="time-info">üîí ‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡∏∂‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏à‡∏≤‡∏Å‡∏ö‡∏±‡∏ç‡∏ä‡∏µ Google ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</div>
        </div>

        <div class="step-navigation">
          <button type="button" class="btn btn-prev" onclick="prevStep()">
            <span>‚Üê</span>
            <span>‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</span>
          </button>
          <button type="button" class="btn btn-next" onclick="nextStep()">
            <span>‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</span>
            <span>‚Üí</span>
          </button>
        </div>
      </div>

      <!-- Step 4: File Attachment -->
      <div class="step-container" id="step4">
        <div class="step-header">
          <div class="step-title">
            <span>üìé</span>
            <span>‡πÅ‡∏ô‡∏ö‡πÑ‡∏ü‡∏•‡πå</span>
          </div>
          <div class="step-description">
            ‡πÅ‡∏ô‡∏ö‡πÑ‡∏ü‡∏•‡πå Location Layout (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ) - ‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö
          </div>
        </div>

        <div class="form-group">
          <label for="locationLayoutFile">üìé ‡πÅ‡∏ô‡∏ö‡πÑ‡∏ü‡∏•‡πå Location Layout (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
          <input type="file" 
                 id="locationLayoutFile" 
                 name="locationLayoutFile" 
                 accept=".pdf,.png,.jpg,.jpeg,.gif" 
                 onchange="handleFileSelect(event)"
                 style="width: 100%; padding: 10px; border: 2px dashed #16a34a; background: #ecfdf5; cursor: pointer; border-radius: 8px;">
          <div class="time-info">
            üìé ‡πÅ‡∏ô‡∏ö‡πÑ‡∏ü‡∏•‡πå PDF ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (PNG, JPG, GIF) - ‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö<br>
            üí° ‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô Google Drive ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥<br>
            ‚ö†Ô∏è ‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 10 MB
          </div>
          
          <div id="fileInfo">
            <div style="display: flex; align-items: flex-start; gap: 10px;">
              <div style="flex-shrink: 0; font-size: 24px; line-height: 1;">‚úì</div>
              <div style="flex: 1; min-width: 0;">
                <div style="margin-bottom: 4px;">
                  <strong style="color: #065f46;">‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å:</strong>
                </div>
                <div id="fileName" style="word-break: break-all; color: #047857; font-size: 12px; margin-bottom: 4px;"></div>
                <div style="font-size: 11px; color: #059669;">
                  <strong>üìè ‡∏Ç‡∏ô‡∏≤‡∏î:</strong> <span id="fileSize"></span>
                </div>
              </div>
              <button type="button" id="clearFileBtn" onclick="clearLocationFile()" title="‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå">üóëÔ∏è</button>
            </div>
          </div>
        </div>

        <div class="step-navigation">
          <button type="button" class="btn btn-prev" onclick="prevStep()">
            <span>‚Üê</span>
            <span>‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</span>
          </button>
          <button type="button" class="btn btn-next" onclick="nextStep()">
            <span>‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</span>
            <span>‚Üí</span>
          </button>
        </div>
      </div>

      <!-- Step 5: Summary -->
      <div class="step-container" id="step5">
        <div class="step-header">
          <div class="step-title">
            <span>‚úì</span>
            <span>‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>
          </div>
          <div class="step-description">
            ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠
          </div>
        </div>

        <div class="summary-card">
          <!-- Date & Time -->
          <div class="summary-section">
            <div class="summary-section-title">
              <span>üìÖ</span>
              <span>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤</span>
              <a href="#" class="edit-link" style="margin-left: auto;" onclick="goToStep(1); return false;">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</a>
            </div>
            <div class="summary-item">
              <div class="summary-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</div>
              <div class="summary-value highlight" id="summaryDate">-</div>
            </div>
            <div class="summary-item">
              <div class="summary-label">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô:</div>
              <div class="summary-value" id="summaryWorkType">-</div>
            </div>
            <div class="summary-item">
              <div class="summary-label">‡πÄ‡∏ß‡∏•‡∏≤:</div>
              <div class="summary-value" id="summaryTime">-</div>
            </div>
          </div>

          <div class="summary-item">
              <div class="summary-label">‡∏ó‡∏µ‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å:</div>
              <div class="summary-value" id="summarySelectedTeam" style="color: #10b981; font-weight: 600;">-</div>
            </div>

          <!-- Work Details -->
          <div class="summary-section">
            <div class="summary-section-title">
              <span>üìù</span>
              <span>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô</span>
              <a href="#" class="edit-link" style="margin-left: auto;" onclick="goToStep(2); return false;">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</a>
            </div>
            <div class="summary-item">
              <div class="summary-label">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î:</div>
              <div class="summary-value" id="summaryDescription">-</div>
            </div>
            <div class="summary-item">
              <div class="summary-label">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà:</div>
              <div class="summary-value" id="summaryLocation">-</div>
            </div>
          </div>

          <!-- Requester Info -->
          <div class="summary-section">
            <div class="summary-section-title">
              <span>üë§</span>
              <span>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏Ç‡∏≠</span>
              <a href="#" class="edit-link" style="margin-left: auto;" onclick="goToStep(3); return false;">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</a>
            </div>
            <div class="summary-item">
              <div class="summary-label">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏Ç‡∏≠:</div>
              <div class="summary-value" id="summaryRequesterName">-</div>
            </div>
            <div class="summary-item">
              <div class="summary-label">‡∏≠‡∏µ‡πÄ‡∏°‡∏•:</div>
              <div class="summary-value" id="summaryRequesterEmail">-</div>
            </div>
          </div>

          <!-- File Attachment -->
          <div class="summary-section">
            <div class="summary-section-title">
              <span>üìé</span>
              <span>‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö</span>
              <a href="#" class="edit-link" style="margin-left: auto;" onclick="goToStep(4); return false;">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</a>
            </div>
            <div class="summary-item">
              <div class="summary-label">‡πÑ‡∏ü‡∏•‡πå:</div>
              <div class="summary-value" id="summaryFile">‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö</div>
            </div>
          </div>
        </div>

        <div class="step-navigation">
          <button type="button" class="btn btn-prev" onclick="prevStep()">
            <span>‚Üê</span>
            <span>‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</span>
          </button>
          <button type="submit" class="btn btn-submit" id="submitBtn">
            <span>‚úì</span>
            <span>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠</span>
          </button>
        </div>
      </div>
    </form>

    <div class="loading" id="loading">
      <div class="spinner"></div>
      <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...</p>
    </div>
  </div>

  <div class="toast-container" id="toastContainer"></div>
  
  <script>
    // ‚≠ê Global Variables
    var currentStep = 1;
    var totalSteps = 5;
    var selectedFileData = null;
    var formChanged = false;
    var isSubmitting = false;
    var isSurveyRole = false;
    var surveyRoleInfo = null;

        function showMessage(text, type, duration) {
      if (typeof duration === 'undefined') duration = 5000;
      
      const messageDiv = document.getElementById('message');
      messageDiv.textContent = text;
      messageDiv.className = 'message ' + type;
      messageDiv.style.display = 'block';
      
      setTimeout(function() {
        messageDiv.style.display = 'none';
      }, duration);
    }

        // ‚≠ê Toast Notification
    function showToast(title, message, type, duration) {
      if (typeof type === 'undefined') type = 'info';
      if (typeof duration === 'undefined') duration = 5000;
      
      var container = document.getElementById('toastContainer');
      if (!container) {
        container = document.createElement('div');
        container.id = 'toastContainer';
        container.className = 'toast-container';
        document.body.appendChild(container);
      }
      
      var icons = {
        success: '‚úÖ',
        error: '‚ùå',
        warning: '‚ö†Ô∏è',
        info: '‚ÑπÔ∏è'
      };
      
      var toast = document.createElement('div');
      toast.className = 'toast ' + type;
      toast.innerHTML = 
        '<div class="toast-icon">' + (icons[type] || '‚ÑπÔ∏è') + '</div>' +
        '<div class="toast-content">' +
        '<div class="toast-title">' + title + '</div>' +
        (message ? '<div class="toast-message">' + message + '</div>' : '') +
        '</div>' +
        '<button class="toast-close" onclick="removeToast(this)">√ó</button>' +
        '<div class="toast-progress"></div>';
      
      container.appendChild(toast);
      
      var progress = toast.querySelector('.toast-progress');
      var startTime = Date.now();
      
      var interval = setInterval(function() {
        var elapsed = Date.now() - startTime;
        var percentage = (elapsed / duration) * 100;
        
        if (percentage >= 100) {
          clearInterval(interval);
          removeToast(toast.querySelector('.toast-close'));
        } else {
          progress.style.width = (100 - percentage) + '%';
        }
      }, 50);
      
      toast._progressInterval = interval;
    }

    function removeToast(closeBtn) {
      var toast = closeBtn.parentElement || closeBtn;
      if (toast._progressInterval) {
        clearInterval(toast._progressInterval);
      }
      
      toast.style.animation = 'slideOutRight 0.3s ease-out';
      setTimeout(function() {
        if (toast.parentElement) {
          toast.parentElement.removeChild(toast);
        }
      }, 300);
    }

    
    function setMinDate() {
      const today = new Date();
      const dateString = today.getFullYear() + '-' + 
                        String(today.getMonth() + 1).padStart(2, '0') + '-' + 
                        String(today.getDate()).padStart(2, '0');
      document.getElementById('requestDate').setAttribute('min', dateString);
    }

    function loadWorkTypes() {
      const workTypeSelect = document.getElementById('workType');
      workTypeSelect.innerHTML = '<option value="">-- ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô... --</option>';
      workTypeSelect.disabled = true;
      
      google.script.run
        .withSuccessHandler(function(workTypes) {
          workTypeSelect.innerHTML = '';
          
          if (!workTypes || workTypes.length === 0) {
            workTypeSelect.innerHTML = '<option value="">-- ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô Survey --</option>';
          } else {
            workTypeSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô --</option>';
            
            workTypes.forEach(function(workType) {
              const option = document.createElement('option');
              option.value = workType.name;
              option.textContent = workType.name + ' (' + workType.duration + ' ‡∏ô‡∏≤‡∏ó‡∏µ)';
              option.setAttribute('data-duration', workType.duration);
              workTypeSelect.appendChild(option);
            });
            
            workTypeSelect.disabled = false;
          }
        })
        .withFailureHandler(function(error) {
          workTypeSelect.innerHTML = '<option value="">-- ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î --</option>';
        })
        .getWorkTypeList('Survey Work');
    }

    function loadUserEmailAndName() {
      const emailInput = document.getElementById('requesterEmail');
      const nameInput = document.getElementById('requesterName');
      const nameInfo = document.getElementById('nameInfo');
      
      emailInput.value = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...';
      emailInput.disabled = true;
      
      nameInput.value = '';
      nameInput.placeholder = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...';
      nameInput.readOnly = true;
      
      google.script.run
        .withSuccessHandler(function(email) {
          if (email) {
            emailInput.value = email;
            emailInput.disabled = true;
            
            google.script.run
              .withSuccessHandler(function(result) {
                if (result.success && result.name) {
                  nameInput.value = result.name;
                  nameInput.readOnly = false;
                  nameInput.style.background = '#ffffff';
                  nameInput.style.cursor = 'text';
                  nameInfo.innerHTML = '‚úÖ ‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö - ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ';
                  nameInfo.style.color = '#16a34a';
                } else {
                  nameInput.value = '';
                  nameInput.placeholder = '‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•';
                  nameInput.readOnly = false;
                  nameInput.style.background = '#ffffff';
                  nameInput.style.cursor = 'text';
                  nameInfo.innerHTML = 'üìù ‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏Ç‡∏≠ - ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
                  nameInfo.style.color = '#16a34a';
                }
              })
              .withFailureHandler(function(error) {
                nameInput.value = '';
                nameInput.placeholder = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î';
                nameInput.readOnly = false;
                nameInput.style.background = '#ffffff';
              })
              .getUserNameFromEmail(email);
          }
        })
        .withFailureHandler(function(error) {
          emailInput.value = '';
          emailInput.placeholder = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î';
        })
        .getCurrentUserEmail();
    }

    function checkUserRole() {
  console.log('üîç Checking user role...');
  
  google.script.run
    .withSuccessHandler(function(result) {
      console.log('üì• Role check result:', result);
      
      if (result.success && result.isSurveyRole) {

        document.getElementById('manualTeamSelectionGroup').style.display = 'block';
        // ‚úÖ ‡πÄ‡∏õ‡πá‡∏ô Survey Role
        isSurveyRole = true;
        surveyRoleInfo = result;
        
        console.log('‚úÖ Survey Role detected:', result.role);
        
        // ‡πÅ‡∏™‡∏î‡∏á Survey Role Indicator
        document.getElementById('surveyRoleIndicator').style.display = 'block';
        document.getElementById('surveyRoleText').textContent = 
          'üë®‚Äçüíº ' + result.role + ' Mode - ' + result.name;
        
        // ‡πÅ‡∏™‡∏î‡∏á Requester Selection
        document.getElementById('requesterSelectionGroup').style.display = 'block';
        
        // ‡∏ã‡πà‡∏≠‡∏ô Original Fields
        document.getElementById('requesterNameGroup').style.display = 'none';
        document.getElementById('requesterEmailGroup').style.display = 'none';
        
        // ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ Requester
        loadRequesterList();
        
        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Info Box
        updateInfoBoxForSurveyRole();
        
        // ‚≠ê‚≠ê‚≠ê Survey Role - ‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á Holiday Warning
        console.log('‚≠ê Survey Role - Holiday warning skipped');
        
      } else {
        // ‚ùå ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà Survey Role - ‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏î‡∏¥‡∏°
        isSurveyRole = false;
        loadUserEmailAndName();
        
        // ‚≠ê‚≠ê‚≠ê ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å checkTodayHolidayStatus ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Regular User
        setTimeout(function() {
          checkTodayHolidayStatusForRegularUser();
        }, 800);
      }
    })
    .withFailureHandler(function(error) {
      console.error('‚ùå Error checking role:', error);
      isSurveyRole = false;
      loadUserEmailAndName();
      
      // ‚≠ê‚≠ê‚≠ê ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å holiday check ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Regular User (‡∏Å‡∏£‡∏ì‡∏µ error)
      setTimeout(function() {
        checkTodayHolidayStatusForRegularUser();
      }, 800);
    })
    .validateSurveyRole();
}

function checkTodayHolidayStatusForRegularUser() {
  if (isSurveyRole) {
    console.log('‚≠ê Survey Role - Holiday warning skipped');
    return;
  }
  
  console.log('üîç Checking today holiday status (Regular User)...');
  
  google.script.run
    .withSuccessHandler(function(holidays) {
      if (!holidays || holidays.length === 0) {
        console.log('‚úÖ No holidays data');
        return;
      }
      
      var now = new Date();
      var today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      var currentHour = now.getHours();
      
      var tomorrow = new Date(today);
      tomorrow.setDate(tomorrow.getDate() + 1);
      var tomorrowStr = formatDateYYYYMMDD(tomorrow);
      
      var tomorrowHoliday = null;
      var consecutiveDays = 0;
      
      // ‡∏´‡∏≤‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ
      holidays.forEach(function(holiday) {
        if (holiday.date === tomorrowStr) {
          tomorrowHoliday = holiday;
        }
      });
      
      // ‡∏ô‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ô
      if (tomorrowHoliday) {
        var checkDate = new Date(tomorrow);
        
        while (true) {
          var checkDateStr = formatDateYYYYMMDD(checkDate);
          var isHoliday = holidays.some(function(h) {
            return h.date === checkDateStr;
          });
          
          if (isHoliday) {
            consecutiveDays++;
            checkDate.setDate(checkDate.getDate() + 1);
          } else {
            break;
          }
        }
      }
      
      var todayStr = formatDateYYYYMMDD(today);
      var todayHoliday = null;
      
      // ‡∏´‡∏≤‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
      holidays.forEach(function(holiday) {
        if (holiday.date === todayStr) {
          todayHoliday = holiday;
        }
      });
      
      // ========================================
      // ‚≠ê ‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà 1: ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î
      // ========================================
      if (todayHoliday) {
        var holidayMsg = 'üó∫Ô∏è Survey Work: ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏≠‡∏á‡πÑ‡∏î‡πâ‡∏ï‡∏•‡∏≠‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏ß‡∏±‡∏ô\n\n' +
                        'üí° ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏à‡∏ô‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏ñ‡∏±‡∏î‡πÑ‡∏õ';
        
        showToast(
          'üéâ ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î: ' + todayHoliday.name,
          holidayMsg,
          'warning',
          15000
        );
        
        console.log('‚ö†Ô∏è Today is holiday:', todayHoliday.name);
        return;
      }
      
      // ========================================
      // ‚≠ê ‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà 2: ‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î
      // ========================================
      if (tomorrowHoliday) {
        var warningMsg = '';
        var warningType = 'warning';
        var warningTitle = '‚ö†Ô∏è ‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î!';
        
        // üó∫Ô∏è Survey: ‡∏à‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡πÑ‡∏î‡πâ ‡πÅ‡∏ï‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏à‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô 13:00 ‡∏ô.
        if (currentHour < 13) {
          warningMsg = 'üìÖ ‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ: ' + tomorrowHoliday.name;
          
          if (consecutiveDays > 1) {
            warningMsg += ' (‡∏´‡∏¢‡∏∏‡∏î‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ô ' + consecutiveDays + ' ‡∏ß‡∏±‡∏ô)';
          }
          
          var hoursLeft = 13 - currentHour;
          var minutesLeft = 60 - now.getMinutes();
          
          if (minutesLeft === 60) {
            minutesLeft = 0;
            hoursLeft++;
          }
          
          warningMsg += '\n\n' +
                       'üó∫Ô∏è Survey Work:\n' +
                       '‚úÖ ‡∏¢‡∏±‡∏á‡∏à‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡πÑ‡∏î‡πâ! ‡πÅ‡∏ï‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏à‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô 13:00 ‡∏ô.\n' +
                       '‚è≥ ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏µ‡∏Å ' + hoursLeft + ' ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á ' + minutesLeft + ' ‡∏ô‡∏≤‡∏ó‡∏µ\n\n' +
                       'üìå ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:\n' +
                       '   ‚Ä¢ ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£ ‚úì\n' +
                       '   ‚Ä¢ ‡∏à‡∏≠‡∏á‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤ ‚â•1 ‡∏ß‡∏±‡∏ô ‚úì\n' +
                       '   ‚Ä¢ ‡∏à‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô 13:00 ‡∏ô. ‚úì';
          
          warningType = 'warning';
          warningTitle = '‚è∞ ‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î - ‡∏£‡∏µ‡∏ö‡∏à‡∏≠‡∏á!';
          
          console.log('‚ö†Ô∏è Tomorrow is holiday (can still book):', tomorrowHoliday.name);
          
        } else {
          // ‡πÄ‡∏•‡∏¢‡πÄ‡∏ß‡∏•‡∏≤ 13:00 ‡∏ô. ‡πÅ‡∏•‡πâ‡∏ß - ‡∏´‡πâ‡∏≤‡∏°‡∏à‡∏≠‡∏á
          warningMsg = 'üìÖ ‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ: ' + tomorrowHoliday.name;
          
          if (consecutiveDays > 1) {
            warningMsg += ' (‡∏´‡∏¢‡∏∏‡∏î‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ô ' + consecutiveDays + ' ‡∏ß‡∏±‡∏ô)';
          }
          
          warningMsg += '\n\n' +
                       '‚ùå ‡πÄ‡∏•‡∏¢‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß (‡∏ï‡πâ‡∏≠‡∏á‡∏à‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô 13:00 ‡∏ô.)\n\n' +
                       'üó∫Ô∏è Survey Work: ‡∏´‡πâ‡∏≤‡∏°‡∏à‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î\n' +
                       'üí° ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏à‡∏ô‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏ñ‡∏±‡∏î‡πÑ‡∏õ';
          
          warningType = 'error';
          warningTitle = '‚ùå ‡πÄ‡∏•‡∏¢‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡πÅ‡∏•‡πâ‡∏ß';
          
          console.log('‚ùå Tomorrow is holiday (cannot book):', tomorrowHoliday.name);
        }
        
        showToast(
          warningTitle,
          warningMsg,
          warningType,
          20000
        );
      }
      
    })
    .withFailureHandler(function(error) {
      console.error('‚ùå Error checking holiday status:', error);
    })
    .getHolidayList();
}

    function handleFileSelect(event) {
      const file = event.target.files[0];
      const fileInfo = document.getElementById('fileInfo');
      const fileName = document.getElementById('fileName');
      const fileSize = document.getElementById('fileSize');
      
      if (!file) {
        clearLocationFile();
        return;
      }
      
      const maxSize = 10 * 1024 * 1024;
      if (file.size > maxSize) {
        showToast('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏ü‡∏•‡πå‡∏°‡∏µ‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ (‡πÄ‡∏Å‡∏¥‡∏ô 10 MB)', 'error', 4000);
        event.target.value = '';
        clearLocationFile();
        return;
      }
      
      const allowedTypes = ['application/pdf', 'image/png', 'image/jpeg', 'image/gif', 'image/jpg'];
      if (!allowedTypes.includes(file.type)) {
        showToast('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞ PDF, PNG, JPG, GIF)', 'error', 4000);
        event.target.value = '';
        clearLocationFile();
        return;
      }
      
      fileName.textContent = file.name;
      fileSize.textContent = formatFileSize(file.size);
      fileInfo.style.display = 'block';
      
      const reader = new FileReader();
      reader.onload = function(e) {
        selectedFileData = {
          name: file.name,
          mimeType: file.type,
          content: e.target.result.split(',')[1]
        };
      };
      reader.onerror = function(error) {
        showToast('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå', 'error', 4000);
        clearLocationFile();
      };
      reader.readAsDataURL(file);
    }

    function clearLocationFile() {
      document.getElementById('locationLayoutFile').value = '';
      document.getElementById('fileInfo').style.display = 'none';
      document.getElementById('fileName').textContent = '';
      document.getElementById('fileSize').textContent = '';
      selectedFileData = null;
    }

        function updateAvailableSlots() {
      const date = document.getElementById('requestDate').value;
      const startTimeSelect = document.getElementById('startTime');
      const endTimeSelect = document.getElementById('endTime');
      
      if (!date) {
        startTimeSelect.innerHTML = '<option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡πà‡∏≠‡∏ô --</option>';
        startTimeSelect.disabled = true;
        return;
      }
      
      startTimeSelect.innerHTML = '<option value="">-- ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ß‡∏•‡∏≤... --</option>';
      startTimeSelect.className += ' loading-select';
      startTimeSelect.disabled = true;
      endTimeSelect.innerHTML = '<option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡πà‡∏≠‡∏ô --</option>';
      endTimeSelect.disabled = true;
      
      if (isSurveyRole) {
        startTimeSelect.className = startTimeSelect.className.replace(' loading-select', '');
        startTimeSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô --</option>';
        
        const allSlots = [];
        for (let hour = 9; hour <= 19; hour++) {
          for (let minute = 0; minute < 60; minute += 30) {
            if (hour === 19 && minute === 30) break;
            const time = hour.toString().padStart(2, '0') + ':' + minute.toString().padStart(2, '0');
            allSlots.push(time);
          }
        }
        
        allSlots.forEach(function(slot) {
          const option = document.createElement('option');
          option.value = slot;
          option.textContent = slot + ' ‡∏ô.';
          startTimeSelect.appendChild(option);
        });
        
        startTimeSelect.disabled = false;
      } else {
        google.script.run
          .withSuccessHandler(function(availableSlots) {
            startTimeSelect.className = startTimeSelect.className.replace(' loading-select', '');
            startTimeSelect.innerHTML = '';
            
            if (!availableSlots || availableSlots.length === 0) {
              startTimeSelect.innerHTML = '<option value="">-- ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏ß‡∏•‡∏≤‡∏ß‡πà‡∏≤‡∏á --</option>';
              startTimeSelect.disabled = true;
            } else {
              startTimeSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô --</option>';
              
              availableSlots.forEach(function(slot) {
                const option = document.createElement('option');
                option.value = slot;
                option.textContent = slot + ' ‡∏ô.';
                startTimeSelect.appendChild(option);
              });
              
              startTimeSelect.disabled = false;
            }
          })
          .withFailureHandler(function(error) {
            startTimeSelect.className = startTimeSelect.className.replace(' loading-select', '');
            startTimeSelect.innerHTML = '<option value="">-- ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î --</option>';
            startTimeSelect.disabled = true;
          })
          .getSurveyAvailableTimeSlots(date);
      }
    }

    function updateEndTimeSlots() {
      const date = document.getElementById('requestDate').value;
      const startTime = document.getElementById('startTime').value;
      const endTimeSelect = document.getElementById('endTime');
      const workTypeSelect = document.getElementById('workType');
      
      if (!startTime) {
        endTimeSelect.innerHTML = '<option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡πà‡∏≠‡∏ô --</option>';
        endTimeSelect.disabled = true;
        return;
      }
      
      endTimeSelect.innerHTML = '<option value="">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</option>';
      endTimeSelect.className += ' loading-select';
      endTimeSelect.disabled = true;
      
      const selectedOption = workTypeSelect.options[workTypeSelect.selectedIndex];
      const duration = parseInt(selectedOption.getAttribute('data-duration')) || 60;
      const workType = workTypeSelect.value;
      
      google.script.run
        .withSuccessHandler(function(availableEndTimes) {
          endTimeSelect.className = endTimeSelect.className.replace(' loading-select', '');
          endTimeSelect.innerHTML = '';
          
          if (!availableEndTimes || availableEndTimes.length === 0) {
            endTimeSelect.innerHTML = '<option value="">-- ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î --</option>';
            endTimeSelect.disabled = true;
          } else {
            endTimeSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î --</option>';
            
            const startParts = startTime.split(':');
            const startHour = parseInt(startParts[0]);
            const startMinute = parseInt(startParts[1]);
            const totalMinutes = (startHour * 60) + startMinute + duration;
            const endHour = Math.floor(totalMinutes / 60);
            const endMin = totalMinutes % 60;
            const defaultEndTime = endHour.toString().padStart(2, '0') + ':' + 
                                  endMin.toString().padStart(2, '0');
            
            availableEndTimes.forEach(function(time) {
              const option = document.createElement('option');
              option.value = time;
              option.textContent = time + ' ‡∏ô.';
              if (time === defaultEndTime) {
                option.selected = true;
              }
              endTimeSelect.appendChild(option);
            });
            
            endTimeSelect.disabled = false;
          }
        })
        .withFailureHandler(function(error) {
          endTimeSelect.className = endTimeSelect.className.replace(' loading-select', '');
          endTimeSelect.innerHTML = '<option value="">-- ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î --</option>';
          endTimeSelect.disabled = true;
        })
        .getSurveyAvailableEndTimes(date, startTime, workType);
    }

        function resetTimeSelections() {
      const startTimeSelect = document.getElementById('startTime');
      const endTimeSelect = document.getElementById('endTime');
      const requestDate = document.getElementById('requestDate').value;
      
      startTimeSelect.value = '';
      endTimeSelect.value = '';
      
      if (requestDate) {
        updateAvailableSlots();
      }
    }

        function handleSubmit(event) {
      event.preventDefault();
      
      const submitBtn = document.getElementById('submitBtn');
      const loading = document.querySelector('.loading');
      
      const formData = {
        requestDate: document.getElementById('requestDate').value,
        workType: document.getElementById('workType').value,
        startTime: document.getElementById('startTime').value,
        endTime: document.getElementById('endTime').value,
        assignedInspector: document.getElementById('assignedInspector').value, // [‡πÄ‡∏û‡∏¥‡πà‡∏°] ‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏≠‡∏á
        description: document.getElementById('description').value.trim(),
        location: document.getElementById('location').value.trim(),
        requesterName: document.getElementById('requesterName').value.trim(),
        requesterEmail: document.getElementById('requesterEmail').value.trim(),
        locationLayoutFile: selectedFileData
      };
      
      // Survey Role - ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ó‡∏µ‡∏°‡∏Å‡πà‡∏≠‡∏ô
      if (isSurveyRole) {
        submitBtn.disabled = true;
        showToast('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö', '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏ó‡∏µ‡∏°‡∏ß‡πà‡∏≤‡∏á...', 'info', 3000);
        
        google.script.run
          .withSuccessHandler(function(availabilityResult) {
            submitBtn.disabled = false;
            
            if (!availabilityResult.available) {
              var confirmMsg = 
                '‚ö†Ô∏è ‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: ‡∏ó‡∏µ‡∏°‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á\n\n' +
                availabilityResult.message + '\n\n' +
                '‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ï‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?';
              
              if (!confirm(confirmMsg)) {
                showToast('‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å', '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠', 'info', 3000);
                return;
              }
            }
            
            proceedWithSubmit(formData, submitBtn, loading);
          })
          .withFailureHandler(function(error) {
            submitBtn.disabled = false;
            showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏µ‡∏°‡πÑ‡∏î‡πâ', 'error', 5000);
          })
          .checkSurveyTeamAvailability(formData.requestDate, formData.startTime, formData.endTime);
        
        return;
      }
      
      // Regular User - Confirm
      const confirmMessage = 
        '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n' +
        'üìã ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á Survey Work Request\n' +
        '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n' +
        'üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ' + formData.requestDate + '\n' +
        'üîß ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô: ' + formData.workType + '\n' +
        '‚è∞ ‡πÄ‡∏ß‡∏•‡∏≤: ' + formData.startTime + ' - ' + formData.endTime + ' ‡∏ô.\n' +
        'üìç ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà: ' + formData.location + '\n' +
        'üë§ ‡∏ú‡∏π‡πâ‡∏Ç‡∏≠: ' + formData.requesterName + '\n' +
        'üìß ‡∏≠‡∏µ‡πÄ‡∏°‡∏•: ' + formData.requesterEmail + '\n' +
        (selectedFileData ? 'üìé ‡πÑ‡∏ü‡∏•‡πå: ' + selectedFileData.name + '\n' : '') +
        '\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n' +
        '‚úÖ ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?';
      
      if (!confirm(confirmMessage)) {
        showToast('‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å', '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠', 'info', 2000);
        return;
      }
      
      proceedWithSubmit(formData, submitBtn, loading);
    }

    window.onload = function() {
      setMinDate();
      loadWorkTypes();
      checkUserRole();
      loadManualLink();
      setupFormChangeDetection();
      setupHolidayCheck();
      
      // ‚≠ê ‡πÉ‡∏ä‡πâ Toast ‡πÅ‡∏ó‡∏ô showMessage
      setTimeout(function() {
        showToast(
          '‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö', 
          '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á Survey Work', 
          'info', 
          5000
        );
      }, 1000);
      
      // Event Listeners
      document.getElementById('requestDate').addEventListener('change', function() {
        updateAvailableSlots();
        // [‡πÄ‡∏û‡∏¥‡πà‡∏°] ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ó‡∏µ‡∏°‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ß‡∏±‡∏ô
        if (isSurveyRole) {
           document.getElementById('assignedInspectorContainer').innerHTML = '<div class="inspector-loading">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡πà‡∏≠‡∏ô</div>';
           document.getElementById('assignedInspector').value = '';
        }
      });
      document.getElementById('startTime').addEventListener('change', function() {
        updateEndTimeSlots();
        if (isSurveyRole) loadAvailableSurveyTeams(); // [‡πÄ‡∏û‡∏¥‡πà‡∏°] ‡πÇ‡∏´‡∏•‡∏î‡∏ó‡∏µ‡∏°‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°
      });
      document.getElementById('workType').addEventListener('change', resetTimeSelections);
      document.getElementById('surveyWorkForm').addEventListener('submit', handleSubmit);
      
      document.getElementById('requesterSelection').addEventListener('change', function() {
        const selectedValue = this.value;
        
        if (selectedValue) {
          const parts = selectedValue.split('|');
          const email = parts[0];
          const name = parts[1];
          
          document.getElementById('requesterEmail').value = email;
          document.getElementById('requesterName').value = name;
          
          console.log('‚úÖ Selected requester:', name, '-', email);
        }
      });
    };

    // ‚≠ê Step Navigation
    function goToStep(step) {
      // ‡∏ñ‡πâ‡∏≤‡∏à‡∏∞‡πÑ‡∏õ‡∏Ç‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤ ‡∏ï‡πâ‡∏≠‡∏á validate ‡∏Å‡πà‡∏≠‡∏ô
      if (step > currentStep) {
        for (let i = currentStep; i < step; i++) {
          if (!validateStep(i)) {
            showToast('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà ' + i + ' ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', 'warning', 4000);
            return;
          }
        }
      }

      // ‡∏ã‡πà‡∏≠‡∏ô‡∏ó‡∏∏‡∏Å step
      document.querySelectorAll('.step-container').forEach(function(container) {
        container.classList.remove('active');
      });

      // ‡πÅ‡∏™‡∏î‡∏á step ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
      document.getElementById('step' + step).classList.add('active');

      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï progress indicator
      updateProgressIndicator(step);

      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï summary ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô step 5
      if (step === 5) {
        updateSummary();
      }

      currentStep = step;
    }

    function nextStep() {
      if (validateStep(currentStep)) {
        goToStep(currentStep + 1);
      } else {
        showToast('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠', 'warning', 4000);
      }
    }

    function prevStep() {
      if (currentStep > 1) {
        goToStep(currentStep - 1);
      }
    }

    function validateStep(step) {
      switch(step) {
        case 1:
          const date = document.getElementById('requestDate').value;
          const workType = document.getElementById('workType').value;
          const startTime = document.getElementById('startTime').value;
          const endTime = document.getElementById('endTime').value;
          return date && workType && startTime && endTime;
        
        case 2:
          const description = document.getElementById('description').value.trim();
          const location = document.getElementById('location').value.trim();
          return description && location;
        
        case 3:
          const name = document.getElementById('requesterName').value.trim();
          const email = document.getElementById('requesterEmail').value.trim();
          return name && email;
        
        case 4:
          return true; // ‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö
        
        default:
          return true;
      }
    }

    function updateProgressIndicator(step) {
      const steps = document.querySelectorAll('.progress-step');
      const progressLine = document.getElementById('progressLineFill');
      
      steps.forEach(function(stepElement, index) {
        const stepNumber = index + 1;
        
        if (stepNumber < step) {
          stepElement.classList.add('completed');
          stepElement.classList.remove('active');
        } else if (stepNumber === step) {
          stepElement.classList.add('active');
          stepElement.classList.remove('completed');
        } else {
          stepElement.classList.remove('active', 'completed');
        }
      });

      const progress = ((step - 1) / (totalSteps - 1)) * 100;
      progressLine.style.width = progress + '%';
    }

// [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏£‡∏∏‡∏õ ‡πÉ‡∏´‡πâ‡πÇ‡∏ä‡∏ß‡πå‡∏ó‡∏µ‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏î‡πâ‡∏ß‡∏¢
    function updateSummary() {
      // Date & Time
      document.getElementById('summaryDate').textContent = document.getElementById('requestDate').value || '-';
      
      // Work Type (‡πÅ‡∏Å‡πâ‡πÉ‡∏´‡πâ‡∏î‡∏∂‡∏á Text ‡∏à‡∏≤‡∏Å Dropdown)
      var workTypeSelect = document.getElementById('workType');
      var workTypeText = workTypeSelect.options[workTypeSelect.selectedIndex] ? workTypeSelect.options[workTypeSelect.selectedIndex].text : '-';
      document.getElementById('summaryWorkType').textContent = workTypeText;
      
      const startTime = document.getElementById('startTime').value;
      const endTime = document.getElementById('endTime').value;
      document.getElementById('summaryTime').textContent = (startTime && endTime) ? startTime + ' - ' + endTime + ' ‡∏ô.' : '-';

      // [‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ] ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Survey Role)
      var teamValue = '-';
      if (isSurveyRole) {
         var selectedTeams = document.getElementById('assignedInspector').value;
         if (selectedTeams) {
            teamValue = selectedTeams.replace(/,/g, ', '); // ‡∏à‡∏±‡∏î format ‡πÉ‡∏´‡πâ‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°
         } else {
            teamValue = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡∏° (‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)';
         }
      } else {
         teamValue = '‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏ó‡∏µ‡∏°‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (Auto-Assign)';
      }
      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡∏á‡πÉ‡∏ô HTML ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°
      var summaryTeamEl = document.getElementById('summarySelectedTeam');
      if (summaryTeamEl) summaryTeamEl.textContent = teamValue;

      // Work Details
      document.getElementById('summaryDescription').textContent = document.getElementById('description').value.trim() || '-';
      document.getElementById('summaryLocation').textContent = document.getElementById('location').value.trim() || '-';
      
      // Requester Info
      document.getElementById('summaryRequesterName').textContent = document.getElementById('requesterName').value.trim() || '-';
      document.getElementById('summaryRequesterEmail').textContent = document.getElementById('requesterEmail').value.trim() || '-';
      
      // File
      if (selectedFileData) {
        document.getElementById('summaryFile').textContent = selectedFileData.name;
      } else {
        document.getElementById('summaryFile').textContent = '‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö';
      }
    }

    // ‚≠ê Form Change Detection
    function setupFormChangeDetection() {
      var form = document.getElementById('surveyWorkForm');
      var inputs = form.querySelectorAll('input, select, textarea');
      
      inputs.forEach(function(input) {
        if (input.readOnly || input.disabled) return;
        
        input.addEventListener('change', function() {
          formChanged = true;
        });
        
        input.addEventListener('input', function() {
          formChanged = true;
        });
      });
      
      var fileInput = document.getElementById('locationLayoutFile');
      if (fileInput) {
        fileInput.addEventListener('change', function() {
          if (this.files && this.files.length > 0) {
            formChanged = true;
          }
        });
      }
    }

    window.addEventListener('beforeunload', function(e) {
      if (isSubmitting || !formChanged) {
        return undefined;
      }
      
      var confirmationMessage = '‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?';
      e.preventDefault();
      e.returnValue = confirmationMessage;
      return confirmationMessage;
    });

    function resetFormChangeFlag() {
      formChanged = false;
      isSubmitting = false;
    }

    function setSubmittingFlag() {
      isSubmitting = true;
    }

    // ‚≠ê File Handling
    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return Math.round((bytes / Math.pow(k, i)) * 100) / 100 + ' ' + sizes[i];
    }

    function loadRequesterList() {
      const selectElement = document.getElementById('requesterSelection');
      selectElement.innerHTML = '<option value="">-- ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠... --</option>';
      selectElement.disabled = true;
      
      google.script.run
        .withSuccessHandler(function(requesters) {
          selectElement.innerHTML = '';
          
          if (!requesters || requesters.length === 0) {
            selectElement.innerHTML = '<option value="">-- ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏Ç‡∏≠ --</option>';
            showToast('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏Ç‡∏≠‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö', 'warning', 4000);
            return;
          }
          
          const selfOption = document.createElement('option');
          selfOption.value = surveyRoleInfo.email + '|' + surveyRoleInfo.name;
          selfOption.textContent = 'üë§ ' + surveyRoleInfo.name + ' (‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á)';
          selectElement.appendChild(selfOption);
          
          const divider = document.createElement('option');
          divider.disabled = true;
          divider.textContent = '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ';
          selectElement.appendChild(divider);
          
          requesters.forEach(function(requester) {
            const option = document.createElement('option');
            option.value = requester.email + '|' + requester.name;
            option.textContent = requester.displayText;
            selectElement.appendChild(option);
          });
          
          selectElement.disabled = false;
          selectElement.value = surveyRoleInfo.email + '|' + surveyRoleInfo.name;
          document.getElementById('requesterEmail').value = surveyRoleInfo.email;
          document.getElementById('requesterName').value = surveyRoleInfo.name;
        })
        .withFailureHandler(function(error) {
          selectElement.innerHTML = '<option value="">-- ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î --</option>';
          showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏Ç‡∏≠‡πÑ‡∏î‡πâ', 'error', 4000);
        })
        .getAllRequesters();
    }

    function updateInfoBoxForSurveyRole() {
      const infoBox = document.querySelector('.info-box');
      if (infoBox) {
        infoBox.innerHTML = 
          '<strong>üë®‚Äçüíº Survey Role Mode:</strong> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏î‡πâ‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏ß‡∏á ‚≠ê<br>' +
          '<strong>‚ö†Ô∏è ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</strong> ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏ó‡∏µ‡∏°‡∏ß‡πà‡∏≤‡∏á‡∏ï‡∏≠‡∏ô Submit<br>' +
          '<strong>üìÖ ‡∏à‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î:</strong> ‡πÑ‡∏î‡πâ ‚úÖ<br>' +
          '<strong>‚è∞ ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏Å‡∏≤‡∏£:</strong> 09:00 - 20:00 ‡∏ô.<br>' +
          '<strong>üë• ‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô:</strong> ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏ó‡∏µ‡∏°‡∏ß‡πà‡∏≤‡∏á (‡πÄ‡∏ä‡πá‡∏Ñ‡∏ï‡∏≠‡∏ô Submit)';
        infoBox.style.background = 'linear-gradient(135deg, #fef3c7 0%, #fde68a 100%)';
        infoBox.style.borderColor = '#f59e0b';
      }
    }

    // ‚≠ê Load Functions (‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏à‡∏≤‡∏Å original - ‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)
    function loadManualLink() {
      google.script.run
        .withSuccessHandler(function(url) {
          if (url && url.trim() !== '') {
            var manualBtn = document.getElementById('manualLinkBtn');
            var fullUrl = url + '?page=survey_manual';
            
            if (fullUrl.startsWith('http://') || fullUrl.startsWith('https://')) {
              manualBtn.href = fullUrl;
              manualBtn.style.display = 'flex';
            }
          }
        })
        .withFailureHandler(function(error) {
          console.error('Error loading manual link:', error);
        })
        .getManualUrl();
    }






    function setupHolidayCheck() {
      var dateInput = document.getElementById('requestDate');
      
      dateInput.addEventListener('change', function() {
        var selectedDate = this.value;
        
        if (selectedDate && !isSurveyRole) {
          checkHolidayRestrictions(selectedDate, 'survey');
        }
      });
    }

    /**
 * ‚≠ê ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Regular User ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô (‡∏ï‡∏≠‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö)
 */


    function checkTodayHolidayStatus() {
      if (isSurveyRole) {
        return;
      }
      
      google.script.run
        .withSuccessHandler(function(holidays) {
          if (!holidays || holidays.length === 0) return;
          
          // Implementation same as original
          // ... (‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÇ‡∏Ñ‡πâ‡∏î‡∏à‡∏≤‡∏Å original)
        })
        .withFailureHandler(function(error) {
          console.error('Error checking holiday status:', error);
        })
        .getHolidayList();
    }

    function formatDateYYYYMMDD(date) {
      var year = date.getFullYear();
      var month = String(date.getMonth() + 1).padStart(2, '0');
      var day = String(date.getDate()).padStart(2, '0');
      return year + '-' + month + '-' + day;
    }

    function checkHolidayRestrictions(dateStr, inspectionType) {
      if (!dateStr) return;
      
      showToast('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö', '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î...', 'info', 2000);
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (!result.allowed) {
            showToast(
              result.title || '‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ',
              result.message,
              'error',
              12000
            );
            
            document.getElementById('requestDate').value = '';
            document.getElementById('startTime').innerHTML = '<option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡πà‡∏≠‡∏ô --</option>';
            document.getElementById('startTime').disabled = true;
            document.getElementById('endTime').innerHTML = '<option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡πà‡∏≠‡∏ô --</option>';
            document.getElementById('endTime').disabled = true;
          } else if (result.warning) {
            showToast(
              result.title || '‚ö†Ô∏è ‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô',
              result.message,
              'warning',
              10000
            );
          }
        })
        .withFailureHandler(function(error) {
          showToast(
            '‚ö†Ô∏è ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
            '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡πÑ‡∏î‡πâ: ' + error.message,
            'error',
            5000
          );
        })
        .checkDateBookingAllowed(dateStr, 'survey');
    }

    // ‚≠ê Form Submit


    function proceedWithSubmit(formData, submitBtn, loading) {
      setSubmittingFlag();
      submitBtn.disabled = true;
      loading.style.display = 'block';
      
      showToast('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•', '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Survey Work Request...', 'info', 3000);
      
      google.script.run
        .withSuccessHandler(function(result) {
          loading.style.display = 'none';
          submitBtn.disabled = false;
          
          if (result && result.success) {
            let successMsg = result.message || '‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Survey Work Request ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß';
            let toastMsg = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢';

            if (result.recordedBy) {
              toastMsg += '\nüìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÇ‡∏î‡∏¢: ' + result.recordedBy;
            }
            
            if (result.fileName) {
              toastMsg += ' ‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
            }
            
            showToast('‚úÖ ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', toastMsg, 'success', 8000);
            resetFormChangeFlag();
            resetForm();
          } else {
            isSubmitting = false;
            const errorMessage = result && result.message ? result.message : '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏';
            showToast('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', errorMessage, 'error', 8000);
          }
        })
        .withFailureHandler(function(error) {
          loading.style.display = 'none';
          submitBtn.disabled = false;
          isSubmitting = false;
          
          const errorMessage = error.message || error.toString();
          showToast('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ: ' + errorMessage, 'error', 8000);
        })
        .saveSurveyWorkRequirement(formData);
    }

// [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏£‡∏ß‡∏°‡∏ñ‡∏∂‡∏á‡∏ä‡πà‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡∏°)
    function resetForm() {
      document.getElementById('surveyWorkForm').reset();
      clearLocationFile();
      goToStep(1);
      loadWorkTypes();
      loadUserEmailAndName();
      setMinDate();
      resetFormChangeFlag();
      
      document.getElementById('startTime').innerHTML = '<option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡πà‡∏≠‡∏ô --</option>';
      document.getElementById('startTime').disabled = true;
      document.getElementById('endTime').innerHTML = '<option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡πà‡∏≠‡∏ô --</option>';
      document.getElementById('endTime').disabled = true;

      // [‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà] ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
      if (document.getElementById('assignedInspector')) {
        document.getElementById('assignedInspector').value = '';
      }
      
      // [‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà] ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡∏°‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
      var teamContainer = document.getElementById('assignedInspectorContainer');
      if (teamContainer) {
        teamContainer.innerHTML = '<div class="inspector-loading" style="color: #047857; text-align: center; font-style: italic;">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡πà‡∏≠‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏ó‡∏µ‡∏°‡∏ß‡πà‡∏≤‡∏á</div>';
      }
      
      console.log('‚úÖ Form reset complete');
    }

// [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏ó‡∏µ‡∏° Survey ‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á (‡∏õ‡∏£‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏≤‡πÉ‡∏´‡πâ‡∏™‡∏ß‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô)
function loadAvailableSurveyTeams() {
  if (!isSurveyRole) return;

  var date = document.getElementById('requestDate').value;
  var startTime = document.getElementById('startTime').value;
  var endTime = document.getElementById('endTime').value;
  var container = document.getElementById('assignedInspectorContainer');
  
  if (!container) return;

  if (!date || !startTime) {
    container.innerHTML = '<div class="inspector-loading">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö</div>';
    return;
  }
  
  // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ
  var checkEndTime = endTime;
  if (!checkEndTime) {
     var parts = startTime.split(':');
     var hour = parseInt(parts[0]) + 1;
     checkEndTime = hour.toString().padStart(2, '0') + ':' + parts[1];
  }

  container.innerHTML = '<div class="inspector-loading">üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏ó‡∏µ‡∏° Survey ‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á...</div>';

  google.script.run
    .withSuccessHandler(function(resources) {
      var availableTeams = resources || [];
      var surveyTeams = availableTeams.filter(function(t) {
        return t.subType.toLowerCase() === 'survey';
      });

      if (surveyTeams.length === 0) {
        container.innerHTML = '<div class="inspector-loading" style="color: #dc2626;">‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ó‡∏µ‡∏° Survey ‡∏ß‡πà‡∏≤‡∏á‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏µ‡πâ</div>';
        return;
      }
      
      // ‡∏õ‡∏£‡∏±‡∏ö CSS ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡∏™‡∏ß‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô
      var html = '<div style="display: flex; flex-direction: column; gap: 8px;">';
      for (var i = 0; i < surveyTeams.length; i++) {
        var team = surveyTeams[i];
        html += '<label style="display: flex; align-items: center; gap: 12px; padding: 12px; background: white; border: 1px solid #e5e7eb; border-radius: 8px; cursor: pointer; transition: all 0.2s;">';
        html += '<input type="checkbox" class="survey-team-cb" id="team_' + team.id + '" value="' + team.name + '" onchange="updateSelectedSurveyTeams()" style="width: 18px; height: 18px; accent-color: #10b981; cursor: pointer;">';
        html += '<span style="flex: 1; font-size: 14px; color: #374151; font-weight: 500;">' + team.name + '</span>';
        html += '</label>';
      }
      html += '</div>';
      container.innerHTML = html;
    })
    .withFailureHandler(function(error) {
      container.innerHTML = '<div class="inspector-loading">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏ó‡∏µ‡∏°</div>';
    })
    .getAvailableResourcesList(date, startTime, checkEndTime, null);
}

// [‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà] ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡πà‡∏≤‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ï‡∏¥‡πä‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡∏°
function updateSelectedSurveyTeams() {
  var checkboxes = document.querySelectorAll('.survey-team-cb:checked');
  var selectedTeams = [];
  for (var i = 0; i < checkboxes.length; i++) {
    selectedTeams.push(checkboxes[i].value);
  }
  document.getElementById('assignedInspector').value = selectedTeams.join(',');
}
  </script>
</body>
</html>

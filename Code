//Version 14 20/10/2025 10:30

function doGet(e) {
  const page = e.parameter.page;
  
  if (page === 'qc') {
    return HtmlService.createHtmlOutputFromFile('qc')
      .setTitle('QC RFI System')
      .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
  } else if (page === 'qc_edit') {
    return HtmlService.createHtmlOutputFromFile('qc_edit')
      .setTitle('QC - ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç RFI')
      .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
  } else if (page === 'qc_postpone') {
    return HtmlService.createHtmlOutputFromFile('qc_postpone')
      .setTitle('QC - ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ï‡∏£‡∏ß‡∏à RFI')
      .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
  } else if (page === 'survey') {
    // ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Survey Work
    return HtmlService.createHtmlOutputFromFile('survey')
      .setTitle('Survey Work Requirement System')
      .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
      }else if (page === 'manual') {
  return HtmlService.createHtmlOutputFromFile('manual')
    .setTitle('‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô RFI System');
    }else if (page === 'survey_manual') {
  return HtmlService.createHtmlOutputFromFile('survey_manual')
    .setTitle('‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô RFI System');
        }else if (page === 'Codition') {
  return HtmlService.createHtmlOutputFromFile('Codition')
    .setTitle('‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á RFI System');

  } else {
    return HtmlService.createHtmlOutputFromFile('index')
      .setTitle('RFI Requirement System')
      .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
  }
}




// ===== Global Variables for Load Balancing =====
/**
 * ‚≠ê Cache ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö workload ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡πÉ‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥
 * ‡πÉ‡∏ä‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Sheet (‡πÄ‡∏ä‡πà‡∏ô ‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö)
 */
var WORKLOAD_CACHE = {};

/**
 * ‚≠ê Cache ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö last selected team (Round Robin)
 */
var LAST_SELECTED_TEAM = {};

/**
 * ‚≠ê Reset cache (‡πÉ‡∏ä‡πâ‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏î‡∏™‡∏≠‡∏ö)
 */
function resetWorkloadCache() {
  WORKLOAD_CACHE = {};
  LAST_SELECTED_TEAM = {};
  console.log('‚úÖ Workload cache reset');
}

/**
 * ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏° workload ‡πÉ‡∏ô cache
 */
function incrementWorkloadCache(resourceId, date) {
  const key = resourceId + '_' + date;
  if (!WORKLOAD_CACHE[key]) {
    WORKLOAD_CACHE[key] = 0;
  }
  WORKLOAD_CACHE[key]++;
  console.log('üìä Cache updated:', resourceId, 'on', date, '‚Üí', WORKLOAD_CACHE[key], 'tasks');
}

/**
 * ‚≠ê ‡∏î‡∏∂‡∏á workload ‡∏à‡∏≤‡∏Å cache
 */
function getWorkloadFromCache(resourceId, date) {
  const key = resourceId + '_' + date;
  return WORKLOAD_CACHE[key] || 0;
}



/**
 * ‚≠ê ‡∏™‡∏£‡πâ‡∏≤‡∏á Report ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏° Column AN
 */
function createColumnANReport() {
  try {
    console.log('========== Creating Column AN Report ==========');
    
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('RFI_List');
    
    if (!sheet) {
      SpreadsheetApp.getUi().alert('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö RFI_List sheet');
      return;
    }
    
    const lastRow = sheet.getLastRow();
    if (lastRow <= 1) {
      SpreadsheetApp.getUi().alert('‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
      return;
    }
    
    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: Column A (ID), O (Status), AN (Type)
    const idData = sheet.getRange(2, 1, lastRow - 1, 1).getValues();
    const statusData = sheet.getRange(2, 15, lastRow - 1, 1).getValues();
    const typeData = sheet.getRange(2, 40, lastRow - 1, 1).getValues();
    
    // ‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    let rfiWorkCount = 0;
    let surveyWorkCount = 0;
    let emptyCount = 0;
    
    const rfiStatusCount = {};
    const surveyStatusCount = {};
    
    for (let i = 0; i < idData.length; i++) {
      const status = String(statusData[i][0] || '').trim();
      const type = String(typeData[i][0] || '').trim();
      
      if (type === 'RFI Work') {
        rfiWorkCount++;
        rfiStatusCount[status] = (rfiStatusCount[status] || 0) + 1;
      } else if (type === 'Survey Work') {
        surveyWorkCount++;
        surveyStatusCount[status] = (surveyStatusCount[status] || 0) + 1;
      } else {
        emptyCount++;
      }
    }
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á Report Sheet
    let reportSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Column_AN_Report');
    
    if (reportSheet) {
      SpreadsheetApp.getActiveSpreadsheet().deleteSheet(reportSheet);
    }
    
    reportSheet = SpreadsheetApp.getActiveSpreadsheet().insertSheet('Column_AN_Report');
    
    // Header
    reportSheet.getRange(1, 1).setValue('üìä Column AN Report');
    reportSheet.getRange(1, 1).setFontSize(16).setFontWeight('bold');
    
    reportSheet.getRange(2, 1).setValue('Generated: ' + new Date().toLocaleString('th-TH'));
    reportSheet.getRange(2, 1).setFontSize(10).setFontColor('#666666');
    
    // Summary
    let row = 4;
    reportSheet.getRange(row, 1).setValue('üìã Summary').setFontWeight('bold').setFontSize(14);
    row++;
    
    reportSheet.getRange(row, 1).setValue('Total Records:');
    reportSheet.getRange(row, 2).setValue(lastRow - 1);
    row++;
    
    reportSheet.getRange(row, 1).setValue('üìã RFI Work:');
    reportSheet.getRange(row, 2).setValue(rfiWorkCount);
    reportSheet.getRange(row, 1, 1, 2).setBackground('#dbeafe');
    row++;
    
    reportSheet.getRange(row, 1).setValue('üó∫Ô∏è Survey Work:');
    reportSheet.getRange(row, 2).setValue(surveyWorkCount);
    reportSheet.getRange(row, 1, 1, 2).setBackground('#d1fae5');
    row++;
    
    if (emptyCount > 0) {
      reportSheet.getRange(row, 1).setValue('‚ö†Ô∏è Empty/Other:');
      reportSheet.getRange(row, 2).setValue(emptyCount);
      reportSheet.getRange(row, 1, 1, 2).setBackground('#fef3c7');
      row++;
    }
    
    // RFI Work by Status
    row += 2;
    reportSheet.getRange(row, 1).setValue('üìã RFI Work by Status').setFontWeight('bold').setFontSize(14);
    row++;
    
    reportSheet.getRange(row, 1).setValue('Status');
    reportSheet.getRange(row, 2).setValue('Count');
    reportSheet.getRange(row, 1, 1, 2).setFontWeight('bold').setBackground('#1877f2').setFontColor('white');
    row++;
    
    Object.keys(rfiStatusCount).sort().forEach(function(status) {
      reportSheet.getRange(row, 1).setValue(status);
      reportSheet.getRange(row, 2).setValue(rfiStatusCount[status]);
      row++;
    });
    
    // Survey Work by Status
    row += 2;
    reportSheet.getRange(row, 1).setValue('üó∫Ô∏è Survey Work by Status').setFontWeight('bold').setFontSize(14);
    row++;
    
    reportSheet.getRange(row, 1).setValue('Status');
    reportSheet.getRange(row, 2).setValue('Count');
    reportSheet.getRange(row, 1, 1, 2).setFontWeight('bold').setBackground('#16a34a').setFontColor('white');
    row++;
    
    Object.keys(surveyStatusCount).sort().forEach(function(status) {
      reportSheet.getRange(row, 1).setValue(status);
      reportSheet.getRange(row, 2).setValue(surveyStatusCount[status]);
      row++;
    });
    
    // Format columns
    reportSheet.setColumnWidth(1, 250);
    reportSheet.setColumnWidth(2, 100);
    
    // Auto-fit
    reportSheet.autoResizeColumn(1);
    reportSheet.autoResizeColumn(2);
    
    console.log('‚úÖ Report created successfully');
    
    SpreadsheetApp.getUi().alert(
      '‡∏™‡∏£‡πâ‡∏≤‡∏á Report ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‚úÖ',
      '‡∏™‡∏£‡πâ‡∏≤‡∏á Sheet "Column_AN_Report" ‡πÅ‡∏•‡πâ‡∏ß\n\n' +
      '‡∏™‡∏£‡∏∏‡∏õ:\n' +
      'üìã RFI Work: ' + rfiWorkCount + ' records\n' +
      'üó∫Ô∏è Survey Work: ' + surveyWorkCount + ' records\n' +
      (emptyCount > 0 ? '‚ö†Ô∏è Empty: ' + emptyCount + ' records\n' : '') +
      '\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÑ‡∏õ‡∏î‡∏π‡∏ó‡∏µ‡πà Sheet "Column_AN_Report"',
      SpreadsheetApp.getUi().ButtonSet.OK
    );
    
    // ‡πÄ‡∏õ‡∏¥‡∏î Report Sheet
    SpreadsheetApp.setActiveSheet(reportSheet);
    
  } catch (error) {
    console.error('‚ùå Error:', error);
    
    SpreadsheetApp.getUi().alert(
      '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
      '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á Report ‡πÑ‡∏î‡πâ\n\n' +
      'Error: ' + error.toString(),
      SpreadsheetApp.getUi().ButtonSet.OK
    );
  }
}



// ===== Utility Functions =====
function formatDate(date) {
  if (!date) return '';
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  return year + '-' + month + '-' + day;
}

function formatTime(timeValue) {
  if (!timeValue) return '';
  
  if (typeof timeValue === 'string') {
    return timeValue;
  }
  
  if (timeValue instanceof Date) {
    const hours = String(timeValue.getHours()).padStart(2, '0');
    const minutes = String(timeValue.getMinutes()).padStart(2, '0');
    return hours + ':' + minutes;
  }
  
  if (typeof timeValue === 'number') {
    const totalMinutes = Math.round(timeValue * 24 * 60);
    const hours = Math.floor(totalMinutes / 60);
    const minutes = totalMinutes % 60;
    return String(hours).padStart(2, '0') + ':' + String(minutes).padStart(2, '0');
  }
  
  return timeValue.toString();
}

function formatDateThai(dateString) {
  if (!dateString) return '';
  
  const months = [
    '‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå', '‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°', '‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô', '‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°', '‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô',
    '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°', '‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô', '‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°', '‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô', '‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'
  ];
  
  const date = new Date(dateString + 'T00:00:00');
  const day = date.getDate();
  const month = months[date.getMonth()];
  const year = date.getFullYear() + 543;
  
  return day + ' ' + month + ' ' + year;
}

function timeToMinutes(timeString) {
  if (!timeString) return 0;
  const parts = timeString.split(':');
  return parseInt(parts[0]) * 60 + parseInt(parts[1]);
}


/**
 * ‚≠ê UPDATED: getWorkTypeList with Cache
 */
function getWorkTypeList(category) {
  return getCachedData(
    CACHE_CONFIG.WORK_TYPES.key + '_' + (category || 'ALL'),
    function() {
      return loadWorkTypesFromSheet(category);
    },
    CACHE_CONFIG.WORK_TYPES.ttl
  );
}

/**
 * ‚≠ê Loader Function: ‡πÇ‡∏´‡∏•‡∏î Work Types ‡∏à‡∏≤‡∏Å Sheet
 */
function loadWorkTypesFromSheet(category) {
  try {
    if (!category || category.trim() === '') {
      category = 'RFI Work';
    }
    
    console.log('üì• Loading Work Types from sheet:', category);
    
    const workSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Work');
    
    if (!workSheet) {
      console.log('‚ùå Work sheet not found');
      return [];
    }
    
    const lastRow = workSheet.getLastRow();
    if (lastRow <= 1) {
      console.log('‚ö†Ô∏è No work types found');
      return [];
    }
    
    const data = workSheet.getRange(2, 1, lastRow - 1, 8).getValues();
    const workTypes = [];
    
    for (let i = 0; i < data.length; i++) {
      const idWork = String(data[i][0] || '').trim();
      const nameWork = String(data[i][1] || '').trim();
      const workCategory = String(data[i][2] || '').trim();
      const duration = parseInt(data[i][4]) || 60;
      const sequence = String(data[i][5] || '').trim();
      const qcType = String(data[i][6] || '').trim();
      const note = String(data[i][7] || '').trim();
      
      if (workCategory === category && nameWork) {
        workTypes.push({
          name: nameWork,
          duration: duration,
          sequence: sequence,
          qcType: qcType,
          note: note,
          workCategory: workCategory,
          qcTypeNumeric: parseInt(qcType) || 999
        });
      }
    }
    
    workTypes.sort(function(a, b) {
      if (a.qcTypeNumeric !== b.qcTypeNumeric) {
        return a.qcTypeNumeric - b.qcTypeNumeric;
      }
      return a.name.localeCompare(b.name);
    });
    
    console.log('‚úÖ Loaded', workTypes.length, 'work types from sheet');
    
    return workTypes;
    
  } catch (error) {
    console.error('‚ùå Error loading work types:', error);
    logError('loadWorkTypesFromSheet', error, { category: category }, 'ERROR');
    return [];
  }
}

function teamSupportsWorkType(teamWorkTypes, requestedWorkType) {
  if (!teamWorkTypes || !requestedWorkType) {
    console.log('  ‚ùå Missing input');
    return false;
  }
  
  const workTypesStr = String(teamWorkTypes).trim();
  
  // ‚≠ê Universal Team (‡∏ó‡∏≥‡πÑ‡∏î‡πâ‡∏ó‡∏∏‡∏Å‡∏á‡∏≤‡∏ô)
  if (workTypesStr === '*') {
    console.log('  ‚Üí ‚úÖ Universal team (supports all work types)');
    return true;
  }
  
  // ‚≠ê ‡πÅ‡∏¢‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡∏°‡∏ó‡∏≥‡πÑ‡∏î‡πâ + lowercase
  const supportedTypes = workTypesStr.split(',').map(function(t) {
    return t.trim().toLowerCase();  // ‚úÖ Case-insensitive
  });
  
  // ‚≠ê ‡πÅ‡∏õ‡∏•‡∏á‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡πá‡∏ô lowercase
  const requested = String(requestedWorkType).trim().toLowerCase();
  
  // ‚≠ê ‡πÉ‡∏ä‡πâ includes() (‡∏ó‡∏±‡∏ô‡∏™‡∏°‡∏±‡∏¢‡∏Å‡∏ß‡πà‡∏≤ indexOf)
  const isSupported = supportedTypes.includes(requested);
  
  // ‚≠ê Logging ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö debug
  if (isSupported) {
    console.log('  ‚Üí ‚úÖ Team supports:', requestedWorkType);
  } else {
    console.log('  ‚Üí ‚ùå Team does NOT support:', requestedWorkType);
    console.log('     Team has:', supportedTypes.join(', '));
    console.log('     Looking for:', requested);
  }
  
  return isSupported;
}
/**
 * ‚≠ê UPDATED: getTeamsByCategory with Cache
 */
function getTeamsByCategory(category, workType) {
  const cacheKey = CACHE_CONFIG.RESOURCES.key + '_' + category + '_' + (workType || 'ALL');
  
  return getCachedData(
    cacheKey,
    function() {
      return loadTeamsByCategoryFromSheet(category, workType);
    },
    CACHE_CONFIG.RESOURCES.ttl
  );
}

/**
 * ‚≠ê Loader Function: ‡πÇ‡∏´‡∏•‡∏î Teams ‡∏à‡∏≤‡∏Å Sheet
 */
function loadTeamsByCategoryFromSheet(category, workType) {
  try {
    console.log('üì• Loading teams from sheet:', category, workType);
    
    const resourceSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Resources');
    
    if (!resourceSheet) {
      console.log('‚ùå Resources sheet not found');
      return [];
    }
    
    const lastRow = resourceSheet.getLastRow();
    const lastColumn = resourceSheet.getLastColumn();
    
    if (lastRow <= 1) {
      console.log('‚ö†Ô∏è No resources found');
      return [];
    }
    
    const categories = category.split(',').map(function(c) {
      return c.trim().toLowerCase();
    });
    
    const data = resourceSheet.getRange(2, 1, lastRow - 1, lastColumn).getValues();
    const teams = [];
    
    for (let i = 0; i < data.length; i++) {
      const row = data[i];
      const resourceId = String(row[0] || '').trim();
      const resourceName = String(row[1] || '').trim();
      const subType = String(row[2] || '').trim();
      const teamNo = row[3];
      const status = String(row[4] || '').trim();
      const teamWorkTypes = String(row[8] || '').trim();
      
      if (status !== 'Activated' || !resourceId || !subType) {
        continue;
      }
      
      const subTypeLower = subType.toLowerCase();
      const matchesCategory = categories.indexOf(subTypeLower) !== -1;
      
      if (!matchesCategory) {
        continue;
      }
      
      if (workType && !teamSupportsWorkType(teamWorkTypes, workType)) {
        continue;
      }
      
      teams.push({
        resourceId: resourceId,
        resourceName: resourceName,
        subType: subType,
        teamNo: teamNo || 999,
        workTypes: teamWorkTypes
      });
    }
    
    teams.sort(function(a, b) {
      return a.teamNo - b.teamNo;
    });
    
    console.log('‚úÖ Loaded', teams.length, 'teams from sheet');
    
    return teams;
    
  } catch (error) {
    console.error('‚ùå Error loading teams:', error);
    logError('loadTeamsByCategoryFromSheet', error, { category: category, workType: workType }, 'ERROR');
    return [];
  }
}

/**
 * ‚ú® ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤ Status ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤ "‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡∏°" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
 * (‡πÉ‡∏ä‡πâ‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ô‡πÑ‡∏î‡πâ‡∏ó‡∏±‡πâ‡∏á RFI ‡πÅ‡∏•‡∏∞ Survey Work)
 */
function isStatusInactive(status) {
  if (!status) return false;
  
  const statusLower = status.toLowerCase();
  
  // ‚úÖ Status ‡∏ó‡∏µ‡πà‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡∏°‡πÅ‡∏•‡πâ‡∏ß (‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ä‡πá‡∏Ñ)
  const inactiveStatuses = [
    'cancel',           // ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å (EN)
    'cancelled',        // ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å (EN - ‡∏™‡∏∞‡∏Å‡∏î‡∏ï‡πà‡∏≤‡∏á)
    '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',           // ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å (TH)
    'completed',        // ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß
    '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô',         // ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô (TH)
    'closed',           // ‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß
    '‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô',           // ‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô (TH)
    'rejected',         // ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò
    '‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò',           // ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò (TH)
    'archived',         // ‡πÄ‡∏Å‡πá‡∏ö‡∏ñ‡∏≤‡∏ß‡∏£
    'void',             // ‡πÇ‡∏°‡∏Ü‡∏∞
    'deleted'           // ‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß
  ];
  
  // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤ status ‡∏°‡∏µ‡∏Ñ‡∏≥‡πÉ‡∏î‡∏Ñ‡∏≥‡∏´‡∏ô‡∏∂‡πà‡∏á‡πÉ‡∏ô‡∏ô‡∏±‡πâ‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
  return inactiveStatuses.some(function(inactive) {
    return statusLower.includes(inactive);
  });
}

/**
 * ‚úÖ UPDATED: ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å Buffer - ‡πÄ‡∏ä‡πá‡∏Ñ‡πÅ‡∏Ñ‡πà‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô
 */
function isTeamAvailable(resourceId, date, startTime, endTime, excludeRfiId) {
  try {
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('RFI_List');
    if (!sheet) return true;
    
    const lastRow = sheet.getLastRow();
    if (lastRow <= 1) return true;
    
    const data = sheet.getRange(2, 1, lastRow - 1, 15).getValues();
    
    const requestStartMinutes = timeToMinutes(startTime);
    const requestEndMinutes = timeToMinutes(endTime);
    
    for (let i = 0; i < data.length; i++) {
      const row = data[i];
      const rfiId = String(row[0] || '').trim();
      const rfiDate = formatDate(new Date(row[4]));
      const rfiStartTime = formatTime(row[5]);
      const rfiEndTime = formatTime(row[6]);
      const assignedTeams = String(row[11] || '').trim();
      const status = String(row[14] || '').trim();
      
      if (excludeRfiId && rfiId === excludeRfiId) {
        console.log('Skipping RFI being edited:', rfiId);
        continue;
      }
      
      if (isStatusInactive(status)) {
        console.log('Skipping inactive status:', status, '(RFI:', rfiId + ')');
        continue;
      }
      
      if (rfiDate === date) {
        const resourceSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Resources');
        if (!resourceSheet) continue;
        
        const resourceData = resourceSheet.getRange(2, 1, resourceSheet.getLastRow() - 1, 2).getValues();
        
        const nameToId = {};
        for (let j = 0; j < resourceData.length; j++) {
          const rid = String(resourceData[j][0] || '').trim();
          const rname = String(resourceData[j][1] || '').trim();
          if (rid && rname) {
            nameToId[rname] = rid;
          }
        }
        
        const teamNamesList = assignedTeams.split(',').map(function(name) {
          return name.trim();
        });
        
        let isThisTeamAssigned = false;
        for (let k = 0; k < teamNamesList.length; k++) {
          const teamName = teamNamesList[k];
          if (nameToId[teamName] === resourceId) {
            isThisTeamAssigned = true;
            break;
          }
        }
        
        if (!isThisTeamAssigned) {
          continue;
        }
        
        const existingStartMinutes = timeToMinutes(rfiStartTime);
        const existingEndMinutes = timeToMinutes(rfiEndTime);
        
        // ‚úÖ ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å Buffer - ‡πÄ‡∏ä‡πá‡∏Ñ‡πÅ‡∏Ñ‡πà‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô
        const isAvailable = (requestEndMinutes <= existingStartMinutes) || 
                           (requestStartMinutes >= existingEndMinutes);
        
        if (!isAvailable) {
          console.log('Team ' + resourceId + ' is NOT available (RFI: ' + rfiId + ', Status: ' + status + ')');
          return false;
        }
      }
    }
    
    return true;
    
  } catch (error) {
    console.error('Error checking team availability:', error);
    return false;
  }
}

/**
 * ‚úÖ UPDATED: ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏ó‡∏µ‡∏° Survey ‡∏ß‡πà‡∏≤‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (Survey Work - ‡πÑ‡∏°‡πà‡∏°‡∏µ buffer)
 */
function isSurveyTeamAvailable(resourceId, date, startTime, endTime) {
  try {
    console.log('üîç Checking Survey Team availability:', resourceId, date, startTime, endTime);
    
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('RFI_List');
    if (!sheet) return true;
    
    const lastRow = sheet.getLastRow();
    if (lastRow <= 1) return true;
    
    const data = sheet.getRange(2, 1, lastRow - 1, 15).getValues();
    
    const requestStartMinutes = timeToMinutes(startTime);
    const requestEndMinutes = timeToMinutes(endTime);
    
    for (let i = 0; i < data.length; i++) {
      const row = data[i];
      const rfiId = String(row[0] || '').trim();              // Column A - ID
      const rfiDate = formatDate(new Date(row[4]));           // Column E - Request_Date
      const rfiStartTime = formatTime(row[5]);                // Column F - Start_Time
      const rfiEndTime = formatTime(row[6]);                  // Column G - End_Time
      const assignedTeams = String(row[11] || '').trim();     // Column L - Assigned_Inspector
      const status = String(row[14] || '').trim();            // Column O - Status
      
      // ‚úÖ ‡πÉ‡∏ä‡πâ isStatusInactive() ‡πÅ‡∏ó‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏¥‡∏°
      if (isStatusInactive(status)) {
        console.log('  ‚è≠Ô∏è Skipping inactive status:', status, '(RFI:', rfiId + ')');
        continue;
      }
      
      if (rfiDate !== date) continue;
      
      const resourceSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Resources');
      if (!resourceSheet) continue;
      
      const resourceData = resourceSheet.getRange(2, 1, resourceSheet.getLastRow() - 1, 2).getValues();
      
      const nameToId = {};
      for (let j = 0; j < resourceData.length; j++) {
        const rid = String(resourceData[j][0] || '').trim();
        const rname = String(resourceData[j][1] || '').trim();
        if (rid && rname) {
          nameToId[rname] = rid;
        }
      }
      
      const teamNamesList = assignedTeams.split(',').map(function(name) {
        return name.trim();
      });
      
      let isThisTeamAssigned = false;
      for (let k = 0; k < teamNamesList.length; k++) {
        const teamName = teamNamesList[k];
        if (nameToId[teamName] === resourceId) {
          isThisTeamAssigned = true;
          break;
        }
      }
      
      if (!isThisTeamAssigned) continue;
      
      const existingStartMinutes = timeToMinutes(rfiStartTime);
      const existingEndMinutes = timeToMinutes(rfiEndTime);
      
      // ‚≠ê ‡πÑ‡∏°‡πà‡∏°‡∏µ buffer - ‡πÄ‡∏ä‡πá‡∏Ñ‡πÅ‡∏Ñ‡πà‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô
      const isAvailable = (requestEndMinutes <= existingStartMinutes) || 
                         (requestStartMinutes >= existingEndMinutes);
      
      if (!isAvailable) {
        console.log('  ‚ùå Survey Team', resourceId, 'is busy (RFI:', rfiId, ', Status:', status + ')');
        console.log('     Existing:', rfiStartTime, '-', rfiEndTime);
        console.log('     Request:', startTime, '-', endTime);
        return false;
      }
    }
    
    console.log('  ‚úÖ Survey Team', resourceId, 'is available');
    return true;
    
  } catch (error) {
    console.error('‚ùå Error checking Survey team availability:', error);
    return false;
  }
}



/**
 * ‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï: ‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡∏°‡∏°‡∏µ (‡∏£‡∏ß‡∏° cache)
 */
function getTeamWorkload(resourceId, date, useCache) {
  try {
    if (typeof useCache === 'undefined') useCache = true;
    
    // 1. ‡∏ô‡∏±‡∏ö‡∏à‡∏≤‡∏Å Sheet
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('RFI_List');
    let sheetWorkload = 0;
    
    if (sheet) {
      const lastRow = sheet.getLastRow();
      
      if (lastRow > 1) {
        const data = sheet.getRange(2, 1, lastRow - 1, 15).getValues();
        
        for (let i = 0; i < data.length; i++) {
          const row = data[i];
          const rfiDate = formatDate(new Date(row[4]));
          const assignedTeams = String(row[11] || '').trim();
          const status = String(row[14] || '').trim();
          
          if (isStatusInactive(status)) continue;
          
          if (rfiDate === date) {
            const resourceSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Resources');
            if (!resourceSheet) continue;
            
            const resourceData = resourceSheet.getRange(2, 1, resourceSheet.getLastRow() - 1, 2).getValues();
            
            const nameToId = {};
            for (let j = 0; j < resourceData.length; j++) {
              const rid = String(resourceData[j][0] || '').trim();
              const rname = String(resourceData[j][1] || '').trim();
              if (rid && rname) {
                nameToId[rname] = rid;
              }
            }
            
            const teamNamesList = assignedTeams.split(',').map(function(name) {
              return name.trim();
            });
            
            for (let k = 0; k < teamNamesList.length; k++) {
              const teamName = teamNamesList[k];
              if (nameToId[teamName] === resourceId) {
                sheetWorkload++;
                break;
              }
            }
          }
        }
      }
    }
    
    // 2. ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å cache (‡∏ñ‡πâ‡∏≤‡πÉ‡∏ä‡πâ)
    const cacheWorkload = useCache ? getWorkloadFromCache(resourceId, date) : 0;
    const totalWorkload = sheetWorkload + cacheWorkload;
    
    return totalWorkload;
    
  } catch (error) {
    console.error('Error getting team workload:', error);
    return 0;
  }
}

/**
 * ‚úÖ UPDATED: ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ó‡∏µ‡∏°‡∏ï‡∏≤‡∏° Workload + Round Robin + Random (‡∏ñ‡πâ‡∏≤ Team No. ‡∏ã‡πâ‡∏≥)
 */
function sortTeamsByWorkload(teams, date, useCache) {
  try {
    if (typeof useCache === 'undefined') useCache = true;
    
    console.log('Sorting teams by workload for date:', date, '(Cache:', useCache ? 'ON' : 'OFF' + ')');
    
    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì workload ‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ó‡∏µ‡∏°
    const teamsWithWorkload = teams.map(function(team) {
      const workload = getTeamWorkload(team.resourceId, date, useCache);
      console.log('Team:', team.resourceName, 'Workload:', workload, 'Team No:', team.teamNo);
      
      return {
        resourceId: team.resourceId,
        resourceName: team.resourceName,
        subType: team.subType,
        teamNo: team.teamNo,
        workload: workload
      };
    });
    
    // ‡∏´‡∏≤ min workload
    let minWorkload = Infinity;
    teamsWithWorkload.forEach(function(t) {
      if (t.workload < minWorkload) {
        minWorkload = t.workload;
      }
    });
    
    // ‡πÅ‡∏¢‡∏Å‡∏ó‡∏µ‡∏°‡∏ó‡∏µ‡πà‡∏°‡∏µ workload ‡∏ô‡πâ‡∏≠‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
    const minWorkloadTeams = teamsWithWorkload.filter(function(t) {
      return t.workload === minWorkload;
    });
    
    // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏´‡∏•‡∏≤‡∏¢‡∏ó‡∏µ‡∏°‡∏ó‡∏µ‡πà workload ‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô ‚Üí ‡πÉ‡∏ä‡πâ Round Robin ‡∏´‡∏£‡∏∑‡∏≠ Random
    if (minWorkloadTeams.length > 1) {
      console.log('‚öñÔ∏è Found', minWorkloadTeams.length, 'teams with same workload (', minWorkload, ')');
      
      // ‚≠ê ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ Team No. ‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
      const teamsByTeamNo = {};
      
      minWorkloadTeams.forEach(function(team) {
        const key = team.teamNo;
        if (!teamsByTeamNo[key]) {
          teamsByTeamNo[key] = [];
        }
        teamsByTeamNo[key].push(team);
      });
      
      // ‚≠ê ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ Team No. ‡∏ã‡πâ‡∏≥ ‚Üí Random ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
      const hasDuplicateTeamNo = Object.keys(teamsByTeamNo).some(function(teamNo) {
        return teamsByTeamNo[teamNo].length > 1;
      });
      
      if (hasDuplicateTeamNo) {
        console.log('üé≤ Found duplicate Team No. - Using RANDOM selection');
        
        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á Team No. ‡∏à‡∏≤‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÑ‡∏õ‡∏°‡∏≤‡∏Å
        const sortedTeamNos = Object.keys(teamsByTeamNo).sort(function(a, b) {
          return parseInt(a) - parseInt(b);
        });
        
        // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Team No. ‡πÅ‡∏£‡∏Å (‡∏ó‡∏µ‡πà‡∏°‡∏µ workload ‡∏ô‡πâ‡∏≠‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î)
        const firstTeamNo = sortedTeamNos[0];
        const teamsWithSameNo = teamsByTeamNo[firstTeamNo];
        
        console.log('   Team No.', firstTeamNo, 'has', teamsWithSameNo.length, 'teams');
        
        // ‚≠ê Random ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å 1 ‡∏ó‡∏µ‡∏°
        const randomIndex = Math.floor(Math.random() * teamsWithSameNo.length);
        const selectedTeam = teamsWithSameNo[randomIndex];
        
        console.log('   üéØ Randomly selected:', selectedTeam.resourceName);
        
        // ‡πÄ‡∏≠‡∏≤‡∏ó‡∏µ‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏°‡∏≤‡πÑ‡∏ß‡πâ‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏∏‡∏î
        const otherTeams = teamsWithWorkload.filter(function(t) {
          return t.resourceId !== selectedTeam.resourceId;
        }).sort(function(a, b) {
          if (a.workload !== b.workload) return a.workload - b.workload;
          if (a.teamNo !== b.teamNo) return a.teamNo - b.teamNo;
          return a.resourceId.localeCompare(b.resourceId);
        });
        
        return [selectedTeam].concat(otherTeams);
      }
      
      // ‚≠ê ‡πÑ‡∏°‡πà‡∏°‡∏µ Team No. ‡∏ã‡πâ‡∏≥ ‚Üí ‡πÉ‡∏ä‡πâ Round Robin
      const categoryKey = teams[0].subType + '_' + date;
      const lastSelected = LAST_SELECTED_TEAM[categoryKey];
      
      console.log('üîÑ No duplicate Team No. - Using ROUND ROBIN');
      console.log('Last selected:', lastSelected);
      
      // ‡∏´‡∏≤ index ‡∏Ç‡∏≠‡∏á‡∏ó‡∏µ‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏Å‡πà‡∏≠‡∏ô
      let startIndex = 0;
      if (lastSelected) {
        for (let i = 0; i < minWorkloadTeams.length; i++) {
          if (minWorkloadTeams[i].resourceId === lastSelected) {
            startIndex = (i + 1) % minWorkloadTeams.length;
            break;
          }
        }
      }
      
      // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà‡πÇ‡∏î‡∏¢‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å‡∏ó‡∏µ‡∏°‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
      const rotated = minWorkloadTeams.slice(startIndex).concat(minWorkloadTeams.slice(0, startIndex));
      
      console.log('üîÑ Round Robin order:', rotated.map(function(t) {
        return t.resourceName;
      }).join(' ‚Üí '));
      
      // ‡∏ô‡∏≥‡∏ó‡∏µ‡∏°‡∏ó‡∏µ‡πà workload ‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤‡∏°‡∏≤‡∏ï‡πà‡∏≠‡∏ó‡πâ‡∏≤‡∏¢
      const higherWorkloadTeams = teamsWithWorkload.filter(function(t) {
        return t.workload > minWorkload;
      }).sort(function(a, b) {
        if (a.workload !== b.workload) return a.workload - b.workload;
        if (a.teamNo !== b.teamNo) return a.teamNo - b.teamNo;
        return a.resourceId.localeCompare(b.resourceId);
      });
      
      return rotated.concat(higherWorkloadTeams);
    }
    
    // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏ó‡∏µ‡∏°‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏ó‡∏µ‡πà workload ‡∏ô‡πâ‡∏≠‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î ‡∏´‡∏£‡∏∑‡∏≠ workload ‡πÑ‡∏°‡πà‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô
    teamsWithWorkload.sort(function(a, b) {
      if (a.workload !== b.workload) {
        return a.workload - b.workload;
      }
      if (a.teamNo !== b.teamNo) {
        return a.teamNo - b.teamNo;
      }
      return a.resourceId.localeCompare(b.resourceId);
    });
    
    console.log('Teams sorted by workload:');
    teamsWithWorkload.forEach(function(t) {
      console.log('-', t.resourceName, '(Workload:', t.workload + ', Team No:', t.teamNo + ')');
    });
    
    return teamsWithWorkload;
    
  } catch (error) {
    console.error('Error sorting teams by workload:', error);
    return teams;
  }
}


/**
 * ‚úÖ FINAL: ‡∏à‡∏±‡∏î‡∏ó‡∏µ‡∏°‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (RFI Work) - Load Balanced + Work Type Filter
 */
function assignTeamAutomatically(category, date, startTime, endTime, excludeRfiId, useCache, workType) {
  try {
    // Set default values
    if (typeof excludeRfiId === 'undefined') excludeRfiId = null;
    if (typeof useCache === 'undefined') useCache = false;
    if (typeof workType === 'undefined') workType = null;
    
    console.log('========== Auto-assigning team (Load Balanced + Work Type Filter) ==========');
    console.log('Category:', category);
    console.log('Work Type:', workType); // ‚≠ê ‡πÉ‡∏´‡∏°‡πà
    console.log('Date:', date);
    console.log('Time:', startTime, '-', endTime);
    console.log('Use Cache:', useCache);
    
    // ‡πÅ‡∏¢‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏á‡∏≤‡∏ô
    const categories = category.split(',').map(function(c) {
      return c.trim();
    });
    
    console.log('Categories:', categories);
    
    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
    if (categories.length === 1) {
      // ‚≠ê ‡∏™‡πà‡∏á workType ‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢
      const teams = getTeamsByCategory(category, workType);
      
      if (teams.length === 0) {
        const categoryDisplay = category.replace(/,/g, ', ');
        
        // ‚≠ê ‡∏õ‡∏£‡∏±‡∏ö error message
        if (workType) {
          return {
            success: false,
            message: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ó‡∏µ‡∏° ' + categoryDisplay + ' ‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô "' + workType + '"\n' +
                    'üí° ‡∏•‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏á‡∏≤‡∏ô‡∏≠‡∏∑‡πà‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ó‡∏µ‡∏°‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Work_Types ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'
          };
        } else {
          return {
            success: false,
            message: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î ' + categoryDisplay
          };
        }
      }
      
      // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ó‡∏µ‡∏°‡∏ï‡∏≤‡∏° workload
      const sortedTeams = sortTeamsByWorkload(teams, date, useCache);
      
      // ‡∏´‡∏≤‡∏ó‡∏µ‡∏°‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á
      for (let i = 0; i < sortedTeams.length; i++) {
        const team = sortedTeams[i];
        
        if (isTeamAvailable(team.resourceId, date, startTime, endTime, excludeRfiId)) {
          console.log('‚úÖ Selected team:', team.resourceName, '(Workload:', team.workload + ')');
          
          // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï cache (‡∏ñ‡πâ‡∏≤‡πÉ‡∏ä‡πâ)
          if (useCache) {
            incrementWorkloadCache(team.resourceId, date);
            LAST_SELECTED_TEAM[team.subType + '_' + date] = team.resourceId;
          }
          
          return {
            success: true,
            assignedTeams: [team.resourceName],
            teamNames: team.resourceName,
            resourceIds: team.resourceId,
            teamNo: team.teamNo,
            workload: team.workload,
            workType: workType // ‚≠ê ‡∏™‡πà‡∏á work type ‡∏Å‡∏•‡∏±‡∏ö
          };
        }
      }
      
      // ‚≠ê ‡∏õ‡∏£‡∏±‡∏ö error message
      if (workType) {
        return {
          success: false,
          message: '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ó‡∏µ‡∏° ' + category + ' ‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô "' + workType + '" ‡πÅ‡∏•‡∏∞‡∏ß‡πà‡∏≤‡∏á‡πÉ‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å\n' +
                  'üí° ‡∏•‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏∑‡πà‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏ß‡∏±‡∏ô‡∏≠‡∏∑‡πà‡∏ô'
        };
      } else {
        return {
          success: false,
          message: '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ó‡∏µ‡∏°‡∏ß‡πà‡∏≤‡∏á‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î ' + category + ' ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å'
        };
      }
    }
    
    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏•‡∏≤‡∏¢‡∏´‡∏°‡∏ß‡∏î
    return assignMultipleTeams(categories, date, startTime, endTime, excludeRfiId, useCache, workType);

  } catch (error) {
    console.error('Error in assignTeamAutomatically:', error);
    console.error('Stack:', error.stack);
    
    // ‚úÖ‚úÖ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ ‚úÖ‚úÖ‚úÖ
    logError('assignTeamAutomatically', error, {
      category: category,
      date: date,
      startTime: startTime,
      endTime: endTime,
      workType: workType,
      useCache: useCache
    }, 'ERROR');
    
    return {
      success: false,
      message: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏ó‡∏µ‡∏°: ' + error.toString()
    };
  }
}
/**
 * ‚úÖ FINAL: ‡∏à‡∏±‡∏î‡∏´‡∏•‡∏≤‡∏¢‡∏ó‡∏µ‡∏° (Multi-Work) - Load Balanced + Work Type Filter
 */
function assignMultipleTeams(categories, date, startTime, endTime, excludeRfiId, useCache, workType) {
  try {
    // Set default values
    if (typeof excludeRfiId === 'undefined') excludeRfiId = null;
    if (typeof useCache === 'undefined') useCache = false;
    if (typeof workType === 'undefined') workType = null;
    
    console.log('========== Assigning multiple teams (Load Balanced + Work Type Filter) ==========');
    console.log('Categories:', categories);
    console.log('Work Type:', workType); // ‚≠ê ‡πÉ‡∏´‡∏°‡πà
    console.log('Use Cache:', useCache);
    
    const teamsByCategory = {};
    
    // ‡∏î‡∏∂‡∏á‡∏ó‡∏µ‡∏°‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏´‡∏°‡∏ß‡∏î (‚≠ê ‡∏™‡πà‡∏á workType ‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢)
    for (let i = 0; i < categories.length; i++) {
      const cat = categories[i];
      const teams = getTeamsByCategory(cat, workType);
      
      if (teams.length === 0) {
        // ‚≠ê ‡∏õ‡∏£‡∏±‡∏ö error message
        if (workType) {
          return {
            success: false,
            message: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ó‡∏µ‡∏° ' + cat + ' ‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô "' + workType + '"\n' +
                    'üí° ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ó‡∏µ‡∏°‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Work_Types ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'
          };
        } else {
          return {
            success: false,
            message: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ó‡∏µ‡∏°‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î ' + cat
          };
        }
      }
      
      // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ó‡∏µ‡∏°‡∏ï‡∏≤‡∏° workload + Round Robin
      teamsByCategory[cat] = sortTeamsByWorkload(teams, date, useCache);
      console.log('Category ' + cat + ':', teamsByCategory[cat].length, 'teams');
    }
    
    // ‡∏à‡∏≥‡∏Å‡∏±‡∏î combinations
    const MAX_TEAMS_PER_CATEGORY = 3;
    
    Object.keys(teamsByCategory).forEach(function(cat) {
      if (teamsByCategory[cat].length > MAX_TEAMS_PER_CATEGORY) {
        teamsByCategory[cat] = teamsByCategory[cat].slice(0, MAX_TEAMS_PER_CATEGORY);
        console.log('‚ö° Limited ' + cat + ' to ' + MAX_TEAMS_PER_CATEGORY + ' teams');
      }
    });
    
    // Cache team availability
    const teamAvailability = {};
    Object.keys(teamsByCategory).forEach(function(cat) {
      teamsByCategory[cat].forEach(function(team) {
        teamAvailability[team.resourceId] = isTeamAvailable(
          team.resourceId, date, startTime, endTime, excludeRfiId
        );
      });
    });
    
    const availableCombinations = [];
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ä‡∏∏‡∏î‡∏Ñ‡πà‡∏≤‡∏ú‡∏™‡∏°‡∏ó‡∏µ‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    function generateCombinations(index, currentCombo) {
      if (index === categories.length) {
        let allAvailable = true;
        let totalTeamNo = 0;
        let totalWorkload = 0;
        
        for (let i = 0; i < currentCombo.length; i++) {
          const team = currentCombo[i];
          
          if (!teamAvailability[team.resourceId]) {
            allAvailable = false;
            break;
          }
          
          totalTeamNo += team.teamNo;
          totalWorkload += team.workload;
        }
        
        if (allAvailable) {
          availableCombinations.push({
            teams: currentCombo.slice(),
            totalTeamNo: totalTeamNo,
            totalWorkload: totalWorkload
          });
        }
        
        return;
      }
      
      const cat = categories[index];
      const teams = teamsByCategory[cat];
      
      for (let i = 0; i < teams.length; i++) {
        currentCombo.push(teams[i]);
        generateCombinations(index + 1, currentCombo);
        currentCombo.pop();
      }
    }
    
    generateCombinations(0, []);
    
    console.log('Found ' + availableCombinations.length + ' available combinations');
    
    if (availableCombinations.length === 0) {
      // ‚≠ê ‡∏õ‡∏£‡∏±‡∏ö error message
      if (workType) {
        return {
          success: false,
          message: '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∏‡∏î‡∏ó‡∏µ‡∏°‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô "' + workType + '" ‡πÅ‡∏•‡∏∞‡∏ß‡πà‡∏≤‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏°‡∏ß‡∏î ' + categories.join(', ') + '\n' +
                  'üí° ‡∏•‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏∑‡πà‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß'
        };
      } else {
        return {
          success: false,
          message: '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∏‡∏î‡∏ó‡∏µ‡∏°‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏°‡∏ß‡∏î ' + categories.join(', ')
        };
      }
    }
    
    // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏°‡∏µ workload ‡∏£‡∏ß‡∏°‡∏ô‡πâ‡∏≠‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
    availableCombinations.sort(function(a, b) {
      if (a.totalWorkload !== b.totalWorkload) {
        return a.totalWorkload - b.totalWorkload;
      }
      return a.totalTeamNo - b.totalTeamNo;
    });
    
    const bestCombo = availableCombinations[0];
    const teamNames = bestCombo.teams.map(function(t) {
      return t.resourceName;
    });
    
    const resourceIds = bestCombo.teams.map(function(t) {
      return t.resourceId;
    });
    
    console.log('‚úÖ Selected teams:', teamNames.join(', '));
    console.log('Total workload:', bestCombo.totalWorkload);
    
    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï cache (‡∏ñ‡πâ‡∏≤‡πÉ‡∏ä‡πâ)
    if (useCache) {
      bestCombo.teams.forEach(function(team) {
        incrementWorkloadCache(team.resourceId, date);
        LAST_SELECTED_TEAM[team.subType + '_' + date] = team.resourceId;
      });
    }
    
    return {
      success: true,
      assignedTeams: bestCombo.teams,
      teamNames: teamNames.join(','),
      resourceIds: resourceIds.join(','),
      totalTeamNo: bestCombo.totalTeamNo,
      totalWorkload: bestCombo.totalWorkload,
      workType: workType // ‚≠ê ‡∏™‡πà‡∏á work type ‡∏Å‡∏•‡∏±‡∏ö
    };
    
  } catch (error) {
    console.error('Error in assignMultipleTeams:', error);
    console.error('Stack:', error.stack);
    return {
      success: false,
      message: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏´‡∏•‡∏≤‡∏¢‡∏ó‡∏µ‡∏°: ' + error.toString()
    };
  }
}

/**
 * ‚úÖ FIXED: ‡πÉ‡∏´‡πâ‡∏ó‡∏∏‡∏Å Role ‡∏ó‡∏µ‡πà Activated ‡∏Ç‡∏≠ RFI/Survey ‡πÑ‡∏î‡πâ
 */
function validateAndGetUser(email, name) {
  try {
    console.log('Validating user:', email, name);
    
    const userSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('User');
    
    if (!userSheet) {
      console.log('User sheet not found, creating...');
      createUserSheet();
      return addNewUser(email, name);
    }
    
    const lastRow = userSheet.getLastRow();
    
    if (lastRow <= 1) {
      return addNewUser(email, name);
    }
    
    const data = userSheet.getRange(2, 1, lastRow - 1, 5).getValues();
    
    for (let i = 0; i < data.length; i++) {
      const row = data[i];
      const rowIndex = i + 2;
      const userEmail = String(row[1] || '').trim().toLowerCase();
      const existingName = String(row[2] || '').trim();
      const role = String(row[3] || '').trim();
      const status = String(row[4] || '').trim();
      
      if (userEmail === email.toLowerCase()) {
        
        // ‚≠ê ‡πÄ‡∏ä‡πá‡∏Ñ‡πÅ‡∏Ñ‡πà Status = Activated (‡πÑ‡∏°‡πà‡∏™‡∏ô‡πÉ‡∏à Role)
        if (status === 'Activated') {
          
          // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ä‡∏∑‡πà‡∏≠‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô
          if (name && name !== existingName) {
            console.log('Updating user name from "' + existingName + '" to "' + name + '"');
            userSheet.getRange(rowIndex, 3).setValue(name);
            
            return {
              success: true,
              email: userEmail,
              name: name,
              role: role,
              exists: true,
              nameUpdated: true
            };
          }
          
          // ‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô
          console.log('Found existing active user:', existingName, userEmail, '(Role:', role + ')');
          return {
            success: true,
            email: userEmail,
            name: existingName,
            role: role,
            exists: true,
            nameUpdated: false
          };
        } else {
          // ‚ö†Ô∏è Status ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà Activated
          return {
            success: false,
            message: '‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (Status: ' + status + ')\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö'
          };
        }
      }
    }
    
    // ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠‡∏≠‡∏µ‡πÄ‡∏°‡∏• ‚Üí ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà
    return addNewUser(email, name);
    
  } catch (error) {
    console.error('Error in validateAndGetUser:', error);
    return {
      success: false,
      message: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: ' + error.toString()
    };
  }
}

function addNewUser(email, name) {
  try {
    const userSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('User');
    const lastRow = userSheet.getLastRow();
    const nextRow = lastRow + 1;
    
    const userId = nextRow - 1;
    
    const newUserData = [
      userId,
      email,
      name,
      'Requester',     // ‚≠ê Default Role
      'Activated'      // ‚≠ê Default Status
    ];
    
    userSheet.getRange(nextRow, 1, 1, 5).setValues([newUserData]);
    
    console.log('Added new user:', userId, name, email, '(Role: Requester)');
    
    return {
      success: true,
      email: email,
      name: name,
      role: 'Requester',  // ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏° role
      exists: false,
      userId: userId
    };
    
  } catch (error) {
    console.error('Error adding new user:', error);
    return {
      success: false,
      message: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà: ' + error.toString()
    };
  }
}

function createUserSheet() {
  try {
    const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    let sheet = spreadsheet.getSheetByName('User');
    
    if (sheet) {
      console.log('User sheet already exists');
      return sheet;
    }
    
    sheet = spreadsheet.insertSheet('User');
    
    const headers = ['ID_User', 'UserEmail', 'DisplayName', 'Role', 'Status'];
    sheet.getRange(1, 1, 1, 5).setValues([headers]);
    
    const headerRange = sheet.getRange(1, 1, 1, 5);
    headerRange.setFontWeight('bold');
    headerRange.setBackground('#1877f2');
    headerRange.setFontColor('#ffffff');
    headerRange.setHorizontalAlignment('center');
    
    sheet.setColumnWidth(1, 100);
    sheet.setColumnWidth(2, 250);
    sheet.setColumnWidth(3, 200);
    sheet.setColumnWidth(4, 150);
    sheet.setColumnWidth(5, 120);
    
    sheet.setFrozenRows(1);
    
    const roleRule = SpreadsheetApp.newDataValidation()
      .requireValueInList(['Admin', 'QC Reviewer', 'QC', 'Requester', 'Manager'], true)
      .setAllowInvalid(false)
      .build();
    sheet.getRange(2, 4, 1000, 1).setDataValidation(roleRule);
    
    const statusRule = SpreadsheetApp.newDataValidation()
      .requireValueInList(['Activated', 'Deactivated'], true)
      .setAllowInvalid(false)
      .build();
    sheet.getRange(2, 5, 1000, 1).setDataValidation(statusRule);
    
    console.log('User sheet created successfully');
    return sheet;
    
  } catch (error) {
    console.error('Error creating User sheet:', error);
    throw error;
  }
}

// ===== ID Generation Functions =====
function generateUniqueId() {
  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
  let id = '';
  
  for (let i = 0; i < 8; i++) {
    id += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  
  if (isIdExists(id)) {
    return generateUniqueId();
  }
  
  return id;
}

function isIdExists(id) {
  try {
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('RFI_List');
    if (!sheet) return false;
    
    const lastRow = sheet.getLastRow();
    if (lastRow <= 1) return false;
    
    const ids = sheet.getRange(2, 1, lastRow - 1, 1).getValues();
    
    for (let i = 0; i < ids.length; i++) {
      if (ids[i][0] === id) {
        return true;
      }
    }
    
    return false;
  } catch (error) {
    console.error('Error checking ID existence:', error);
    return false;
  }
}

// ===== Email Functions =====
function getQCEmailList() {
  try {
    const userSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('User');
    
    if (!userSheet) {
      console.log('User sheet not found');
      return [];
    }
    
    const lastRow = userSheet.getLastRow();
    if (lastRow <= 1) {
      console.log('No data in User sheet');
      return [];
    }
    
    const data = userSheet.getRange(2, 2, lastRow - 1, 4).getValues();
    const emailList = [];
    
    for (let i = 0; i < data.length; i++) {
      const email = String(data[i][0] || '').trim();
      const role = String(data[i][2] || '').trim();
      const status = String(data[i][3] || '').trim();
      
      if ((role === 'QC Reviewer' || role === 'QC') && 
          status === 'Activated' && 
          email && email.includes('@')) {
        emailList.push({
          email: email,
          role: role
        });
      }
    }
    
    console.log('Found QC emails:', emailList.length);
    return emailList;
    
  } catch (error) {
    console.error('Error getting QC email list:', error);
    return [];
  }
}

function checkEmailQuota() {
  try {
    const remainingQuota = MailApp.getRemainingDailyQuota();
    console.log('Remaining email quota:', remainingQuota);
    return remainingQuota;
  } catch (error) {
    console.error('Error checking email quota:', error);
    return 0;
  }
}

function safeSendEmail(emailParams) {
  try {
    const quota = checkEmailQuota();
    if (quota <= 0) {
      console.log('Email quota exceeded, skipping email');
      return false;
    }
    
    MailApp.sendEmail(emailParams);
    return true;
  } catch (error) {
    console.error('Error sending email:', error);
    return false;
  }
}

function sendRFINotificationEmail(data, rfiId) {
  try {
    console.log('========== START: sendRFINotificationEmail ==========');
    
    const quota = checkEmailQuota();
    if (quota <= 1) {
      console.log('Email quota too low:', quota);
      return false;
    }
    
    const emailList = getQCEmailList();
    
    if (emailList.length === 0) {
      console.log('No QC email recipients found');
      return false;
    }
    
    const recipients = emailList.map(function(e) { return e.email; });
    
    // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° Requester Email
    if (data.requesterEmail && 
        data.requesterEmail.includes('@') && 
        !recipients.includes(data.requesterEmail)) {
      recipients.push(data.requesterEmail);
    }
    
    // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° Team Emails
    if (data.assignedTeam) {
      const teamEmails = getTeamEmailsByTeamNames(data.assignedTeam);
      teamEmails.forEach(function(teamMember) {
        if (!recipients.includes(teamMember.email)) {
          recipients.push(teamMember.email);
          console.log('Added team member:', teamMember.name, '->', teamMember.email);
        }
      });
    }
    
    console.log('Sending to:', recipients.length, 'recipients');
    
    const emailHtml = createRFIEmailHTML(data, rfiId);
    
    const sent = safeSendEmail({
      to: recipients.join(','),
      subject: 'üìã RFI Request ‡πÉ‡∏´‡∏°‡πà [ID: ' + rfiId + ']',
      htmlBody: emailHtml,
      name: 'RFI Requirement System'
    });
    
    console.log('Email result:', sent);
    return sent;
    
  } catch (error) {
    console.error('Error in sendRFINotificationEmail:', error);
    return false;
  }
}

/**
 * ‚≠ê ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï: ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏µ‡πÄ‡∏°‡∏• RFI (‡πÄ‡∏û‡∏¥‡πà‡∏° Location Layout Link)
 */
function createRFIEmailHTML(data, rfiId) {
  var categoryDisplay = data.teamCategory ? data.teamCategory.replace(/,/g, ', ') : '';
  var teamInfo = data.assignedTeam ? 
    '<tr><th>‡∏ó‡∏µ‡∏°‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡πÉ‡∏´‡πâ</th><td><strong>' + data.assignedTeam + '</strong> (' + categoryDisplay + ')</td></tr>' : '';
  
  // ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á Location Layout File
  var fileInfo = '';
  if (data.locationLayoutUrl) {
    fileInfo = '<tr><th>üìé Location Layout</th><td><a href="' + data.locationLayoutUrl + '" target="_blank" style="color: #1877f2; text-decoration: none; font-weight: 600; display: inline-flex; align-items: center; gap: 6px; padding: 8px 12px; background: #e7f3ff; border-radius: 6px; border: 1px solid #1877f2;">üìÑ ‡∏î‡∏π‡πÑ‡∏ü‡∏•‡πå Location Layout ‚Üó</a></td></tr>';
  }
  
  var emailBody = `<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<style>
body { 
  font-family: Arial, sans-serif; 
  margin: 0;
  padding: 0;
  background-color: #f5f6f7;
}
.email-container {
  max-width: 650px;
  margin: 20px auto;
  background: #ffffff;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
}
.email-header {
  background: linear-gradient(135deg, #1877f2 0%, #2948b1 100%);
  padding: 30px 25px;
  text-align: center;
}
.email-header h2 {
  color: #ffffff;
  margin: 0;
  font-size: 28px;
  font-weight: 600;
}
.email-header .icon {
  font-size: 48px;
  margin-bottom: 10px;
}
.id-badge { 
  display: inline-block;
  background: rgba(255, 255, 255, 0.2);
  color: white;
  padding: 8px 16px;
  border-radius: 8px;
  font-weight: bold;
  font-size: 18px;
  margin-top: 15px;
  border: 2px solid rgba(255, 255, 255, 0.3);
}
.email-body {
  padding: 30px 25px;
}
.greeting {
  font-size: 16px;
  color: #333;
  margin-bottom: 10px;
}
.intro-text {
  font-size: 15px;
  color: #666;
  margin-bottom: 25px;
  line-height: 1.6;
}
.section-title {
  font-size: 20px;
  font-weight: 600;
  color: #1877f2;
  margin: 25px 0 15px 0;
  padding-bottom: 8px;
  border-bottom: 2px solid #e7f3ff;
}
table { 
  border-collapse: collapse; 
  width: 100%;
  margin-bottom: 20px;
  border: 1px solid #e4e6eb;
  border-radius: 8px;
  overflow: hidden;
}
td, th { 
  border: 1px solid #e4e6eb;
  padding: 14px 16px;
  text-align: left;
  font-size: 15px;
}
th { 
  background-color: #f0f2f5;
  font-weight: 600;
  color: #333;
  width: 35%;
}
td {
  color: #444;
  line-height: 1.5;
}
.status-badge {
  display: inline-block;
  background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);
  color: #000;
  padding: 6px 14px;
  border-radius: 6px;
  font-size: 13px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  box-shadow: 0 2px 8px rgba(255, 193, 7, 0.3);
}
.alert-box {
  background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
  border-left: 4px solid #ffc107;
  padding: 16px;
  border-radius: 8px;
  margin: 20px 0;
  font-size: 15px;
  color: #856404;
}
.alert-box strong {
  color: #f59e0b;
  font-weight: 700;
}
.footer {
  background: #f0f2f5;
  padding: 20px 25px;
  text-align: center;
  border-top: 1px solid #e4e6eb;
}
.footer p {
  margin: 5px 0;
  font-size: 13px;
  color: #666;
}
.footer .timestamp {
  font-size: 12px;
  color: #999;
  margin-top: 8px;
}
.file-link {
  color: #1877f2;
  text-decoration: none;
  font-weight: 600;
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 10px 16px;
  background: linear-gradient(135deg, #e7f3ff 0%, #d4e9ff 100%);
  border-radius: 8px;
  border: 2px solid #1877f2;
  transition: all 0.3s ease;
  font-size: 14px;
}
.file-link:hover {
  background: linear-gradient(135deg, #1877f2 0%, #2948b1 100%);
  color: white;
  box-shadow: 0 4px 12px rgba(24, 119, 242, 0.3);
}
.highlight {
  background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
  border-left: 4px solid #10b981;
  padding: 14px;
  border-radius: 8px;
  margin: 15px 0;
  font-size: 14px;
  color: #065f46;
}
.highlight strong {
  color: #16a34a;
  font-weight: 700;
}
/* Responsive */
@media only screen and (max-width: 600px) {
  .email-container {
    margin: 10px;
  }
  .email-header {
    padding: 20px 15px;
  }
  .email-body {
    padding: 20px 15px;
  }
  th, td {
    padding: 10px 12px;
    font-size: 14px;
  }
  .section-title {
    font-size: 18px;
  }
}
</style>
</head>
<body>
<div class="email-container">
  <!-- Header -->
  <div class="email-header">
    <div class="icon">üìã</div>
    <h2>‡πÅ‡∏à‡πâ‡∏á RFI Request ‡πÉ‡∏´‡∏°‡πà</h2>
    <div class="id-badge">RFI ID: ${rfiId}</div>
  </div>
  
  <!-- Body -->
  <div class="email-body">
    <p class="greeting"><strong>‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‡∏ó‡∏µ‡∏° QC</strong></p>
    <p class="intro-text">
      ‡∏°‡∏µ RFI Request ‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ 
      ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏≤‡∏°‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô
    </p>
    
    <h3 class="section-title">üìã ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î RFI</h3>
    <table>
      <tr>
        <th>üÜî RFI ID</th>
        <td><strong style="color: #1877f2; font-size: 16px;">${rfiId}</strong></td>
      </tr>
      <tr>
        <th>üìù ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th>
        <td>${data.description}</td>
      </tr>
      <tr>
        <th>üìç ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</th>
        <td><strong>${data.location}</strong></td>
      </tr>
      <tr>
        <th>üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£</th>
        <td><strong style="color: #1877f2;">${formatDateThai(data.requestDate)}</strong></td>
      </tr>
      <tr>
        <th>‚è∞ ‡πÄ‡∏ß‡∏•‡∏≤</th>
        <td><strong>${data.startTime} - ${data.endTime} ‡∏ô.</strong></td>
      </tr>
      ${teamInfo}
      ${fileInfo}
      <tr>
        <th>üë§ ‡∏ú‡∏π‡πâ‡∏Ç‡∏≠</th>
        <td>${data.requesterName}</td>
      </tr>
      ${data.requesterEmail ? '<tr><th>üìß ‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ú‡∏π‡πâ‡∏Ç‡∏≠</th><td><a href="mailto:' + data.requesterEmail + '" style="color: #1877f2; text-decoration: none;">' + data.requesterEmail + '</a></td></tr>' : ''}
      <tr>
        <th>üìä ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
        <td><span class="status-badge">RFI Request Submitted</span></td>
      </tr>
    </table>
    
    ${data.locationLayoutUrl ? '<div class="highlight"><strong>üìé Location Layout File ‡πÅ‡∏ô‡∏ö‡∏°‡∏≤‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ô‡∏µ‡πâ</strong><br>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</div>' : ''}
    
    <div class="alert-box">
      <strong>‚ö†Ô∏è ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ:</strong><br>
      1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î RFI ‡πÅ‡∏•‡∏∞ Location Layout (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)<br>
      2. ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏Ç‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡∏ñ‡πâ‡∏≤‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô)<br>
      3. ‡∏à‡∏±‡∏î‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô<br>
      4. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÉ‡∏ô RFI System<br>
      5. ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ï‡∏≤‡∏°‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Å‡∏≤‡∏£
    </div>
  </div>
  
  <!-- Footer -->
  <div class="footer">
    <p><strong>RFI Requirement System</strong></p>
    <p>‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ô‡∏µ‡πâ‡∏™‡πà‡∏á‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö RFI Requirement ‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</p>
    <p class="timestamp">‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á: ${new Date().toLocaleString('th-TH', { 
      timeZone: 'Asia/Bangkok',
      year: 'numeric',
      month: 'long',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit'
    })}</p>
  </div>
</div>
</body>
</html>`;
  
  return emailBody;
}

/**
 * ‚≠ê ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï: ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏µ‡πÄ‡∏°‡∏• Internal Inspection (‡πÄ‡∏û‡∏¥‡πà‡∏° Location Layout Link)
 */
function createInternalInspectionEmailHTML(data, rfiId) {
  var categoryDisplay = data.teamCategory ? data.teamCategory.replace(/,/g, ', ') : '';
  var teamInfo = data.assignedTeam ? 
    '<tr><th>‡∏ó‡∏µ‡∏°‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡πÉ‡∏´‡πâ</th><td><strong>' + data.assignedTeam + '</strong> (' + categoryDisplay + ')</td></tr>' : '';
  
  // ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á Location Layout File
  var fileInfo = '';
  if (data.locationLayoutUrl) {
    fileInfo = '<tr><th>üìé Location Layout</th><td><a href="' + data.locationLayoutUrl + '" target="_blank" style="color: #f59e0b; text-decoration: none; font-weight: 600; display: inline-flex; align-items: center; gap: 6px; padding: 8px 12px; background: #fff7ed; border-radius: 6px; border: 1px solid #f59e0b;">üìÑ ‡∏î‡∏π‡πÑ‡∏ü‡∏•‡πå Location Layout ‚Üó</a></td></tr>';
  }
  
  var emailBody = `<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<style>
body { font-family: Arial, sans-serif; margin: 20px; }
h2 { color: #f59e0b; }
.id-badge { 
  display: inline-block;
  background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
  color: white;
  padding: 5px 12px;
  border-radius: 5px;
  font-weight: bold;
  font-size: 16px;
  margin-bottom: 15px;
}
table { border-collapse: collapse; width: 100%; }
td, th { border: 1px solid #ddd; padding: 8px; text-align: left; }
th { background-color: #fff7ed; }
.status-badge {
  display: inline-block;
  background: #f59e0b;
  color: white;
  padding: 3px 8px;
  border-radius: 3px;
  font-size: 12px;
  font-weight: bold;
}
.alert-box {
  background: #fff7ed;
  border-left: 4px solid #f59e0b;
  padding: 10px;
  margin: 15px 0;
  border-radius: 5px;
}
.highlight {
  background: #fff7ed;
  padding: 10px;
  border-left: 4px solid #f59e0b;
  margin: 15px 0;
  border-radius: 5px;
}
</style>
</head>
<body>
<h2>üè¢ ‡πÅ‡∏à‡πâ‡∏á Internal Inspection Request</h2>
<div class="id-badge">Internal ID: ${rfiId}</div>
<p>‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‡∏ó‡∏µ‡∏° QC ‡πÅ‡∏•‡∏∞‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á</p>
<p>‡∏°‡∏µ Internal Inspection Request ‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö (‡∏†‡∏≤‡∏¢‡πÉ‡∏ô)</p>

<div class="highlight">
  <strong>üìÖ Calendar Event</strong><br>
  ‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á Calendar Event ‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á invitation ‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì<br>
  ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Calendar ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°
</div>

<h3>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î Internal Inspection</h3>
<table>
<tr><th>Internal ID</th><td><strong style="color: #f59e0b;">${rfiId}</strong></td></tr>
<tr><th>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th><td>${data.description}</td></tr>
<tr><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</th><td>${data.location}</td></tr>
<tr><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£</th><td>${formatDateThai(data.requestDate)}</td></tr>
<tr><th>‡πÄ‡∏ß‡∏•‡∏≤</th><td><strong>${data.startTime} - ${data.endTime} ‡∏ô.</strong></td></tr>
${teamInfo}
${fileInfo}
<tr><th>‡∏ú‡∏π‡πâ‡∏Ç‡∏≠</th><td>${data.requesterName}</td></tr>
${data.requesterEmail ? '<tr><th>‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ú‡∏π‡πâ‡∏Ç‡∏≠</th><td>' + data.requesterEmail + '</td></tr>' : ''}
<tr><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><td><span class="status-badge">Internal Inspection Submitted</span></td></tr>
</table>

${data.locationLayoutUrl ? '<div class="highlight"><strong>üìé Location Layout File ‡πÅ‡∏ô‡∏ö‡∏°‡∏≤‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ô‡∏µ‡πâ</strong><br>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</div>' : ''}

<div class="alert-box">
  <strong>‚ö†Ô∏è ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ:</strong><br>
  1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Calendar Event ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö<br>
  2. ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏° (Accept/Decline)<br>
  3. ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÅ‡∏•‡∏∞‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô<br>
  4. ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏Ç‡∏≠‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°<br>
  5. Internal Inspection ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ Consultant
</div>

<hr>
<p><small>‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ô‡∏µ‡πâ‡∏™‡πà‡∏á‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö RFI Requirement ‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</small></p>
<p><small>‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á: ${new Date().toLocaleString('th-TH')}</small></p>
</body>
</html>`;
  
  return emailBody;
}

/**
 * ‚úÖ UPDATED: Get Available Time Slots (‡πÑ‡∏°‡πà‡∏°‡∏µ Buffer)
 */
function getAvailableTimeSlots(date, category) {
  try {
    if (!date) return [];
    
    const now = new Date();
    const selectedDate = new Date(date + 'T00:00:00');
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    const selectedDateOnly = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), selectedDate.getDate());
    
    const allSlots = [];
    for (let hour = 9; hour <= 19; hour++) {
      for (let minute = 0; minute < 60; minute += 30) {
        if (hour === 19 && minute === 30) break;
        const time = hour.toString().padStart(2, '0') + ':' + minute.toString().padStart(2, '0');
        allSlots.push(time);
      }
    }
    
    let filteredSlots = allSlots.slice();
    
    if (selectedDateOnly.getTime() === today.getTime()) {
      const minTime = new Date(now.getTime() + (30 * 60 * 1000));
      
      filteredSlots = allSlots.filter(function(slot) {
        const slotTime = new Date(selectedDate);
        const timeParts = slot.split(':');
        slotTime.setHours(parseInt(timeParts[0]), parseInt(timeParts[1]), 0, 0);
        return slotTime > minTime;
      });
    } else if (selectedDateOnly < today) {
      return [];
    }
    
    if (!category) {
      return filteredSlots;
    }
    
    const availableTeams = getTeamsByCategory(category);
    
    if (availableTeams.length === 0) {
      return [];
    }
    
    const blockedSlots = getBlockedTimeSlotsForTeams(date, availableTeams);
    
    const availableSlots = [];
    
    for (let i = 0; i < filteredSlots.length; i++) {
      const startSlot = filteredSlots[i];
      
      const startParts = startSlot.split(':');
      const startHour = parseInt(startParts[0]);
      const startMin = parseInt(startParts[1]);
      const endHour = startMin === 30 ? startHour + 1 : startHour;
      const endMin = startMin === 30 ? 0 : 30;
      const endSlot = endHour.toString().padStart(2, '0') + ':' + endMin.toString().padStart(2, '0');
      
      const requestStartMinutes = timeToMinutes(startSlot);
      const requestEndMinutes = timeToMinutes(endSlot);
      
      let hasAvailableTeam = false;
      
      for (let j = 0; j < availableTeams.length; j++) {
        const team = availableTeams[j];
        const blocks = blockedSlots[team.resourceId] || [];
        
        let isAvailable = true;
        
        for (let k = 0; k < blocks.length; k++) {
          const block = blocks[k];
          // ‚úÖ ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å buffer
          if (!(requestEndMinutes <= block.start || requestStartMinutes >= block.end)) {
            isAvailable = false;
            break;
          }
        }
        
        if (isAvailable) {
          hasAvailableTeam = true;
          break;
        }
      }
      
      if (hasAvailableTeam) {
        availableSlots.push(startSlot);
      }
    }
    
    return availableSlots;
    
  } catch (error) {
    console.error('Error in getAvailableTimeSlots:', error);
    return [];
  }
}

/**
 * ‚ö° UPDATED: Get Available End Times (‡πÉ‡∏ä‡πâ Duration ‡∏à‡∏≤‡∏Å Work Type)
 */
function getAvailableEndTimes(date, startTime, category, workType) {
  try {
    if (!startTime || !date) return [];
    
    console.log('‚ö° Getting end times');
    console.log('  Date:', date);
    console.log('  Start Time:', startTime);
    console.log('  Work Type:', workType);
    
    const startMinutes = timeToMinutes(startTime);
    
    // ‚úÖ ‡∏î‡∏∂‡∏á Duration ‡∏à‡∏≤‡∏Å Sheet "Work"
    let minDuration = 60; // Default 60 ‡∏ô‡∏≤‡∏ó‡∏µ
    
    if (workType) {
      const workSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Work');
      
      if (workSheet) {
        const lastRow = workSheet.getLastRow();
        const data = workSheet.getRange(2, 1, lastRow - 1, 7).getValues();
        
        for (let i = 0; i < data.length; i++) {
          const nameWork = String(data[i][1] || '').trim();
          const duration = parseInt(data[i][4]) || 60;
          
          if (nameWork === workType) {
            minDuration = duration;
            console.log('‚úÖ Found duration for', workType + ':', duration, 'min');
            break;
          }
        }
      }
    }
    
    console.log('Min Duration:', minDuration, 'minutes');
    
    const minEndMinutes = startMinutes + minDuration;
    
    // ‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á all end slots (09:00 - 20:00)
    const allEndSlots = [];
    for (let hour = 9; hour <= 20; hour++) {
      for (let minute = 0; minute < 60; minute += 30) {
        if (hour === 9 && minute === 0) continue; // ‡πÑ‡∏°‡πà‡πÄ‡∏≠‡∏≤ 09:00
        if (hour === 20 && minute > 0) break;      // ‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 20:00
        
        const endMinutes = (hour * 60) + minute;
        
        // ‚úÖ ‡∏ï‡πâ‡∏≠‡∏á >= min duration
        if (endMinutes >= minEndMinutes && endMinutes <= 20 * 60) {
          const time = hour.toString().padStart(2, '0') + ':' + 
                      minute.toString().padStart(2, '0');
          allEndSlots.push(time);
        }
      }
    }
    
    console.log('‚úÖ Generated', allEndSlots.length, 'end time options');
    console.log('Options:', allEndSlots.join(', '));
    
    return allEndSlots;
    
  } catch (error) {
    console.error('Error in getAvailableEndTimes:', error);
    return [];
  }
}

/**
 * ‚úÖ UPDATED: ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ RFI ‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÅ‡∏•‡πâ‡∏ß)
 */
function getRFIByDate(date) {
  try {
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('RFI_List');
    if (!sheet) return [];
    
    const lastRow = sheet.getLastRow();
    if (lastRow <= 1) return [];
    
    const data = sheet.getRange(2, 1, lastRow - 1, 15).getValues();
    const rfiList = [];
    
    for (let i = 0; i < data.length; i++) {
      const row = data[i];
      const rfiId = row[0];
      const requestDate = formatDate(new Date(row[4]));
      const status = String(row[14] || '').trim();  // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° String() ‡πÅ‡∏•‡∏∞ trim()
      
      // ‚úÖ ‡πÉ‡∏ä‡πâ isStatusInactive() ‡πÅ‡∏ó‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏¥‡∏°
      if (isStatusInactive(status)) {
        continue;  // ‡∏Ç‡πâ‡∏≤‡∏° RFI ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡∏°‡πÅ‡∏•‡πâ‡∏ß
      }
      
      if (requestDate === date) {
        rfiList.push({
          id: rfiId,
          requestDate: requestDate,
          startTime: formatTime(row[5]),
          endTime: formatTime(row[6]),
          assignedTeam: row[7] || '',
          description: row[2],
          location: row[3]
        });
      }
    }
    
    return rfiList;
  } catch (error) {
    console.error('Error getting RFI by date:', error);
    return [];
  }
}

function uploadSurveyLocationLayout(fileData, surveyNo) {
  try {
    console.log('========== Upload Survey Location Layout START ==========');
    console.log('Survey NO:', surveyNo);
    console.log('Original file name:', fileData.name);
    console.log('MIME type:', fileData.mimeType);
    
    // ‡πÉ‡∏ä‡πâ Folder ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö RFI
    var LOCATION_LAYOUT_FOLDER_ID = '11xT2Ik1A5yD8S7yPaVEEeVfJGKLY5LRW';
    
    // ‡∏î‡∏∂‡∏á Folder
    var folder = DriveApp.getFolderById(LOCATION_LAYOUT_FOLDER_ID);
    
    if (!folder) {
      throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö Folder Location Layout');
    }
    
    console.log('‚úÖ Folder found:', folder.getName());
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà: SW_[Survey_NO]_LocationLayout.[ext]
    var fileExtension = fileData.name.split('.').pop().toLowerCase();
    var newFileName = 'SW_' + surveyNo + '_LocationLayout.' + fileExtension;
    
    console.log('‚úÖ New file name:', newFileName);
    
    // Decode Base64
    var blob = Utilities.newBlob(
      Utilities.base64Decode(fileData.content),
      fileData.mimeType,
      newFileName
    );
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏ô Drive
    var file = folder.createFile(blob);
    
    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Permission (Anyone with link can view)
    file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
    
    var fileUrl = file.getUrl();
    var fileId = file.getId();
    
    console.log('‚úÖ File uploaded successfully');
    console.log('File ID:', fileId);
    console.log('File URL:', fileUrl);
    console.log('========== Upload Survey Location Layout END ==========');
    
    return {
      success: true,
      fileUrl: fileUrl,
      fileId: fileId,
      fileName: file.getName(),
      originalFileName: fileData.name
    };
    
  } catch (error) {
    console.error('========== Upload Survey Location Layout FAILED ==========');
    console.error('Error:', error);
    console.error('Stack:', error.stack);
    
    // ‚úÖ‚úÖ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ ‚úÖ‚úÖ‚úÖ
    logError('uploadSurveyLocationLayout', error, {
      surveyNo: surveyNo,
      fileName: fileData.name || 'unknown',
      mimeType: fileData.mimeType || 'unknown',
      fileSize: fileData.content ? fileData.content.length : 0,
      folderId: '11xT2Ik1A5yD8S7yPaVEEeVfJGKLY5LRW'
    }, 'ERROR');
    
    return {
      success: false,
      message: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå: ' + error.toString()
    };
  }
}

function uploadLocationLayout(fileData, rfiId) {
  try {
    console.log('========== Upload Location Layout START ==========');
    console.log('RFI ID:', rfiId);
    console.log('Original file name:', fileData.name);
    console.log('MIME type:', fileData.mimeType);
    
    // Folder ID
    var LOCATION_LAYOUT_FOLDER_ID = '11xT2Ik1A5yD8S7yPaVEEeVfJGKLY5LRW';
    
    // ‡∏î‡∏∂‡∏á Folder
    var folder = DriveApp.getFolderById(LOCATION_LAYOUT_FOLDER_ID);
    
    if (!folder) {
      throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö Folder Location Layout');
    }
    
    console.log('‚úÖ Folder found:', folder.getName());
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà: RFI_[ID]_LocationLayout.[ext]
    var fileExtension = fileData.name.split('.').pop().toLowerCase();
    var newFileName = 'RFI_' + rfiId + '_LocationLayout.' + fileExtension;
    
    console.log('‚úÖ New file name:', newFileName);
    
    // Decode Base64
    var blob = Utilities.newBlob(
      Utilities.base64Decode(fileData.content),
      fileData.mimeType,
      newFileName
    );
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏ô Drive
    var file = folder.createFile(blob);
    
    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Permission (Anyone with link can view)
    file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
    
    var fileUrl = file.getUrl();
    var fileId = file.getId();
    
    console.log('‚úÖ File uploaded successfully');
    console.log('File ID:', fileId);
    console.log('File URL:', fileUrl);
    console.log('========== Upload Location Layout END ==========');
    
    return {
      success: true,
      fileUrl: fileUrl,
      fileId: fileId,
      fileName: file.getName(),
      originalFileName: fileData.name
    };
    
  } catch (error) {
    console.error('========== Upload Location Layout FAILED ==========');
    console.error('Error:', error);
    console.error('Stack:', error.stack);
    
    // ‚úÖ‚úÖ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ ‚úÖ‚úÖ‚úÖ
    logError('uploadLocationLayout', error, {
      rfiId: rfiId,
      fileName: fileData.name || 'unknown',
      mimeType: fileData.mimeType || 'unknown',
      fileSize: fileData.content ? fileData.content.length : 0,
      folderId: '11xT2Ik1A5yD8S7yPaVEEeVfJGKLY5LRW'
    }, 'ERROR'); // ERROR ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÑ‡∏°‡πà‡∏£‡πâ‡∏≤‡∏¢‡πÅ‡∏£‡∏á‡πÄ‡∏ó‡πà‡∏≤ save function
    
    return {
      success: false,
      message: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå: ' + error.toString()
    };
  }
}

function saveRFIRequirement(data) {
  // ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏°: ‡∏™‡∏£‡πâ‡∏≤‡∏á Array ‡πÄ‡∏Å‡πá‡∏ö Progress
  var progress = [];
  var isInternal = data.inspectionType === 'internal';
  
  try {
    console.log('========== saveRFIRequirement START ==========');
    console.log('Inspection Type:', data.inspectionType);
    console.log('Has file:', !!data.locationLayoutFile);
    
    // ‚≠ê Step 1: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    progress.push('‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
    
    // Validation
    if (!data.inspectionType || !data.requestDate || !data.startTime || !data.endTime || 
        !data.workType || !data.description || !data.location || 
        !data.requesterName || !data.requesterEmail || !data.teamCategory) {
      return {
        success: false,
        message: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô',
        progress: progress
      };
    }
    
    // ‚≠ê ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    if (!data.locationLayoutFile) {
      return {
        success: false,
        message: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏ô‡∏ö‡πÑ‡∏ü‡∏•‡πå Location Layout',
        progress: progress
      };
    }
    
    const userValidation = validateAndGetUser(data.requesterEmail, data.requesterName);
    
    if (!userValidation.success) {
      return {
        success: false,
        message: userValidation.message,
        progress: progress
      };
    }
    
    const validatedEmail = userValidation.email;
    const validatedName = userValidation.name;
    
    // ‚≠ê Step 2: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    progress.push('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
    
    // ‡∏à‡∏±‡∏î‡∏ó‡∏µ‡∏°‡∏ï‡∏≤‡∏° Inspection Type
    let teamAssignment;
    
    if (data.inspectionType === 'internal') {
      teamAssignment = assignTeamAutomatically(
        data.teamCategory,
        data.requestDate,
        data.startTime,
        data.endTime,
        null,
        false,
        data.workType
      );
    } else {
      teamAssignment = assignTeamAutomatically(
        data.teamCategory,
        data.requestDate,
        data.startTime,
        data.endTime,
        null,
        false,
        data.workType
      );
    }
    
    if (!teamAssignment || !teamAssignment.success) {
      return {
        success: false,
        message: teamAssignment ? teamAssignment.message : '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏±‡∏î‡∏ó‡∏µ‡∏°‡πÑ‡∏î‡πâ',
        progress: progress
      };
    }
    
    const rfiId = generateUniqueId();
    console.log('Generated ID:', rfiId);
    
    // ‚≠ê Step 3: ‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå
    progress.push('‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå');
    
    console.log('Uploading file to Drive...');
    const uploadResult = uploadLocationLayout(data.locationLayoutFile, rfiId);
    
    if (!uploadResult.success) {
      console.error('File upload failed:', uploadResult.message);
      return {
        success: false,
        message: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏î‡πâ: ' + uploadResult.message,
        progress: progress
      };
    }
    
    console.log('‚úÖ File uploaded:', uploadResult.fileUrl);
    
    let sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('RFI_List');
    
    if (!sheet) {
      sheet = createRFIListSheet();
    }
    
    const lastRow = sheet.getLastRow();
    const nextRow = lastRow + 1;
    const currentTime = new Date();
    
    const combinedDescription = data.workType + ' - ' + data.description;
    
    const dateParts = data.requestDate.split('-');
    const formattedDate = dateParts[1] + '/' + dateParts[2] + '/' + dateParts[0];
    
    // ‚≠ê ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• 41 columns (‡πÄ‡∏û‡∏¥‡πà‡∏° Column AO = index 40)
    const rowData = [];
    for (let i = 0; i < 41; i++) {
      rowData.push('');
    }
    
    rowData[0] = rfiId;
    rowData[2] = combinedDescription;
    rowData[3] = data.location;
    rowData[4] = formattedDate;
    rowData[5] = data.startTime;
    rowData[6] = data.endTime;
    rowData[9] = validatedEmail;
    rowData[10] = validatedName;
    rowData[11] = teamAssignment.teamNames;
    
    // ‡∏ï‡∏±‡πâ‡∏á Status ‡πÅ‡∏•‡∏∞ Column AN ‡∏ï‡∏≤‡∏° Inspection Type
    if (data.inspectionType === 'internal') {
      rowData[14] = 'Internal Inspection Submitted';
      rowData[39] = 'Internal Inspection';
    } else {
      rowData[14] = 'RFI Request Submitted';
      rowData[39] = 'RFI Work';
    }
    
    rowData[15] = currentTime;
    rowData[40] = uploadResult.fileUrl; // ‚≠ê Column AO (index 40) - Location Layout URL
    
    sheet.getRange(nextRow, 1, 1, 41).setValues([rowData]);
    console.log('Data added to sheet successfully');
    
    // ‚≠ê Step 4: ‡∏™‡∏£‡πâ‡∏≤‡∏á Calendar Event (‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Internal)
    let calendarResult = null;
    
    if (isInternal) {
      progress.push('‡∏™‡∏£‡πâ‡∏≤‡∏á Calendar Event');
      
      const categoryDisplay = data.teamCategory.replace(/,/g, ', ');
      
      const calendarData = {
        requestDate: data.requestDate,
        startTime: data.startTime,
        endTime: data.endTime,
        description: combinedDescription,
        location: data.location,
        requesterName: validatedName,
        requesterEmail: validatedEmail,
        assignedTeam: teamAssignment.teamNames,
        teamCategory: categoryDisplay,
        locationLayoutUrl: uploadResult.fileUrl
      };
      
      calendarResult = createInternalInspectionCalendarEvent(calendarData, rfiId);
    }
    
    // ‚≠ê Step 5: ‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
    progress.push('‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô');
    
    let emailSent = false;
    
    if (data.inspectionType === 'internal') {
      const categoryDisplay = data.teamCategory.replace(/,/g, ', ');
      
      const emailData = {
        requestDate: data.requestDate,
        startTime: data.startTime,
        endTime: data.endTime,
        description: combinedDescription,
        location: data.location,
        requesterName: validatedName,
        requesterEmail: validatedEmail,
        assignedTeam: teamAssignment.teamNames,
        teamCategory: categoryDisplay,
        locationLayoutUrl: uploadResult.fileUrl
      };
      
      emailSent = sendInternalInspectionNotificationEmail(emailData, rfiId);
      
    } else {
      const categoryDisplay = data.teamCategory.replace(/,/g, ', ');
      
      const emailData = {
        requestDate: data.requestDate,
        startTime: data.startTime,
        endTime: data.endTime,
        description: combinedDescription,
        location: data.location,
        requesterName: validatedName,
        requesterEmail: validatedEmail,
        assignedTeam: teamAssignment.teamNames,
        teamCategory: categoryDisplay,
        locationLayoutUrl: uploadResult.fileUrl
      };
      
      emailSent = sendRFINotificationEmail(emailData, rfiId);
    }
    
    // ‚≠ê Step 6: ‡∏à‡∏±‡∏î‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô (‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡∏ï‡∏≠‡∏ô‡∏ï‡πâ‡∏ô)
    progress.push('‡∏à‡∏±‡∏î‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô');
    
    let message = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ' + (data.inspectionType === 'internal' ? 'Internal Inspection' : 'RFI Request') + ' ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß (ID: ' + rfiId + ')';
    message += '\n‡∏á‡∏≤‡∏ô: ' + data.workType;
    message += '\n‡∏´‡∏°‡∏ß‡∏î‡∏á‡∏≤‡∏ô: ' + data.teamCategory.replace(/,/g, ', ');
    message += '\n‡∏à‡∏±‡∏î‡∏ó‡∏µ‡∏°: ' + teamAssignment.teamNames;
    message += '\n‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó: ' + (data.inspectionType === 'internal' ? 'Internal Inspection' : 'RFI Work');
    message += '\nüìé ‡πÑ‡∏ü‡∏•‡πå: ' + uploadResult.fileName;
    
    if (!userValidation.exists) {
      message += '\n‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡πâ‡∏ß';
    }
    
    if (data.inspectionType === 'internal') {
      if (calendarResult && calendarResult.success) {
        message += '\n‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á Calendar Event ‡πÅ‡∏•‡πâ‡∏ß (‡∏™‡∏µ‡∏™‡πâ‡∏°)';
      } else {
        message += '\n‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á Calendar Event ‡πÑ‡∏î‡πâ';
      }
    }
    
    if (emailSent) {
      message += '\n‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏à‡πâ‡∏á‡∏ó‡∏µ‡∏° QC ‡πÅ‡∏•‡∏∞‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß';
    }
    
    console.log('========== saveRFIRequirement SUCCESS ==========');
    
    // ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏°: ‡∏™‡πà‡∏á progress ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ
    return {
      success: true,
      message: message,
      rfiId: rfiId,
      emailSent: emailSent,
      calendarCreated: data.inspectionType === 'internal' ? (calendarResult && calendarResult.success) : false,
      userAdded: !userValidation.exists,
      assignedTeam: teamAssignment.teamNames,
      workType: data.workType,
      inspectionType: data.inspectionType,
      fileUrl: uploadResult.fileUrl,
      fileName: uploadResult.fileName,
      progress: progress // ‚≠ê ‡∏™‡πà‡∏á progress ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ
    };
    
  } catch (error) {
    console.error('========== saveRFIRequirement FAILED ==========');
    console.error('Error:', error);
    
    // ‚úÖ‚úÖ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ - Log Error ‡∏•‡∏á Sheet ‚úÖ‚úÖ‚úÖ
    logError('saveRFIRequirement', error, {
      inspectionType: data.inspectionType || 'unknown',
      teamCategory: data.teamCategory || 'unknown',
      requestDate: data.requestDate || 'unknown',
      workType: data.workType || 'unknown',
      requesterEmail: data.requesterEmail || 'unknown',
      hasFile: !!data.locationLayoutFile
    }, 'CRITICAL'); // CRITICAL ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å
    
    return {
      success: false,
      message: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.toString()
    };
  }
}

// ===== Sheet Creation Functions =====
function createRFIListSheet() {
  try {
    const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    let sheet = spreadsheet.getSheetByName('RFI_List');
    
    if (sheet) {
      console.log('RFI_List sheet already exists');
      return sheet;
    }
    
    sheet = spreadsheet.insertSheet('RFI_List');
    
    const headers = [
      'ID_RFI', '', 'description', 'Location', 'Request_Date',
      'Start_Time', 'End_Time', 'Assigned_Team', '', 'Requester_Email',
      'Requester_Name', '', 'Assigned_Inspector', '', 'Status', 'Created_Timestamp'
    ];
    
    sheet.getRange(1, 1, 1, headers.length).setValues([headers]);
    
    const headerRange = sheet.getRange(1, 1, 1, headers.length);
    headerRange.setFontWeight('bold');
    headerRange.setBackground('#1877f2');
    headerRange.setFontColor('#ffffff');
    headerRange.setHorizontalAlignment('center');
    
    sheet.setFrozenRows(1);
    
    console.log('RFI_List sheet created successfully');
    return sheet;
    
  } catch (error) {
    console.error('Error creating RFI_List sheet:', error);
    throw error;
  }
}



function updateAvailableSlots() {
  const date = document.getElementById('requestDate').value;
  const startTimeSelect = document.getElementById('startTime');
  const endTimeSelect = document.getElementById('endTime');
  
  setSelectLoading(startTimeSelect, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á...');
  resetEndTimeSelect();
  
  if (date) {
    const selectedDate = new Date(date + 'T00:00:00');
    const today = new Date();
    const todayDateOnly = new Date(today.getFullYear(), today.getMonth(), today.getDate());
    const selectedDateOnly = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), selectedDate.getDate());
    
    if (selectedDateOnly <= todayDateOnly) {
      startTimeSelect.className = startTimeSelect.className.replace(' loading-select', '');
      startTimeSelect.innerHTML = '<option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏ô‡πÑ‡∏õ --</option>';
      startTimeSelect.disabled = true;
      showMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏ß‡∏±‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ', 'warning');
      return;
    }
    
    // ‡∏™‡πà‡∏á category ‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢
    const category = selectedTeamCategory;
    
    google.script.run
      .withSuccessHandler(function(availableSlots) {            
        startTimeSelect.className = startTimeSelect.className.replace(' loading-select', '');
        startTimeSelect.innerHTML = '';
        
        if (!availableSlots || availableSlots.length === 0) {
          startTimeSelect.innerHTML = '<option value="">-- ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏ß‡∏•‡∏≤‡∏ß‡πà‡∏≤‡∏á --</option>';
          startTimeSelect.disabled = true;
          showMessage('‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏ß‡∏•‡∏≤‡∏ß‡πà‡∏≤‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å', 'warning');
        } else {
          startTimeSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô --</option>';
          
          availableSlots.forEach(function(slot) {
            const option = document.createElement('option');
            option.value = slot;
            option.textContent = slot + ' ‡∏ô.';
            startTimeSelect.appendChild(option);
          });
          
          startTimeSelect.disabled = false;
        }
      })
      .withFailureHandler(function(error) {
        console.error('Error getting available slots:', error);
        
        startTimeSelect.className = startTimeSelect.className.replace(' loading-select', '');
        startTimeSelect.innerHTML = '<option value="">-- ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î --</option>';
        startTimeSelect.disabled = true;
        
        showMessage('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á: ' + error.message, 'error');
      })
      .getAvailableTimeSlots(date, category);  // ‡∏™‡πà‡∏á category ‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢
  } else {
    startTimeSelect.innerHTML = '<option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡πà‡∏≠‡∏ô --</option>';
    startTimeSelect.disabled = true;
  }
}

function updateEndTimeSlots() {
  var date = document.getElementById('requestDate').value;
  var startTime = document.getElementById('startTime').value;
  var endTimeSelect = document.getElementById('endTime');
  
  if (!startTime) {
    resetEndTimeSelect();
    return;
  }
  
  setSelectLoading(endTimeSelect, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î...');
  
  if (date && startTime) {
    // ‚úÖ ‡∏î‡∏∂‡∏á Work Type ‡πÅ‡∏•‡∏∞ Duration
    var workTypeSelect = document.getElementById('workType');
    var selectedOption = workTypeSelect.options[workTypeSelect.selectedIndex];
    var duration = parseInt(selectedOption.getAttribute('data-duration')) || 60;
    var workType = workTypeSelect.value; // ‚úÖ ‡∏î‡∏∂‡∏á Work Type
    
    var startParts = startTime.split(':');
    var startHour = parseInt(startParts[0]);
    var startMin = parseInt(startParts[1]);
    
    // ‚úÖ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì End Time ‡∏à‡∏≤‡∏Å Duration
    var totalMinutes = (startHour * 60) + startMin + duration;
    var endHour = Math.floor(totalMinutes / 60);
    var endMin = totalMinutes % 60;
    
    var defaultEndTime = endHour.toString().padStart(2, '0') + ':' + 
                        endMin.toString().padStart(2, '0');
    
    var category = selectedTeamCategory;
    
    google.script.run
      .withSuccessHandler(function(availableEndTimes) {
        endTimeSelect.className = endTimeSelect.className.replace(' loading-select', '');
        endTimeSelect.innerHTML = '';
        
        if (!availableEndTimes || availableEndTimes.length === 0) {
          endTimeSelect.innerHTML = '<option value="">-- ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á --</option>';
          endTimeSelect.disabled = true;
          showMessage('‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°', 'warning');
        } else {
          endTimeSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î --</option>';
          
          availableEndTimes.forEach(function(time) {
            var option = document.createElement('option');
            option.value = time;
            option.textContent = time + ' ‡∏ô.';
            if (time === defaultEndTime) {
              option.selected = true;
            }
            endTimeSelect.appendChild(option);
          });
          
          endTimeSelect.disabled = false;
          
          if (availableEndTimes.includes(defaultEndTime)) {
            showMessage('‚úÖ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô: ' + defaultEndTime + ' ‡∏ô. (' + duration + ' ‡∏ô‡∏≤‡∏ó‡∏µ)', 'info', 3000);
          }
        }
      })
      .withFailureHandler(function(error) {
        endTimeSelect.className = endTimeSelect.className.replace(' loading-select', '');
        endTimeSelect.innerHTML = '<option value="">-- ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î --</option>';
        endTimeSelect.disabled = true;
        showMessage('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î', 'error');
      })
      .getAvailableEndTimes(date, startTime, category, workType); // ‚úÖ ‡∏™‡πà‡∏á workType
  }
}


function initTeamCategoryButtons() {
  const teamButtons = document.querySelectorAll('.team-btn');
  const multiSelectContainer = document.getElementById('multiSelectContainer');
  const multiWorkBtn = document.getElementById('multiWorkBtn');
  
  teamButtons.forEach(function(btn) {
    btn.addEventListener('click', function() {
      // ... ‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏° ...
      
      // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ: ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡πÇ‡∏´‡∏•‡∏î time slots ‡πÉ‡∏´‡∏°‡πà
      const requestDate = document.getElementById('requestDate').value;
      if (requestDate) {
        updateAvailableSlots();
      }
    });
  });
}

function updateMultiWorkSelection() {
  if (!isMultiWork) return;
  
  const checkboxes = document.querySelectorAll('#multiSelectContainer input[type="checkbox"]:checked');
  const selectedCategories = [];
  
  checkboxes.forEach(function(cb) {
    selectedCategories.push(cb.value);
  });
  
  if (selectedCategories.length > 0) {
    selectedTeamCategory = selectedCategories.join(',');
    document.getElementById('teamCategory').value = selectedTeamCategory;
    showMessage('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: ' + selectedTeamCategory, 'info', 2000);
    
    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ: ‡πÇ‡∏´‡∏•‡∏î time slots ‡πÉ‡∏´‡∏°‡πà
    const requestDate = document.getElementById('requestDate').value;
    if (requestDate) {
      updateAvailableSlots();
    }
  } else {
    selectedTeamCategory = null;
    document.getElementById('teamCategory').value = '';
  }
}


/**
 * ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Code ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
 */
function getCodeList() {
  try {
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Code');
    
    if (!sheet) {
      console.log('Code sheet not found');
      return [];
    }
    
    const lastRow = sheet.getLastRow();
    if (lastRow <= 1) {
      console.log('No codes found');
      return [];
    }
    
    const data = sheet.getRange(2, 1, lastRow - 1, 3).getValues();
    const codes = [];
    
    for (let i = 0; i < data.length; i++) {
      const id = data[i][0];
      const code = String(data[i][1] || '').trim();
      const name = String(data[i][2] || '').trim();
      
      if (code) {
        codes.push({
          id: id,
          code: code,
          name: name
        });
      }
    }
    
    console.log('Found codes:', codes.length);
    return codes;
    
  } catch (error) {
    console.error('Error getting code list:', error);
    return [];
  }
}

/**
 * ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Resources ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà Activated
 */
function getAllResourcesList() {
  try {
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Resources');
    
    if (!sheet) {
      console.log('Resources sheet not found');
      return [];
    }
    
    const lastRow = sheet.getLastRow();
    if (lastRow <= 1) {
      console.log('No resources found');
      return [];
    }
    
    const data = sheet.getRange(2, 1, lastRow - 1, 5).getValues();
    const resources = [];
    
    for (let i = 0; i < data.length; i++) {
      const resourceId = String(data[i][0] || '').trim();
      const resourceName = String(data[i][1] || '').trim();
      const subType = String(data[i][2] || '').trim();
      const teamNo = data[i][3];
      const status = String(data[i][4] || '').trim();
      
      if (status === 'Activated' && resourceId && resourceName) {
        resources.push({
          id: resourceId,
          name: resourceName,
          subType: subType,
          teamNo: teamNo
        });
      }
    }
    
    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏° Team No.
    resources.sort(function(a, b) {
      return a.teamNo - b.teamNo;
    });
    
    console.log('Found resources:', resources.length);
    return resources;
    
  } catch (error) {
    console.error('Error getting resources list:', error);
    return [];
  }
}

/**
 * ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Requester (Role = Requester, Status = Activated)
 */
function getRequesterList() {
  try {
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('User');
    
    if (!sheet) {
      console.log('User sheet not found');
      return [];
    }
    
    const lastRow = sheet.getLastRow();
    if (lastRow <= 1) {
      console.log('No users found');
      return [];
    }
    
    const data = sheet.getRange(2, 2, lastRow - 1, 4).getValues();
    const requesters = [];
    
    for (let i = 0; i < data.length; i++) {
      const email = String(data[i][0] || '').trim();
      const name = String(data[i][1] || '').trim();
      const role = String(data[i][2] || '').trim();
      const status = String(data[i][3] || '').trim();
      
      if (role === 'Requester' && status === 'Activated' && email && name) {
        requesters.push({
          email: email,
          name: name
        });
      }
    }
    
    console.log('Found requesters:', requesters.length);
    return requesters;
    
  } catch (error) {
    console.error('Error getting requester list:', error);
    return [];
  }
}

/**
 * ‡∏î‡∏∂‡∏á email ‡∏Ç‡∏≠‡∏á user ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
 */

/**
 * ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Order_RFI ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
 */
function getNextOrderRFI(code) {
  try {
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('RFI_List');
    
    if (!sheet) {
      return 1;
    }
    
    const lastRow = sheet.getLastRow();
    if (lastRow <= 1) {
      return 1;
    }
    
    // ‡∏î‡∏∂‡∏á Column H (Order_RFI) ‡πÅ‡∏•‡∏∞ I (Code)
    const data = sheet.getRange(2, 8, lastRow - 1, 2).getValues();
    
    let maxOrder = 0;
    
    for (let i = 0; i < data.length; i++) {
      const orderRFI = data[i][0];
      const rfiCode = String(data[i][1] || '').trim();
      
      if (rfiCode === code && orderRFI && !isNaN(orderRFI)) {
        if (orderRFI > maxOrder) {
          maxOrder = orderRFI;
        }
      }
    }
    
    return maxOrder + 1;
    
  } catch (error) {
    console.error('Error getting next order RFI:', error);
    return 1;
  }
}

/**
 * ‚≠ê ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Order_Survey ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ (‡πÅ‡∏¢‡∏Å‡∏à‡∏≤‡∏Å Order_RFI)
 */
function getNextOrderSurvey() {
  try {
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('RFI_List');
    
    if (!sheet) {
      return 1;
    }
    
    const lastRow = sheet.getLastRow();
    if (lastRow <= 1) {
      return 1;
    }
    
    // ‡∏î‡∏∂‡∏á Column H (Order) ‡πÅ‡∏•‡∏∞ Column AN (Type)
    const orderData = sheet.getRange(2, 8, lastRow - 1, 1).getValues();  // Column H
    const typeData = sheet.getRange(2, 40, lastRow - 1, 1).getValues();   // Column AN
    
    let maxOrder = 0;
    
    for (let i = 0; i < orderData.length; i++) {
      const order = orderData[i][0];
      const type = String(typeData[i][0] || '').trim();
      
      // ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Survey Work ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
      if (type === 'Survey Work' && order && !isNaN(order)) {
        if (order > maxOrder) {
          maxOrder = order;
        }
      }
    }
    
    console.log('‚úÖ Next Order_Survey:', maxOrder + 1);
    return maxOrder + 1;
    
  } catch (error) {
    console.error('Error getting next order Survey:', error);
    return 1;
  }
}

function saveQCRFI(data) {
  try {
    console.log('========== saveQCRFI START ==========');
    console.log('Input data:', JSON.stringify(data));
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Role
    const roleValidation = validateQCRole();
    if (!roleValidation.success) {
      return {
        success: false,
        message: roleValidation.message
      };
    }
    
    console.log('QC Role validated:', roleValidation.name, roleValidation.role);
    
    // ‚úÖ FIXED: Validation - ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö Work Type
    if (!data.workType || !data.requestDate || !data.startTime || 
        !data.description || !data.location || !data.assignedInspector || 
        !data.requesterEmail || !data.requesterName) {
      
      // Debug: ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î
      const missing = [];
      if (!data.workType) missing.push('Work Type');
      if (!data.requestDate) missing.push('Request Date');
      if (!data.startTime) missing.push('Start Time');
      if (!data.description) missing.push('Description');
      if (!data.location) missing.push('Location');
      if (!data.assignedInspector) missing.push('Assigned Inspector');
      if (!data.requesterEmail) missing.push('Requester Email');
      if (!data.requesterName) missing.push('Requester Name');
      
      console.log('‚ùå Missing fields:', missing);
      
      return {
        success: false,
        message: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô (‡∏£‡∏ß‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô)\n‡∏Ç‡∏≤‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ' + missing.join(', ')
      };
    }
    
    // ‚úÖ ‡∏î‡∏∂‡∏á Sequence, QC_Type ‡πÅ‡∏•‡∏∞ Duration ‡∏à‡∏≤‡∏Å Sheet "Work"
    const workSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Work');
    if (!workSheet) {
      return {
        success: false,
        message: '‡πÑ‡∏°‡πà‡∏û‡∏ö Sheet "Work"'
      };
    }
    
    const lastRow = workSheet.getLastRow();
    const workData = workSheet.getRange(2, 1, lastRow - 1, 7).getValues();
    
    let sequence = '';
    let qcType = '';
    let duration = 60; // Default
    
    // ‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Work Type ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
    for (let i = 0; i < workData.length; i++) {
      const nameWork = String(workData[i][1] || '').trim();
      
      if (nameWork === data.workType) {
        duration = parseInt(workData[i][4]) || 60;       // Column E - Duration
        sequence = String(workData[i][5] || '').trim();   // Column F - Sequence
        qcType = String(workData[i][6] || '').trim();     // Column G - QC_Type
        break;
      }
    }
    
    if (!sequence || !qcType) {
      return {
        success: false,
        message: 'Work Type "' + data.workType + '" ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Sequence ‡∏´‡∏£‡∏∑‡∏≠ QC_Type\n' +
                '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Sheet "Work"'
      };
    }
    
    console.log('‚úÖ Work Type:', data.workType);
    console.log('‚úÖ Duration:', duration, 'minutes');
    console.log('‚úÖ Sequence:', sequence, ', QC_Type:', qcType);
    
    // ‚úÖ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏ö‡∏∏)
    let endTime = data.endTime;
    
    if (!endTime) {
      const startParts = data.startTime.split(':');
      const startHour = parseInt(startParts[0]);
      const startMinute = parseInt(startParts[1]);
      
      // ‡∏ö‡∏ß‡∏Å duration (‡∏´‡∏ô‡πà‡∏ß‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡∏ô‡∏≤‡∏ó‡∏µ)
      const totalMinutes = (startHour * 60) + startMinute + duration;
      const endHour = Math.floor(totalMinutes / 60);
      const endMinute = totalMinutes % 60;
      
      endTime = endHour.toString().padStart(2, '0') + ':' + endMinute.toString().padStart(2, '0');
      
      console.log('‚úÖ Auto-calculated End Time:', endTime, '(Start:', data.startTime, '+ Duration:', duration, 'min)');
    }
    
    // ‡∏î‡∏∂‡∏á Sheet
    let sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('RFI_List');
    
    if (!sheet) {
      console.log('RFI_List sheet not found, creating new one...');
      sheet = createRFIListSheet();
    }
    
    const rfiListLastRow = sheet.getLastRow();
    const nextRow = rfiListLastRow + 1;
    const currentTime = new Date();
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á Unique ID
    const rfiId = generateUniqueId();
    console.log('Generated ID:', rfiId);
    
    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Running Number
    const orderRFI = getNextOrderRFIBySequenceAndType(sequence, qcType);
    console.log('Order RFI:', orderRFI);
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á RFI_NO
    const orderRFIPadded = String(orderRFI).padStart(4, '0');
    const rfiNo = 'ITD-TTLR-' + sequence + '-RFI-' + qcType + '-' + orderRFIPadded;
    console.log('RFI NO:', rfiNo);
    
    // Format date
    const dateParts = data.requestDate.split('-');
    const formattedDate = dateParts[1] + '/' + dateParts[2] + '/' + dateParts[0];
    
    console.log('Adding data to sheet at row:', nextRow);
    
    // ‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á Combined Description (Work Type + Description)
    const combinedDescription = data.workType + ' - ' + data.description;
    
    // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• 41 columns
    const rowData = [];
    for (let i = 0; i < 41; i++) {
      rowData.push('');
    }
    
    rowData[0] = rfiId;                          // A - ID
    rowData[1] = rfiNo;                          // B - RFI_NO
    rowData[2] = combinedDescription;            // C - description (‚úÖ ‡∏£‡∏ß‡∏° Work Type)
    rowData[3] = data.location;                  // D - Location
    rowData[4] = formattedDate;                  // E - Request_Date
    rowData[5] = data.startTime;                 // F - Start_Time
    rowData[6] = endTime;                        // G - End_Time (‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏•‡πâ‡∏ß)
    rowData[7] = orderRFI;                       // H - Order_RFI
    rowData[8] = sequence + '-' + qcType;        // I - Code
    rowData[9] = data.requesterEmail;            // J - Requester_Email
    rowData[10] = data.requesterName;            // K - Requester_Name
    rowData[11] = data.assignedInspector;        // L - Assigned_Inspector
    rowData[14] = 'Draft';                       // O - Status
    rowData[15] = currentTime;                   // P - Created_Timestamp
    rowData[16] = roleValidation.email;          // Q - Recorded By
    rowData[18] = 'Open RFI';                    // S - Type
    rowData[19] = data.requireSurveyReport || 'None';  // T
    rowData[20] = data.requireLabReport || 'None';     // U
    rowData[39] = 'RFI Work';                    // AN
    
    console.log('Row data prepared');
    
    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
    sheet.getRange(nextRow, 1, 1, 41).setValues([rowData]);
    console.log('Data added to sheet successfully');
    
    let message = '‡∏™‡∏£‡πâ‡∏≤‡∏á RFI ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß ‚úÖ\n\n';
    message += 'üìã RFI NO: ' + rfiNo + '\n';
    message += 'üîß Work Type: ' + data.workType + '\n';
    message += '‚è±Ô∏è Duration: ' + duration + ' ‡∏ô‡∏≤‡∏ó‡∏µ\n';
    message += 'üïê ‡πÄ‡∏ß‡∏•‡∏≤: ' + data.startTime + ' - ' + endTime + ' ‡∏ô.\n';
    message += 'üë• ‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô: ' + data.assignedInspector + '\n';
    message += 'üë§ ‡∏ú‡∏π‡πâ‡∏Ç‡∏≠: ' + data.requesterName + '\n';
    message += '‚úçÔ∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÇ‡∏î‡∏¢: ' + roleValidation.name;
    
    console.log('========== saveQCRFI SUCCESS ==========');
    
    return {
      success: true,
      message: message,
      rfiId: rfiId,
      rfiNo: rfiNo
    };
    
  } catch (error) {
    console.error('========== saveQCRFI FAILED ==========');
    console.error('Error:', error);
    console.error('Stack:', error.stack);
    
    // ‚úÖ‚úÖ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ ‚úÖ‚úÖ‚úÖ
    logError('saveQCRFI', error, {
      workType: data.workType || 'unknown',
      requestDate: data.requestDate || 'unknown',
      assignedInspector: data.assignedInspector || 'unknown',
      requesterEmail: data.requesterEmail || 'unknown'
    }, 'CRITICAL');
    
    return {
      success: false,
      message: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.toString()
    };
  }
}
/**
 * ‚≠ê ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Running Number ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ (‡∏ï‡∏≤‡∏° Sequence + QC_Type)
 */
function getNextOrderRFIBySequenceAndType(sequence, qcType) {
  try {
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('RFI_List');
    
    if (!sheet) {
      return 1;
    }
    
    const lastRow = sheet.getLastRow();
    if (lastRow <= 1) {
      return 1;
    }
    
    // ‡∏î‡∏∂‡∏á Column H (Order_RFI) ‡πÅ‡∏•‡∏∞ I (Code ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö Sequence-QC_Type)
    const data = sheet.getRange(2, 8, lastRow - 1, 2).getValues();
    
    let maxOrder = 0;
    const searchKey = sequence + '-' + qcType;
    
    for (let i = 0; i < data.length; i++) {
      const orderRFI = data[i][0];
      const rfiCode = String(data[i][1] || '').trim();
      
      if (rfiCode === searchKey && orderRFI && !isNaN(orderRFI)) {
        if (orderRFI > maxOrder) {
          maxOrder = orderRFI;
        }
      }
    }
    
    console.log('Max Order for', searchKey, '=', maxOrder);
    return maxOrder + 1;
    
  } catch (error) {
    console.error('Error getting next order RFI:', error);
    return 1;
  }
}


/**
 * ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Resources ‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á ‡∏ì ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô RFI)
 */
function getAvailableResourcesList(date, startTime, endTime, excludeRfiId) {
  try {
    console.log('Getting available resources for:', date, startTime, endTime, 'Exclude RFI:', excludeRfiId);
    
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Resources');
    
    if (!sheet) {
      console.log('Resources sheet not found');
      return [];
    }
    
    const lastRow = sheet.getLastRow();
    if (lastRow <= 1) {
      console.log('No resources found');
      return [];
    }
    
    const data = sheet.getRange(2, 1, lastRow - 1, 5).getValues();
    const availableResources = [];
    
    for (let i = 0; i < data.length; i++) {
      const resourceId = String(data[i][0] || '').trim();
      const resourceName = String(data[i][1] || '').trim();
      const subType = String(data[i][2] || '').trim();
      const teamNo = data[i][3];
      const status = String(data[i][4] || '').trim();
      
      if (status === 'Activated' && resourceId && resourceName) {
        // ‚≠ê ‡∏™‡πà‡∏á excludeRfiId ‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢
        if (isTeamAvailable(resourceId, date, startTime, endTime, excludeRfiId)) {
          availableResources.push({
            id: resourceId,
            name: resourceName,
            subType: subType,
            teamNo: teamNo
          });
        }
      }
    }
    
    availableResources.sort(function(a, b) {
      return a.teamNo - b.teamNo;
    });
    
    console.log('Found available resources:', availableResources.length);
    return availableResources;
    
  } catch (error) {
    console.error('Error getting available resources list:', error);
    return [];
  }
}

/**
 * ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ User ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÄ‡∏õ‡πá‡∏ô QC ‡∏´‡∏£‡∏∑‡∏≠ QC Reviewer ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
 */
function validateQCRole() {
  try {
    const userEmail = Session.getActiveUser().getEmail();
    console.log('Validating QC role for:', userEmail);
    
    const userSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('User');
    
    if (!userSheet) {
      return {
        success: false,
        message: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á User'
      };
    }
    
    const lastRow = userSheet.getLastRow();
    if (lastRow <= 1) {
      return {
        success: false,
        message: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ'
      };
    }
    
    const data = userSheet.getRange(2, 2, lastRow - 1, 4).getValues();
    
    for (let i = 0; i < data.length; i++) {
      const email = String(data[i][0] || '').trim().toLowerCase();
      const name = String(data[i][1] || '').trim();
      const role = String(data[i][2] || '').trim();
      const status = String(data[i][3] || '').trim();
      
      if (email === userEmail.toLowerCase()) {
        // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤ Role ‡πÄ‡∏õ‡πá‡∏ô QC ‡∏´‡∏£‡∏∑‡∏≠ QC Reviewer ‡πÅ‡∏•‡∏∞ Status = Activated
        if ((role === 'QC' || role === 'QC Reviewer') && status === 'Activated') {
          console.log('QC role validated:', name, role);
          return {
            success: true,
            name: name,
            role: role,
            email: email
          };
        } else {
          return {
            success: false,
            message: '‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏£‡∏∞‡∏ö‡∏ö QC (Role: ' + role + ', Status: ' + status + ')'
          };
        }
      }
    }
    
    return {
      success: false,
      message: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö'
    };
    
  } catch (error) {
    console.error('Error validating QC role:', error);
    return {
      success: false,
      message: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå: ' + error.toString()
    };
  }
}

/**
 * ‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç QC RFI
 */
function openQCEditForm() {
  const html = HtmlService.createHtmlOutputFromFile('qc_edit')
    .setWidth(900)
    .setHeight(900);
  
  SpreadsheetApp.getUi().showModalDialog(html, 'QC - ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç RFI');
}



function getRFIById(rfiId) {
  try {
    console.log('Getting RFI by ID:', rfiId);
    
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('RFI_List');
    
    if (!sheet) {
      console.log('RFI_List sheet not found');
      return null;
    }
    
    const lastRow = sheet.getLastRow();
    if (lastRow <= 1) {
      console.log('No data rows');
      return null;
    }
    
    // ‚úÖ ‡∏î‡∏∂‡∏á‡∏ñ‡∏∂‡∏á column AS (46 columns)
    const data = sheet.getRange(2, 1, lastRow - 1, 47).getValues();
    
    for (let i = 0; i < data.length; i++) {
      const row = data[i];
      const id = String(row[0] || '').trim();
      
      if (id === rfiId) {
        console.log('Found RFI:', id);
        
        let createdTimestamp = '';
        if (row[15]) {
          try {
            createdTimestamp = new Date(row[15]).toISOString();
          } catch (e) {
            createdTimestamp = String(row[15]);
          }
        }
        
        let requestDate = '';
        if (row[4]) {
          try {
            const d = new Date(row[4]);
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            requestDate = year + '-' + month + '-' + day;
          } catch (e) {
            requestDate = formatDate(new Date(row[4]));
          }
        }
        
        // ‚úÖ ‡πÅ‡∏¢‡∏Å Work Type ‡∏à‡∏≤‡∏Å description
        const fullDescription = String(row[2] || '').trim();
        let workType = '';
        let description = fullDescription;
        
        if (fullDescription.includes(' - ')) {
          const parts = fullDescription.split(' - ');
          workType = parts[0].trim();
          description = parts.slice(1).join(' - ').trim();
        }
        
        const rfiData = {
          id: id,
          rfiNo: String(row[1] || '').trim(),
          description: description,
          fullDescription: fullDescription,
          workType: workType,
          location: String(row[3] || '').trim(),
          requestDate: requestDate,
          startTime: formatTime(row[5]),
          endTime: formatTime(row[6]),
          orderRFI: row[7],
          code: String(row[8] || '').trim(),
          requesterEmail: String(row[9] || '').trim(),
          requesterName: String(row[10] || '').trim(),
          assignedInspector: String(row[11] || '').trim(),
          status: String(row[14] || '').trim(),
          createdTimestamp: createdTimestamp,
          recordedBy: String(row[16] || '').trim(),
          type: String(row[18] || '').trim(),
          requireSurveyReport: String(row[19] || '').trim(),
          requireLabReport: String(row[20] || '').trim(),
          postponeReason: String(row[35] || '').trim(),
          // ‚úÖ ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏° ITP/QC Code/ITEM/Description
          itp: String(row[41] || '').trim(),              // AP
          qcCode: String(row[42] || '').trim(),           // AQ
          item: String(row[43] || '').trim(),             // AR
          descriptionCode: String(row[44] || '').trim(),  // AS
          tagNumber: String(row[45] || '').trim(), 
          pdfRegenerationFlag: String(row[46] || '').trim(), 
          rowIndex: i + 2
        };
        
        console.log('Returning RFI data with ITP:', rfiData.itp, 'QC Code:', rfiData.qcCode);
        return rfiData;
      }
    }
    
    console.log('RFI not found');
    return null;
    
  } catch (error) {
    console.error('Error getting RFI by ID:', error);
    console.error('Stack:', error.stack);
    return null;
  }
}

/**
 * ‚úÖ FINAL VERSION: ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç RFI (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Limited Edit Mode + ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å PDF Flag)
 */
function updateQCRFI(rfiId, data) {
  try {
    console.log('========== updateQCRFI START ==========');
    console.log('RFI ID:', rfiId);
    console.log('isLimitedEdit:', data.isLimitedEdit || false);
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Role ‡∏Å‡πà‡∏≠‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
    const roleValidation = validateQCRole();
    if (!roleValidation.success) {
      return {
        success: false,
        message: roleValidation.message
      };
    }
    
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('RFI_List');
    
    if (!sheet) {
      return {
        success: false,
        message: '‡πÑ‡∏°‡πà‡∏û‡∏ö RFI_List sheet'
      };
    }
    
    // ‡∏´‡∏≤ row ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï
    const lastRow = sheet.getLastRow();
    const dataRange = sheet.getRange(2, 1, lastRow - 1, 47).getValues();
    let rowIndex = -1;
    let currentStatus = '';
    let currentType = '';
    let currentCode = '';
    
    for (let i = 0; i < dataRange.length; i++) {
      if (String(dataRange[i][0]).trim() === rfiId) {
        rowIndex = i + 2;
        currentStatus = String(dataRange[i][14] || '').trim();  // Column O
        currentType = String(dataRange[i][18] || '').trim();    // Column S ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏°
        currentCode = String(dataRange[i][8] || '').trim();
        
        console.log('üìã Current Type:', currentType);
        console.log('üìã Current Status:', currentStatus);
        console.log('üìã Current AU value:', dataRange[i][46] || '(empty)');
        
        break;
      }
    }
    
    if (rowIndex === -1) {
      return {
        success: false,
        message: '‡πÑ‡∏°‡πà‡∏û‡∏ö RFI ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç'
      };
    }
    
    console.log('‚úÖ Found RFI at row', rowIndex);
    
    // ‚≠ê‚≠ê‚≠ê ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç Limited Edit ‡∏ó‡∏µ‡πà Backend
    var isLimitedEdit = false;
    
    if (currentType === 'Open RFI') {
      const limitedStatuses = [
        'Waiting for Revised Attachment',
        'Pending QC Review',
        'Rejected by Consult ‚Äì Revise Required',
        'Revised Attachment Submitted ‚Äì Pending QC Review'
      ];
      
      isLimitedEdit = limitedStatuses.indexOf(currentStatus) !== -1;
    }
    
    console.log('üîí Backend Limited Edit Check:', isLimitedEdit);
    console.log('   Type:', currentType);
    console.log('   Status:', currentStatus);
    // ‚≠ê‚≠ê‚≠ê ‡∏à‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°
    
    // ‚úÖ Validation ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡πÇ‡∏´‡∏°‡∏î
    if (isLimitedEdit) {
      console.log('üîí Limited Edit Mode - Validating editable fields only');
      
      if (!data.itp || !data.qcCode || !data.item || !data.descriptionCode) {
        return {
          success: false,
          message: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ITP'
        };
      }
      
      if (!data.tagNumber) {
        return {
          success: false,
          message: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å TAG NUMBER'
        };
      }
      
      if (!data.description) {
        return {
          success: false,
          message: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î RFI'
        };
      }
      
      if (!data.location) {
        return {
          success: false,
          message: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà'
        };
      }
      
      console.log('‚úÖ Limited Edit validation passed');
      
    } else {
      console.log('üìù Normal Edit Mode - Validating all fields');
      
      // Validation ‡∏õ‡∏Å‡∏ï‡∏¥
      if (!data.tagNumber) {
        return {
          success: false,
          message: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å TAG NUMBER'
        };
      }

      if (!data.itp || !data.qcCode || !data.item || !data.descriptionCode) {
        return {
          success: false,
          message: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ITP'
        };
      }

      if (!data.assignedInspector) {
        return {
          success: false,
          message: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô'
        };
      }
      
      if (!data.requestDate || !data.startTime || !data.endTime) {
        return {
          success: false,
          message: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤'
        };
      }
      
      if (!data.description || !data.location) {
        return {
          success: false,
          message: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà'
        };
      }
      
      console.log('‚úÖ Normal Edit validation passed');
    }
    
    // ‚úÖ ‡∏î‡∏∂‡∏á Sequence, QC_Type ‡πÅ‡∏•‡∏∞ Duration ‡∏à‡∏≤‡∏Å Work Type
    const workSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Work');
    if (!workSheet) {
      return {
        success: false,
        message: '‡πÑ‡∏°‡πà‡∏û‡∏ö Sheet "Work"'
      };
    }
    
    const lastRowWork = workSheet.getLastRow();
    const workData = workSheet.getRange(2, 1, lastRowWork - 1, 7).getValues();
    
    let sequence = '';
    let qcType = '';
    let duration = 60;
    
    for (let i = 0; i < workData.length; i++) {
      const nameWork = String(workData[i][1] || '').trim();
      
      if (nameWork === data.workType) {
        duration = parseInt(workData[i][4]) || 60;
        sequence = String(workData[i][5] || '').trim();
        qcType = String(workData[i][6] || '').trim();
        break;
      }
    }
    
    if (!isLimitedEdit && (!sequence || !qcType)) {
      return {
        success: false,
        message: 'Work Type ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Sequence ‡∏´‡∏£‡∏∑‡∏≠ QC_Type\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Sheet "Work"'
      };
    }
    
    console.log('‚úÖ Work Type:', data.workType);
    console.log('‚úÖ Duration:', duration, 'minutes');
    console.log('‚úÖ Sequence:', sequence, ', QC_Type:', qcType);
    
    // ‚úÖ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏ö‡∏∏)
    let endTime = data.endTime;
    
    if (!isLimitedEdit && !endTime) {
      const startParts = data.startTime.split(':');
      const startHour = parseInt(startParts[0]);
      const startMinute = parseInt(startParts[1]);
      
      const totalMinutes = (startHour * 60) + startMinute + duration;
      const endHour = Math.floor(totalMinutes / 60);
      const endMinute = totalMinutes % 60;
      
      endTime = endHour.toString().padStart(2, '0') + ':' + endMinute.toString().padStart(2, '0');
      
      console.log('‚úÖ Auto-calculated End Time:', endTime);
    }
    
    // Format date
    let formattedDate = '';
    if (!isLimitedEdit) {
      const dateParts = data.requestDate.split('-');
      formattedDate = dateParts[1] + '/' + dateParts[2] + '/' + dateParts[0];
    }
    
    const currentTime = new Date();
    
    // ‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á Combined Description
    const combinedDescription = data.workType + ' - ' + data.description;
    
    // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï RFI_NO ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    let needUpdateRFINo = false;
    let newRFINo = '';
    const newCode = sequence + '-' + qcType;
    
    if (!isLimitedEdit && currentStatus === 'RFI Request Submitted' && newCode !== currentCode) {
      console.log('Code changed from', currentCode, 'to', newCode);
      const orderRFI = getNextOrderRFIBySequenceAndType(sequence, qcType);
      const orderRFIPadded = String(orderRFI).padStart(4, '0');
      newRFINo = 'ITD-TTLR-' + sequence + '-RFI-' + qcType + '-' + orderRFIPadded;
      needUpdateRFINo = true;
      
      console.log('New RFI_NO:', newRFINo, 'Order:', orderRFI);
    }
    
    // ‚úÖ‚úÖ‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    if (isLimitedEdit) {
      // ========== LIMITED EDIT MODE ==========
      console.log('üîí Updating Limited Edit fields only');
      
      sheet.getRange(rowIndex, 3).setValue(combinedDescription);         // C - description
      sheet.getRange(rowIndex, 4).setValue(data.location);              // D - Location
      
      // ‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï ITP/Code/TAG
      sheet.getRange(rowIndex, 42).setValue(data.itp || '');            // AP - ITP
      sheet.getRange(rowIndex, 43).setValue(data.qcCode || '');         // AQ - QC_Code
      sheet.getRange(rowIndex, 44).setValue(data.item || '');           // AR - ITEM
      sheet.getRange(rowIndex, 45).setValue(data.descriptionCode || ''); // AS - Description_Code
      sheet.getRange(rowIndex, 46).setValue(data.tagNumber || '');      // AT - TAG_NUMBER
      
      console.log('‚úÖ ITP/Code/TAG saved');
      
      // ‚≠ê‚≠ê‚≠ê CRITICAL: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Column AU - PDF Flag ‚≠ê‚≠ê‚≠ê
      console.log('üìù Writing PDF Flag to Column AU (row', rowIndex, ')...');
      
      const pdfFlagCell = sheet.getRange(rowIndex, 47); // Column AU
      pdfFlagCell.setValue('Need Re-Generate PDF');
      
      // ‚úÖ ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
      SpreadsheetApp.flush();
      
      // ‚úÖ ‡∏≠‡πà‡∏≤‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö
      const writtenValue = pdfFlagCell.getValue();
      console.log('‚úÖ Verified AU value:', writtenValue);
      
      if (writtenValue === 'Need Re-Generate PDF') {
        console.log('‚úÖ‚úÖ‚úÖ PDF Flag written successfully to Column AU');
      } else {
        console.error('‚ùå WARNING: PDF Flag not saved! Got:', writtenValue);
      }
      
      sheet.getRange(rowIndex, 18).setValue(currentTime);               // R - Updated_Timestamp
      
      console.log('‚úÖ Limited Edit complete');
      
    } else {
      // ========== NORMAL EDIT MODE ==========
      console.log('‚úÖ Updating all fields (Normal Edit)');
      
      sheet.getRange(rowIndex, 3).setValue(combinedDescription);
      sheet.getRange(rowIndex, 4).setValue(data.location);
      sheet.getRange(rowIndex, 5).setValue(formattedDate);
      sheet.getRange(rowIndex, 6).setValue(data.startTime);
      sheet.getRange(rowIndex, 7).setValue(endTime);
      
      // ‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Code ‡πÅ‡∏•‡∏∞ RFI_NO (‡∏ñ‡πâ‡∏≤‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô)
      if (needUpdateRFINo) {
        const newOrderRFI = getNextOrderRFIBySequenceAndType(sequence, qcType);
        
        sheet.getRange(rowIndex, 2).setValue(newRFINo);
        sheet.getRange(rowIndex, 8).setValue(newOrderRFI);
        sheet.getRange(rowIndex, 9).setValue(newCode);
        
        console.log('Updated: RFI_NO =', newRFINo, ', Order_RFI =', newOrderRFI, ', Code =', newCode);
      }
      
      sheet.getRange(rowIndex, 10).setValue(data.requesterEmail);
      sheet.getRange(rowIndex, 11).setValue(data.requesterName);
      sheet.getRange(rowIndex, 12).setValue(data.assignedInspector);
      sheet.getRange(rowIndex, 18).setValue(currentTime);
      sheet.getRange(rowIndex, 20).setValue(data.requireSurveyReport || 'None');
      sheet.getRange(rowIndex, 21).setValue(data.requireLabReport || 'None');
      
      // ‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï ITP/Code/TAG
      sheet.getRange(rowIndex, 42).setValue(data.itp || '');
      sheet.getRange(rowIndex, 43).setValue(data.qcCode || '');
      sheet.getRange(rowIndex, 44).setValue(data.item || '');
      sheet.getRange(rowIndex, 45).setValue(data.descriptionCode || '');
      sheet.getRange(rowIndex, 46).setValue(data.tagNumber || '');
      
      console.log('‚úÖ All fields updated');
    }
    
    console.log('‚úÖ Saved ITP/Code data:', data.itp, data.qcCode, data.item);
    
    // ‡∏î‡∏∂‡∏á RFI_NO ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
    const finalRFINo = needUpdateRFINo ? newRFINo : sheet.getRange(rowIndex, 2).getValue();
    
    let message = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç RFI ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß\n';
    message += 'RFI NO: ' + finalRFINo + '\n';
    
    if (isLimitedEdit) {
      message += 'üîí ‡πÇ‡∏´‡∏°‡∏î: Limited Edit (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ö‡∏≤‡∏á‡∏ü‡∏¥‡∏•‡∏î‡πå)\n';
      message += 'ITP: ' + data.itp + '\n';
      message += 'QC Code: ' + data.qcCode + '\n';
      message += 'ITEM: ' + data.item + '\n';
      message += 'TAG NUMBER: ' + data.tagNumber + '\n';
      message += '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î: ' + data.description.substring(0, 50) + '...\n';
      message += '‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà: ' + data.location + '\n';
      message += '\n‚≠ê PDF Flag: Need Re-Generate PDF (Column AU)';
    } else {
      message += 'Work Type: ' + data.workType + ' (Duration: ' + duration + ' ‡∏ô‡∏≤‡∏ó‡∏µ)\n';
      message += 'ITP: ' + data.itp + '\n';
      message += 'QC Code: ' + data.qcCode + '\n';
      message += 'ITEM: ' + data.item + '\n';
      message += 'TAG NUMBER: ' + data.tagNumber + '\n';
      if (needUpdateRFINo) {
        message += '‚ö†Ô∏è ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Work Type ‡∏à‡∏≤‡∏Å ' + currentCode + ' ‚Üí ' + newCode + '\n';
        message += 'üìã RFI NO ‡πÉ‡∏´‡∏°‡πà: ' + finalRFINo + '\n';
      }
      message += '‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô: ' + data.assignedInspector + '\n';
      message += '‡∏ú‡∏π‡πâ‡∏Ç‡∏≠: ' + data.requesterName + '\n';
    }
    
    message += '\n‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏î‡∏¢: ' + roleValidation.name + ' (' + roleValidation.role + ')';
    
    console.log('========== updateQCRFI SUCCESS ==========');
    
    return {
      success: true,
      message: message,
      rfiId: rfiId,
      rfiNo: finalRFINo
    };
    
  } catch (error) {
    console.error('========== updateQCRFI FAILED ==========');
    console.error('Error:', error);
    console.error('Stack:', error.stack);
    
    // ‚úÖ‚úÖ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ ‚úÖ‚úÖ‚úÖ
    logError('updateQCRFI', error, {
      rfiId: rfiId,
      isLimitedEdit: data.isLimitedEdit || false,
      workType: data.workType || 'unknown',
      tagNumber: data.tagNumber || 'unknown'
    }, 'ERROR'); // ERROR ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÑ‡∏°‡πà‡∏£‡πâ‡∏≤‡∏¢‡πÅ‡∏£‡∏á‡πÄ‡∏ó‡πà‡∏≤ CRITICAL
    
    return {
      success: false,
      message: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.toString()
    };
  }
}
/**
 * Format date ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö input type="date" (YYYY-MM-DD)
 */
function formatDateForInput(date) {
  if (!date) return '';
  const d = new Date(date);
  const year = d.getFullYear();
  const month = String(d.getMonth() + 1).padStart(2, '0');
  const day = String(d.getDate()).padStart(2, '0');
  return year + '-' + month + '-' + day;
}
/**
 * ‚úÖ FIXED VERSION 2: ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ RFI ‡∏û‡∏£‡πâ‡∏≠‡∏° Debug Log ‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
 */
function getRFIListForQC() {
  try {
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('RFI_List');
    
    if (!sheet) {
      console.log('DEBUG: RFI_List sheet not found');
      return [];
    }
    
    const lastRow = sheet.getLastRow();
    console.log('DEBUG: lastRow =', lastRow);
    
    if (lastRow <= 1) {
      console.log('DEBUG: No data rows');
      return [];
    }
    
    // ‚úÖ ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏ß‡∏° Column S (Type) = index 18
    const data = sheet.getRange(2, 1, lastRow - 1, 21).getValues();
    console.log('DEBUG: Total rows =', data.length);
    
    const rfiList = [];
    
    for (let i = 0; i < data.length; i++) {
      const row = data[i];
      const id = String(row[0] || '').trim();
      const rfiNo = String(row[1] || '').trim();
      const status = String(row[14] || '').trim();
      const type = String(row[18] || '').trim(); // ‚úÖ Column S - Type
      
      console.log('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
      console.log('DEBUG: Row', i);
      console.log('  ID:', id);
      console.log('  RFI_NO:', rfiNo);
      console.log('  Status:', status);
      console.log('  Type:', type);
      
      // ‚úÖ ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ó‡∏µ‡πà 1: Draft ‡∏´‡∏£‡∏∑‡∏≠ RFI Request Submitted
      const isBasicStatus = (
        status === 'Draft' || 
        status === 'RFI Request Submitted'
      );
      
      console.log('  ‚Üí isBasicStatus:', isBasicStatus);
      
      // ‚úÖ ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ó‡∏µ‡πà 2: Limited Edit Status
      const isLimitedEditStatus = (
        status === 'Waiting for Revised Attachment' ||
        status === 'Pending QC Review' ||
        status === 'Rejected by Consult ‚Äì Revise Required' ||
        status === 'Revised Attachment Submitted ‚Äì Pending QC Review'
      );
      
      console.log('  ‚Üí isLimitedEditStatus:', isLimitedEditStatus);
      
      // ‚úÖ ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô Open RFI ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
      const isOpenRFI = (type === 'Open RFI');
      console.log('  ‚Üí isOpenRFI:', isOpenRFI);
      
      // ‚úÖ ‡∏£‡∏ß‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç
      const isLimitedEditAndOpenRFI = isLimitedEditStatus && isOpenRFI;
      console.log('  ‚Üí isLimitedEditAndOpenRFI:', isLimitedEditAndOpenRFI);
      
      const shouldShow = isBasicStatus || isLimitedEditAndOpenRFI;
      console.log('  ‚Üí shouldShow:', shouldShow);
      
      if (shouldShow) {
        console.log('  ‚úÖ MATCHED! Adding to list');
        
        let createdTimestamp = '';
        if (row[15]) {
          try {
            createdTimestamp = new Date(row[15]).toISOString();
          } catch (e) {
            createdTimestamp = String(row[15]);
          }
        }
        
        rfiList.push({
          id: id,
          rfiNo: rfiNo,
          description: String(row[2] || '').trim(),
          location: String(row[3] || '').trim(),
          requestDate: formatDate(new Date(row[4])),
          startTime: formatTime(row[5]),
          endTime: formatTime(row[6]),
          code: String(row[8] || '').trim(),
          requesterEmail: String(row[9] || '').trim(),
          requesterName: String(row[10] || '').trim(),
          assignedInspector: String(row[11] || '').trim(),
          status: status,
          createdTimestamp: createdTimestamp,
          type: type,
          requireSurveyReport: String(row[19] || '').trim(),
          requireLabReport: String(row[20] || '').trim()
        });
      } else {
        console.log('  ‚ùå SKIPPED');
      }
    }
    
    console.log('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
    console.log('DEBUG: Final list count =', rfiList.length);
    
    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏° ID (‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Å‡πà‡∏≠‡∏ô)
    rfiList.sort(function(a, b) {
      if (a.id > b.id) return -1;
      if (a.id < b.id) return 1;
      return 0;
    });
    
    return rfiList;
    
  } catch (error) {
    console.error('ERROR in getRFIListForQC:', error);
    console.error('Stack:', error.stack);
    return [];
  }
}


function getCurrentUserInfo() {
  try {
    const user = Session.getActiveUser();
    const email = user.getEmail();
    
    // ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏≤‡∏Å UserProperties ‡∏´‡∏£‡∏∑‡∏≠ ContactsApp
    let displayName = '';
    
    // ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏µ‡πà 1: ‡∏•‡∏≠‡∏á‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å UserProperties (‡∏ñ‡πâ‡∏≤‡πÄ‡∏Ñ‡∏¢‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ)
    const userProps = PropertiesService.getUserProperties();
    displayName = userProps.getProperty('displayName') || '';
    
    // ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏µ‡πà 2: ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•
    if (!displayName && email) {
      displayName = email.split('@')[0];
      // ‡πÅ‡∏õ‡∏•‡∏á firstname.lastname ‡πÄ‡∏õ‡πá‡∏ô Firstname Lastname
      displayName = displayName.split('.').map(function(word) {
        return word.charAt(0).toUpperCase() + word.slice(1);
      }).join(' ');
    }
    
    return {
      success: true,
      email: email,
      name: displayName
    };
  } catch (error) {
    console.error('Error getting current user info:', error);
    return {
      success: false,
      email: '',
      name: '',
      error: error.toString()
    };
  }
}

// ===== ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏ô Code.gs (‡πÉ‡∏Å‡∏•‡πâ‡∏ó‡πâ‡∏≤‡∏¢‡πÑ‡∏ü‡∏•‡πå) =====
// ‚ö†Ô∏è ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÄ‡∏î‡∏¥‡∏°: ‡∏°‡∏µ /** ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î multi-line comment ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏õ‡∏¥‡∏î
// ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏ó‡∏∏‡∏Å function ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å comment ‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ

/**
 * ‡∏î‡∏∂‡∏á email ‡∏Ç‡∏≠‡∏á user ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
 */
function getCurrentUserEmail() {
  try {
    return Session.getActiveUser().getEmail();
  } catch (error) {
    console.error('Error getting current user email:', error);
    return '';
  }
}

/**
 * ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ RFI ‡∏ó‡∏µ‡πà Status = Inspection Postponed (‡∏£‡∏ß‡∏° Postpone Reason)
 */
function getPostponedRFIList() {
  try {
    console.log('========== Getting Postponed RFI List ==========');

    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('RFI_List');

    if (!sheet) {
      console.log('RFI_List sheet not found');
      return [];
    }

    const lastRow = sheet.getLastRow();
    if (lastRow <= 1) {
      console.log('No data rows');
      return [];
    }

    const data = sheet.getRange(2, 1, lastRow - 1, 36).getValues();
    const postponedList = [];

    for (let i = 0; i < data.length; i++) {
      const row = data[i];
      const id = String(row[0] || '').trim();
      const status = String(row[14] || '').trim();

      // ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏° logging
      if (i < 5) {
        console.log('Row ' + (i + 2) + ': ID=' + id + ', Status="' + status + '"');
      }

      // ‚úÖ ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏ö‡∏ö‡∏¢‡∏∑‡∏î‡∏´‡∏¢‡∏∏‡πà‡∏ô (case-insensitive + partial match)
      const statusLower = status.toLowerCase();
      const isPostponed = (
        status === 'Inspection Postponed' ||
        statusLower.includes('postpone') ||
        statusLower.includes('‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô') ||
        statusLower === 'postponed'
      );

      if (isPostponed) {
        console.log('‚úÖ Found postponed RFI:', id, 'Status:', status);

        let createdTimestamp = '';
        if (row[15]) {
          try {
            createdTimestamp = new Date(row[15]).toISOString();
          } catch (e) {
            createdTimestamp = String(row[15]);
          }
        }

        postponedList.push({
          id: id,
          rfiNo: String(row[1] || '').trim(),
          description: String(row[2] || '').trim(),
          location: String(row[3] || '').trim(),
          requestDate: formatDate(new Date(row[4])),
          startTime: formatTime(row[5]),
          endTime: formatTime(row[6]),
          code: String(row[8] || '').trim(),
          requesterEmail: String(row[9] || '').trim(),
          requesterName: String(row[10] || '').trim(),
          assignedInspector: String(row[11] || '').trim(),
          status: status,
          createdTimestamp: createdTimestamp,
          postponeReason: String(row[35] || '').trim()
        });
      }
    }

    postponedList.sort(function(a, b) {
      if (!a.createdTimestamp || !b.createdTimestamp) return 0;
      return new Date(b.createdTimestamp).getTime() - new Date(a.createdTimestamp).getTime();
    });

    console.log('Found postponed RFI:', postponedList.length);
    return postponedList;

  } catch (error) {
    console.error('Error getting postponed RFI list:', error);
    return [];
  }
}

/**
 * ‡πÄ‡∏•‡∏∑‡∏≠‡∏ô‡∏ï‡∏£‡∏ß‡∏à RFI (‡∏£‡∏ß‡∏° Postpone Reason ‡∏à‡∏≤‡∏Å Sheet)
 */
function reschedulePostponedRFI(rfiId, data) {
  try {
    console.log('========== reschedulePostponedRFI START ==========');
    console.log('RFI ID:', rfiId);
    console.log('New schedule:', JSON.stringify(data));
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Role ‡∏Å‡πà‡∏≠‡∏ô‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£
    const roleValidation = validateQCRole();
    if (!roleValidation.success) {
      return {
        success: false,
        message: roleValidation.message
      };
    }
    
    // Validation
    if (!rfiId || !data.requestDate || !data.startTime || !data.assignedInspector) {
      return {
        success: false,
        message: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô'
      };
    }
    
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('RFI_List');
    
    if (!sheet) {
      return {
        success: false,
        message: '‡πÑ‡∏°‡πà‡∏û‡∏ö RFI_List sheet'
      };
    }
    
    // ‚úÖ ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• RFI ‡πÄ‡∏ï‡πá‡∏° (‡∏£‡∏ß‡∏° postponeReason ‡∏à‡∏≤‡∏Å Column AJ)
    const rfiData = getRFIById(rfiId);
    
    if (!rfiData) {
      return {
        success: false,
        message: '‡πÑ‡∏°‡πà‡∏û‡∏ö RFI ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏ô‡∏ï‡∏£‡∏ß‡∏à'
      };
    }
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ Status = "Inspection Postponed" ‡∏à‡∏£‡∏¥‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    if (rfiData.status !== 'Inspection Postponed') {
      return {
        success: false,
        message: 'RFI ‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Inspection Postponed (‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: ' + rfiData.status + ')'
      };
    }
    
    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì end time (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏ö‡∏∏ ‡πÉ‡∏ä‡πâ +1 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á)
    let endTime = data.endTime;
    if (!endTime) {
      const startParts = data.startTime.split(':');
      const endHour = parseInt(startParts[0]) + 1;
      endTime = endHour.toString().padStart(2, '0') + ':' + startParts[1];
    }
    
    // Format date
    const dateParts = data.requestDate.split('-');
    const formattedDate = dateParts[1] + '/' + dateParts[2] + '/' + dateParts[0];
    
    const currentTime = new Date();
    
    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    sheet.getRange(rfiData.rowIndex, 5).setValue(formattedDate);              // E - Request_Date
    sheet.getRange(rfiData.rowIndex, 6).setValue(data.startTime);             // F - Start_Time
    sheet.getRange(rfiData.rowIndex, 7).setValue(endTime);                    // G - End_Time
    sheet.getRange(rfiData.rowIndex, 12).setValue(data.assignedInspector);    // L - Assigned_Inspector
    sheet.getRange(rfiData.rowIndex, 15).setValue('Rescheduled ‚Äì Proceed to Site Inspection');             // O - Status ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô "Rescheduled ‚Äì Proceed to Site Inspection"
    sheet.getRange(rfiData.rowIndex, 18).setValue(currentTime);               // R - Updated_Timestamp
    sheet.getRange(rfiData.rowIndex, 47).setValue('Need Re-Generate PDF');
    
    console.log('Updated RFI at row:', rfiData.rowIndex);
    
    // ========== ‚úÖ ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å Postpone Calendar Function ==========
    
    let calendarPostponeResult = null;
    
    // ‚úÖ ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ postponeRFIInspection() ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    if (typeof postponeRFIInspection === 'function') {
      try {
        console.log('========== Calling postponeRFIInspection ==========');
        
        // ‚úÖ ‡πÉ‡∏ä‡πâ postponeReason ‡∏à‡∏≤‡∏Å Sheet (Column AJ)
        const postponeReasonFromSheet = rfiData.postponeReason || '‡πÄ‡∏•‡∏∑‡∏≠‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö RFI';
        console.log('Using postpone reason from sheet:', postponeReasonFromSheet);
        
        calendarPostponeResult = postponeRFIInspection(
          rfiData.rfiNo,                    // RFI Number
          rfiData.description,              // Description
          data.requestDate,                 // New Date (YYYY-MM-DD)
          data.startTime,                   // New Start Time
          endTime,                          // New End Time
          postponeReasonFromSheet,          // ‚úÖ Postpone Reason ‡∏à‡∏≤‡∏Å Column AJ
          rfiData.requesterEmail,           // Requester Email
          '',                               // Guest Emails (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ)
          rfiData.location,                 // New Location
          data.assignedInspector,           // Assigned Inspector (‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô)
          true,                             // Send Email = true
          60                                // Search Days = 60
        );
        
        console.log('========== Postpone Calendar Result ==========');
        console.log('Success:', calendarPostponeResult.success);
        console.log('Events Updated:', calendarPostponeResult.rfiEventsUpdated);
        console.log('Emails Sent:', calendarPostponeResult.emailsSent);
        
      } catch (calendarError) {
        console.error('‚ö†Ô∏è Error calling postponeRFIInspection:', calendarError);
        console.error('Stack:', calendarError.stack);
        
        // ‚ö†Ô∏è ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ error ‡∏ô‡∏µ‡πâ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô - ‡πÅ‡∏Ñ‡πà‡πÅ‡∏à‡πâ‡∏á warning
        calendarPostponeResult = {
          success: false,
          message: 'Calendar update failed: ' + calendarError.toString(),
          error: calendarError.toString()
        };
      }
    } else {
      console.log('‚ö†Ô∏è postponeRFIInspection() not found - skipping calendar update');
      calendarPostponeResult = {
        success: false,
        message: 'Calendar integration not available'
      };
    }
    
    // ========== ‚úÖ END: Postpone Calendar Integration ==========
    
    let message = '‡πÄ‡∏•‡∏∑‡∏≠‡∏ô‡∏ï‡∏£‡∏ß‡∏à RFI ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à\n';
    message += 'RFI NO: ' + rfiData.rfiNo + '\n';
    message += '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡∏°‡πà: ' + formatDateThai(data.requestDate) + '\n';
    message += '‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏´‡∏°‡πà: ' + data.startTime + ' - ' + endTime + ' ‡∏ô.\n';
    message += '‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà: ' + data.assignedInspector + '\n';
    message += '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: Rescheduled ‚Äì Proceed to Site Inspection';
    
    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Calendar Result
    if (calendarPostponeResult && calendarPostponeResult.success) {
      message += '\n\n‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Calendar ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:';
      message += '\n‚Ä¢ Events Updated: ' + calendarPostponeResult.rfiEventsUpdated;
      message += '\n‚Ä¢ Emails Sent: ' + (calendarPostponeResult.emailsSent ? 'Yes' : 'No');
    } else if (calendarPostponeResult && calendarPostponeResult.message) {
      message += '\n\n‚ö†Ô∏è Calendar: ' + calendarPostponeResult.message;
    }
    
    console.log('========== reschedulePostponedRFI SUCCESS ==========');
    
    return {
      success: true,
      message: message,
      rfiId: rfiId,
      rfiNo: rfiData.rfiNo,
      calendarResult: calendarPostponeResult
    };
    
  } catch (error) {
    console.error('========== reschedulePostponedRFI FAILED ==========');
    console.error('Error:', error);
    console.error('Stack:', error.stack);
    
    // ‚úÖ‚úÖ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ ‚úÖ‚úÖ‚úÖ
    logError('reschedulePostponedRFI', error, {
      rfiId: rfiId,
      requestDate: data.requestDate || 'unknown',
      assignedInspector: data.assignedInspector || 'unknown'
    }, 'ERROR');
    
    return {
      success: false,
      message: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.toString()
    };
  }
}


// ========== EXAMPLE: ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏à‡∏≤‡∏Å qc_postpone.html ==========

/**
 * ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏à‡∏≤‡∏Å Frontend (qc_postpone.html)
 */
function exampleUsageFromFrontend() {
  // ‡πÉ‡∏ô qc_postpone.html ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
  // function handleRescheduleSubmit() ‡∏à‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏Å reschedulePostponedRFI()
  // ‡∏ã‡∏∂‡πà‡∏á‡∏à‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏Å postponeRFIInspection() ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
  
  const formData = {
    requestDate: '2025-01-20',
    startTime: '14:00',
    endTime: '16:00',
    assignedInspector: 'Survey Team A,Lab Team B'
  };
  
  // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ú‡πà‡∏≤‡∏ô google.script.run
  google.script.run
    .withSuccessHandler(function(result) {
      if (result.success) {
        console.log('‚úÖ RFI Postponed:', result.message);
        
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ú‡∏• Calendar Update
        if (result.calendarResult) {
          console.log('Calendar Events Updated:', result.calendarResult.rfiEventsUpdated);
          console.log('Emails Sent:', result.calendarResult.emailsSent);
        }
      }
    })
    .withFailureHandler(function(error) {
      console.error('‚ùå Error:', error);
    })
    .reschedulePostponedRFI(rfiId, formData);
}

// ========== TEST FUNCTION ==========





/**
 * ‚≠ê ‡∏î‡∏∂‡∏á‡∏ó‡∏µ‡∏° Survey ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà Activated
 */
function getSurveyTeams() {
  try {
    console.log('Getting Survey teams');
    
    const resourceSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Resources');
    
    if (!resourceSheet) {
      console.log('Resources sheet not found');
      return [];
    }
    
    const lastRow = resourceSheet.getLastRow();
    if (lastRow <= 1) {
      console.log('No resources found');
      return [];
    }
    
    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: A (Resource_ID), B (Resource_Name), C (Sub_Type), D (Team No.), E (Status)
    const data = resourceSheet.getRange(2, 1, lastRow - 1, 5).getValues();
    const teams = [];
    
    for (let i = 0; i < data.length; i++) {
      const row = data[i];
      const resourceId = String(row[0] || '').trim();
      const resourceName = String(row[1] || '').trim();
      const subType = String(row[2] || '').trim();
      const teamNo = row[3];
      const status = String(row[4] || '').trim();
      
      // ‚≠ê ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Survey ‡∏ó‡∏µ‡πà Activated
      if (status === 'Activated' && resourceId && subType.toLowerCase() === 'survey') {
        teams.push({
          resourceId: resourceId,
          resourceName: resourceName,
          subType: subType,
          teamNo: teamNo || 999
        });
        console.log('Found Survey team:', resourceId, resourceName, 'Team No:', teamNo);
      }
    }
    
    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏° Team No.
    teams.sort(function(a, b) {
      return a.teamNo - b.teamNo;
    });
    
    console.log('Total Survey teams found:', teams.length);
    return teams;
    
  } catch (error) {
    console.error('Error getting Survey teams:', error);
    return [];
  }
}



/**
 * ‚úÖ FINAL: ‡∏à‡∏±‡∏î‡∏ó‡∏µ‡∏° Survey ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ - Load Balanced + Work Type Filter
 */
function assignSurveyTeamAutomatically(date, startTime, endTime, useCache, workType) {
  try {
    // Set default value
    if (typeof useCache === 'undefined') useCache = false;
    if (typeof workType === 'undefined') workType = null;
    
    console.log('========== Auto-assigning Survey team (Load Balanced + Work Type Filter) ==========');
    console.log('Work Type:', workType); // ‚≠ê ‡πÉ‡∏´‡∏°‡πà
    console.log('Date:', date);
    console.log('Time:', startTime, '-', endTime);
    console.log('Use Cache:', useCache);
    
    // ‚≠ê ‡∏™‡πà‡∏á workType ‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢
    const teams = getTeamsByCategory('Survey', workType);
    
    if (teams.length === 0) {
      // ‚≠ê ‡∏õ‡∏£‡∏±‡∏ö error message
      if (workType) {
        return {
          success: false,
          message: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ó‡∏µ‡∏° Survey ‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô "' + workType + '"\n' +
                  'üí° ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏ó‡∏µ‡∏° Survey ‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Work_Types ‡πÄ‡∏õ‡πá‡∏ô "*" ‡∏´‡∏£‡∏∑‡∏≠‡∏°‡∏µ "' + workType + '"'
        };
      } else {
        return {
          success: false,
          message: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ó‡∏µ‡∏° Survey ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö'
        };
      }
    }
    
    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ó‡∏µ‡∏°‡∏ï‡∏≤‡∏° workload + Round Robin
    const sortedTeams = sortTeamsByWorkload(teams, date, useCache);
    
    // ‡∏´‡∏≤‡∏ó‡∏µ‡∏°‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á
    for (let i = 0; i < sortedTeams.length; i++) {
      const team = sortedTeams[i];
      
      if (isSurveyTeamAvailable(team.resourceId, date, startTime, endTime)) {
        console.log('‚úÖ Selected Survey team:', team.resourceName, '(Workload:', team.workload + ')');
        
        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï cache (‡∏ñ‡πâ‡∏≤‡πÉ‡∏ä‡πâ)
        if (useCache) {
          incrementWorkloadCache(team.resourceId, date);
          LAST_SELECTED_TEAM[team.subType + '_' + date] = team.resourceId;
        }
        
        return {
          success: true,
          teamName: team.resourceName,
          resourceId: team.resourceId,
          teamNo: team.teamNo,
          workload: team.workload,
          workType: workType // ‚≠ê ‡∏™‡πà‡∏á work type ‡∏Å‡∏•‡∏±‡∏ö
        };
      }
    }
    
    // ‚≠ê ‡∏õ‡∏£‡∏±‡∏ö error message
    if (workType) {
      return {
        success: false,
        message: '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ó‡∏µ‡∏° Survey ‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô "' + workType + '" ‡πÅ‡∏•‡∏∞‡∏ß‡πà‡∏≤‡∏á‡πÉ‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å\n' +
                'üí° ‡∏•‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏∑‡πà‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏ß‡∏±‡∏ô‡∏≠‡∏∑‡πà‡∏ô'
      };
    } else {
      return {
        success: false,
        message: '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ó‡∏µ‡∏° Survey ‡∏ß‡πà‡∏≤‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å'
      };
    }
    
  } catch (error) {
    console.error('Error in assignSurveyTeamAutomatically:', error);
    console.error('Stack:', error.stack);
    return {
      success: false,
      message: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏ó‡∏µ‡∏°: ' + error.toString()
    };
  }
}

/**
 * ‚ö° UPDATED: Survey Available Time Slots (Optimized)
 * ‚úÖ ‡∏£‡∏±‡∏Å‡∏©‡∏≤ function signature ‡πÄ‡∏î‡∏¥‡∏°
 */
function getSurveyAvailableTimeSlots(date) {
  try {
    if (!date) return [];
    
    const now = new Date();
    const selectedDate = new Date(date + 'T00:00:00');
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    const selectedDateOnly = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), selectedDate.getDate());
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á all slots
    const allSlots = [];
    for (let hour = 9; hour <= 19; hour++) {
      for (let minute = 0; minute < 60; minute += 30) {
        if (hour === 19 && minute === 30) break;
        const time = hour.toString().padStart(2, '0') + ':' + minute.toString().padStart(2, '0');
        allSlots.push(time);
      }
    }
    
    let filteredSlots = allSlots.slice();
    
    // ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏õ + 30 ‡∏ô‡∏≤‡∏ó‡∏µ
    if (selectedDateOnly.getTime() === today.getTime()) {
      const minTime = new Date(now.getTime() + (30 * 60 * 1000));
      
      filteredSlots = allSlots.filter(function(slot) {
        const slotTime = new Date(selectedDate);
        const timeParts = slot.split(':');
        slotTime.setHours(parseInt(timeParts[0]), parseInt(timeParts[1]), 0, 0);
        return slotTime > minTime;
      });
    } else if (selectedDateOnly < today) {
      return [];
    }
    
    const availableTeams = getSurveyTeams();
    
    if (availableTeams.length === 0) {
      return [];
    }
    
    // ‚ö° Cache blocked slots
    const blockedSlots = getBlockedTimeSlotsForTeams(date, availableTeams);
    
    const availableSlots = [];
    
    for (let i = 0; i < filteredSlots.length; i++) {
      const startSlot = filteredSlots[i];
      
      const startParts = startSlot.split(':');
      const startHour = parseInt(startParts[0]);
      const startMin = parseInt(startParts[1]);
      const endHour = startMin === 30 ? startHour + 1 : startHour;
      const endMin = startMin === 30 ? 0 : 30;
      const endSlot = endHour.toString().padStart(2, '0') + ':' + endMin.toString().padStart(2, '0');
      
      const requestStartMinutes = timeToMinutes(startSlot);
      const requestEndMinutes = timeToMinutes(endSlot);
      
      // ‚ö° ‡πÄ‡∏ä‡πá‡∏Ñ‡∏à‡∏≤‡∏Å cached data (‡πÑ‡∏°‡πà‡∏°‡∏µ buffer)
      let hasAvailableTeam = false;
      
      for (let j = 0; j < availableTeams.length; j++) {
        const team = availableTeams[j];
        const blocks = blockedSlots[team.resourceId] || [];
        
        let isAvailable = true;
        
        for (let k = 0; k < blocks.length; k++) {
          const block = blocks[k];
          // ‡πÑ‡∏°‡πà‡∏°‡∏µ buffer - ‡πÄ‡∏ä‡πá‡∏Ñ‡πÅ‡∏Ñ‡πà‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô
          if (!(requestEndMinutes <= block.start || requestStartMinutes >= block.end)) {
            isAvailable = false;
            break;
          }
        }
        
        if (isAvailable) {
          hasAvailableTeam = true;
          break;
        }
      }
      
      if (hasAvailableTeam) {
        availableSlots.push(startSlot);
      }
    }
    
    return availableSlots;
    
  } catch (error) {
    console.error('Error in getSurveyAvailableTimeSlots:', error);
    return [];
  }
}

/**
 * ‚ö° OPTIMIZED: Get Available End Times (‡πÉ‡∏ä‡πâ Duration ‡∏à‡∏≤‡∏Å Work Type)
 */
function getSurveyAvailableEndTimes(date, startTime, workType) {
  try {
    if (!startTime || !date) return [];
    
    console.log('‚ö° Getting end times - Quick mode');
    
    const startMinutes = timeToMinutes(startTime);
    
    // ‚úÖ ‡∏î‡∏∂‡∏á Duration ‡∏à‡∏≤‡∏Å Sheet "Work"
    let minDuration = 60;
    
    if (workType) {
      const workSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Work');
      
      if (workSheet) {
        const lastRow = workSheet.getLastRow();
        const data = workSheet.getRange(2, 1, lastRow - 1, 5).getValues();
        
        for (let i = 0; i < data.length; i++) {
          const nameWork = String(data[i][1] || '').trim();
          const duration = parseInt(data[i][4]) || 60;
          
          if (nameWork === workType) {
            minDuration = duration;
            break;
          }
        }
      }
    }
    
    console.log('Duration:', minDuration, 'min');
    
    const minEndMinutes = startMinutes + minDuration;
    
    // ‚ö° ‡∏™‡∏£‡πâ‡∏≤‡∏á end slots ‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡πá‡∏ß (‡πÑ‡∏°‡πà‡πÄ‡∏ä‡πá‡∏Ñ availability)
    const allEndSlots = [];
    for (let hour = 9; hour <= 20; hour++) {
      for (let minute = 0; minute < 60; minute += 30) {
        if (hour === 9 && minute === 0) continue;
        if (hour === 20 && minute > 0) break;
        
        const endMinutes = (hour * 60) + minute;
        
        if (endMinutes >= minEndMinutes && endMinutes <= 20 * 60) {
          const time = hour.toString().padStart(2, '0') + ':' + 
                      minute.toString().padStart(2, '0');
          allEndSlots.push(time);
        }
      }
    }
    
    console.log('‚úÖ Generated', allEndSlots.length, 'end time options');
    return allEndSlots;
    
  } catch (error) {
    console.error('Error in getSurveyAvailableEndTimes:', error);
    return [];
  }
}


function saveSurveyWorkRequirement(data) {
  try {
    console.log('========== saveSurveyWorkRequirement START ==========');
    console.log('Has file:', !!data.locationLayoutFile);
    
    // Validation
    if (!data.requestDate || !data.startTime || !data.endTime || 
        !data.workType || !data.description || !data.location || 
        !data.requesterName || !data.requesterEmail) {
      return {
        success: false,
        message: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô'
      };
    }
    
    var progressSteps = [];

    // Validate User
    progressSteps.push('‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ');
    const userValidation = validateAndGetUser(data.requesterEmail, data.requesterName);
    
    if (!userValidation.success) {
      console.log('User validation failed:', userValidation.message);
      return {
        success: false,
        message: userValidation.message
      };
    }
    
    console.log('User validation success:', userValidation);
    
    const validatedEmail = userValidation.email;
    const validatedName = userValidation.name;
    
    // ‚≠ê ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (Recorded By)
    const currentUserEmail = Session.getActiveUser().getEmail();
    let recordedByEmail = currentUserEmail;
    let recordedByName = '';
    
    // ‚≠ê ‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
    const userSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('User');
    if (userSheet) {
      const lastRow = userSheet.getLastRow();
      if (lastRow > 1) {
        const userData = userSheet.getRange(2, 2, lastRow - 1, 3).getValues();
        
        for (let i = 0; i < userData.length; i++) {
          const email = String(userData[i][0] || '').trim().toLowerCase();
          const name = String(userData[i][1] || '').trim();
          
          if (email === currentUserEmail.toLowerCase()) {
            recordedByName = name;
            console.log('‚úÖ Recorded By:', recordedByName, '(', recordedByEmail, ')');
            break;
          }
        }
      }
    }
    
    // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠‡∏ä‡∏∑‡πà‡∏≠ ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏≠‡∏µ‡πÄ‡∏°‡∏•
    if (!recordedByName) {
      recordedByName = currentUserEmail;
    }
    
    // ‡∏à‡∏±‡∏î‡∏ó‡∏µ‡∏° Survey ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
    let teamAssignment;

    // ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡∏°‡πÄ‡∏≠‡∏á (Manual - ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Survey Role)
if (data.assignedInspector && data.assignedInspector.trim() !== '') {
      console.log('Manual team selection:', data.assignedInspector);

      // [‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà] üîí Validation: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ó‡∏µ‡∏°‡∏°‡∏µ‡∏à‡∏£‡∏¥‡∏á‡πÅ‡∏•‡∏∞ Status = Activated
      // 1. ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡∏° Survey ‡∏ó‡∏µ‡πà Active ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
      const activeSurveyTeams = getSurveyTeams(); 
      const validTeamNames = activeSurveyTeams.map(function(t) { return t.resourceName; });
      
      // 2. ‡πÅ‡∏¢‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡∏°‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏°‡∏≤ (‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏•‡∏≤‡∏¢‡∏ó‡∏µ‡∏° ‡∏Ñ‡∏±‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢ ,)
      const inputTeams = data.assignedInspector.split(',').map(function(t) { return t.trim(); });
      
      // 3. ‡∏´‡∏≤‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏ó‡∏µ‡∏°‡πÑ‡∏´‡∏ô‡∏ö‡πâ‡∏≤‡∏á‡∏ó‡∏µ‡πà "‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏π‡πà" ‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡∏° Active
      const invalidTeams = inputTeams.filter(function(teamName) {
        return validTeamNames.indexOf(teamName) === -1;
      });
      
      // 4. ‡∏ñ‡πâ‡∏≤‡πÄ‡∏à‡∏≠‡∏ó‡∏µ‡∏°‡πÅ‡∏õ‡∏•‡∏Å‡∏õ‡∏•‡∏≠‡∏° ‡∏´‡∏£‡∏∑‡∏≠‡∏ó‡∏µ‡∏°‡∏ó‡∏µ‡πà‡∏õ‡∏¥‡∏î‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡∏î‡∏µ‡∏î‡∏Å‡∏•‡∏±‡∏ö‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
      if (invalidTeams.length > 0) {
         console.error('‚ùå Security Warning: Invalid teams detected:', invalidTeams);
         return {
           success: false,
           message: '‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡∏°‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (Inactive): ' + invalidTeams.join(', ')
         };
      }
      // [‡∏à‡∏ö‡∏™‡πà‡∏ß‡∏ô Validation]

      teamAssignment = {
        success: true,
        teamName: data.assignedInspector, 
        resourceId: 'MANUAL',
        teamNo: 0,
        workload: 0
      };
    } else {
      // ‡∏Å‡∏£‡∏ì‡∏µ‡∏à‡∏±‡∏î‡∏ó‡∏µ‡∏°‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (Auto - User ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ)
      progressSteps.push('‡∏à‡∏±‡∏î‡∏ó‡∏µ‡∏° Survey');
      teamAssignment = assignSurveyTeamAutomatically(
        data.requestDate, 
        data.startTime, 
        data.endTime,
        false,
        data.workType
      );
    }
    
    if (!teamAssignment || !teamAssignment.success) {
      console.log('Team assignment failed');
      return {
        success: false,
        message: teamAssignment ? teamAssignment.message : '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏±‡∏î‡∏ó‡∏µ‡∏°‡πÑ‡∏î‡πâ'
      };
    }
    
    console.log('Survey team assigned:', teamAssignment);
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á Unique ID
    const rfiId = generateUniqueId();
    console.log('Generated ID:', rfiId);
    
    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Order_Survey ‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á Survey_NO
    const orderSurvey = getNextOrderSurvey();
    const surveyNo = 'SW-' + String(orderSurvey).padStart(4, '0');
    console.log('Survey NO:', surveyNo);
    
    // ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏õ‡∏¢‡∏±‡∏á Google Drive (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
    let uploadResult = null;
    
    if (data.locationLayoutFile) {
      progressSteps.push('‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå');
      console.log('Uploading file to Drive...');
      uploadResult = uploadSurveyLocationLayout(data.locationLayoutFile, surveyNo);
      
      if (!uploadResult.success) {
        console.error('File upload failed:', uploadResult.message);
        return {
          success: false,
          message: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏î‡πâ: ' + uploadResult.message
        };
      }
      
      console.log('‚úÖ File uploaded:', uploadResult.fileUrl);
    } else {
      console.log('‚ö†Ô∏è No file attached - skipping upload');
    }
    
    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Sheet
    progressSteps.push('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
    let sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('RFI_List');
    
    if (!sheet) {
      sheet = createRFIListSheet();
    }
    
    const lastRow = sheet.getLastRow();
    const nextRow = lastRow + 1;
    const currentTime = new Date();
    
    const combinedDescription = data.workType + ' - ' + data.description;
    
    const dateParts = data.requestDate.split('-');
    const formattedDate = dateParts[1] + '/' + dateParts[2] + '/' + dateParts[0];
    
    // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• 41 columns
    const rowData = [];
    for (let i = 0; i < 41; i++) {
      rowData.push('');
    }
    
    rowData[0] = rfiId;                               // A - ID
    rowData[1] = surveyNo;                            // B - Survey_NO
    rowData[2] = combinedDescription;                 // C - Description
    rowData[3] = data.location;                       // D - Location
    rowData[4] = formattedDate;                       // E - Request_Date
    rowData[5] = data.startTime;                      // F - Start_Time
    rowData[6] = data.endTime;                        // G - End_Time
    rowData[7] = orderSurvey;                         // H - Order_Survey
    rowData[9] = validatedEmail;                      // J - Requester_Email
    rowData[10] = validatedName;                      // K - Requester_Name
    rowData[11] = teamAssignment.teamName;            // L - Assigned_Team
    rowData[14] = 'Survey Work Request Submitted';    // O - Status
    rowData[15] = currentTime;                        // P - Created_Timestamp
    rowData[16] = recordedByEmail;                    // Q - Recorded_By (Email) ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏°
    rowData[39] = 'Survey Work';                      // AN - Type
    rowData[40] = uploadResult ? uploadResult.fileUrl : '';  // AO - Location_Layout_URL
    
    sheet.getRange(nextRow, 1, 1, 41).setValues([rowData]);
    console.log('‚úÖ Data added to sheet successfully');
    console.log('   Recorded By:', recordedByName, '(', recordedByEmail, ')');
    
    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å Calendar Service
    progressSteps.push('‡∏™‡∏£‡πâ‡∏≤‡∏á Calendar Event');
    let calendarResult = null;
    
    try {
      console.log('Calling Calendar Service...');
      
      const teamEmails = [];
      
      const surveyTeamEmails = getSurveyEmailList();
      surveyTeamEmails.forEach(function(member) {
        teamEmails.push(member.email);
      });
      
      const assignedTeamEmails = getTeamEmailsByTeamNames(teamAssignment.teamName);
      assignedTeamEmails.forEach(function(member) {
        if (teamEmails.indexOf(member.email) === -1) {
          teamEmails.push(member.email);
        }
      });
      
      calendarResult = callCalendarServiceWithRetry({
        requestDate: data.requestDate,
        startTime: data.startTime,
        endTime: data.endTime,
        description: combinedDescription,
        location: data.location,
        requesterName: validatedName,
        requesterEmail: validatedEmail,
        assignedTeam: teamAssignment.teamName,
        surveyNo: surveyNo,
        teamEmails: teamEmails,
        locationLayoutUrl: uploadResult ? uploadResult.fileUrl : null
      }, 3);
      
      if (calendarResult.success) {
        console.log('‚úÖ Calendar Event Created via Service');
        console.log('Event ID:', calendarResult.data.eventId);
      } else {
        console.log('‚ö†Ô∏è Calendar Service Failed:', calendarResult.message);
      }
      
    } catch (calendarError) {
      console.error('‚ö†Ô∏è Calendar Service Error:', calendarError);
      calendarResult = {
        success: false,
        error: calendarError.toString()
      };
    }
    
    // ‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•
    progressSteps.push('‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô');
    let emailSent = false;
    try {
      const emailData = {
        requestDate: data.requestDate,
        startTime: data.startTime,
        endTime: data.endTime,
        description: combinedDescription,
        location: data.location,
        requesterName: validatedName,
        requesterEmail: validatedEmail,
        assignedTeam: teamAssignment.teamName,
        teamCategory: 'Survey Work',
        locationLayoutUrl: uploadResult ? uploadResult.fileUrl : null,
        recordedBy: recordedByName,  // ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Recorded By
        recordedByEmail: recordedByEmail
      };
      emailSent = sendSurveyWorkNotificationEmail(emailData, rfiId, surveyNo);
    } catch (emailError) {
      console.error('Failed to send email:', emailError);
    }
    
    let message = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Survey Work Request ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß';
    message += '\nüìã Survey NO: ' + surveyNo;
    message += '\n‡∏á‡∏≤‡∏ô: ' + data.workType;
    message += '\nüë• ‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô: ' + teamAssignment.teamName;
    message += '\nüìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÇ‡∏î‡∏¢: ' + recordedByName;  // ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    
    if (uploadResult && uploadResult.fileName) {
      message += '\nüìé ‡πÑ‡∏ü‡∏•‡πå: ' + uploadResult.fileName;
    }
    
    if (!userValidation.exists) {
      message += '\n‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡πâ‡∏ß';
    }
    
    if (calendarResult && calendarResult.success) {
      message += '\n‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á Calendar Event ‡πÅ‡∏•‡πâ‡∏ß';
    } else if (calendarResult) {
      message += '\n‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á Calendar Event ‡πÑ‡∏î‡πâ';
    }
    
    if (emailSent) {
      message += '\n‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏à‡πâ‡∏á‡∏ó‡∏µ‡∏° Survey ‡πÅ‡∏•‡πâ‡∏ß';
    }
    
    console.log('========== saveSurveyWorkRequirement SUCCESS ==========');
    
    return {
      success: true,
      message: message,
      rfiId: rfiId,
      surveyNo: surveyNo,
      emailSent: emailSent,
      calendarCreated: calendarResult ? calendarResult.success : false,
      userAdded: !userValidation.exists,
      assignedTeam: teamAssignment.teamName,
      workType: data.workType,
      fileUrl: uploadResult ? uploadResult.fileUrl : null,
      fileName: uploadResult ? uploadResult.fileName : null,
      progress: progressSteps,
      recordedBy: recordedByName  // ‚≠ê ‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢
    };
    
  } catch (error) {
    console.error('========== saveSurveyWorkRequirement FAILED ==========');
    console.error('Error:', error);
    
    // ‚úÖ‚úÖ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ ‚úÖ‚úÖ‚úÖ
    logError('saveSurveyWorkRequirement', error, {
      requestDate: data.requestDate || 'unknown',
      workType: data.workType || 'unknown',
      requesterEmail: data.requesterEmail || 'unknown',
      hasFile: !!data.locationLayoutFile
    }, 'CRITICAL');
    
    return {
      success: false,
      message: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.toString()
    };
  }
}

/**
 * ‚≠ê ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å Calendar Service API (‡πÉ‡∏ä‡πâ Properties)
 */
function callCalendarService(eventData) {
  try {
    // ‚≠ê ‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å Properties (‡πÑ‡∏°‡πà hardcode)
    const scriptProperties = PropertiesService.getScriptProperties();
    const CALENDAR_SERVICE_URL = scriptProperties.getProperty('CALENDAR_SERVICE_URL');
    const API_KEY = scriptProperties.getProperty('CALENDAR_SERVICE_API_KEY');
    
    if (!CALENDAR_SERVICE_URL || !API_KEY) {
      throw new Error('Calendar Service not configured. Run setupCalendarServiceConfig() first.');
    }
    
    const payload = {
      apiKey: API_KEY,
      action: 'createSurveyWorkEvent',
      data: eventData
    };
    
    const options = {
      method: 'post',
      contentType: 'application/json',
      payload: JSON.stringify(payload),
      muteHttpExceptions: true
    };
    
    console.log('Sending request to Calendar Service...');
    console.log('URL:', CALENDAR_SERVICE_URL);
    
    const response = UrlFetchApp.fetch(CALENDAR_SERVICE_URL, options);
    const responseCode = response.getResponseCode();
    const responseText = response.getContentText();
    
    console.log('Response Code:', responseCode);
    console.log('Response:', responseText);
    
    if (responseCode !== 200) {
      return {
        success: false,
        message: 'Calendar Service returned error code: ' + responseCode
      };
    }
    
    const result = JSON.parse(responseText);
    
    return result;
    
  } catch (error) {
    console.error('Error calling Calendar Service:', error);
    
    return {
      success: false,
      message: 'Failed to call Calendar Service: ' + error.toString()
    };
  }
}

/**
 * ‚≠ê ‡∏î‡∏∂‡∏á Email List ‡∏Ç‡∏≠‡∏á Survey Team (Role = "Survey" ‡∏´‡∏£‡∏∑‡∏≠ "Survey Reviewer")
 */
function getSurveyEmailList() {
  try {
    const userSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('User');
    
    if (!userSheet) {
      console.log('User sheet not found');
      return [];
    }
    
    const lastRow = userSheet.getLastRow();
    if (lastRow <= 1) {
      console.log('No data in User sheet');
      return [];
    }
    
    const data = userSheet.getRange(2, 2, lastRow - 1, 4).getValues();
    const emailList = [];
    
    for (let i = 0; i < data.length; i++) {
      const email = String(data[i][0] || '').trim();
      const displayName = String(data[i][1] || '').trim();
      const role = String(data[i][2] || '').trim();
      const status = String(data[i][3] || '').trim();
      
      // ‚≠ê ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Role = "Survey" ‡∏´‡∏£‡∏∑‡∏≠ "Survey Reviewer" ‡πÅ‡∏•‡∏∞ Status = "Activated"
      if ((role === 'Survey' || role === 'Survey Reviewer') && 
          status === 'Activated' && 
          email && email.includes('@')) {
        emailList.push({
          email: email,
          name: displayName,
          role: role
        });
      }
    }
    
    console.log('Found Survey team emails:', emailList.length);
    return emailList;
    
  } catch (error) {
    console.error('Error getting Survey email list:', error);
    return [];
  }
}

function createSurveyWorkCalendarEvent(data, rfiId, surveyNo) {
  try {
    console.log('========== Creating Survey Work Calendar Event ==========');
    console.log('RFI ID:', rfiId);
    console.log('Data:', JSON.stringify(data));
    
    // ‚≠ê ‡πÉ‡∏™‡πà Calendar ID ‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏î‡πâ
    const CENTRAL_CALENDAR_ID = '6cbf6620e2630d70b763e8fe7f04d40b59d13da14a4c39cbb17687c69778b135@group.calendar.google.com';
    
    console.log('üîç Using Central Calendar ID:', CENTRAL_CALENDAR_ID);
    
    let calendar;
    
    try {
      calendar = CalendarApp.getCalendarById(CENTRAL_CALENDAR_ID);
      
      if (!calendar) {
        console.log('‚ùå Cannot access Central Calendar');
        console.log('‚ö†Ô∏è Falling back to user calendar');
        calendar = CalendarApp.getDefaultCalendar();
      } else {
        console.log('‚úÖ Using Central Calendar:', calendar.getName());
        console.log('‚úÖ Owner:', calendar.getOwnerEmail());
      }
      
    } catch (calError) {
      console.log('‚ùå Error accessing Central Calendar:', calError.message);
      console.log('‚ö†Ô∏è User may not have access - check calendar sharing');
      console.log('‚ö†Ô∏è Falling back to user calendar');
      calendar = CalendarApp.getDefaultCalendar();
    }
    
    // ‚≠ê ‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏° - ‡∏™‡∏£‡πâ‡∏≤‡∏á Event
    const dateParts = data.requestDate.split('-');
    const year = parseInt(dateParts[0]);
    const month = parseInt(dateParts[1]) - 1;
    const day = parseInt(dateParts[2]);
    
    const startTimeParts = data.startTime.split(':');
    const startHour = parseInt(startTimeParts[0]);
    const startMinute = parseInt(startTimeParts[1]);
    
    const endTimeParts = data.endTime.split(':');
    const endHour = parseInt(endTimeParts[0]);
    const endMinute = parseInt(endTimeParts[1]);
    
    const startDateTime = new Date(year, month, day, startHour, startMinute, 0);
    const endDateTime = new Date(year, month, day, endHour, endMinute, 0);
    
    const eventTitle = 'üó∫Ô∏è Survey Work: ' + surveyNo + ' - ' + data.assignedTeam;
    
    const description = 
      '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n' +
      'üó∫Ô∏è SURVEY WORK REQUEST\n' +
      '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n' +
      'Survey NO: ' + surveyNo + '\n' +
      '‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô: ' + data.assignedTeam + '\n' +
      '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î: ' + data.description + '\n' +
      '‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà: ' + data.location + '\n\n' +
      '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n' +
      '‡∏ú‡∏π‡πâ‡∏Ç‡∏≠: ' + data.requesterName + '\n' +
      '‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ú‡∏π‡πâ‡∏Ç‡∏≠: ' + data.requesterEmail + '\n' +
      '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n' +
      '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ' + formatDateThai(data.requestDate) + '\n' +
      '‡πÄ‡∏ß‡∏•‡∏≤: ' + data.startTime + ' - ' + data.endTime + ' ‡∏ô.\n\n' +
      '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó: Survey Work\n' +
      '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: Survey Work Request Submitted\n\n' +
      '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n' +
      '‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏î‡∏¢: Survey Work Requirement System\n' +
      '‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á: ' + new Date().toLocaleString('th-TH') + '\n' +
      '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê';
    
    const guestList = [];
    
    if (data.requesterEmail && data.requesterEmail.includes('@')) {
      guestList.push(data.requesterEmail);
      console.log('Added Requester:', data.requesterEmail);
    }
    
    const surveyTeamEmails = getSurveyEmailList();
    surveyTeamEmails.forEach(function(member) {
      if (guestList.indexOf(member.email) === -1) {
        guestList.push(member.email);
        console.log('Added Survey Team Member:', member.email, '(' + member.role + ')');
      }
    });
    
    if (data.assignedTeam) {
      const teamEmails = getTeamEmailsByTeamNames(data.assignedTeam);
      teamEmails.forEach(function(teamMember) {
        if (guestList.indexOf(teamMember.email) === -1) {
          guestList.push(teamMember.email);
          console.log('Added team member:', teamMember.name, '->', teamMember.email);
        }
      });
    }
    
    console.log('Total guests:', guestList.length);
    
    const event = calendar.createEvent(
      eventTitle,
      startDateTime,
      endDateTime,
      {
        description: description,
        location: data.location,
        guests: guestList.join(','),
        sendInvites: true
      }
    );
    
    try {
      event.setColor(CalendarApp.EventColor.GREEN);
    } catch (colorError) {
      console.log('Could not set event color:', colorError.message);
    }
    
    console.log('‚úÖ Calendar Event Created:', event.getId());
    console.log('Event Title:', eventTitle);
    console.log('Calendar Owner:', calendar.getOwnerEmail());
    console.log('Start:', startDateTime);
    console.log('End:', endDateTime);
    console.log('Guests:', guestList.join(', '));
    console.log('========== Calendar Event Creation Complete ==========');
    
    return {
      success: true,
      eventId: event.getId(),
      eventTitle: eventTitle,
      guestsCount: guestList.length,
      guests: guestList,
      calendarOwner: calendar.getOwnerEmail()
    };
    
  } catch (error) {
    console.error('Error in sendRFINotificationEmail:', error);
    
    // ‚úÖ‚úÖ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ ‚úÖ‚úÖ‚úÖ
    logError('sendRFINotificationEmail', error, {
      rfiId: rfiId,
      requesterEmail: data.requesterEmail || 'unknown',
      assignedTeam: data.assignedTeam || 'unknown',
      recipientCount: (data.assignedTeam ? 1 : 0)
    }, 'WARNING'); // WARNING ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÑ‡∏°‡πà‡∏£‡πâ‡∏≤‡∏¢‡πÅ‡∏£‡∏á (‡∏™‡πà‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡πÅ‡∏ï‡πà RFI ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß)
    
    return false;
  }
}

/**
 * ‚≠ê ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï: ‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏à‡πâ‡∏á Survey Work ‡πÑ‡∏õ‡∏´‡∏≤ Survey Team
 */
function sendSurveyWorkNotificationEmail(data, rfiId, surveyNo) {
  try {
    console.log('========== START: sendSurveyWorkNotificationEmail ==========');
    
    const quota = checkEmailQuota();
    if (quota <= 1) {
      console.log('Email quota too low:', quota);
      return false;
    }
    
    const emailList = getSurveyEmailList();
    
    if (emailList.length === 0) {
      console.log('No Survey team email recipients found');
      return false;
    }
    
    const recipients = emailList.map(function(e) { return e.email; });
    
    // ‡πÄ‡∏û‡∏¥‡πà‡∏° Requester Email
    if (data.requesterEmail && 
        data.requesterEmail.includes('@') && 
        !recipients.includes(data.requesterEmail)) {
      recipients.push(data.requesterEmail);
    }
    
    // ‡πÄ‡∏û‡∏¥‡πà‡∏° Team Emails
    if (data.assignedTeam) {
      const teamEmails = getTeamEmailsByTeamNames(data.assignedTeam);
      teamEmails.forEach(function(teamMember) {
        if (!recipients.includes(teamMember.email)) {
          recipients.push(teamMember.email);
          console.log('Added team member:', teamMember.name, '->', teamMember.email);
        }
      });
    }
    
    console.log('Sending to:', recipients.length, 'recipients');
    console.log('Recipients:', recipients.join(', '));
    
    // ‚≠ê ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å createSurveyWorkEmailHTML ‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á surveyNo
    const emailHtml = createSurveyWorkEmailHTML(data, rfiId, surveyNo);
    
    const sent = safeSendEmail({
      to: recipients.join(','),
      subject: 'üó∫Ô∏è Survey Work Request ‡πÉ‡∏´‡∏°‡πà [ID: ' + surveyNo + ']',
      htmlBody: emailHtml,
      name: 'Survey Work Requirement System'
    });
    
    console.log('Email result:', sent);
    return sent;
    
  } catch (error) {
    console.error('Error in sendSurveyWorkNotificationEmail:', error);
    
    // ‚úÖ‚úÖ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ ‚úÖ‚úÖ‚úÖ
    logError('sendSurveyWorkNotificationEmail', error, {
      rfiId: rfiId,
      surveyNo: surveyNo,
      requesterEmail: data.requesterEmail || 'unknown',
      assignedTeam: data.assignedTeam || 'unknown'
    }, 'WARNING');
    
    return false;
  }
}
function createSurveyWorkEmailHTML(data, rfiId, surveyNo) {
  // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á Location Layout File
  var fileInfo = '';
  if (data.locationLayoutUrl) {
    fileInfo = '<tr><th>üìé Location Layout</th><td><a href="' + data.locationLayoutUrl + '" target="_blank" style="color: #16a34a; text-decoration: none; font-weight: 600; display: inline-flex; align-items: center; gap: 6px; padding: 8px 12px; background: #ecfdf5; border-radius: 6px; border: 1px solid #16a34a;">üìÑ ‡∏î‡∏π‡πÑ‡∏ü‡∏•‡πå Location Layout ‚Üó</a></td></tr>';
  }
  
  // ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á Recorded By
  var recordedByInfo = '';
  if (data.recordedBy && data.recordedByEmail) {
    recordedByInfo = '<tr><th>üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÇ‡∏î‡∏¢</th><td>' + data.recordedBy;
    
    // ‡∏ñ‡πâ‡∏≤ Requester ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤ Survey Role ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏´‡πâ
    if (data.recordedByEmail !== data.requesterEmail) {
      recordedByInfo += ' <span style="color: #f59e0b; font-weight: 600;">(Survey Role)</span>';
    }
    
    recordedByInfo += '</td></tr>';
  }
  
  const emailBody = `<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<style>
body { font-family: Arial, sans-serif; margin: 20px; }
h2 { color: #16a34a; }
.id-badge { 
  display: inline-block;
  background: linear-gradient(135deg, #16a34a 0%, #22c55e 100%);
  color: white;
  padding: 5px 12px;
  border-radius: 5px;
  font-weight: bold;
  font-size: 16px;
  margin-bottom: 15px;
}
table { border-collapse: collapse; width: 100%; }
td, th { border: 1px solid #ddd; padding: 8px; text-align: left; }
th { background-color: #ecfdf5; }
.status-badge {
  display: inline-block;
  background: #22c55e;
  color: white;
  padding: 3px 8px;
  border-radius: 3px;
  font-size: 12px;
  font-weight: bold;
}
.highlight {
  background: #ecfdf5;
  padding: 10px;
  border-left: 4px solid #16a34a;
  margin: 15px 0;
  border-radius: 5px;
}
</style>
</head>
<body>
<h2>üó∫Ô∏è ‡πÅ‡∏à‡πâ‡∏á Survey Work Request ‡πÉ‡∏´‡∏°‡πà</h2>
<div class="id-badge">Survey NO: ${surveyNo}</div>
<p>‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‡∏ó‡∏µ‡∏° Survey</p>
<p>‡∏°‡∏µ Survey Work Request ‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</p>

<div class="highlight">
  <strong>üìÖ Calendar Event</strong><br>
  ‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á Calendar Event ‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á invitation ‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì<br>
  ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Calendar ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°
</div>

<h3>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î Survey Work</h3>
<table>
<tr><th>Survey NO</th><td><strong>${surveyNo}</strong></td></tr>
<tr><th>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th><td>${data.description}</td></tr>
<tr><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</th><td>${data.location}</td></tr>
<tr><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£</th><td>${formatDateThai(data.requestDate)}</td></tr>
<tr><th>‡πÄ‡∏ß‡∏•‡∏≤</th><td>${data.startTime} - ${data.endTime} ‡∏ô.</td></tr>
<tr><th>‡∏ó‡∏µ‡∏°‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡πÉ‡∏´‡πâ</th><td><strong style="color: #16a34a;">${data.assignedTeam}</strong> (Survey Team)</td></tr>
${fileInfo}
<tr><th>‡∏ú‡∏π‡πâ‡∏Ç‡∏≠</th><td>${data.requesterName}</td></tr>
${data.requesterEmail ? '<tr><th>‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ú‡∏π‡πâ‡∏Ç‡∏≠</th><td>' + data.requesterEmail + '</td></tr>' : ''}
${recordedByInfo}
<tr><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><td><span class="status-badge">Survey Work Request Submitted</span></td></tr>
</table>

${data.locationLayoutUrl ? '<div class="highlight"><strong>üìé Location Layout File ‡πÅ‡∏ô‡∏ö‡∏°‡∏≤‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ô‡∏µ‡πâ</strong><br>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</div>' : ''}

<div class="highlight">
  <strong>‚ö†Ô∏è ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ:</strong><br>
  1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Calendar Event ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö<br>
  2. ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏° (Accept/Decline)<br>
  3. ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÅ‡∏•‡∏∞‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô<br>
  4. ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏Ç‡∏≠‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°
</div>

<hr>
<p><small>‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ô‡∏µ‡πâ‡∏™‡πà‡∏á‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö Survey Work Requirement ‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</small></p>
<p><small>‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á: ${new Date().toLocaleString('th-TH')}</small></p>
</body>
</html>`;
  
  return emailBody;
}



/**
 * ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡πÉ‡∏´‡πâ‡∏°‡∏µ Column AN = "RFI Work"
 * (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö records ‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï)
 */
function updateOldRecordsColumnAN() {
  try {
    console.log('========== Update Old Records Column AN ==========');
    
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('RFI_List');
    
    if (!sheet) {
      console.log('‚ùå RFI_List sheet not found');
      return;
    }
    
    const lastRow = sheet.getLastRow();
    if (lastRow <= 1) {
      console.log('‚ùå No data rows');
      return;
    }
    
    // ‡∏î‡∏∂‡∏á Column AN (index 40)
    const typeData = sheet.getRange(2, 40, lastRow - 1, 1).getValues();
    
    let updateCount = 0;
    
    for (let i = 0; i < typeData.length; i++) {
      const type = String(typeData[i][0] || '').trim();
      
      // ‡∏ñ‡πâ‡∏≤ Column AN ‡∏ß‡πà‡∏≤‡∏á ‡∏´‡∏£‡∏∑‡∏≠ ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà "Survey Work" ‡πÉ‡∏´‡πâ‡πÉ‡∏™‡πà "RFI Work"
      if (!type || (type !== 'Survey Work' && type !== 'RFI Work')) {
        sheet.getRange(i + 2, 40).setValue('RFI Work');
        updateCount++;
      }
    }
    
    console.log('‚úÖ Updated ' + updateCount + ' records with Column AN = "RFI Work"');
    console.log('==================================================');
    
    if (updateCount > 0) {
      SpreadsheetApp.getUi().alert(
        '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‚úÖ',
        '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Column AN ‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö ' + updateCount + ' records\n' +
        '‡∏ó‡∏∏‡∏Å record ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà Survey Work ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πá‡∏ô "RFI Work"',
        SpreadsheetApp.getUi().ButtonSet.OK
      );
    } else {
      SpreadsheetApp.getUi().alert(
        '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï',
        '‡∏ó‡∏∏‡∏Å records ‡∏°‡∏µ Column AN ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß',
        SpreadsheetApp.getUi().ButtonSet.OK
      );
    }
    
  } catch (error) {
    console.error('‚ùå Error:', error);
    
    SpreadsheetApp.getUi().alert(
      '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
      '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Column AN ‡πÑ‡∏î‡πâ\n\n' +
      'Error: ' + error.toString(),
      SpreadsheetApp.getUi().ButtonSet.OK
    );
  }
}




// ===== Performance & Helper Functions =====

/**
 * ‚ö° Cache blocked time slots ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏µ‡∏°
 */
function getBlockedTimeSlotsForTeams(date, teams) {
  const blockedSlots = {};
  
  teams.forEach(function(team) {
    blockedSlots[team.resourceId] = [];
  });
  
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('RFI_List');
  if (!sheet) return blockedSlots;
  
  const lastRow = sheet.getLastRow();
  if (lastRow <= 1) return blockedSlots;
  
  const data = sheet.getRange(2, 1, lastRow - 1, 15).getValues();
  
  const resourceSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Resources');
  if (!resourceSheet) return blockedSlots;
  
  const resourceData = resourceSheet.getRange(2, 1, resourceSheet.getLastRow() - 1, 2).getValues();
  
  const nameToId = {};
  resourceData.forEach(function(row) {
    const rid = String(row[0] || '').trim();
    const rname = String(row[1] || '').trim();
    if (rid && rname) {
      nameToId[rname] = rid;
    }
  });
  
  for (let i = 0; i < data.length; i++) {
    const row = data[i];
    const rfiDate = formatDate(new Date(row[4]));
    const status = String(row[14] || '').trim();
    
    if (isStatusInactive(status)) continue;
    if (rfiDate !== date) continue;
    
    const startTime = formatTime(row[5]);
    const endTime = formatTime(row[6]);
    const assignedTeams = String(row[11] || '').trim();
    
    if (!assignedTeams) continue;
    
    const teamNames = assignedTeams.split(',').map(function(n) { return n.trim(); });
    
    teamNames.forEach(function(teamName) {
      const resourceId = nameToId[teamName];
      if (resourceId && blockedSlots[resourceId]) {
        blockedSlots[resourceId].push({
          start: timeToMinutes(startTime),
          end: timeToMinutes(endTime)
        });
      }
    });
  }
  
  return blockedSlots;
}

/**
 * üîß ‡πÅ‡∏õ‡∏•‡∏á minutes ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô time string
 */
function minutesToTime(minutes) {
  const hours = Math.floor(minutes / 60);
  const mins = minutes % 60;
  return hours.toString().padStart(2, '0') + ':' + mins.toString().padStart(2, '0');
}

/**
 * ‚öôÔ∏è ‡∏î‡∏∂‡∏á Buffer Minutes ‡∏ï‡∏≤‡∏° Work Type
 */
function getBufferMinutes(workType) {
  const bufferConfig = {
    'Survey Work': 0,
    'Lab Work': 30,
    'Inspector Work': 30,
    'Heavy Work': 60
  };
  
  return bufferConfig[workType] || 25;
}

/**
 * üí¨ ‡∏´‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ Time Slots
 */
function getNoSlotsReason(date, category) {
  try {
    const teams = getTeamsByCategory(category);
    
    if (teams.length === 0) {
      return {
        reason: 'no_teams',
        message: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î ' + category,
        suggestion: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô'
      };
    }
    
    const selectedDate = new Date(date + 'T00:00:00');
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    if (selectedDate < today) {
      return {
        reason: 'past_date',
        message: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß',
        suggestion: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏ß‡∏±‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ'
      };
    }
    
    const blockedSlots = getBlockedTimeSlotsForTeams(date, teams);
    
    let totalBlocks = 0;
    Object.keys(blockedSlots).forEach(function(teamId) {
      totalBlocks += blockedSlots[teamId].length;
    });
    
    if (totalBlocks > 0) {
      return {
        reason: 'fully_booked',
        message: '‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô‡∏ñ‡∏π‡∏Å‡∏à‡∏≠‡∏á‡πÄ‡∏ï‡πá‡∏°‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ',
        suggestion: '‡∏•‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ó‡∏µ‡∏° QC ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏ß‡∏•‡∏≤',
        details: {
          totalTeams: teams.length,
          totalBookings: totalBlocks
        }
      };
    }
    
    return {
      reason: 'time_constraint',
      message: '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°',
      suggestion: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏≠‡∏∑‡πà‡∏ô'
    };
    
  } catch (error) {
    console.error('Error getting no slots reason:', error);
    return {
      reason: 'error',
      message: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö',
      suggestion: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á'
    };
  }
}

/**
 * üìä ‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡∏°‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏ß‡∏•‡∏≤
 */
function getAvailableTeamsWithSlots(date, category) {
  try {
    const teams = getTeamsByCategory(category);
    if (teams.length === 0) return [];
    
    const blockedSlots = getBlockedTimeSlotsForTeams(date, teams);
    
    const result = [];
    
    teams.forEach(function(team) {
      const blocks = blockedSlots[team.resourceId] || [];
      
      result.push({
        teamId: team.resourceId,
        teamName: team.resourceName,
        teamNo: team.teamNo,
        totalBookings: blocks.length,
        blockedTimes: blocks.map(function(b) {
          return minutesToTime(b.start) + '-' + minutesToTime(b.end);
        }),
        isFullyBooked: blocks.length >= 10
      });
    });
    
    result.sort(function(a, b) {
      return a.totalBookings - b.totalBookings;
    });
    
    return result;
    
  } catch (error) {
    console.error('Error getting available teams:', error);
    return [];
  }
}

/**
 * üí° ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏∑‡πà‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ó‡∏µ‡∏°‡∏ß‡πà‡∏≤‡∏á
 */
function suggestAlternativeTimeSlots(category, date, startTime, endTime) {
  try {
    const teams = getTeamsByCategory(category);
    if (teams.length === 0) return [];
    
    const duration = timeToMinutes(endTime) - timeToMinutes(startTime);
    const suggestions = [];
    
    const allSlots = [];
    for (let hour = 9; hour <= 19; hour++) {
      for (let minute = 0; minute < 60; minute += 30) {
        if (hour === 19 && minute === 30) break;
        allSlots.push(hour.toString().padStart(2, '0') + ':' + minute.toString().padStart(2, '0'));
      }
    }
    
    allSlots.forEach(function(slot) {
      const startMinutes = timeToMinutes(slot);
      const endMinutes = startMinutes + duration;
      
      if (endMinutes > 20 * 60) return;
      
      const endSlot = minutesToTime(endMinutes);
      
      let hasAvailableTeam = false;
      
      for (let i = 0; i < teams.length; i++) {
        if (isTeamAvailable(teams[i].resourceId, date, slot, endSlot)) {
          hasAvailableTeam = true;
          break;
        }
      }
      
      if (hasAvailableTeam) {
        suggestions.push({
          startTime: slot,
          endTime: endSlot,
          duration: duration + ' ‡∏ô‡∏≤‡∏ó‡∏µ'
        });
      }
    });
    
    return suggestions.slice(0, 5);
    
  } catch (error) {
    console.error('Error suggesting alternatives:', error);
    return [];
  }
}

/**
 * ‚úÖ Validate RFI Request
 */
function validateRFIRequest(data) {
  const errors = [];
  
  if (!data.requestDate) errors.push('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà');
  if (!data.startTime) errors.push('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô');
  if (!data.endTime) errors.push('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î');
  if (!data.description) errors.push('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î');
  if (!data.location) errors.push('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà');
  
  if (data.requestDate) {
    const selectedDate = new Date(data.requestDate + 'T00:00:00');
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    if (selectedDate < today) {
      errors.push('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß');
    }
  }
  
  if (data.startTime && data.endTime) {
    const startMinutes = timeToMinutes(data.startTime);
    const endMinutes = timeToMinutes(data.endTime);
    
    if (endMinutes <= startMinutes) {
      errors.push('‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô');
    }
    
    const duration = endMinutes - startMinutes;
    if (duration < 30) {
      errors.push('‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤ 30 ‡∏ô‡∏≤‡∏ó‡∏µ');
    }
    
    if (duration > 480) {
      errors.push('‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 8 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á');
    }
  }
  
  if (data.startTime) {
    const startMinutes = timeToMinutes(data.startTime);
    if (startMinutes < 9 * 60 || startMinutes >= 19 * 60) {
      errors.push('‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á 09:00-19:00');
    }
  }
  
  if (data.endTime) {
    const endMinutes = timeToMinutes(data.endTime);
    if (endMinutes > 20 * 60) {
      errors.push('‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 20:00');
    }
  }
  
  if (data.requesterEmail && !data.requesterEmail.includes('@')) {
    errors.push('‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
  }
  
  return {
    valid: errors.length === 0,
    errors: errors
  };
}

/**
 * üí¨ ‡∏´‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡∏ó‡∏µ‡∏°‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ
 */
function getTeamAssignmentFailureReason(category, date, startTime, endTime) {
  try {
    const teams = getTeamsByCategory(category);
    
    if (teams.length === 0) {
      return {
        reason: 'no_teams_in_category',
        message: '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ó‡∏µ‡∏°‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î ' + category,
        suggestion: '‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô'
      };
    }
    
    const unavailableTeams = [];
    
    teams.forEach(function(team) {
      if (!isTeamAvailable(team.resourceId, date, startTime, endTime)) {
        unavailableTeams.push({
          teamName: team.resourceName,
          teamNo: team.teamNo
        });
      }
    });
    
    if (unavailableTeams.length === teams.length) {
      return {
        reason: 'all_teams_busy',
        message: '‡∏ó‡∏µ‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏µ‡πâ',
        suggestion: '‡∏•‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏∑‡πà‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏ß‡∏±‡∏ô‡∏≠‡∏∑‡πà‡∏ô',
        details: {
          totalTeams: teams.length,
          busyTeams: unavailableTeams
        }
      };
    }
    
    return {
      reason: 'unknown',
      message: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏±‡∏î‡∏ó‡∏µ‡∏°‡πÑ‡∏î‡πâ',
      suggestion: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö'
    };
    
  } catch (error) {
    console.error('Error:', error);
    return {
      reason: 'error',
      message: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.toString()
    };
  }
}


function getTeamEmailsByTeamNames(teamNames) {
  try {
    console.log('========== getTeamEmailsByTeamNames START ==========');
    console.log('Input teamNames:', teamNames);
    console.log('Type:', typeof teamNames);
    
    // Check 1: teamNames is valid
    if (!teamNames) {
      console.log('‚ùå No team names provided (null/undefined)');
      return [];
    }
    
    const teamString = String(teamNames).trim();
    console.log('Team string (trimmed):', teamString);
    
    if (teamString === '') {
      console.log('‚ùå Empty team names');
      return [];
    }
    
    // Check 2: Parse team names
    const requestedTeams = teamString.split(',').map(function(t) { 
      return t.trim(); 
    }).filter(function(t) { 
      return t.length > 0; 
    });
    
    console.log('Parsed teams:', JSON.stringify(requestedTeams));
    console.log('Number of teams:', requestedTeams.length);
    
    if (requestedTeams.length === 0) {
      console.log('‚ùå No valid teams after parsing');
      return [];
    }
    
    // Check 3: Access spreadsheet
    console.log('Accessing spreadsheet...');
    const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    console.log('‚úÖ Spreadsheet name:', spreadsheet.getName());
    
    // Check 4: Get Resources sheet
    console.log('Looking for Resources sheet...');
    const resourceSheet = spreadsheet.getSheetByName('Resources');
    
    if (!resourceSheet) {
      console.log('‚ùå Resources sheet not found!');
      
      // Debug: List all sheets
      const allSheets = spreadsheet.getSheets();
      console.log('Available sheets:', allSheets.map(function(s) { 
        return s.getName(); 
      }).join(', '));
      
      return [];
    }
    
    console.log('‚úÖ Resources sheet found!');
    
    // Check 5: Get data
    const lastRow = resourceSheet.getLastRow();
    const lastColumn = resourceSheet.getLastColumn();
    
    console.log('Last row:', lastRow);
    console.log('Last column:', lastColumn);
    
    if (lastRow <= 1) {
      console.log('‚ö†Ô∏è No data rows in Resources sheet');
      return [];
    }
    
    if (lastColumn < 6) {
      console.log('‚ùå Resources sheet missing columns (need at least 6)');
      console.log('   Current columns:', lastColumn);
      console.log('   Required: 6 (A-F with Contact_Email in column F)');
      return [];
    }
    
    // Check 6: Read data (B-F = Name, SubType, TeamNo, Status, Email)
    console.log('Reading data from rows 2 to', lastRow, '...');
    const data = resourceSheet.getRange(2, 2, lastRow - 1, 5).getValues();
    console.log('‚úÖ Data rows read:', data.length);
    
    // Check 7: Process data
    const teamEmails = [];
    let rowsChecked = 0;
    let activatedCount = 0;
    let matchedCount = 0;
    
    for (let i = 0; i < data.length; i++) {
      rowsChecked++;
      
      const resourceName = String(data[i][0] || '').trim();  // Column B
      const subType = String(data[i][1] || '').trim();       // Column C
      const teamNo = data[i][2];                              // Column D
      const status = String(data[i][3] || '').trim();        // Column E
      const contactEmail = String(data[i][4] || '').trim();  // Column F
      
      // Debug first 3 rows
      if (i < 3) {
        console.log('Row ' + (i + 2) + ':');
        console.log('  Name:', resourceName);
        console.log('  Status:', status);
        console.log('  Email:', contactEmail);
      }
      
      if (status === 'Activated') {
        activatedCount++;
      }
      
      // Check if this team is in requested list
      const isRequested = requestedTeams.indexOf(resourceName) !== -1;
      
      if (isRequested) {
        matchedCount++;
        console.log('‚úì Matched team:', resourceName);
        console.log('  Status:', status);
        console.log('  Email:', contactEmail);
      }
      
      if (isRequested && 
          status === 'Activated' && 
          contactEmail && 
          contactEmail.includes('@')) {
        
        teamEmails.push({
          email: contactEmail,
          name: resourceName,
          role: 'Team Member'
        });
        
        console.log('‚úÖ Added:', resourceName, '‚Üí', contactEmail);
      }
    }
    
    console.log('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
    console.log('Summary:');
    console.log('  Rows checked:', rowsChecked);
    console.log('  Activated teams:', activatedCount);
    console.log('  Matched teams:', matchedCount);
    console.log('  Final result:', teamEmails.length, 'emails');
    console.log('========== getTeamEmailsByTeamNames END ==========');
    
    return teamEmails;
    
  } catch (error) {
    console.error('‚ùå‚ùå‚ùå ERROR in getTeamEmailsByTeamNames ‚ùå‚ùå‚ùå');
    console.error('Error message:', error.toString());
    console.error('Error stack:', error.stack);
    return [];
  }
}

/**
 * ‚≠ê ‡∏•‡∏ö Meeting Links ‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å Description
 */
function removeMeetingLinksFromDescription(description) {
  if (!description) return '';
  
  Logger.log('üßπ Cleaning description from meeting links...');
  
  let cleaned = String(description);
  
  // ‡∏•‡∏ö Google Meet links
  cleaned = cleaned.replace(/https:\/\/meet\.google\.com\/[a-z\-]+/gi, '');
  
  // ‡∏•‡∏ö Zoom links
  cleaned = cleaned.replace(/https:\/\/[^\s]*zoom\.us\/[^\s)]+/gi, '');
  
  // ‡∏•‡∏ö Microsoft Teams links
  cleaned = cleaned.replace(/https:\/\/teams\.microsoft\.com\/[^\s)]+/gi, '');
  
  // ‡∏•‡∏ö "Join with Google Meet" ‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á
  cleaned = cleaned.replace(/Join (?:with )?Google Meet[^\n]*/gi, '');
  cleaned = cleaned.replace(/‚îÄ{5,}Join with Google Meet‚îÄ{5,}/gi, '');
  
  // ‡∏•‡∏ö "Video call link:" ‡πÅ‡∏•‡∏∞ link ‡∏ó‡∏µ‡πà‡∏ï‡∏≤‡∏°‡∏°‡∏≤
  cleaned = cleaned.replace(/Video call link:\s*https?:\/\/[^\s]+/gi, '');
  cleaned = cleaned.replace(/Video call link:[^\n]*/gi, '');
  
  // ‡∏•‡∏ö "View your event at:" ‡πÅ‡∏•‡∏∞ link
  cleaned = cleaned.replace(/View your event at:\s*https?:\/\/[^\s]+/gi, '');
  cleaned = cleaned.replace(/View your event at:[^\n]*/gi, '');
  
  // ‡∏•‡∏ö‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î divider ‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠
  cleaned = cleaned.replace(/‚îÄ{10,}/g, '');
  cleaned = cleaned.replace(/‚îÅ{10,}/g, '');
  
  // ‡∏•‡∏ö‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ß‡πà‡∏≤‡∏á‡∏ã‡πâ‡∏≥‡∏ã‡πâ‡∏≠‡∏ô (‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÅ‡∏Ñ‡πà 1-2 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î)
  cleaned = cleaned.replace(/\n\n\n+/g, '\n\n');
  
  // ‡∏•‡∏ö‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏´‡∏±‡∏ß‡πÅ‡∏•‡∏∞‡∏ó‡πâ‡∏≤‡∏¢
  cleaned = cleaned.trim();
  
  Logger.log('‚úÖ Description cleaned');
  
  return cleaned;
}

/**
 * ‚≠ê FIXED: ‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏à‡∏≤‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏• (‡πÉ‡∏´‡πâ‡∏ó‡∏∏‡∏Å Role ‡∏ó‡∏µ‡πà Activated ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ)
 */
function getUserNameFromEmail(email) {
  try {
    console.log('Getting user name for email:', email);
    
    if (!email) {
      return {
        success: false,
        name: '',
        exists: false
      };
    }
    
    const userSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('User');
    
    if (!userSheet) {
      console.log('User sheet not found');
      return {
        success: false,
        name: '',
        exists: false
      };
    }
    
    const lastRow = userSheet.getLastRow();
    
    if (lastRow <= 1) {
      return {
        success: false,
        name: '',
        exists: false
      };
    }
    
    // ‡∏î‡∏∂‡∏á Column B (Email), C (DisplayName), D (Role), E (Status)
    const data = userSheet.getRange(2, 2, lastRow - 1, 4).getValues();
    
    for (let i = 0; i < data.length; i++) {
      const row = data[i];
      const userEmail = String(row[0] || '').trim().toLowerCase();
      const displayName = String(row[1] || '').trim();
      const role = String(row[2] || '').trim();
      const status = String(row[3] || '').trim();
      
      if (userEmail === email.toLowerCase()) {
        // ‚≠ê ‡πÄ‡∏ä‡πá‡∏Ñ‡πÅ‡∏Ñ‡πà Status = Activated (‡πÑ‡∏°‡πà‡∏™‡∏ô‡πÉ‡∏à Role)
        if (status === 'Activated') {
          console.log('Found active user:', displayName, '(Role:', role + ')');
          return {
            success: true,
            name: displayName,
            exists: true,
            role: role
          };
        } else {
          // Status ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà Activated
          console.log('Found email but status is:', status);
          return {
            success: false,
            name: '',
            exists: true,
            role: role,
            status: status,
            message: '‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (Status: ' + status + ')\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö'
          };
        }
      }
    }
    
    // ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÄ‡∏•‡∏¢ ‚Üí ‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏≠‡∏á
    console.log('Email not found in User sheet');
    return {
      success: true, // ‚≠ê ‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏î‡πâ
      name: '',
      exists: false
    };
    
  } catch (error) {
    console.error('Error getting user name:', error);
    return {
      success: false,
      name: '',
      exists: false,
      error: error.toString()
    };
  }
}



// ===== Code.gs =====

/**
 * ‚≠ê ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ API Key ‡πÅ‡∏•‡∏∞ Service URL ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å (‡∏£‡∏±‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)
 */
function setupCalendarServiceConfig() {
  const ui = SpreadsheetApp.getUi();
  
  // 1. ‡πÉ‡∏™‡πà Service URL
  const urlResponse = ui.prompt(
    'Setup Calendar Service',
    'Enter Calendar Service URL:\n(from Project B deployment)',
    ui.ButtonSet.OK_CANCEL
  );
  
  if (urlResponse.getSelectedButton() !== ui.Button.OK) {
    ui.alert('Setup cancelled');
    return;
  }
  
  const serviceUrl = urlResponse.getResponseText().trim();
  
  // 2. ‡πÉ‡∏™‡πà API Key
  const keyResponse = ui.prompt(
    'Setup Calendar Service',
    'Enter API Key:\n(from Project B setupApiKey)',
    ui.ButtonSet.OK_CANCEL
  );
  
  if (keyResponse.getSelectedButton() !== ui.Button.OK) {
    ui.alert('Setup cancelled');
    return;
  }
  
  const apiKey = keyResponse.getResponseText().trim();
  
  // 3. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
  const scriptProperties = PropertiesService.getScriptProperties();
  scriptProperties.setProperty('CALENDAR_SERVICE_URL', serviceUrl);
  scriptProperties.setProperty('CALENDAR_SERVICE_API_KEY', apiKey);
  
  Logger.log('‚úÖ Configuration saved!');
  
  ui.alert(
    'Setup Complete! ‚úÖ',
    'Calendar Service URL: ' + serviceUrl + '\n\n' +
    'API Key: ' + apiKey.substring(0, 20) + '...\n\n' +
    'Configuration saved successfully!',
    ui.ButtonSet.OK
  );
}

/**
 * ‚≠ê ‡∏î‡∏π‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
 */
function viewCalendarServiceConfig() {
  const scriptProperties = PropertiesService.getScriptProperties();
  const serviceUrl = scriptProperties.getProperty('CALENDAR_SERVICE_URL');
  const apiKey = scriptProperties.getProperty('CALENDAR_SERVICE_API_KEY');
  
  Logger.log('Service URL:', serviceUrl);
  Logger.log('API Key:', apiKey);
  
  const ui = SpreadsheetApp.getUi();
  ui.alert(
    'Calendar Service Configuration',
    'URL: ' + (serviceUrl || '(not set)') + '\n\n' +
    'API Key: ' + (apiKey ? apiKey.substring(0, 20) + '...' : '(not set)'),
    ui.ButtonSet.OK
  );
}

/**
 * ‚≠ê ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï callCalendarService() ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ Properties
 */
function callCalendarService(eventData) {
  try {
    // ‚≠ê ‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å Properties
    const scriptProperties = PropertiesService.getScriptProperties();
    const CALENDAR_SERVICE_URL = scriptProperties.getProperty('CALENDAR_SERVICE_URL');
    const API_KEY = scriptProperties.getProperty('CALENDAR_SERVICE_API_KEY');
    
    if (!CALENDAR_SERVICE_URL || !API_KEY) {
      throw new Error('Calendar Service not configured. Run setupCalendarServiceConfig() first.');
    }
    
    const payload = {
      apiKey: API_KEY,
      action: 'createSurveyWorkEvent',
      data: eventData
    };
    
    const options = {
      method: 'post',
      contentType: 'application/json',
      payload: JSON.stringify(payload),
      muteHttpExceptions: true
    };
    
    console.log('Sending request to Calendar Service...');
    console.log('URL:', CALENDAR_SERVICE_URL);
    
    const response = UrlFetchApp.fetch(CALENDAR_SERVICE_URL, options);
    const responseCode = response.getResponseCode();
    const responseText = response.getContentText();
    
    console.log('Response Code:', responseCode);
    console.log('Response:', responseText);
    
    if (responseCode !== 200) {
      return {
        success: false,
        message: 'Calendar Service returned error code: ' + responseCode
      };
    }
    
    const result = JSON.parse(responseText);
    
    return result;
    
  } catch (error) {
    console.error('Error calling Calendar Service:', error);
    
    return {
      success: false,
      message: 'Failed to call Calendar Service: ' + error.toString()
    };
  }
}


/**
 * ‚≠ê ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å Calendar Service ‡∏û‡∏£‡πâ‡∏≠‡∏° Retry Logic
 */
function callCalendarServiceWithRetry(eventData, maxRetries) {
  if (typeof maxRetries === 'undefined') maxRetries = 3;
  
  let lastError = null;
  
  for (let attempt = 1; attempt <= maxRetries; attempt++) {
    try {
      console.log('üì° Calendar Service - Attempt ' + attempt + ' of ' + maxRetries);
      
      const result = callCalendarService(eventData);
      
      if (result.success) {
        console.log('‚úÖ Success on attempt ' + attempt);
        return result;
      }
      
      lastError = result.message;
      console.log('‚ö†Ô∏è Failed on attempt ' + attempt + ':', result.message);
      
      // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á attempt ‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢ ‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏Å‡πà‡∏≠‡∏ô retry
      if (attempt < maxRetries) {
        const waitSeconds = attempt; // 1s, 2s, 3s
        console.log('‚è≥ Waiting ' + waitSeconds + 's before retry...');
        Utilities.sleep(waitSeconds * 1000);
      }
      
    } catch (error) {
      lastError = error.toString();
      console.error('‚ùå Error on attempt ' + attempt + ':', error);
      
      if (attempt < maxRetries) {
        const waitSeconds = attempt;
        console.log('‚è≥ Waiting ' + waitSeconds + 's before retry...');
        Utilities.sleep(waitSeconds * 1000);
      }
    }
  }
  
  // ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß‡∏ó‡∏∏‡∏Å attempts
  return {
    success: false,
    message: 'Failed after ' + maxRetries + ' attempts. Last error: ' + lastError
  };
}


/**
 * ‚≠ê ‡πÉ‡∏´‡∏°‡πà: ‡πÄ‡∏û‡∏¥‡πà‡∏° Column "Work_Category" ‡πÉ‡∏ô Sheet "Work"
 * ‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ: ‡∏£‡∏±‡∏ô function ‡∏ô‡∏µ‡πâ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
 */
function addWorkCategoryColumn() {
  try {
    console.log('========== Adding Work_Category Column ==========');
    
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Work');
    
    if (!sheet) {
      throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö Sheet "Work"');
    }
    
    const lastColumn = sheet.getLastColumn();
    console.log('Current columns:', lastColumn);
    
    // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ Column "Work_Category" ‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
    const headers = sheet.getRange(1, 1, 1, lastColumn).getValues()[0];
    const hasCategoryColumn = headers.indexOf('Work_Category') !== -1;
    
    if (hasCategoryColumn) {
      console.log('‚úÖ Work_Category column already exists');
      SpreadsheetApp.getUi().alert(
        'Column ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß',
        'Sheet "Work" ‡∏°‡∏µ Column "Work_Category" ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß',
        SpreadsheetApp.getUi().ButtonSet.OK
      );
      return;
    }
    
    // ‡πÄ‡∏û‡∏¥‡πà‡∏° Column "Work_Category" (Column C)
    const headerRow = 1;
    const newColumnIndex = 3; // Column C
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ Column C ‡∏ß‡πà‡∏≤‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    const columnCHeader = sheet.getRange(headerRow, newColumnIndex).getValue();
    
    if (columnCHeader && columnCHeader !== '') {
      console.log('‚ö†Ô∏è Column C is not empty:', columnCHeader);
      
      const ui = SpreadsheetApp.getUi();
      const response = ui.alert(
        'Column C ‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á',
        'Column C ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß: "' + columnCHeader + '"\n\n' +
        '‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏° Column ‡πÉ‡∏´‡∏°‡πà‡∏ï‡πà‡∏≠‡∏ó‡πâ‡∏≤‡∏¢‡πÅ‡∏ó‡∏ô‡πÑ‡∏´‡∏°?',
        ui.ButtonSet.YES_NO
      );
      
      if (response === ui.Button.YES) {
        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡πâ‡∏≤‡∏¢‡∏™‡∏∏‡∏î
        const newCol = lastColumn + 1;
        sheet.getRange(headerRow, newCol).setValue('Work_Category');
        
        // Format header
        sheet.getRange(headerRow, newCol)
          .setFontWeight('bold')
          .setBackground('#1877f2')
          .setFontColor('#ffffff')
          .setHorizontalAlignment('center');
        
        console.log('‚úÖ Added Work_Category at column', newCol);
      } else {
        console.log('‚ùå User cancelled');
        return;
      }
    } else {
      // Column C ‡∏ß‡πà‡∏≤‡∏á - ‡πÉ‡∏™‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢
      sheet.getRange(headerRow, newColumnIndex).setValue('Work_Category');
      
      // Format header
      sheet.getRange(headerRow, newColumnIndex)
        .setFontWeight('bold')
        .setBackground('#1877f2')
        .setFontColor('#ffffff')
        .setHorizontalAlignment('center');
      
      console.log('‚úÖ Added Work_Category at column C');
    }
    
    // ‡πÄ‡∏û‡∏¥‡πà‡∏° Data Validation
    const lastRow = sheet.getLastRow();
    if (lastRow > 1) {
      const categoryColumn = sheet.getRange(2, 3, lastRow - 1, 1); // ‡∏´‡∏£‡∏∑‡∏≠ column ‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°
      
      const rule = SpreadsheetApp.newDataValidation()
        .requireValueInList(['RFI Work', 'Survey Work'], true)
        .setAllowInvalid(false)
        .setHelpText('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: RFI Work ‡∏´‡∏£‡∏∑‡∏≠ Survey Work')
        .build();
      
      categoryColumn.setDataValidation(rule);
      console.log('‚úÖ Added data validation');
    }
    
    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á column
    sheet.setColumnWidth(3, 150);
    
    console.log('========== Work_Category Column Added ==========');
    
    SpreadsheetApp.getUi().alert(
      '‡πÄ‡∏û‡∏¥‡πà‡∏° Column ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‚úÖ',
      '‡πÄ‡∏û‡∏¥‡πà‡∏° Column "Work_Category" ‡πÉ‡∏ô Sheet "Work" ‡πÅ‡∏•‡πâ‡∏ß\n\n' +
      'üìù ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ: ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Work_Category ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡πÅ‡∏ñ‡∏ß\n' +
      '   ‚Ä¢ RFI Work - ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏ß‡πá‡∏ö Index\n' +
      '   ‚Ä¢ Survey Work - ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏ß‡πá‡∏ö Survey',
      SpreadsheetApp.getUi().ButtonSet.OK
    );
    
  } catch (error) {
    console.error('‚ùå Error:', error);
    SpreadsheetApp.getUi().alert(
      '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
      '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏° Column ‡πÑ‡∏î‡πâ\n\nError: ' + error.toString(),
      SpreadsheetApp.getUi().ButtonSet.OK
    );
  }
}

/**
 * ‚≠ê ‡πÉ‡∏´‡∏°‡πà: ‡πÄ‡∏û‡∏¥‡πà‡∏° Column "Work_Types" ‡πÉ‡∏ô Sheet "Resources"
 * ‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ: ‡∏£‡∏±‡∏ô function ‡∏ô‡∏µ‡πâ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
 */
function addWorkTypesColumn() {
  try {
    console.log('========== Adding Work_Types Column ==========');
    
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Resources');
    
    if (!sheet) {
      throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö Sheet "Resources"');
    }
    
    const lastColumn = sheet.getLastColumn();
    console.log('Current columns:', lastColumn);
    
    // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ Column "Work_Types" ‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
    const headers = sheet.getRange(1, 1, 1, lastColumn).getValues()[0];
    const hasWorkTypesColumn = headers.indexOf('Work_Types') !== -1;
    
    if (hasWorkTypesColumn) {
      console.log('‚úÖ Work_Types column already exists');
      SpreadsheetApp.getUi().alert(
        'Column ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß',
        'Sheet "Resources" ‡∏°‡∏µ Column "Work_Types" ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß',
        SpreadsheetApp.getUi().ButtonSet.OK
      );
      return;
    }
    
    // ‡πÄ‡∏û‡∏¥‡πà‡∏° Column "Work_Types" ‡∏ï‡πà‡∏≠‡∏ó‡πâ‡∏≤‡∏¢
    const newColumnIndex = lastColumn + 1;
    
    sheet.getRange(1, newColumnIndex).setValue('Work_Types');
    
    // Format header
    sheet.getRange(1, newColumnIndex)
      .setFontWeight('bold')
      .setBackground('#1877f2')
      .setFontColor('#ffffff')
      .setHorizontalAlignment('center');
    
    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á column
    sheet.setColumnWidth(newColumnIndex, 300);
    
    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á (default = "*" ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏µ‡∏°‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà)
    const lastRow = sheet.getLastRow();
    if (lastRow > 1) {
      const ui = SpreadsheetApp.getUi();
      const response = ui.alert(
        '‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô',
        '‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Work_Types ‡πÄ‡∏õ‡πá‡∏ô "*" (‡∏ó‡∏≥‡πÑ‡∏î‡πâ‡∏ó‡∏∏‡∏Å‡∏á‡∏≤‡∏ô) ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏µ‡∏°‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÑ‡∏´‡∏°?\n\n' +
        '‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏õ‡πá‡∏ô‡∏á‡∏≤‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÑ‡∏î‡πâ‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á',
        ui.ButtonSet.YES_NO
      );
      
      if (response === ui.Button.YES) {
        const dataRange = sheet.getRange(2, newColumnIndex, lastRow - 1, 1);
        const defaultValues = [];
        
        for (let i = 0; i < lastRow - 1; i++) {
          defaultValues.push(['*']);
        }
        
        dataRange.setValues(defaultValues);
        console.log('‚úÖ Set default Work_Types to "*"');
      }
    }
    
    console.log('‚úÖ Added Work_Types at column', newColumnIndex);
    console.log('========== Work_Types Column Added ==========');
    
    SpreadsheetApp.getUi().alert(
      '‡πÄ‡∏û‡∏¥‡πà‡∏° Column ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‚úÖ',
      '‡πÄ‡∏û‡∏¥‡πà‡∏° Column "Work_Types" ‡πÉ‡∏ô Sheet "Resources" ‡πÅ‡∏•‡πâ‡∏ß\n\n' +
      'üìù ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:\n' +
      '   ‚Ä¢ "*" = ‡∏ó‡∏≥‡πÑ‡∏î‡πâ‡∏ó‡∏∏‡∏Å‡∏á‡∏≤‡∏ô (Universal Team)\n' +
      '   ‚Ä¢ "Soil Testing,Concrete Quality Check" = ‡∏ó‡∏≥‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏\n\n' +
      '‚ö†Ô∏è ‡πÉ‡∏™‡πà‡∏´‡∏•‡∏≤‡∏¢‡∏á‡∏≤‡∏ô: ‡∏Ñ‡∏±‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢ comma (,) ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á',
      SpreadsheetApp.getUi().ButtonSet.OK
    );
    
  } catch (error) {
    console.error('‚ùå Error:', error);
    SpreadsheetApp.getUi().alert(
      '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
      '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏° Column ‡πÑ‡∏î‡πâ\n\nError: ' + error.toString(),
      SpreadsheetApp.getUi().ButtonSet.OK
    );
  }
}



/**
 * üí° ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏´‡∏°‡∏ß‡∏î‡∏á‡∏≤‡∏ô‡∏ï‡∏≤‡∏° Work Type (‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏´‡∏•‡∏≤‡∏¢‡∏´‡∏°‡∏ß‡∏î‡πÑ‡∏î‡πâ)
 */
function getRecommendedCategory(workType) {
  try {
    console.log('========== getRecommendedCategory ==========');
    console.log('Work Type:', workType);
    
    if (!workType) {
      return {
        success: false,
        recommended: []
      };
    }
    
    const resourceSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Resources');
    
    if (!resourceSheet) {
      console.log('Resources sheet not found');
      return {
        success: false,
        recommended: []
      };
    }
    
    const lastRow = resourceSheet.getLastRow();
    if (lastRow <= 1) {
      return {
        success: false,
        recommended: []
      };
    }
    
    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: B (Resource_Name), C (Sub_Type), E (Status), I (Work_Types)
    const data = resourceSheet.getRange(2, 2, lastRow - 1, 8).getValues();
    
    // ‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡∏°‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ
    const categoryCount = {};
    
    for (let i = 0; i < data.length; i++) {
      const row = data[i];
      const resourceName = String(row[0] || '').trim();
      const subType = String(row[1] || '').trim();
      const status = String(row[3] || '').trim();
      const teamWorkTypes = String(row[7] || '').trim(); // Column I
      
      // ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡∏°‡∏ó‡∏µ‡πà Active
      if (status !== 'Activated' || !subType) {
        continue;
      }
      
      // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
      const supportsWork = teamSupportsWorkType(teamWorkTypes, workType);
      
      if (supportsWork) {
        if (!categoryCount[subType]) {
          categoryCount[subType] = {
            count: 0,
            teams: []
          };
        }
        categoryCount[subType].count++;
        categoryCount[subType].teams.push(resourceName);
        
        console.log('‚úÖ Team supports:', resourceName, '(', subType, ')');
      }
    }
    
    // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ó‡∏µ‡∏°‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÄ‡∏•‡∏¢
    if (Object.keys(categoryCount).length === 0) {
      console.log('‚ö†Ô∏è No teams support this work type');
      return {
        success: false,
        recommended: [],
        message: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ó‡∏µ‡∏°‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ'
      };
    }
    
    // ‚≠ê ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô: ‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö (‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡∏°‡∏°‡∏≤‡∏Å‡πÑ‡∏õ‡∏ô‡πâ‡∏≠‡∏¢)
    const recommendedList = Object.keys(categoryCount)
      .map(function(category) {
        return {
          category: category,
          count: categoryCount[category].count,
          teams: categoryCount[category].teams
        };
      })
      .sort(function(a, b) {
        return b.count - a.count; // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏à‡∏≤‡∏Å‡∏°‡∏≤‡∏Å‡πÑ‡∏õ‡∏ô‡πâ‡∏≠‡∏¢
      });
    
    console.log('üìä Category counts:', JSON.stringify(categoryCount));
    console.log('üí° Recommended (all):', recommendedList.map(r => r.category + '(' + r.count + ')').join(', '));
    console.log('==========================================');
    
    return {
      success: true,
      recommended: recommendedList, // ‚≠ê ‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô array
      allCategories: categoryCount
    };
    
  } catch (error) {
    console.error('Error in getRecommendedCategory:', error);
    return {
      success: false,
      recommended: [],
      error: error.toString()
    };
  }
}






function getManualUrl() {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const linkSheet = ss.getSheetByName('Link_URL');
    
    if (!linkSheet) {
      Logger.log('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö Sheet "Link_URL"');
      return null;
    }
    
    const url = linkSheet.getRange('B2').getValue();
    
    if (!url || url.toString().trim() === '') {
      Logger.log('‚ùå Cell B2 ‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤');
      return null;
    }
    
    Logger.log('‚úÖ Manual URL loaded: ' + url);
    return url.toString().trim();
    
  } catch (error) {
    Logger.log('‚ùå Error in getManualUrl: ' + error.toString());
    return null;
  }
}

/**
 * ‚≠ê ‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏à‡πâ‡∏á Internal Inspection (QC + QC Reviewer + Teams)
 */
function sendInternalInspectionNotificationEmail(data, rfiId) {
  try {
    console.log('========== sendInternalInspectionNotificationEmail ==========');
    
    const quota = checkEmailQuota();
    if (quota <= 1) {
      console.log('Email quota too low:', quota);
      return false;
    }
    
    // ‚≠ê ‡∏î‡∏∂‡∏á QC + QC Reviewer
    const qcEmails = getQCEmailList();
    const recipients = qcEmails.map(function(e) { return e.email; });
    
    // ‡πÄ‡∏û‡∏¥‡πà‡∏° Requester
    if (data.requesterEmail && 
        data.requesterEmail.includes('@') && 
        !recipients.includes(data.requesterEmail)) {
      recipients.push(data.requesterEmail);
    }
    
    // ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏° Team Emails
    if (data.assignedTeam) {
      const teamEmails = getTeamEmailsByTeamNames(data.assignedTeam);
      teamEmails.forEach(function(teamMember) {
        if (!recipients.includes(teamMember.email)) {
          recipients.push(teamMember.email);
          console.log('Added team member:', teamMember.name, '->', teamMember.email);
        }
      });
    }
    
    console.log('Sending to:', recipients.length, 'recipients');
    
    const emailHtml = createInternalInspectionEmailHTML(data, rfiId);
    
    const sent = safeSendEmail({
      to: recipients.join(','),
      subject: 'üè¢ Internal Inspection Request [ID: ' + rfiId + ']',
      htmlBody: emailHtml,
      name: 'RFI Requirement System'
    });
    
    console.log('Email result:', sent);
    return sent;
    
  } catch (error) {
    console.error('Error in sendInternalInspectionNotificationEmail:', error);
    
    // ‚úÖ‚úÖ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ ‚úÖ‚úÖ‚úÖ
    logError('sendInternalInspectionNotificationEmail', error, {
      rfiId: rfiId,
      requesterEmail: data.requesterEmail || 'unknown',
      assignedTeam: data.assignedTeam || 'unknown'
    }, 'WARNING');
    
    return false;
  }
}



function createInternalInspectionCalendarEvent(data, rfiId) {
  try {
    console.log('========== Creating Internal Inspection Calendar Event ==========');
    console.log('RFI ID:', rfiId);
    
    const CENTRAL_CALENDAR_ID = '6cbf6620e2630d70b763e8fe7f04d40b59d13da14a4c39cbb17687c69778b135@group.calendar.google.com';
    
    let calendar;
    
    try {
      calendar = CalendarApp.getCalendarById(CENTRAL_CALENDAR_ID);
      
      if (!calendar) {
        console.log('‚ùå Cannot access Central Calendar');
        calendar = CalendarApp.getDefaultCalendar();
      } else {
        console.log('‚úÖ Using Central Calendar:', calendar.getName());
      }
      
    } catch (calError) {
      console.log('‚ùå Error accessing Central Calendar:', calError.message);
      calendar = CalendarApp.getDefaultCalendar();
    }
    
    const dateParts = data.requestDate.split('-');
    const year = parseInt(dateParts[0]);
    const month = parseInt(dateParts[1]) - 1;
    const day = parseInt(dateParts[2]);
    
    const startTimeParts = data.startTime.split(':');
    const startHour = parseInt(startTimeParts[0]);
    const startMinute = parseInt(startTimeParts[1]);
    
    const endTimeParts = data.endTime.split(':');
    const endHour = parseInt(endTimeParts[0]);
    const endMinute = parseInt(endTimeParts[1]);
    
    const startDateTime = new Date(year, month, day, startHour, startMinute, 0);
    const endDateTime = new Date(year, month, day, endHour, endMinute, 0);
    
    const eventTitle = 'üè¢ Internal Inspection: ' + rfiId + ' - ' + data.assignedTeam;
    
    const description = 
      '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n' +
      'üè¢ INTERNAL INSPECTION REQUEST\n' +
      '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n' +
      'Internal ID: ' + rfiId + '\n' +
      '‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô: ' + data.assignedTeam + '\n' +
      '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î: ' + data.description + '\n' +
      '‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà: ' + data.location + '\n\n' +
      // ... ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏° ...
      '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê';
    
    const guestList = [];
    
    if (data.requesterEmail && data.requesterEmail.includes('@')) {
      guestList.push(data.requesterEmail);
    }
    
    const qcEmails = getQCEmailList();
    qcEmails.forEach(function(member) {
      if (guestList.indexOf(member.email) === -1) {
        guestList.push(member.email);
        console.log('Added QC:', member.email);
      }
    });
    
    if (data.assignedTeam) {
      const teamEmails = getTeamEmailsByTeamNames(data.assignedTeam);
      teamEmails.forEach(function(teamMember) {
        if (guestList.indexOf(teamMember.email) === -1) {
          guestList.push(teamMember.email);
          console.log('Added team member:', teamMember.name, '->', teamMember.email);
        }
      });
    }
    
    console.log('Total guests:', guestList.length);
    
    const event = calendar.createEvent(
      eventTitle,
      startDateTime,
      endDateTime,
      {
        description: description,
        location: data.location,
        guests: guestList.join(','),
        sendInvites: true
      }
    );
    
    // ‡∏ï‡∏±‡πâ‡∏á‡∏™‡∏µ Orange
    try {
      event.setColor(CalendarApp.EventColor.ORANGE);
      console.log('‚úÖ Event color set to ORANGE');
    } catch (colorError) {
      console.log('Could not set event color:', colorError.message);
    }
    
    console.log('‚úÖ Internal Inspection Calendar Event Created:', event.getId());
    console.log('========== Calendar Event Creation Complete ==========');
    
    return {
      success: true,
      eventId: event.getId(),
      eventTitle: eventTitle,
      guestsCount: guestList.length,
      guests: guestList
    };
    
  } catch (error) {
    console.error('========== Calendar Event Creation FAILED ==========');
    console.error('Error:', error);
    
    // ‚úÖ‚úÖ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ ‚úÖ‚úÖ‚úÖ
    logError('createInternalInspectionCalendarEvent', error, {
      rfiId: rfiId,
      requestDate: data.requestDate || 'unknown',
      startTime: data.startTime || 'unknown',
      endTime: data.endTime || 'unknown',
      assignedTeam: data.assignedTeam || 'unknown',
      requesterEmail: data.requesterEmail || 'unknown',
      location: data.location || 'unknown',
      calendarId: '6cbf6620e2630d70b763e8fe7f04d40b59d13da14a4c39cbb17687c69778b135@group.calendar.google.com'
    }, 'ERROR'); // ERROR ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÑ‡∏°‡πà‡∏£‡πâ‡∏≤‡∏¢‡πÅ‡∏£‡∏á‡πÄ‡∏ó‡πà‡∏≤ save function
    
    return {
      success: false,
      error: error.toString(),
      message: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á Calendar Event ‡πÑ‡∏î‡πâ: ' + error.toString()
    };
  }
}


/**
 * ========================================
 * HOLIDAY SYSTEM - API FUNCTIONS
 * ========================================
 */

/**
 * ‚≠ê API ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Frontend ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ
 */
function checkDateBookingAllowed(dateStr, inspectionType) {
  try {
    console.log('üîç Checking date booking:', dateStr, 'Type:', inspectionType);
    
    return canBookDate(dateStr, inspectionType);
    
  } catch (error) {
    console.error('‚ùå Error in checkDateBookingAllowed:', error);
    return {
      allowed: true,
      error: error.toString()
    };
  }
}

/**
 * ‚≠ê ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô Frontend
 */
function getHolidayList() {
  try {
    const holidays = getActiveHolidays();
    
    return holidays.map(function(h) {
      return {
        date: h.date,
        dateThai: formatDateThai(h.date),
        name: h.name
      };
    });
    
  } catch (error) {
    console.error('‚ùå Error getting holiday list:', error);
    return [];
  }
}

/**
 * ‚≠ê ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ User ‡πÄ‡∏õ‡πá‡∏ô Survey Role ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
 */
function validateSurveyRole() {
  try {
    const userEmail = Session.getActiveUser().getEmail();
    console.log('Validating Survey role for:', userEmail);
    
    const userSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('User');
    
    if (!userSheet) {
      return {
        success: false,
        message: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á User'
      };
    }
    
    const lastRow = userSheet.getLastRow();
    if (lastRow <= 1) {
      return {
        success: false,
        message: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ'
      };
    }
    
    const data = userSheet.getRange(2, 2, lastRow - 1, 4).getValues();
    
    for (let i = 0; i < data.length; i++) {
      const email = String(data[i][0] || '').trim().toLowerCase();
      const name = String(data[i][1] || '').trim();
      const role = String(data[i][2] || '').trim();
      const status = String(data[i][3] || '').trim();
      
      if (email === userEmail.toLowerCase()) {
        if ((role === 'Survey' || role === 'Survey Reviewer') && status === 'Activated') {
          console.log('‚úÖ Survey role validated:', name, role);
          return {
            success: true,
            name: name,
            role: role,
            email: email,
            isSurveyRole: true
          };
        } else {
          return {
            success: false,
            message: '‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå Survey Role (Role: ' + role + ', Status: ' + status + ')',
            isSurveyRole: false
          };
        }
      }
    }
    
    return {
      success: false,
      message: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö',
      isSurveyRole: false
    };
    
  } catch (error) {
    console.error('Error validating Survey role:', error);
    return {
      success: false,
      message: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.toString(),
      isSurveyRole: false
    };
  }
}

/**
 * ‚≠ê ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ Requester ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (Role = "Requester", Status = "Activated")
 */
function getAllRequesters() {
  try {
    console.log('========== Getting All Requesters ==========');
    
    const userSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('User');
    
    if (!userSheet) {
      console.log('‚ùå User sheet not found');
      return [];
    }
    
    const lastRow = userSheet.getLastRow();
    if (lastRow <= 1) {
      console.log('‚ö†Ô∏è No users found');
      return [];
    }
    
    // ‡∏î‡∏∂‡∏á Column B (Email), C (DisplayName), D (Role), E (Status)
    const data = userSheet.getRange(2, 2, lastRow - 1, 4).getValues();
    const requesters = [];
    
    for (let i = 0; i < data.length; i++) {
      const email = String(data[i][0] || '').trim();
      const name = String(data[i][1] || '').trim();
      const role = String(data[i][2] || '').trim();
      const status = String(data[i][3] || '').trim();
      
      if (role === 'Requester' && status === 'Activated' && email && name) {
        requesters.push({
          email: email,
          name: name,
          displayText: name + ' (' + email + ')'
        });
        console.log('‚úÖ Found Requester:', name, '-', email);
      }
    }
    
    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏ä‡∏∑‡πà‡∏≠
    requesters.sort(function(a, b) {
      return a.name.localeCompare(b.name, 'th');
    });
    
    console.log('üìä Total Requesters:', requesters.length);
    console.log('==========================================');
    
    return requesters;
    
  } catch (error) {
    console.error('‚ùå Error getting requesters:', error);
    return [];
  }
}

/**
 * ‚≠ê Survey Role - ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏ó‡∏∏‡∏Å‡πÄ‡∏ß‡∏•‡∏≤ (‡πÑ‡∏°‡πà‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏ó‡∏µ‡∏°‡∏ß‡πà‡∏≤‡∏á)
 */
function getSurveyRoleAvailableTimeSlots(date) {
  try {
    if (!date) return [];
    
    console.log('‚≠ê Getting time slots for Survey Role - ALL TIMES AVAILABLE');
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á all slots (09:00 - 19:30)
    const allSlots = [];
    for (let hour = 9; hour <= 19; hour++) {
      for (let minute = 0; minute < 60; minute += 30) {
        if (hour === 19 && minute === 30) break;
        const time = hour.toString().padStart(2, '0') + ':' + minute.toString().padStart(2, '0');
        allSlots.push(time);
      }
    }
    
    console.log('‚úÖ Survey Role - All', allSlots.length, 'slots available (no restrictions)');
    return allSlots;
    
  } catch (error) {
    console.error('Error in getSurveyRoleAvailableTimeSlots:', error);
    return [];
  }
}

/**
 * ‚≠ê UPDATED: getCodeListByWorkType with Cache
 */
function getCodeListByWorkType(workType) {
  const cacheKey = CACHE_CONFIG.CODE_LIST.key + '_' + workType;
  
  return getCachedData(
    cacheKey,
    function() {
      return loadCodeListFromSheet(workType);
    },
    CACHE_CONFIG.CODE_LIST.ttl
  );
}

/**
 * ‚≠ê Loader Function: ‡πÇ‡∏´‡∏•‡∏î Code List ‡∏à‡∏≤‡∏Å Sheet
 */
function loadCodeListFromSheet(workType) {
  try {
    console.log('üì• Loading code list from sheet:', workType);
    
    if (!workType) {
      return [];
    }
    
    const codeSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Code');
    
    if (!codeSheet) {
      console.log('‚ùå Code sheet not found');
      return [];
    }
    
    const lastRow = codeSheet.getLastRow();
    if (lastRow <= 1) {
      console.log('‚ö†Ô∏è No codes found');
      return [];
    }
    
    const data = codeSheet.getRange(2, 1, lastRow - 1, 5).getValues();
    const codes = [];
    
    for (let i = 0; i < data.length; i++) {
      const nameWork = String(data[i][0] || '').trim();
      const itp = String(data[i][1] || '').trim();
      const qcCode = String(data[i][2] || '').trim();
      const item = String(data[i][3] || '').trim();
      const descriptionCode = String(data[i][4] || '').trim();
      
      if (nameWork === workType && itp && qcCode && item && descriptionCode) {
        codes.push({
          nameWork: nameWork,
          itp: itp,
          qcCode: qcCode,
          item: item,
          descriptionCode: descriptionCode,
          displayText: itp + ' - ' + qcCode + ' - ' + item
        });
      }
    }
    
    console.log('‚úÖ Loaded', codes.length, 'codes from sheet');
    
    return codes;
    
  } catch (error) {
    console.error('‚ùå Error loading code list:', error);
    logError('loadCodeListFromSheet', error, { workType: workType }, 'ERROR');
    return [];
  }
}

/**
 * ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏° ITP Code ‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤ Sheet "Code"
 */
function addNewITPCode(data) {
  try {
    console.log('========== addNewITPCode START ==========');
    console.log('Data:', JSON.stringify(data));
    
    // Validation
    if (!data.nameWork || !data.itp || !data.qcCode || !data.item || !data.descriptionCode) {
      return {
        success: false,
        message: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô'
      };
    }
    
    const codeSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Code');
    
    if (!codeSheet) {
      return {
        success: false,
        message: '‡πÑ‡∏°‡πà‡∏û‡∏ö Sheet "Code"'
      };
    }
    
    // ‚úÖ ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ Code ‡∏ã‡πâ‡∏≥‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    const lastRow = codeSheet.getLastRow();
    if (lastRow > 1) {
      const existingData = codeSheet.getRange(2, 1, lastRow - 1, 5).getValues();
      
      for (let i = 0; i < existingData.length; i++) {
        const existingNameWork = String(existingData[i][0] || '').trim();
        const existingITP = String(existingData[i][1] || '').trim();
        const existingQCCode = String(existingData[i][2] || '').trim();
        const existingItem = String(existingData[i][3] || '').trim();
        
        // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤ Combo ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        if (existingNameWork === data.nameWork && 
            existingITP === data.itp && 
            existingQCCode === data.qcCode && 
            existingItem === data.item) {
          return {
            success: false,
            message: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ITP Code ‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß\n' +
                    'Name: ' + data.nameWork + '\n' +
                    'ITP: ' + data.itp + '\n' +
                    'QC Code: ' + data.qcCode + '\n' +
                    'ITEM: ' + data.item
          };
        }
      }
    }
    
    // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà
    const nextRow = lastRow + 1;
    
    const rowData = [
      data.nameWork,
      data.itp,
      data.qcCode,
      data.item,
      data.descriptionCode
    ];
    
    codeSheet.getRange(nextRow, 1, 1, 5).setValues([rowData]);
    
    console.log('‚úÖ ITP Code added at row', nextRow);
    console.log('========== addNewITPCode SUCCESS ==========');
    
    return {
      success: true,
      message: '‡πÄ‡∏û‡∏¥‡πà‡∏° ITP Code ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!\n\n' +
              'Name: ' + data.nameWork + '\n' +
              'ITP: ' + data.itp + '\n' +
              'QC Code: ' + data.qcCode + '\n' +
              'ITEM: ' + data.item,
      data: rowData
    };
    
  } catch (error) {
    console.error('========== addNewITPCode FAILED ==========');
    console.error('Error:', error);
    
    return {
      success: false,
      message: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.toString()
    };
  }
}

/**
 * ‚≠ê ‡∏•‡∏ö ITP Code ‡∏à‡∏≤‡∏Å Sheet "Code"
 */
function deleteITPCode(nameWork, itp, qcCode, item) {
  try {
    console.log('========== deleteITPCode START ==========');
    console.log('Deleting:', nameWork, itp, qcCode, item);
    
    const codeSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Code');
    
    if (!codeSheet) {
      return {
        success: false,
        message: '‡πÑ‡∏°‡πà‡∏û‡∏ö Sheet "Code"'
      };
    }
    
    const lastRow = codeSheet.getLastRow();
    if (lastRow <= 1) {
      return {
        success: false,
        message: '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô Sheet "Code"'
      };
    }
    
    // ‚úÖ ‡∏´‡∏≤ row ‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô
    const data = codeSheet.getRange(2, 1, lastRow - 1, 5).getValues();
    let rowToDelete = -1;
    
    for (let i = 0; i < data.length; i++) {
      const existingNameWork = String(data[i][0] || '').trim();
      const existingITP = String(data[i][1] || '').trim();
      const existingQCCode = String(data[i][2] || '').trim();
      const existingItem = String(data[i][3] || '').trim();
      
      if (existingNameWork === nameWork && 
          existingITP === itp && 
          existingQCCode === qcCode && 
          existingItem === item) {
        rowToDelete = i + 2; // +2 ‡πÄ‡∏û‡∏£‡∏≤‡∏∞ array ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà 0 ‡πÅ‡∏•‡∏∞‡∏°‡∏µ header row
        break;
      }
    }
    
    if (rowToDelete === -1) {
      return {
        success: false,
        message: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ITP ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö'
      };
    }
    
    // ‚úÖ ‡∏•‡∏ö row
    codeSheet.deleteRow(rowToDelete);
    
    console.log('‚úÖ Deleted row:', rowToDelete);
    console.log('========== deleteITPCode SUCCESS ==========');
    
    return {
      success: true,
      message: '‡∏•‡∏ö ITP Code ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!\n\n' +
              'ITP: ' + itp + '\n' +
              'QC Code: ' + qcCode + '\n' +
              'ITEM: ' + item
    };
    
  } catch (error) {
    console.error('========== deleteITPCode FAILED ==========');
    console.error('Error:', error);
    
    return {
      success: false,
      message: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.toString()
    };
  }
}

/**
 * ‚≠ê Survey Role - ‡∏î‡∏∂‡∏á ALL Time Slots (‡πÑ‡∏°‡πà‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏ó‡∏µ‡∏°‡∏ß‡πà‡∏≤‡∏á)
 * ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏ó‡∏∏‡∏Å‡πÄ‡∏ß‡∏•‡∏≤ ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏ä‡πá‡∏Ñ‡∏ó‡∏µ‡∏°‡∏ï‡∏≠‡∏ô submit
 */
function getSurveyRoleAllTimeSlots() {
  try {
    console.log('‚≠ê Getting ALL time slots for Survey Role (no team check)');
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á all slots (09:00 - 19:30)
    const allSlots = [];
    for (let hour = 9; hour <= 19; hour++) {
      for (let minute = 0; minute < 60; minute += 30) {
        if (hour === 19 && minute === 30) break;
        const time = hour.toString().padStart(2, '0') + ':' + minute.toString().padStart(2, '0');
        allSlots.push(time);
      }
    }
    
    console.log('‚úÖ Generated', allSlots.length, 'time slots for Survey Role');
    return allSlots;
    
  } catch (error) {
    console.error('Error in getSurveyRoleAllTimeSlots:', error);
    return [];
  }
}



/**
 * ‚≠ê ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏ó‡∏µ‡∏° Survey ‡∏ß‡πà‡∏≤‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
 */
function checkSurveyTeamAvailability(date, startTime, endTime) {
  try {
    console.log('üîç Checking Survey team availability:', date, startTime, endTime);
    
    const availableTeams = getSurveyTeams();
    
    if (availableTeams.length === 0) {
      return {
        available: false,
        message: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ó‡∏µ‡∏° Survey ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö',
        teamCount: 0,
        totalTeams: 0
      };
    }
    
    let availableTeamCount = 0;
    const availableTeamNames = [];
    
    for (let i = 0; i < availableTeams.length; i++) {
      const team = availableTeams[i];
      
      if (isSurveyTeamAvailable(team.resourceId, date, startTime, endTime)) {
        availableTeamCount++;
        availableTeamNames.push(team.resourceName);
      }
    }
    
    console.log('Available teams:', availableTeamCount, '/', availableTeams.length);
    
    return {
      available: availableTeamCount > 0,
      message: availableTeamCount > 0 ? 
        '‡∏°‡∏µ‡∏ó‡∏µ‡∏°‡∏ß‡πà‡∏≤‡∏á ' + availableTeamCount + ' ‡∏ó‡∏µ‡∏°: ' + availableTeamNames.join(', ') :
        '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ó‡∏µ‡∏° Survey ‡∏ß‡πà‡∏≤‡∏á‡πÉ‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å',
      teamCount: availableTeamCount,
      totalTeams: availableTeams.length,
      availableTeams: availableTeamNames
    };
    
  } catch (error) {
    console.error('Error checking Survey team availability:', error);
    return {
      available: false,
      message: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.toString(),
      teamCount: 0,
      totalTeams: 0
    };
  }
}

/**
 * ========================================
 * ERROR LOGGING SYSTEM
 * ========================================
 */

/**
 * ‚≠ê ‡∏™‡∏£‡πâ‡∏≤‡∏á/‡∏î‡∏∂‡∏á Error_Log Sheet
 */
function createErrorLogSheet() {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    let sheet = ss.getSheetByName('Error_Log');
    
    if (!sheet) {
      console.log('Creating Error_Log sheet...');
      sheet = ss.insertSheet('Error_Log');
      
      // Headers
      const headers = [
        'Timestamp',
        'Function_Name',
        'Error_Message',
        'Stack_Trace',
        'User_Email',
        'User_Name',
        'Parameters',
        'Severity',
        'Browser_Info'
      ];
      
      sheet.getRange(1, 1, 1, 9).setValues([headers]);
      
      // Format header
      const headerRange = sheet.getRange(1, 1, 1, 9);
      headerRange.setFontWeight('bold');
      headerRange.setBackground('#dc2626');
      headerRange.setFontColor('#ffffff');
      headerRange.setHorizontalAlignment('center');
      headerRange.setVerticalAlignment('middle');
      
      // Set column widths
      sheet.setColumnWidth(1, 180);  // Timestamp
      sheet.setColumnWidth(2, 200);  // Function Name
      sheet.setColumnWidth(3, 400);  // Error Message
      sheet.setColumnWidth(4, 300);  // Stack Trace
      sheet.setColumnWidth(5, 200);  // User Email
      sheet.setColumnWidth(6, 150);  // User Name
      sheet.setColumnWidth(7, 300);  // Parameters
      sheet.setColumnWidth(8, 100);  // Severity
      sheet.setColumnWidth(9, 150);  // Browser Info
      
      // Freeze header row
      sheet.setFrozenRows(1);
      
      console.log('‚úÖ Error_Log sheet created');
    }
    
    return sheet;
    
  } catch (error) {
    console.error('‚ùå Failed to create Error_Log sheet:', error);
    return null;
  }
}

/**
 * ‚≠ê ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Error ‡∏•‡∏á Sheet
 */
function logError(functionName, error, params, severity) {
  try {
    // ‚úÖ ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô invalid calls
    if (!functionName || !error) {
      console.warn('‚ö†Ô∏è logError called with missing parameters');
      return false;
    }
    
    if (typeof severity === 'undefined') severity = 'ERROR';
    
    const sheet = createErrorLogSheet();
    
    if (!sheet) {
      console.error('‚ùå Cannot create Error_Log sheet');
      return false;
    }
    
    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• User
    let userEmail = '';
    let userName = '';
    
    try {
      userEmail = Session.getActiveUser().getEmail();
      
      // ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏≤‡∏Å Sheet User
      const userSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('User');
      if (userSheet) {
        const lastRow = userSheet.getLastRow();
        if (lastRow > 1) {
          const userData = userSheet.getRange(2, 2, lastRow - 1, 3).getValues();
          
          for (let i = 0; i < userData.length; i++) {
            const email = String(userData[i][0] || '').trim().toLowerCase();
            const name = String(userData[i][1] || '').trim();
            
            if (email === userEmail.toLowerCase()) {
              userName = name;
              break;
            }
          }
        }
      }
    } catch (userError) {
      userEmail = 'Unknown';
      userName = 'Unknown';
    }
    
    // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Stack Trace
    let stackTrace = '';
    if (error.stack) {
      stackTrace = String(error.stack).substring(0, 1000); // ‡∏à‡∏≥‡∏Å‡∏±‡∏î 1000 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£
    }
    
    // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Parameters
    let paramsStr = '';
    try {
      if (params) {
        paramsStr = JSON.stringify(params, null, 2).substring(0, 500); // ‡∏à‡∏≥‡∏Å‡∏±‡∏î 500 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£
      }
    } catch (jsonError) {
      paramsStr = String(params).substring(0, 500);
    }
    
    // Browser Info (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
    let browserInfo = 'Server-side';
    if (params && params.userAgent) {
      browserInfo = String(params.userAgent).substring(0, 150);
    }
    
    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á Sheet
    const rowData = [
      new Date(),
      functionName,
      error.toString().substring(0, 500),
      stackTrace,
      userEmail,
      userName,
      paramsStr,
      severity,
      browserInfo
    ];
    
    sheet.appendRow(rowData);
    
    // Format ‡∏ï‡∏≤‡∏° Severity
    const lastRow = sheet.getLastRow();
    const lastRowRange = sheet.getRange(lastRow, 1, 1, 9);
    
    if (severity === 'CRITICAL') {
      lastRowRange.setBackground('#fef2f2');
      lastRowRange.setFontColor('#991b1b');
    } else if (severity === 'ERROR') {
      lastRowRange.setBackground('#fff7ed');
      lastRowRange.setFontColor('#9a3412');
    } else if (severity === 'WARNING') {
      lastRowRange.setBackground('#fefce8');
      lastRowRange.setFontColor('#854d0e');
    }
    
    console.log('‚úÖ Error logged to Error_Log sheet');
    console.log('   Function:', functionName);
    console.log('   Severity:', severity);
    console.log('   User:', userName, '(' + userEmail + ')');
    
    return true;
    
  } catch (logError) {
    console.error('‚ùå Failed to log error:', logError);
    return false;
  }
}

/**
 * ‚≠ê ‡∏î‡∏π‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥ Error (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Admin)
 */
function getErrorStatistics() {
  try {
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Error_Log');
    
    if (!sheet) {
      return {
        success: false,
        message: '‡πÑ‡∏°‡πà‡∏û‡∏ö Error_Log sheet'
      };
    }
    
    const lastRow = sheet.getLastRow();
    
    if (lastRow <= 1) {
      return {
        success: true,
        totalErrors: 0,
        message: '‡πÑ‡∏°‡πà‡∏°‡∏µ Error ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö'
      };
    }
    
    const data = sheet.getRange(2, 1, lastRow - 1, 8).getValues();
    
    const stats = {
      totalErrors: lastRow - 1,
      bySeverity: {},
      byFunction: {},
      byUser: {},
      last24Hours: 0
    };
    
    const now = new Date();
    const twentyFourHoursAgo = new Date(now.getTime() - (24 * 60 * 60 * 1000));
    
    for (let i = 0; i < data.length; i++) {
      const timestamp = new Date(data[i][0]);
      const functionName = String(data[i][1] || '').trim();
      const userEmail = String(data[i][4] || '').trim();
      const severity = String(data[i][7] || 'ERROR').trim();
      
      // Count by Severity
      stats.bySeverity[severity] = (stats.bySeverity[severity] || 0) + 1;
      
      // Count by Function
      stats.byFunction[functionName] = (stats.byFunction[functionName] || 0) + 1;
      
      // Count by User
      stats.byUser[userEmail] = (stats.byUser[userEmail] || 0) + 1;
      
      // Count last 24 hours
      if (timestamp > twentyFourHoursAgo) {
        stats.last24Hours++;
      }
    }
    
    return {
      success: true,
      stats: stats
    };
    
  } catch (error) {
    console.error('Error getting error statistics:', error);
    return {
      success: false,
      message: error.toString()
    };
  }
}

/**
 * ‚≠ê ‡∏•‡πâ‡∏≤‡∏á Error Log ‡πÄ‡∏Å‡πà‡∏≤ (‡πÄ‡∏Å‡πá‡∏ö‡πÅ‡∏Ñ‡πà 30 ‡∏ß‡∏±‡∏ô)
 */
function cleanOldErrorLogs() {
  try {
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Error_Log');
    
    if (!sheet) {
      console.log('No Error_Log sheet to clean');
      return;
    }
    
    const lastRow = sheet.getLastRow();
    
    if (lastRow <= 1) {
      console.log('No errors to clean');
      return;
    }
    
    const data = sheet.getRange(2, 1, lastRow - 1, 1).getValues();
    const thirtyDaysAgo = new Date();
    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
    
    let deletedCount = 0;
    
    // ‡∏•‡∏ö‡∏à‡∏≤‡∏Å‡∏•‡πà‡∏≤‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏ö‡∏ô (‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô row)
    for (let i = data.length - 1; i >= 0; i--) {
      const timestamp = new Date(data[i][0]);
      
      if (timestamp < thirtyDaysAgo) {
        sheet.deleteRow(i + 2); // +2 ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏°‡∏µ header
        deletedCount++;
      }
    }
    
    console.log('‚úÖ Cleaned ' + deletedCount + ' old error logs');
    
    return {
      success: true,
      deletedCount: deletedCount
    };
    
  } catch (error) {
    console.error('Error cleaning old logs:', error);
    return {
      success: false,
      message: error.toString()
    };
  }
}



/**
 * ========================================
 * CACHE SYSTEM FOR MASTER DATA
 * ========================================
 */

/**
 * ‚≠ê Cache Configuration
 */
const CACHE_CONFIG = {
  WORK_TYPES: {
    key: 'master_work_types',
    ttl: 21600 // 6 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á
  },
  RESOURCES: {
    key: 'master_resources',
    ttl: 21600 // 6 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á
  },
  CODE_LIST: {
    key: 'master_code_list',
    ttl: 21600 // 6 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á
  },
  USER_LIST: {
    key: 'master_user_list',
    ttl: 3600 // 1 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• User ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ö‡πà‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤)
  }
};

function getCachedData(cacheKey, loaderFunction, ttl) {
  try {
    const cache = CacheService.getScriptCache();
    
    // ‚úÖ ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ cache ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô registry = old cache
    const cachedData = cache.get(cacheKey);
    const registry = getCacheRegistry();
    
    if (cachedData && !registry[cacheKey]) {
      console.log('‚ö†Ô∏è Found old cache (not in registry):', cacheKey);
      console.log('   Auto-adding to registry...');
      
      // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤ registry
      addToCacheRegistry(cacheKey, cachedData.length, ttl);
    }
    
    // ‡∏≠‡πà‡∏≤‡∏ô‡∏à‡∏≤‡∏Å cache ‡∏ï‡πà‡∏≠...
    let data = getCachedDataWithChunks(cacheKey);
    
    if (data) {
      return data;
    }
    
    console.log('‚ùå Cache MISS:', cacheKey, '- Loading from sheet...');
    
    // Load ‡∏à‡∏≤‡∏Å Sheet
    const freshData = loaderFunction();
    
    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Cache + Registry
    try {
      const jsonData = JSON.stringify(freshData);
      
      if (jsonData.length <= 100000) {
        cache.put(cacheKey, jsonData, ttl);
        console.log('‚úÖ Cached (single):', cacheKey, '(', jsonData.length, 'bytes)');
        
        // ‚≠ê ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å registry
        addToCacheRegistry(cacheKey, jsonData.length, ttl);
        
        return freshData;
      }
      
      // ... chunk logic ...
      
    } catch (cacheError) {
      console.error('‚ö†Ô∏è Failed to cache data:', cacheError);
    }
    
    return freshData;
    
  } catch (error) {
    console.error('‚ùå Error in getCachedData:', error);
    
    try {
      return loaderFunction();
    } catch (loaderError) {
      console.error('‚ùå Loader function also failed:', loaderError);
      logError('getCachedData', loaderError, { cacheKey: cacheKey }, 'ERROR');
      return null;
    }
  }
}

/**
 * ‚≠ê ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Cache Key ‡∏•‡∏á Registry
 */
function addToCacheRegistry(cacheKey, size, ttl) {
  try {
    const cache = CacheService.getScriptCache();
    const registryKey = '__cache_registry__';
    
    // ‡∏î‡∏∂‡∏á registry ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
    let registry = {};
    const registryData = cache.get(registryKey);
    
    if (registryData) {
      try {
        registry = JSON.parse(registryData);
      } catch (e) {
        registry = {};
      }
    }
    
    // ‡πÄ‡∏û‡∏¥‡πà‡∏° key ‡πÉ‡∏´‡∏°‡πà
    registry[cacheKey] = {
      size: size,
      timestamp: new Date().getTime(),
      ttl: ttl
    };
    
    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏•‡∏±‡∏ö (‡πÉ‡∏ä‡πâ TTL ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î = 6 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á)
    cache.put(registryKey, JSON.stringify(registry), 21600);
    
  } catch (error) {
    console.error('Error updating cache registry:', error);
  }
}

/**
 * ‚≠ê ‡∏•‡∏ö Cache Key ‡∏à‡∏≤‡∏Å Registry
 */
function removeFromCacheRegistry(cacheKey) {
  try {
    const cache = CacheService.getScriptCache();
    const registryKey = '__cache_registry__';
    
    const registryData = cache.get(registryKey);
    if (!registryData) return;
    
    const registry = JSON.parse(registryData);
    delete registry[cacheKey];
    
    cache.put(registryKey, JSON.stringify(registry), 21600);
    
  } catch (error) {
    console.error('Error removing from cache registry:', error);
  }
}

/**
 * ‚≠ê ‡∏î‡∏∂‡∏á Cache Registry
 */
function getCacheRegistry() {
  try {
    const cache = CacheService.getScriptCache();
    const registryKey = '__cache_registry__';
    
    const registryData = cache.get(registryKey);
    
    if (!registryData) {
      return {};
    }
    
    return JSON.parse(registryData);
    
  } catch (error) {
    console.error('Error getting cache registry:', error);
    return {};
  }
}

/**
 * ‚≠ê FIXED: ‡∏•‡πâ‡∏≤‡∏á Cache ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏£‡∏ß‡∏° Registry)
 */
function clearAllCache() {
  try {
    const cache = CacheService.getScriptCache();
    const registry = getCacheRegistry();
    const keys = Object.keys(registry);
    
    console.log('Clearing', keys.length, 'cache keys...');
    
    // ‡∏•‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞ key
    keys.forEach(function(key) {
      cache.remove(key);
      
      // ‡∏•‡∏ö chunks ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
      cache.remove(key + '_meta');
      for (let i = 0; i < 100; i++) {
        cache.remove(key + '_chunk_' + i);
      }
    });
    
    // ‡∏•‡∏ö registry
    cache.remove('__cache_registry__');
    
    console.log('‚úÖ All cache cleared');
    
    return {
      success: true,
      message: '‡∏•‡πâ‡∏≤‡∏á Cache ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß (' + keys.length + ' keys)'
    };
    
  } catch (error) {
    console.error('‚ùå Error clearing cache:', error);
    logError('clearAllCache', error, {}, 'WARNING');
    
    return {
      success: false,
      message: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.toString()
    };
  }
}

/**
 * ‚≠ê FIXED: ‡∏•‡πâ‡∏≤‡∏á Cache ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Key
 */
function clearCacheByKey(cacheKey) {
  try {
    const cache = CacheService.getScriptCache();
    
    // ‡∏•‡∏ö main key
    cache.remove(cacheKey);
    
    // ‡∏•‡∏ö chunks ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
    cache.remove(cacheKey + '_meta');
    for (let i = 0; i < 100; i++) {
      cache.remove(cacheKey + '_chunk_' + i);
    }
    
    // ‚≠ê ‡∏•‡∏ö‡∏à‡∏≤‡∏Å registry
    removeFromCacheRegistry(cacheKey);
    
    console.log('‚úÖ Cache cleared:', cacheKey);
    
    return {
      success: true,
      message: '‡∏•‡πâ‡∏≤‡∏á Cache: ' + cacheKey
    };
    
  } catch (error) {
    console.error('‚ùå Error clearing cache:', error);
    return {
      success: false,
      message: error.toString()
    };
  }
}


/**
 * ‚≠ê FIXED: ‡∏î‡∏π‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Cache (‡πÉ‡∏ä‡πâ Registry) - UPDATED
 */
function getCacheStatus() {
  try {
    const registry = getCacheRegistry();
    const keys = Object.keys(registry);
    
    // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏•‡∏∏‡πà‡∏° holidays
    const groups = {
      workTypes: [],
      resources: [],
      codeLists: [],
      users: [],
      holidays: [], // <-- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
      other: []
    };
    
    // ... (‡∏™‡πà‡∏ß‡∏ô‡∏ï‡πâ‡∏ô‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏° ‡∏à‡∏ô‡∏ñ‡∏∂‡∏á loop) ...
    if (keys.length === 0) {
        return { success: true, totalKeys: 0, totalSizeKB: '0.00', message: 'Cache is empty', groups: groups, status: {} };
    }

    const status = {};
    let totalSize = 0;
    const now = new Date().getTime();
    
    keys.forEach(function(key) {
      const info = registry[key];
      const size = info.size || 0;
      const timestamp = info.timestamp || 0;
      const ttl = info.ttl || 0;
      const expiresAt = timestamp + (ttl * 1000);
      const isExpired = now > expiresAt;
      
      totalSize += size;
      
      const item = {
        key: key,
        size: size,
        sizeKB: (size / 1024).toFixed(2),
        isExpired: isExpired
      };
      
      status[key] = { cached: true, size: size, sizeKB: (size / 1024).toFixed(2), isExpired: isExpired };
      
      // ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°
      if (key.indexOf('master_work_types') === 0) {
        groups.workTypes.push(item);
      } else if (key.indexOf('master_resources') === 0) {
        groups.resources.push(item);
      } else if (key.indexOf('master_code_list') === 0) {
        groups.codeLists.push(item);
      } else if (key.indexOf('master_user_list') === 0) {
        groups.users.push(item);
      } else if (key === 'master_holidays_data') { // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ô‡∏µ‡πâ
        groups.holidays.push(item);
      } else {
        groups.other.push(item);
      }
    });
    
    return {
      success: true,
      totalKeys: keys.length,
      totalSizeKB: (totalSize / 1024).toFixed(2),
      groups: groups,
      status: status
    };
  } catch (error) {
    console.error('Error getting cache status:', error);
    return { success: false, message: error.toString() };
  }
}

/**
 * ‚≠ê FIXED: ‡πÅ‡∏™‡∏î‡∏á Cache Status ‡πÉ‡∏ô UI (‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°) - UPDATED
 */
function showCacheStatus() {
  const result = getCacheStatus();
  if (!result.success) {
    SpreadsheetApp.getUi().alert('Error: ' + result.message);
    return;
  }
  
  if (result.totalKeys === 0) {
    SpreadsheetApp.getUi().alert('üìä Cache Status', '‚ùå Cache is empty', SpreadsheetApp.getUi().ButtonSet.OK);
    return;
  }
  
  let message = 'üìä Cache Status\n\n';
  message += 'üìà Total Keys: ' + result.totalKeys + '\n';
  message += 'üíæ Total Size: ' + result.totalSizeKB + ' KB\n\n';
  message += '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n';
  
  // ‚úÖ‚úÖ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• Holidays ‚úÖ‚úÖ‚úÖ
  if (result.groups.holidays && result.groups.holidays.length > 0) {
    message += 'üìÖ Holidays:\n';
    result.groups.holidays.forEach(function(item) {
      message += '  ‚úÖ Data Cached (' + item.sizeKB + ' KB)\n';
    });
    message += '\n';
  }

  // Work Types
  if (result.groups.workTypes.length > 0) {
    message += 'üìã Work Types (' + result.groups.workTypes.length + '):\n';
    result.groups.workTypes.forEach(function(item) {
      const name = item.key.replace('master_work_types_', '');
      message += '  ‚úÖ ' + name + ' (' + item.sizeKB + ' KB)\n';
    });
    message += '\n';
  }
  
  // Resources
  if (result.groups.resources.length > 0) {
    message += 'üë• Resources (' + result.groups.resources.length + '):\n';
    result.groups.resources.forEach(function(item) {
      const name = item.key.replace('master_resources_', '');
      message += '  ‚úÖ ' + name + ' (' + item.sizeKB + ' KB)\n';
    });
    message += '\n';
  }
  
  // Code Lists & Users & Other (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°...)
  if (result.groups.codeLists.length > 0) {
    message += 'üè∑Ô∏è Code Lists (' + result.groups.codeLists.length + '):\n';
    result.groups.codeLists.forEach(function(item) {
      const name = item.key.replace('master_code_list_', '');
      message += '  ‚úÖ ' + name + ' (' + item.sizeKB + ' KB)\n';
    });
  }

  SpreadsheetApp.getUi().alert('Cache Status', message, SpreadsheetApp.getUi().ButtonSet.OK);
}


function onOpen() {
  const ui = SpreadsheetApp.getUi();
  
  ui.createMenu('üîß Admin Tools')
    .addSubMenu(ui.createMenu('üöÄ Cache Management')
      .addItem('üìä View Cache Status', 'showCacheStatus')
      .addItem('üî• Warm Up Cache', 'warmUpAllCache')
      .addSeparator()
      .addItem('‚ôªÔ∏è Refresh Work Types', 'refreshWorkTypesCache')       // ‚úÖ
      .addItem('‚ôªÔ∏è Refresh Resources', 'refreshResourcesCache')       // ‚úÖ
      .addItem('‚ôªÔ∏è Refresh Code Lists', 'refreshCodeListCache')
      .addItem('üìÖ Refresh Holiday Cache', 'adminRefreshHolidays') //       // ‚úÖ
      .addSeparator()
      .addItem('üóëÔ∏è Clear All Cache', 'clearAllCacheWithConfirm')
      .addItem('üí£ Hard Reset Cache', 'hardResetCache')
      .addSeparator()
      .addItem('üêõ Debug Registry', 'debugCacheRegistry'))            // ‚úÖ
    .addSubMenu(ui.createMenu('üìä Error Logs')
      .addItem('üìà View Statistics', 'showErrorStatistics')
      .addItem('üßπ Clean Old Logs', 'cleanOldErrorLogs'))
    .addSeparator()
    .addItem('üìã Create Report (Column AN)', 'createColumnANReport')
    .addToUi();
}
/**
 * ‚≠ê ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥ Error
 */
function showErrorStatistics() {
  const result = getErrorStatistics();
  
  if (!result.success) {
    SpreadsheetApp.getUi().alert('Error: ' + result.message);
    return;
  }
  
  if (result.totalErrors === 0) {
    SpreadsheetApp.getUi().alert('‚úÖ ‡πÑ‡∏°‡πà‡∏°‡∏µ Error ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö');
    return;
  }
  
  const stats = result.stats;
  
  let message = 'üìä Error Statistics\n\n';
  message += 'Total Errors: ' + stats.totalErrors + '\n';
  message += 'Last 24 Hours: ' + stats.last24Hours + '\n\n';
  
  message += 'üìå By Severity:\n';
  Object.keys(stats.bySeverity).forEach(function(severity) {
    message += '   ' + severity + ': ' + stats.bySeverity[severity] + '\n';
  });
  
  message += '\nüìå Top 5 Functions:\n';
  const topFunctions = Object.keys(stats.byFunction)
    .sort(function(a, b) {
      return stats.byFunction[b] - stats.byFunction[a];
    })
    .slice(0, 5);
  
  topFunctions.forEach(function(func) {
    message += '   ' + func + ': ' + stats.byFunction[func] + '\n';
  });
  
  SpreadsheetApp.getUi().alert(
    'Error Statistics',
    message,
    SpreadsheetApp.getUi().ButtonSet.OK
  );
}

/**
 * ‚≠ê ‡∏•‡πâ‡∏≤‡∏á Cache (‡∏°‡∏µ Confirm)
 */
function clearAllCacheWithConfirm() {
  const ui = SpreadsheetApp.getUi();
  
  const response = ui.alert(
    'Confirm Clear Cache',
    '‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á Cache ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\n\n' +
    '‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Sheet ‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ñ‡∏±‡∏î‡πÑ‡∏õ',
    ui.ButtonSet.YES_NO
  );
  
  if (response === ui.Button.YES) {
    const result = clearAllCache();
    
    if (result.success) {
      ui.alert('‚úÖ ' + result.message);
    } else {
      ui.alert('‚ùå ' + result.message);
    }
  }
}

/**
 * ‚≠ê FIXED: Generic Refresh by Prefix (with validation)
 */
function refreshCacheByPrefix(prefix, reloadFunction) {
  try {
    // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° validation
    if (!prefix) {
      throw new Error('Prefix is required');
    }
    
    console.log('========== Refreshing Cache:', prefix, '==========');
    
    const registry = getCacheRegistry();
    
    if (!registry || Object.keys(registry).length === 0) {
      console.log('‚ö†Ô∏è Registry is empty');
      return {
        success: false,
        message: 'Cache registry is empty. Run "Warm Up Cache" first.',
        deletedCount: 0
      };
    }
    
    const keys = Object.keys(registry);
    let deletedCount = 0;
    
    console.log('Checking', keys.length, 'keys in registry...');
    
    // ‡∏•‡∏ö‡∏ó‡∏∏‡∏Å key ‡∏ó‡∏µ‡πà‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢ prefix
    keys.forEach(function(key) {
      if (key.indexOf(prefix) === 0) {
        console.log('‚úÖ Removing:', key);
        clearCacheByKey(key);
        deletedCount++;
      }
    });
    
    console.log('Deleted', deletedCount, 'caches');
    
    if (deletedCount === 0) {
      console.log('‚ö†Ô∏è No matching keys found for prefix:', prefix);
    }
    
    // Reload (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ function)
    if (reloadFunction) {
      console.log('Reloading data...');
      try {
        reloadFunction();
      } catch (reloadError) {
        console.error('Error in reload function:', reloadError);
      }
    }
    
    console.log('‚úÖ Cache refreshed:', prefix);
    console.log('==========================================');
    
    return {
      success: true,
      deletedCount: deletedCount
    };
    
  } catch (error) {
    console.error('Error refreshing cache:', error);
    return {
      success: false,
      message: error.toString(),
      deletedCount: 0
    };
  }
}

/**
 * ‚≠ê Refresh Work Types Cache
 */
function refreshWorkTypesCache() {
  try {
    console.log('üîÑ Refreshing Work Types Cache...');
    
    const result = refreshCacheByPrefix('master_work_types', function() {
      getWorkTypeList('RFI Work');
      getWorkTypeList('Survey Work');
    });
    
    if (result.success) {
      SpreadsheetApp.getUi().alert(
        'Work Types Cache Refreshed! ‚úÖ',
        'Deleted: ' + result.deletedCount + ' old caches\n' +
        'Reloaded: 2 work type lists\n\n' +
        'Work Types cache is now up to date!',
        SpreadsheetApp.getUi().ButtonSet.OK
      );
    } else {
      SpreadsheetApp.getUi().alert(
        'Refresh Failed',
        result.message,
        SpreadsheetApp.getUi().ButtonSet.OK
      );
    }
    
  } catch (error) {
    console.error('Error in refreshWorkTypesCache:', error);
    SpreadsheetApp.getUi().alert('Error: ' + error.toString());
  }
}

/**
 * ‚≠ê Refresh Resources Cache
 */
function refreshResourcesCache() {
  try {
    console.log('üîÑ Refreshing Resources Cache...');
    
    const result = refreshCacheByPrefix('master_resources', function() {
      getTeamsByCategory('Survey');
      getTeamsByCategory('Inspector');
      getTeamsByCategory('Lab');
    });
    
    if (result.success) {
      SpreadsheetApp.getUi().alert(
        'Resources Cache Refreshed! ‚úÖ',
        'Deleted: ' + result.deletedCount + ' old caches\n' +
        'Reloaded: 3 resource lists\n\n' +
        'Resources cache is now up to date!',
        SpreadsheetApp.getUi().ButtonSet.OK
      );
    } else {
      SpreadsheetApp.getUi().alert(
        'Refresh Failed',
        result.message,
        SpreadsheetApp.getUi().ButtonSet.OK
      );
    }
    
  } catch (error) {
    console.error('Error in refreshResourcesCache:', error);
    SpreadsheetApp.getUi().alert('Error: ' + error.toString());
  }
}

/**
 * ‚≠ê Refresh Code Lists Cache
 */
function refreshCodeListCache() {
  try {
    console.log('üîÑ Refreshing Code Lists Cache...');
    
    const result = refreshCacheByPrefix('master_code_list');
    
    if (result.success) {
      SpreadsheetApp.getUi().alert(
        'Code Lists Cache Refreshed! ‚úÖ',
        'Deleted: ' + result.deletedCount + ' old caches\n\n' +
        'Code lists will be reloaded on next use.',
        SpreadsheetApp.getUi().ButtonSet.OK
      );
    } else {
      SpreadsheetApp.getUi().alert(
        'Refresh Failed',
        result.message,
        SpreadsheetApp.getUi().ButtonSet.OK
      );
    }
    
  } catch (error) {
    console.error('Error in refreshCodeListCache:', error);
    SpreadsheetApp.getUi().alert('Error: ' + error.toString());
  }
}


/**
 * ‚≠ê ‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Cache Chunks
 */
function getCachedDataWithChunks(cacheKey) {
  try {
    const cache = CacheService.getScriptCache();
    
    // ‡∏•‡∏≠‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥‡∏Å‡πà‡∏≠‡∏ô
    let cachedData = cache.get(cacheKey);
    
    if (cachedData) {
      console.log('‚úÖ Cache HIT (single key):', cacheKey);
      return JSON.parse(cachedData);
    }
    
    // ‡∏•‡∏≠‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏à‡∏≤‡∏Å chunks
    const meta = cache.get(cacheKey + '_meta');
    
    if (meta) {
      console.log('‚úÖ Cache HIT (chunks):', cacheKey);
      
      const metaData = JSON.parse(meta);
      const allData = [];
      
      for (let i = 0; i < metaData.totalChunks; i++) {
        const chunkKey = cacheKey + '_chunk_' + i;
        const chunkData = cache.get(chunkKey);
        
        if (chunkData) {
          const chunk = JSON.parse(chunkData);
          allData.push(...chunk);
        } else {
          console.log('‚ö†Ô∏è Missing chunk:', i);
          return null; // chunk ‡∏´‡∏≤‡∏¢ ‚Üí ‡∏ï‡πâ‡∏≠‡∏á reload
        }
      }
      
      console.log('‚úÖ Reassembled', allData.length, 'items from', metaData.totalChunks, 'chunks');
      return allData;
    }
    
    // Cache miss
    return null;
    
  } catch (error) {
    console.error('Error reading cached chunks:', error);
    return null;
  }
}

/**
 * ‚≠ê ‡∏™‡∏£‡πâ‡∏≤‡∏á Cache ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (Warm Up Cache) - UPDATED
 */
function warmUpAllCache() {
  console.log('========== Warming Up Cache ==========');
  try {
    // 1. Work Types
    console.log('1. Loading Work Types...');
    getWorkTypeList('RFI Work');
    getWorkTypeList('Survey Work');
    console.log('   ‚úÖ Work Types cached');
    
    // 2. Resources (Survey)
    console.log('2. Loading Survey Teams...');
    getTeamsByCategory('Survey');
    console.log('   ‚úÖ Survey Teams cached');
    
    // 3. Resources (Inspector)
    console.log('3. Loading Inspector Teams...');
    getTeamsByCategory('Inspector');
    console.log('   ‚úÖ Inspector Teams cached');
    
    // 4. Resources (Lab)
    console.log('4. Loading Lab Teams...');
    getTeamsByCategory('Lab');
    console.log('   ‚úÖ Lab Teams cached');
    
    // 5. Code List
    console.log('5. Loading Code Lists...');
    const workTypes = getWorkTypeList('RFI Work');
    if (workTypes.length > 0) {
      getCodeListByWorkType(workTypes[0].name);
      console.log('   ‚úÖ Code List cached');
    }

    // ‚úÖ‚úÖ‚úÖ 6. ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ: Holidays ‚úÖ‚úÖ‚úÖ
    console.log('6. Loading Holidays...');
    if (typeof loadHolidaysFromSheet === 'function') {
      loadHolidaysFromSheet();
      console.log('   ‚úÖ Holidays cached');
    } else {
      console.log('   ‚ö†Ô∏è loadHolidaysFromSheet not found');
    }
    
    console.log('\n========== Cache Warm Up Complete ==========');
    
    // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
    const status = getCacheStatus();
    SpreadsheetApp.getUi().alert(
      'Cache Warm Up Complete! ‚úÖ',
      'All master data (including Holidays) has been loaded.\n\n' +
      'Total Keys: ' + status.totalKeys + '\n' +
      'Total Size: ' + status.totalSizeKB + ' KB',
      SpreadsheetApp.getUi().ButtonSet.OK
    );
  } catch (error) {
    console.error('‚ùå Error warming up cache:', error);
    SpreadsheetApp.getUi().alert('Cache Warm Up Failed: ' + error.toString());
  }
}

/**
 * ‚≠ê ‡∏•‡πâ‡∏≤‡∏á Cache ‡πÅ‡∏ö‡∏ö Hard Reset (‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á)
 */
function hardResetCache() {
  try {
    const cache = CacheService.getScriptCache();
    
    console.log('========== Hard Reset Cache ==========');
    
    // ‡∏•‡∏≠‡∏á brute force ‡∏•‡∏ö keys ‡∏ó‡∏µ‡πà‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å
    const possibleKeys = [
      'master_work_types_RFI Work',
      'master_work_types_Survey Work',
      'master_work_types_ALL',
      'master_resources_Survey_ALL',
      'master_resources_Inspector_ALL',
      'master_resources_Lab_ALL',
      'master_code_list_Core Rock',
      '__cache_registry__'
    ];
    
    console.log('Removing known keys...');
    possibleKeys.forEach(function(key) {
      cache.remove(key);
      cache.remove(key + '_meta');
      
      // ‡∏•‡∏ö chunks
      for (let i = 0; i < 100; i++) {
        cache.remove(key + '_chunk_' + i);
      }
    });
    
    // ‡∏•‡∏ö Registry
    cache.remove('__cache_registry__');
    
    console.log('‚úÖ Hard reset complete');
    
    SpreadsheetApp.getUi().alert(
      'Cache Hard Reset Complete! ‚úÖ',
      'All cache has been cleared.\n\n' +
      'Now run "Warm Up Cache" to rebuild.',
      SpreadsheetApp.getUi().ButtonSet.OK
    );
    
    return {
      success: true,
      message: 'Hard reset complete'
    };
    
  } catch (error) {
    console.error('Error in hard reset:', error);
    return {
      success: false,
      message: error.toString()
    };
  }
}

/**
 * ‚≠ê ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Cache Health (‡∏£‡∏±‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô)
 */
function checkCacheHealth() {
  try {
    console.log('========== Cache Health Check ==========');
    
    const status = getCacheStatus();
    
    console.log('Total Keys:', status.totalKeys);
    console.log('Total Size:', status.totalSizeKB, 'KB');
    
    // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤ cache ‡∏ß‡πà‡∏≤‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    if (status.totalKeys === 0) {
      console.log('‚ö†Ô∏è Cache is empty - warming up...');
      warmUpAllCache();
      return;
    }
    
    // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ critical keys ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    const criticalKeys = [
      'master_work_types_RFI Work',
      'master_work_types_Survey Work',
      'master_resources_Survey_ALL'
    ];
    
    let missingKeys = [];
    
    criticalKeys.forEach(function(key) {
      if (!status.status[key] || !status.status[key].cached) {
        missingKeys.push(key);
      }
    });
    
    if (missingKeys.length > 0) {
      console.log('‚ö†Ô∏è Missing critical keys:', missingKeys.join(', '));
      console.log('Re-warming cache...');
      warmUpAllCache();
      return;
    }
    
    console.log('‚úÖ Cache health: OK');
    console.log('==========================================');
    
  } catch (error) {
    console.error('Error checking cache health:', error);
    logError('checkCacheHealth', error, {}, 'WARNING');
  }
}


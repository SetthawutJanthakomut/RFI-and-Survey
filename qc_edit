<!DOCTYPE html>
<html>

<head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QC - ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç RFI</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Kanit', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        h1 {
            text-align: center;
            font-size: 32px;
            font-weight: 600;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 16px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            font-family: 'Kanit', sans-serif;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        th,
        td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e4e6eb;
            font-size: 14px;
        }

        tbody tr:hover {
            background: #f8f9fa;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-draft {
            background: #fff3cd;
            color: #856404;
        }

        .status-submitted {
            background: #d1ecf1;
            color: #0c5460;
        }

        .btn-edit {
            background: #667eea;
            color: white;
            border: none;
            padding: 6px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-family: 'Kanit', sans-serif;
            font-size: 13px;
        }

        .btn-edit:hover {
            background: #5568d3;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state h3 {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            margin: 0 auto 10px;
            border: 3px solid rgba(102, 126, 234, 0.2);
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .message {
            padding: 12px 16px;
            margin-top: 20px;
            border-radius: 10px;
            text-align: center;
            display: none;
            font-size: 14px;
            white-space: pre-line;
        }

        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .inspector-checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .inspector-checkbox-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 8px;
            background: white;
            border: 2px solid #e4e6eb;
            cursor: pointer;
            transition: all 0.2s;
        }

        .inspector-checkbox-item:hover {
            border-color: #667eea;
            background: #f0f3ff;
        }

        .inspector-checkbox-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: #667eea;
        }

        .inspector-checkbox-item label {
            cursor: pointer;
            margin: 0;
            font-size: 15px;
            color: #333;
            flex: 1;
        }

        .inspector-checkbox-item .badge {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 5px;
            background: #e7f0ff;
            color: #667eea;
            font-weight: 500;
        }

        .inspector-checkbox-item input[type="checkbox"]:checked+label {
            font-weight: 600;
            color: #667eea;
        }

        .inspector-loading {
            color: #999;
            text-align: center;
            padding: 30px;
            font-style: italic;
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e4e6eb;
            border-radius: 10px;
            font-family: 'Kanit', sans-serif;
            font-size: 15px;
            transition: all 0.3s;
        }

        input:disabled,
        select:disabled {
            background: #f5f6f7;
            opacity: 0.7;
            cursor: not-allowed;
        }

        textarea {
            height: 90px;
            resize: vertical;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .required {
            color: #e74c3c;
        }

        .info-note {
            font-size: 12px;
            color: #667eea;
            margin-top: 5px;
            font-style: italic;
        }

        .work-type-note {
            margin-top: 12px;
            padding: 12px 16px;
            background: linear-gradient(135deg, #fff7ed 0%, #ffedd5 100%);
            border-left: 4px solid #f59e0b;
            border-radius: 8px;
            font-size: 13px;
            color: #92400e;
            line-height: 1.6;
            animation: slideDown 0.3s ease-out;
        }

        .work-type-note strong {
            color: #f59e0b;
            font-weight: 600;
        }

        .work-type-note::before {
            content: 'üìå ';
            font-size: 16px;
            margin-right: 4px;
        }

        .btn-add-itp {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
    padding: 10px 20px;
    border: none;
    border-radius: 10px;
    font-family: 'Kanit', sans-serif;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.3s;
    display: inline-flex;
    align-items: center;
    gap: 8px;
}

.btn-add-itp:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
}

input[type="text"]:disabled,
textarea:disabled {
    background: #f5f6f7 !important;
    cursor: not-allowed !important;
    opacity: 0.7;
}
/* ‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö ITP */
.btn-delete-itp {
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    color: white;
    padding: 6px 12px;
    border: none;
    border-radius: 6px;
    font-family: 'Kanit', sans-serif;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.3s;
    margin-left: 8px;
    display: inline-flex;
    align-items: center;
    gap: 4px;
}

.btn-delete-itp:hover {
    background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
    transform: scale(1.05);
}

.itp-select-wrapper {
    display: flex;
    align-items: center;
    gap: 10px;
}

.itp-select-wrapper select {
    flex: 1;
}

/* ‚≠ê Status Badge ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Status ‡πÉ‡∏´‡∏°‡πà */
.status-waiting {
    background: #fff3cd;
    color: #856404;
}

.status-pending {
    background: #cfe2ff;
    color: #084298;
}

/* ‚≠ê ‡πÅ‡∏™‡∏î‡∏á Warning ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Limited Edit Mode */
.limited-edit-warning {
    background: linear-gradient(135deg, #fff7ed 0%, #ffedd5 100%);
    border-left: 4px solid #f59e0b;
    padding: 15px 20px;
    border-radius: 10px;
    margin: 20px 0;
    font-size: 14px;
    color: #92400e;
    line-height: 1.6;
}

.limited-edit-warning strong {
    color: #f59e0b;
    font-weight: 600;
    font-size: 15px;
}

.limited-edit-warning ul {
    margin: 10px 0 0 20px;
    padding: 0;
}

.limited-edit-warning li {
    margin: 5px 0;
}

/* ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏° Status Badge ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Status ‡πÉ‡∏´‡∏°‡πà */
.status-rejected {
    background: #fee2e2;
    color: #991b1b;
}

.status-revised {
    background: #dbeafe;
    color: #1e40af;
}
    </style>
</head>

<body>
    <div class="container">
        <div style="text-align: center; margin-bottom: 40px;">
            <div style="display: inline-flex; align-items: center; justify-content: center; width: 80px; height: 80px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 20px; margin-bottom: 20px; box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);">
                <span style="font-size: 40px;">üìù</span>
            </div>

            <h1 style="font-size: 32px; font-weight: 600; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 10px;">
                QC - ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç RFI
            </h1>

            <div style="display: flex; align-items: center; justify-content: center; gap: 10px; flex-wrap: wrap;">
                <span style="color: #666; font-size: 16px;">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Request for Information</span>
                <span style="display: inline-block; padding: 4px 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 20px; font-size: 12px; font-weight: 500;">QC Editor</span>
            </div>

            <div style="display: flex; align-items: center; justify-content: center; gap: 15px; margin-top: 15px; font-size: 13px; color: #999;">
                <div style="display: flex; align-items: center; gap: 5px;">
                    <span style="width: 8px; height: 8px; background: #ffc107; border-radius: 50%; display: inline-block;"></span>
                    <span>Draft</span>
                </div>
                <div style="display: flex; align-items: center; gap: 5px;">
                    <span style="width: 8px; height: 8px; background: #17a2b8; border-radius: 50%; display: inline-block;"></span>
                    <span>Submitted</span>
                </div>
            </div>
        </div>

        <div style="margin-bottom: 20px;">
            <button class="btn btn-primary" onclick="loadRFIList()">üîÑ Refresh</button>
        </div>

        <div id="rfiTableContainer">
            <div class="loading">
                <div class="spinner"></div>
                <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
            </div>
        </div>

        <div id="message" class="message"></div>
        <!-- ‚≠ê Add ITP Modal -->
<div id="addITPModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; overflow-y: auto; padding: 20px;">
    <div style="max-width: 700px; margin: 40px auto; background: white; border-radius: 20px; padding: 40px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
        <div style="text-align: center; margin-bottom: 30px;">
            <div style="display: inline-flex; align-items: center; justify-content: center; width: 70px; height: 70px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 16px; margin-bottom: 15px;">
                <span style="font-size: 36px;">‚ûï</span>
            </div>
            <h2 style="font-size: 26px; font-weight: 600; background: linear-gradient(135deg, #10b981 0%, #059669 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin: 0;">
                ‡πÄ‡∏û‡∏¥‡πà‡∏° ITP Code ‡πÉ‡∏´‡∏°‡πà
            </h2>
            <p style="color: #666; margin-top: 8px; font-size: 14px;">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ITP ‡πÄ‡∏Ç‡πâ‡∏≤ Sheet "Code"</p>
        </div>

        <form id="addITPForm">
            <!-- Name_Work (Work Type Selector) -->
            <div style="margin-bottom: 20px;">
                <label class="form-label">Work Type <span class="required">*</span></label>
                <select id="addITPWorkType" required style="font-size: 15px;">
                    <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Work Type --</option>
                </select>
                <div class="info-note">üí° ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Work Type ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏° ITP</div>
            </div>

            <!-- ITP -->
            <div style="margin-bottom: 20px;">
                <label class="form-label">ITP <span class="required">*</span></label>
                <input type="text" id="addITPITP" required placeholder="‡πÄ‡∏ä‡πà‡∏ô ITP-CIV-001" style="font-size: 15px; text-transform: uppercase;">
                <div class="info-note">‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ITP-XXX-000</div>
            </div>

            <!-- QC Code -->
            <div style="margin-bottom: 20px;">
                <label class="form-label">QC Code <span class="required">*</span></label>
                <input type="text" id="addITPQCCode" required placeholder="‡πÄ‡∏ä‡πà‡∏ô CIV-QC-001" style="font-size: 15px; text-transform: uppercase;">
                <div class="info-note">‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: XXX-QC-000</div>
            </div>

            <!-- ITEM -->
            <div style="margin-bottom: 20px;">
                <label class="form-label">ITEM <span class="required">*</span></label>
                <input type="text" id="addITPItem" required placeholder="‡πÄ‡∏ä‡πà‡∏ô Concrete Strength Test" style="font-size: 15px;">
                <div class="info-note">‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</div>
            </div>

            <!-- Description_Code -->
            <div style="margin-bottom: 20px;">
                <label class="form-label">Description Code <span class="required">*</span></label>
                <textarea id="addITPDescription" required placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°..." style="height: 100px; font-size: 14px;"></textarea>
                <div class="info-note">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</div>
            </div>

            <!-- Buttons -->
            <div style="display: flex; gap: 15px; margin-top: 30px;">
                <button type="button" onclick="closeAddITPModal()" style="flex: 1; padding: 14px; background: #e4e6eb; color: #333; border: none; border-radius: 10px; font-family: 'Kanit', sans-serif; font-size: 16px; font-weight: 500; cursor: pointer; transition: all 0.3s;">
                    ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                </button>
                <button type="submit" style="flex: 1; padding: 14px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; border-radius: 10px; font-family: 'Kanit', sans-serif; font-size: 16px; font-weight: 500; cursor: pointer; transition: all 0.3s;">
                    ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° ITP Code
                </button>
            </div>
        </form>

        <div id="addITPLoading" class="loading" style="display:none;">
            <div class="spinner"></div>
            <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
        </div>
    </div>
</div>

        <!-- Edit View -->
        <div id="editView" style="display:none; margin-top: 30px; border-top: 2px solid #667eea; padding-top: 30px;">
            <div style="background: linear-gradient(135deg, #e7f0ff 0%, #d4e6ff 100%); border-left: 4px solid #667eea; padding: 15px; border-radius: 10px; margin-bottom: 25px; font-size: 14px; color: #1c4587;">
                <strong>üìù ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç RFI:</strong> <span id="editRFINo"></span><br>
                <strong id="editInfoNote">‚ö†Ô∏è ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç RFI NO ‡πÅ‡∏•‡∏∞ Work Type ‡πÑ‡∏î‡πâ</strong>
            </div>

            <form id="editForm">
                <input type="hidden" id="editRfiId">
                <input type="hidden" id="editOriginalStatus">

                <div style="margin-bottom: 20px;">
                    <label class="form-label">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô (Work Type) <span class="required">*</span></label>
                    <select id="editWorkType" disabled>
                        <option value="">-- ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î... --</option>
                    </select>
                    <div class="info-note" id="workTypeNote">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Work Type ‡πÑ‡∏î‡πâ (Status: Draft)</div>
                    <!-- ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á Note -->
                    <div id="editWorkTypeNote" class="work-type-note" style="display: none;"></div>
                </div>
                <!-- ‚úÖ ‚≠ê ITP Selection + Auto-populate QC/ITEM/Description -->
                <div style="margin-bottom: 20px; padding: 20px; background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border-radius: 12px; border-left: 4px solid #0ea5e9;">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 15px;">
                        <span style="font-size: 18px;">üìã</span>
                        <strong style="font-size: 16px; color: #0369a1;">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ITP / QC Code</strong>
                    </div>

                    <!-- ITP Dropdown (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ) -->
                   <div style="margin-bottom: 15px;">
<div style="margin-bottom: 15px;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
        <label class="form-label" style="margin: 0;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ITP <span class="required">*</span></label>
        <button type="button" onclick="openAddITPModal()" class="btn-add-itp" style="padding: 6px 12px; font-size: 13px;">
            ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏° ITP ‡πÉ‡∏´‡∏°‡πà
        </button>
    </div>
    
    <!-- ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏° Wrapper ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Select + ‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö -->
    <div class="itp-select-wrapper">
        <select id="editITPSelect" required style="font-size: 14px;">
            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Work Type ‡∏Å‡πà‡∏≠‡∏ô --</option>
        </select>
        
        <!-- ‚≠ê ‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö ITP -->
        <button type="button" 
                id="btnDeleteITP" 
                class="btn-delete-itp" 
                onclick="deleteSelectedITP()"
                style="display: none;">
            üóëÔ∏è ‡∏•‡∏ö
        </button>
    </div>
    
    <div class="info-note">üí° ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö: ITP - QC Code - ITEM</div>
</div>

                    <!-- Hidden field ‡πÄ‡∏Å‡πá‡∏ö ITP ‡∏à‡∏£‡∏¥‡∏á -->
                    <input type="hidden" id="editITP" required>

                    <!-- QC Code (Read-only) -->
                    <div style="margin-bottom: 15px;">
                        <label class="form-label">QC Code <span class="required">*</span></label>
                        <input type="text" id="editQCCode" required readonly placeholder="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ITP ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡∏Å‡πà‡∏≠‡∏ô" style="background: #f5f6f7; cursor: not-allowed; font-weight: 600; color: #0ea5e9;">
                    </div>

                    <!-- ITEM (Read-only) -->
                    <div style="margin-bottom: 15px;">
                        <label class="form-label">ITEM <span class="required">*</span></label>
                        <input type="text" id="editITEM" required readonly placeholder="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ITP ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡∏Å‡πà‡∏≠‡∏ô" style="background: #f5f6f7; cursor: not-allowed; font-weight: 600; color: #0ea5e9;">
                    </div>

                    <!-- Description Code (Read-only) -->
                    <div>
                        <label class="form-label">Description Code <span class="required">*</span></label>
                        <textarea id="editDescriptionCode" required readonly placeholder="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ITP ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡∏Å‡πà‡∏≠‡∏ô" style="background: #f5f6f7; cursor: not-allowed; height: 100px; font-size: 13px; color: #333;"></textarea>
                        <div class="info-note">‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ITP</div>
                    </div>
                </div>

                <!-- ‚≠ê TAG NUMBER -->
<div style="margin-top: 15px;">
    <label class="form-label">TAG NUMBER <span class="required">*</span></label>
    <input type="text" 
           id="editTagNumber" 
           required 
           placeholder="‡πÄ‡∏ä‡πà‡∏ô TAG-001, TAG-A01"
           style="font-size: 14px;">
    <div class="info-note">üí° ‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç TAG ‡∏Ç‡∏≠‡∏á‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå/‡∏à‡∏∏‡∏î‡∏ï‡∏£‡∏ß‡∏à</div>
</div>

                <div style="margin-bottom: 20px;">
                    <label class="form-label">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î RFI <span class="required">*</span></label>
                    <textarea id="editDescription" required placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÉ‡∏´‡πâ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô‡πÅ‡∏•‡∏∞‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô..."></textarea>

                    <div style="display: flex; align-items: start; gap: 8px; margin-top: 8px; padding: 10px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 6px;">
                        <span style="font-size: 16px;">‚ö†Ô∏è</span>
                        <div style="font-size: 13px; color: #856404; line-height: 1.5;">
                            <strong>‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö QC:</strong> ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á<br>
                            <span style="font-size: 12px;">‚Ä¢ User ‡∏≠‡∏≤‡∏à‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô</span><br>
                            <span style="font-size: 12px;">‚Ä¢ ‡∏Ñ‡∏ß‡∏£‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° ‡πÄ‡∏ä‡πà‡∏ô ‡∏à‡∏∏‡∏î‡∏ï‡∏£‡∏ß‡∏à, ‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï‡∏á‡∏≤‡∏ô, ‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡πâ‡∏≠‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏û‡∏¥‡πÄ‡∏®‡∏©</span>
                        </div>
                    </div>
                </div>

                <div style="margin-bottom: 20px;">
                    <label class="form-label">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà <span class="required">*</span></label>
                    <input type="text" id="editLocation" required placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡πÉ‡∏´‡πâ‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î ‡πÄ‡∏ä‡πà‡∏ô Crown Wall STA.0+050 to STA.0+060">

                    <div style="display: flex; align-items: start; gap: 8px; margin-top: 8px; padding: 10px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 6px;">
                        <span style="font-size: 16px;">üìç</span>
                        <div style="font-size: 13px; color: #856404; line-height: 1.5;">
                            <strong>‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö QC:</strong> ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô<br>
                            <span style="font-size: 12px;">‚Ä¢ User ‡∏≠‡∏≤‡∏à‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô</span><br>
                            <span style="font-size: 12px;">‚Ä¢ ‡∏Ñ‡∏ß‡∏£‡∏£‡∏∞‡∏ö‡∏∏: STA. ‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏∏‡∏î‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏ó‡∏µ‡πà‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô</span>
                        </div>
                    </div>
                </div>

                <div style="margin-bottom: 20px;">
                    <label class="form-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à‡∏á‡∏≤‡∏ô <span class="required">*</span></label>
                    <input type="date" id="editRequestDate" required>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                    <div>
                        <label class="form-label">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô <span class="required">*</span></label>
                        <select id="editStartTime" required>
                            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤ --</option>
                        </select>
                    </div>

                    <div>
                        <label class="form-label">‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î <span class="required">*</span></label>
                        <select id="editEndTime" required>
                            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤ --</option>
                        </select>
                    </div>
                </div>

                <div style="margin-bottom: 20px;">
                    <label class="form-label">‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô (Assigned Inspector) <span class="required">*</span></label>
                    <div id="editAssignedInspectorContainer" style="border: 2px solid #e4e6eb; border-radius: 10px; padding: 15px; background: #f8f9fa; min-height: 100px; max-height: 300px; overflow-y: auto;">
                        <div class="inspector-loading">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡πà‡∏≠‡∏ô</div>
                    </div>
                    <input type="hidden" id="editAssignedInspector" required>
                    <div id="editSelectedTeamsInfo" class="info-note">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏ó‡∏µ‡∏° (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡∏°‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á)</div>
                </div>

                <div style="margin-bottom: 20px;">
                    <label class="form-label">‡∏ú‡∏π‡πâ‡∏Ç‡∏≠</label>
                    <div style="padding: 12px; background: #f5f6f7; border: 2px solid #e4e6eb; border-radius: 10px; color: #666; font-size: 15px;">
                        <div style="font-weight: 600; margin-bottom: 4px;">
                            <span id="editRequesterNameDisplay">-</span>
                        </div>
                        <div style="font-size: 13px; color: #999;">
                            üìß <span id="editRequesterEmailDisplay">-</span>
                        </div>
                    </div>
                    <input type="hidden" id="editRequesterName">
                    <input type="hidden" id="editRequesterEmail">
                    <div class="info-note" style="color: #999;">‚ÑπÔ∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ú‡∏π‡πâ‡∏Ç‡∏≠‡πÑ‡∏î‡πâ</div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                    <div id="editSurveyReportGroup" style="display:none;">
                        <input type="hidden" id="editRequireSurveyReport" value="None">
                        <div style="padding: 12px; background: #e7f0ff; border: 2px solid #667eea; border-radius: 10px;">
                            <label class="form-label" style="margin-bottom: 5px;">Survey Report</label>
                            <div style="color: #667eea; font-weight: 600; font-size: 15px;">‚úì Both (Open + Close)</div>
                            <div class="info-note" style="color: #667eea;">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Survey Team</div>
                        </div>
                    </div>

                    <div id="editLabReportGroup" style="display:none;">
                        <label class="form-label">Lab Report <span class="required">*</span></label>
                        <select id="editRequireLabReport">
                            <option value="Both">Both (Open + Close)</option>
                            <option value="Closing">Closing (Close ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)</option>
                        </select>
                        <div class="info-note">‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Lab Team</div>
                    </div>
                </div>

                <div style="display: flex; gap: 15px; margin-top: 30px;">
                    <button type="button" onclick="cancelEdit()" style="flex: 1; padding: 14px; background: #e4e6eb; color: #333; border: none; border-radius: 10px; font-family: 'Kanit', sans-serif; font-size: 16px; font-weight: 500; cursor: pointer;">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button type="submit" style="flex: 1; padding: 14px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; font-family: 'Kanit', sans-serif; font-size: 16px; font-weight: 500; cursor: pointer;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                </div>
            </form>

            <div id="editLoading" class="loading" style="display:none;">
                <div class="spinner"></div>
                <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
            </div>
        </div>
    </div>

    <script>
        var availableTeams = [];
        var originalAssignedTeams = [];
        var allWorkTypes = [];
        // ‚úÖ ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ
        var codeListByWorkType = [];

        function generateTimeSlots(isEndTime) {
            var slots = [];
            var startHour = 9;
            var endHour = isEndTime ? 20 : 19;

            for (var hour = startHour; hour <= endHour; hour++) {
                for (var minute = 0; minute < 60; minute += 30) {
                    if (hour === 19 && minute === 30 && !isEndTime) break;
                    if (hour === 20 && minute > 0) break;

                    var time = hour.toString().padStart(2, '0') + ':' + minute.toString().padStart(2, '0');
                    slots.push(time);
                }
            }

            return slots;
        }

        function populateTimeDropdown(selectId, selectedValue, isEndTime) {
            var select = document.getElementById(selectId);
            if (!select) return;

            var slots = generateTimeSlots(isEndTime);

            select.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤ --</option>';

            for (var i = 0; i < slots.length; i++) {
                var option = document.createElement('option');
                option.value = slots[i];
                option.textContent = slots[i] + ' ‡∏ô.';

                if (slots[i] === selectedValue) {
                    option.selected = true;
                }

                select.appendChild(option);
            }
        }

        function filterEndTimeOptions() {
            var startTime = document.getElementById('editStartTime').value;
            var endTimeSelect = document.getElementById('editEndTime');
            var currentEndValue = endTimeSelect.value;

            if (!startTime) {
                populateTimeDropdown('editEndTime', currentEndValue, true);
                return;
            }

            var slots = generateTimeSlots(true);
            var startMinutes = timeToMinutes(startTime);

            endTimeSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤ --</option>';

            for (var i = 0; i < slots.length; i++) {
                var slotMinutes = timeToMinutes(slots[i]);

                if (slotMinutes > startMinutes) {
                    var option = document.createElement('option');
                    option.value = slots[i];
                    option.textContent = slots[i] + ' ‡∏ô.';

                    if (slots[i] === currentEndValue) {
                        option.selected = true;
                    }

                    endTimeSelect.appendChild(option);
                }
            }
        }

        function timeToMinutes(time) {
            if (!time) return 0;
            var parts = time.split(':');
            return parseInt(parts[0]) * 60 + parseInt(parts[1]);
        }
        window.onload = function() {
            loadRFIList();
            loadWorkTypeList();
            getCurrentUserEmail();
            checkQCRole();

            populateTimeDropdown('editStartTime', '', false);
            populateTimeDropdown('editEndTime', '', true);

            // ‚úÖ ‚≠ê Add ITP Select Event Listener
            var itpSelect = document.getElementById('editITPSelect');
            if (itpSelect) {
                itpSelect.addEventListener('change', onITPSelectChange);
            }

            setTimeout(function() {
                setupEditFormListeners();
            }, 500);
        };

        function checkQCRole() {
            google.script.run
                .withSuccessHandler(function(result) {
                    if (!result.success) {
                        showMessage(result.message, 'error', 10000);
                        document.querySelector('.btn-primary').disabled = true;
                        document.getElementById('rfiTableContainer').style.opacity = '0.5';
                        document.getElementById('rfiTableContainer').style.pointerEvents = 'none';
                    } else {
                        showMessage('‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö ' + result.name + ' (' + result.role + ')', 'success', 3000);
                    }
                })
                .withFailureHandler(function(error) {
                    showMessage('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÑ‡∏î‡πâ', 'error');
                })
                .validateQCRole();
        }

        function getCurrentUserEmail() {
            google.script.run
                .withSuccessHandler(function(email) {
                    currentUserEmail = email;
                })
                .withFailureHandler(function(error) {
                    console.error('Error getting user email:', error);
                })
                .getCurrentUserEmail();
        }

        function loadWorkTypeList() {
            google.script.run
                .withSuccessHandler(function(workTypes) {
                    allWorkTypes = workTypes || [];
                    console.log('‚úÖ Loaded', allWorkTypes.length, 'work types');
                })
                .withFailureHandler(function(error) {
                    console.error('‚ùå Error loading work types:', error);
                    allWorkTypes = [];
                })
                .getWorkTypeList('RFI Work');
        }


        function setupEditFormListeners() {
            var editDateInput = document.getElementById('editRequestDate');
            var editStartInput = document.getElementById('editStartTime');
            var editEndInput = document.getElementById('editEndTime');

            if (editStartInput) {
                editStartInput.addEventListener('change', function() {
                    filterEndTimeOptions();

                    var date = editDateInput.value;
                    var startTime = this.value;
                    var endTime = editEndInput.value;

                    if (date && startTime) {
                        loadAvailableTeamsForEdit(date, startTime, endTime);
                    }
                });
            }

            if (editDateInput) {
                editDateInput.addEventListener('change', function() {
                    var date = this.value;
                    var startTime = editStartInput.value;
                    var endTime = editEndInput.value;

                    if (date && startTime) {
                        loadAvailableTeamsForEdit(date, startTime, endTime);
                    } else {
                        document.getElementById('editAssignedInspectorContainer').innerHTML = '<div class="inspector-loading">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Å‡πà‡∏≠‡∏ô</div>';
                    }
                });
            }

            if (editEndInput) {
                editEndInput.addEventListener('change', function() {
                    var date = editDateInput.value;
                    var startTime = editStartInput.value;
                    var endTime = this.value;

                    if (date && startTime) {
                        loadAvailableTeamsForEdit(date, startTime, endTime);
                    }
                });
            }

            var editForm = document.getElementById('editForm');
            if (editForm) {
                editForm.addEventListener('submit', function(e) {
                    e.preventDefault();

                    var rfiId = document.getElementById('editRfiId').value;
                    var loading = document.getElementById('editLoading');

// ‚úÖ FIXED: Validation Logic ‡πÅ‡∏¢‡∏Å‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô
var originalStatus = document.getElementById('editOriginalStatus').value || '';

if (!originalStatus) {
    console.warn('‚ö†Ô∏è editOriginalStatus is empty! Defaulting to Normal Edit Mode');
}

var isLimitedEdit = (originalStatus === 'Waiting for Revised Attachment' || 
                    originalStatus === 'Pending QC Review');

console.log('üìã Original Status:', originalStatus);
console.log('üîí Is Limited Edit?', isLimitedEdit);

var formData = {
    workType: document.getElementById('editWorkType').value,
    description: document.getElementById('editDescription').value.trim(),
    location: document.getElementById('editLocation').value.trim(),
    requestDate: document.getElementById('editRequestDate').value,
    startTime: document.getElementById('editStartTime').value,
    endTime: document.getElementById('editEndTime').value,
    assignedInspector: document.getElementById('editAssignedInspector').value,
    requesterEmail: document.getElementById('editRequesterEmail').value,
    requesterName: document.getElementById('editRequesterName').value,
    requireSurveyReport: document.getElementById('editRequireSurveyReport').value || 'None',
    requireLabReport: document.getElementById('editRequireLabReport').value || 'None',
    itp: document.getElementById('editITP').value,
    qcCode: document.getElementById('editQCCode').value,
    item: document.getElementById('editITEM').value,
    descriptionCode: document.getElementById('editDescriptionCode').value,
    tagNumber: document.getElementById('editTagNumber').value.trim(),
    isLimitedEdit: isLimitedEdit  // ‚≠ê ‡∏™‡πà‡∏á flag ‡πÑ‡∏õ‡∏ó‡∏µ‡πà Backend
};

// ‚úÖ Validation ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡πÇ‡∏´‡∏°‡∏î
if (isLimitedEdit) {
    console.log('üîí Limited Edit Mode - Validating editable fields only');
    
    // ‚úÖ ‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ
    if (!formData.itp || !formData.qcCode || !formData.item || !formData.descriptionCode) {
        showMessage('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ITP', 'error');
        return;
    }
    
    if (!formData.tagNumber) {
        showMessage('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å TAG NUMBER', 'error');
        return;
    }
    
    if (!formData.description) {
        showMessage('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î RFI', 'error');
        return;
    }
    
    if (!formData.location) {
        showMessage('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà', 'error');
        return;
    }
    
    console.log('‚úÖ Limited Edit validation passed');
    
} else {
    console.log('üìù Normal Edit Mode - Validating all fields');
    
    // ‚úÖ ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ó‡∏∏‡∏Å‡∏ü‡∏¥‡∏•‡∏î‡πå (‡πÇ‡∏´‡∏°‡∏î‡∏õ‡∏Å‡∏ï‡∏¥)
    if (!formData.tagNumber) {
        showMessage('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å TAG NUMBER', 'error');
        return;
    }

    if (!formData.itp || !formData.qcCode || !formData.item || !formData.descriptionCode) {
        showMessage('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ITP', 'error');
        return;
    }

    if (!formData.assignedInspector) {
        showMessage('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô', 'error');
        return;
    }
    
    if (!formData.requestDate || !formData.startTime || !formData.endTime) {
        showMessage('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤', 'error');
        return;
    }
    
    if (!formData.description || !formData.location) {
        showMessage('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà', 'error');
        return;
    }
    
    console.log('‚úÖ Normal Edit validation passed');
}

// ‚úÖ ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ Backend
loading.style.display = 'block';

google.script.run
    .withSuccessHandler(function(result) {
        loading.style.display = 'none';

        if (result && result.success) {
            showMessage(result.message || '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç RFI ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success', 8000);
            setTimeout(function() {
                cancelEdit();
                loadRFIList();
            }, 2000);
        } else {
            showMessage(result.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error');
        }
    })
    .withFailureHandler(function(error) {
        loading.style.display = 'none';
        showMessage('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + (error.message || error), 'error');
    })
    .updateQCRFI(rfiId, formData);
                });
            }
        }

function loadRFIList() {
    var container = document.getElementById('rfiTableContainer');
    container.innerHTML = '<div class="loading"><div class="spinner"></div><p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p></div>';

    google.script.run
        .withSuccessHandler(function(rfiList) {
            if (!rfiList || rfiList.length === 0) {
                container.innerHTML = '<div class="empty-state"><h3>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ RFI</h3><p>‡πÑ‡∏°‡πà‡∏°‡∏µ RFI ‡∏ó‡∏µ‡πà‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ</p></div>';
                return;
            }

            var html = '<table><thead><tr>';
            html += '<th>RFI NO</th><th>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</th><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>';
            html += '<th>‡πÄ‡∏ß‡∏•‡∏≤</th><th>‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô</th><th>Type</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>'; // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° Type
            html += '</tr></thead><tbody>';

            for (var i = 0; i < rfiList.length; i++) {
                var rfi = rfiList[i];
                
                // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° Status Badge ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Status ‡πÉ‡∏´‡∏°‡πà
                var statusClass = 'status-submitted';
                if (rfi.status === 'Draft') {
                    statusClass = 'status-draft';
                } else if (rfi.status === 'Waiting for Revised Attachment') {
                    statusClass = 'status-waiting';
                } else if (rfi.status === 'Pending QC Review') {
                    statusClass = 'status-pending';
                } else if (rfi.status === 'Rejected by Consult ‚Äì Revise Required') {
                    statusClass = 'status-rejected';
                } else if (rfi.status === 'Revised Attachment Submitted ‚Äì Pending QC Review') {
                    statusClass = 'status-revised';
                }
                
                var desc = rfi.description || '';

                html += '<tr>';
                html += '<td><strong>' + (rfi.rfiNo || 'N/A') + '</strong></td>';
                html += '<td>' + desc.substring(0, 30) + (desc.length > 30 ? '...' : '') + '</td>';
                html += '<td>' + (rfi.location || '') + '</td>';
                html += '<td>' + (rfi.requestDate || '') + '</td>';
                html += '<td>' + (rfi.startTime || '') + '-' + (rfi.endTime || '') + '</td>';
                html += '<td>' + (rfi.assignedInspector || '') + '</td>';
                html += '<td>' + (rfi.type || 'N/A') + '</td>'; // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° Type column
                html += '<td><span class="status-badge ' + statusClass + '">' + rfi.status + '</span></td>';
                html += '<td><button class="btn-edit" onclick="editRFI(\'' + rfi.id + '\')">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button></td>';
                html += '</tr>';
            }

            html += '</tbody></table>';
            container.innerHTML = html;
            showMessage('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + rfiList.length + ' ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£', 'success', 3000);
        })
        .withFailureHandler(function(error) {
            container.innerHTML = '<div class="empty-state"><h3>‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</h3><p>' + (error.message || error) + '</p></div>';
            showMessage('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
        })
        .getRFIListForQC();
}

        function editRFI(rfiId) {
    document.getElementById('rfiTableContainer').style.display = 'none';
    document.querySelector('.btn-primary').style.display = 'none';
    document.getElementById('editView').style.display = 'block';

    google.script.run
        .withSuccessHandler(function(rfi) {
            if (!rfi) {
                alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• RFI');
                cancelEdit();
                return;
            }

            originalAssignedTeams = (rfi.assignedInspector || '').split(',').map(function(t) {
                return t.trim();
            }).filter(function(t) {
                return t;
            });

            document.getElementById('editRFINo').textContent = rfi.rfiNo || 'N/A';
            document.getElementById('editRfiId').value = rfi.id;
            document.getElementById('editOriginalStatus').value = rfi.status;
            
            // ‚≠ê‚≠ê‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ - ‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç Limited Edit Mode
            var isLimitedEdit = false;
            
            // ‚úÖ ‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç: Type = "Open RFI" AND Status ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î
            if (rfi.type === 'Open RFI') {
                var limitedStatuses = [
                    'Waiting for Revised Attachment',
                    'Pending QC Review',
                    'Rejected by Consult ‚Äì Revise Required',
                    'Revised Attachment Submitted ‚Äì Pending QC Review'
                ];
                
                isLimitedEdit = limitedStatuses.indexOf(rfi.status) !== -1;
            }
            
            console.log('üìã Type:', rfi.type);
            console.log('üìã Status:', rfi.status);
            console.log('üîí Is Limited Edit?', isLimitedEdit);
            
            // ‚úÖ ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô Limited Edit Mode (‡∏ñ‡πâ‡∏≤‡∏ï‡∏£‡∏á‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç)
            if (isLimitedEdit) {
                enableLimitedEditMode(rfi.status, rfi.type);
            } else {
                disableLimitedEditMode();
            }
            // ‚≠ê‚≠ê‚≠ê ‡∏à‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°

            document.getElementById('editDescription').value = rfi.description || '';
            document.getElementById('editLocation').value = rfi.location || '';
            document.getElementById('editRequestDate').value = rfi.requestDate || '';

            populateTimeDropdown('editStartTime', rfi.startTime || '', false);
            populateTimeDropdown('editEndTime', rfi.endTime || '', true);

            if (rfi.startTime) {
                filterEndTimeOptions();
            }

            var requesterNameDisplay = document.getElementById('editRequesterNameDisplay');
            var requesterEmailDisplay = document.getElementById('editRequesterEmailDisplay');

            if (requesterNameDisplay) {
                requesterNameDisplay.textContent = rfi.requesterName || '-';
            }
            if (requesterEmailDisplay) {
                requesterEmailDisplay.textContent = rfi.requesterEmail || '-';
            }

            document.getElementById('editRequesterName').value = rfi.requesterName || '';
            document.getElementById('editRequesterEmail').value = rfi.requesterEmail || '';
            document.getElementById('editRequireSurveyReport').value = rfi.requireSurveyReport || 'None';
            document.getElementById('editRequireLabReport').value = rfi.requireLabReport || 'None';

            // ‚úÖ Work Type + ITP Loading
            var workTypeSelect = document.getElementById('editWorkType');
            var workTypeNote = document.getElementById('workTypeNote');
            var editWorkTypeNote = document.getElementById('editWorkTypeNote');
            var editInfoNote = document.getElementById('editInfoNote');

            if (rfi.status === 'RFI Request Submitted') {
                workTypeSelect.disabled = false;
                workTypeSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô --</option>';

                for (var i = 0; i < allWorkTypes.length; i++) {
                    var option = document.createElement('option');
                    option.value = allWorkTypes[i].name;
                    option.textContent = allWorkTypes[i].qcType + ' ' + allWorkTypes[i].name + ' (' + allWorkTypes[i].duration + ' ‡∏ô‡∏≤‡∏ó‡∏µ)';

                    option.setAttribute('data-sequence', allWorkTypes[i].sequence || '010');
                    option.setAttribute('data-qctype', allWorkTypes[i].qcType || '999');
                    option.setAttribute('data-duration', allWorkTypes[i].duration || 60);
                    option.setAttribute('data-note', allWorkTypes[i].note || '');

                    if (allWorkTypes[i].name === rfi.workType) {
                        option.selected = true;

                        var currentNote = allWorkTypes[i].note || '';
                        if (editWorkTypeNote && currentNote.trim() !== '') {
                            editWorkTypeNote.innerHTML = '<strong>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</strong> ' + currentNote;
                            editWorkTypeNote.style.display = 'block';
                        }
                    }

                    workTypeSelect.appendChild(option);
                }

                workTypeSelect.addEventListener('change', function() {
                    var selectedOption = this.options[this.selectedIndex];
                    var note = selectedOption.getAttribute('data-note');

                    if (editWorkTypeNote) {
                        if (note && note.trim() !== '') {
                            editWorkTypeNote.innerHTML = '<strong>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</strong> ' + note;
                            editWorkTypeNote.style.display = 'block';
                        } else {
                            editWorkTypeNote.style.display = 'none';
                        }
                    }

                    var selectedWorkType = this.value;
                    if (selectedWorkType) {
                        console.log('üîÑ Work Type changed:', selectedWorkType);
                        loadCodeListForWorkType(selectedWorkType);
                    } else {
                        document.getElementById('editITPSelect').innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Work Type ‡∏Å‡πà‡∏≠‡∏ô --</option>';
                        document.getElementById('editITPSelect').disabled = true;
                        clearCodeFields();
                    }
                });

                workTypeNote.textContent = '‚úÖ ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Work Type ‡πÑ‡∏î‡πâ';
                workTypeNote.style.color = '#28a745';
                editInfoNote.innerHTML = '<strong>‚úÖ ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Work Type ‡πÑ‡∏î‡πâ</strong>';
                editInfoNote.style.color = '#28a745';

            } else {
                workTypeSelect.disabled = true;
                workTypeSelect.innerHTML = '<option value="' + (rfi.workType || '') + '">' + (rfi.workType || 'N/A') + '</option>';

                for (var j = 0; j < allWorkTypes.length; j++) {
                    if (allWorkTypes[j].name === rfi.workType) {
                        var draftNote = allWorkTypes[j].note || '';
                        if (editWorkTypeNote && draftNote.trim() !== '') {
                            editWorkTypeNote.innerHTML = '<strong>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</strong> ' + draftNote;
                            editWorkTypeNote.style.display = 'block';
                        }
                        break;
                    }
                }

                workTypeNote.textContent = '‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Work Type ‡πÑ‡∏î‡πâ';
                workTypeNote.style.color = '#856404';
                editInfoNote.innerHTML = '<strong>‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Work Type ‡πÑ‡∏î‡πâ</strong>';
                editInfoNote.style.color = '#856404';
            }

            // ‚úÖ ‡πÇ‡∏´‡∏•‡∏î ITP ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
            if (rfi.workType) {
                console.log('üìã Auto-loading ITP for:', rfi.workType);

                google.script.run
                    .withSuccessHandler(function(codes) {
                        codeListByWorkType = codes || [];
                        console.log('‚úÖ Loaded', codeListByWorkType.length, 'codes');

                        var itpSelect = document.getElementById('editITPSelect');

                        if (codeListByWorkType.length === 0) {
                            itpSelect.innerHTML = '<option value="">-- ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ITP --</option>';
                            itpSelect.disabled = true;
                            return;
                        }

                        itpSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ITP --</option>';

                        codeListByWorkType.forEach(function(code, index) {
                            var option = document.createElement('option');
                            option.value = index;
                            option.textContent = code.displayText;
                            option.setAttribute('data-itp', code.itp);
                            option.setAttribute('data-qccode', code.qcCode);
                            option.setAttribute('data-item', code.item);
                            option.setAttribute('data-description', code.descriptionCode);
                            itpSelect.appendChild(option);
                        });

                        itpSelect.disabled = false;

                        setTimeout(function() {
                            if (rfi.itp && rfi.qcCode && rfi.item) {
                                setITPFromSavedData(rfi.itp, rfi.qcCode, rfi.item);
                            }
                            document.getElementById('editTagNumber').value = rfi.tagNumber || '';
                        }, 100);
                        
                    })
                    .withFailureHandler(function(error) {
                        console.error('Error:', error);
                    })
                    .getCodeListByWorkType(rfi.workType);
            }

            if (rfi.requestDate && rfi.startTime) {
                loadAvailableTeamsForEdit(rfi.requestDate, rfi.startTime, rfi.endTime, rfi.id);
            }
        })
        .withFailureHandler(function(error) {
            alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + (error.message || error));
            cancelEdit();
        })
        .getRFIById(rfiId);
}

        function cancelEdit() {
            document.getElementById('rfiTableContainer').style.display = 'block';
            document.querySelector('.btn-primary').style.display = 'inline-block';
            document.getElementById('editView').style.display = 'none';
            document.getElementById('editForm').reset();

            document.getElementById('editSurveyReportGroup').style.display = 'none';
            document.getElementById('editLabReportGroup').style.display = 'none';

            populateTimeDropdown('editStartTime', '', false);
            populateTimeDropdown('editEndTime', '', true);

            // ‚úÖ ‚≠ê Clear Code Fields
            var itpSelect = document.getElementById('editITPSelect');
            if (itpSelect) {
                itpSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Work Type ‡∏Å‡πà‡∏≠‡∏ô --</option>';
                itpSelect.disabled = true;
            }
            clearCodeFields();
            codeListByWorkType = [];

            originalAssignedTeams = [];
            availableTeams = [];
        }

        function loadAvailableTeamsForEdit(date, startTime, endTime, excludeRfiId) {
            var container = document.getElementById('editAssignedInspectorContainer');
            container.innerHTML = '<div class="inspector-loading">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á...</div>';

            if (!endTime && startTime) {
                var startMinutes = timeToMinutes(startTime);
                var endMinutes = startMinutes + 30;
                var hours = Math.floor(endMinutes / 60);
                var mins = endMinutes % 60;
                endTime = hours.toString().padStart(2, '0') + ':' + mins.toString().padStart(2, '0');
            }

            var editingRfiId = excludeRfiId || document.getElementById('editRfiId').value;

            google.script.run
                .withSuccessHandler(function(resources) {
                    availableTeams = resources || [];

                    if (availableTeams.length === 0) {
                        container.innerHTML = '<div class="inspector-loading">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ó‡∏µ‡∏°‡∏ß‡πà‡∏≤‡∏á‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏µ‡πâ</div>';
                        showMessage('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ó‡∏µ‡∏°‡∏ß‡πà‡∏≤‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å', 'warning');
                        return;
                    }

                    var html = '<div class="inspector-checkbox-group">';

                    for (var i = 0; i < availableTeams.length; i++) {
                        var team = availableTeams[i];
                        var isChecked = originalAssignedTeams.indexOf(team.name) !== -1;

                        html += '<div class="inspector-checkbox-item">';
                        html += '<input type="checkbox" id="edit_team_' + team.id + '" value="' + team.name + '"';
                        html += ' onchange="updateEditSelectedTeams()"';
                        if (isChecked) html += ' checked';
                        html += '>';
                        html += '<label for="edit_team_' + team.id + '">' + team.name + '</label>';
                        html += '<span class="badge">' + team.subType + '</span>';
                        html += '</div>';
                    }

                    html += '</div>';
                    container.innerHTML = html;

                    updateEditSelectedTeams();

                    showMessage('‡∏û‡∏ö‡∏ó‡∏µ‡∏°‡∏ß‡πà‡∏≤‡∏á ' + availableTeams.length + ' ‡∏ó‡∏µ‡∏°', 'success', 3000);
                })
                .withFailureHandler(function(error) {
                    container.innerHTML = '<div class="inspector-loading">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</div>';
                    showMessage('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô', 'error');
                })
                .getAvailableResourcesList(date, startTime, endTime, editingRfiId);
        }

        function updateEditSelectedTeams() {
            var checkboxes = document.querySelectorAll('#editAssignedInspectorContainer input[type="checkbox"]:checked');
            var selectedTeams = [];
            var hasSurvey = false;
            var hasLab = false;

            for (var i = 0; i < checkboxes.length; i++) {
                var teamName = checkboxes[i].value;
                selectedTeams.push(teamName);

                var teamNameLower = teamName.toLowerCase();
                if (teamNameLower.indexOf('survey') !== -1) {
                    hasSurvey = true;
                }
                if (teamNameLower.indexOf('lab') !== -1) {
                    hasLab = true;
                }
            }

            document.getElementById('editAssignedInspector').value = selectedTeams.join(',');

            var surveyGroup = document.getElementById('editSurveyReportGroup');
            if (surveyGroup) {
                if (hasSurvey) {
                    surveyGroup.style.display = 'block';
                    document.getElementById('editRequireSurveyReport').value = 'Both';
                } else {
                    surveyGroup.style.display = 'none';
                    document.getElementById('editRequireSurveyReport').value = 'None';
                }
            }

            var labGroup = document.getElementById('editLabReportGroup');
            if (labGroup) {
                if (hasLab) {
                    labGroup.style.display = 'block';
                } else {
                    labGroup.style.display = 'none';
                    document.getElementById('editRequireLabReport').value = 'None';
                }
            }

            var infoDiv = document.getElementById('editSelectedTeamsInfo');
            if (infoDiv) {
                if (selectedTeams.length > 0) {
                    infoDiv.textContent = '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß: ' + selectedTeams.join(', ');
                    infoDiv.style.fontWeight = '600';
                } else {
                    infoDiv.textContent = '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏ó‡∏µ‡∏° (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡∏°‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á)';
                    infoDiv.style.fontWeight = '400';
                }
            }
        }

        function showMessage(text, type, duration) {
            if (typeof duration === 'undefined') duration = 5000;
            var messageDiv = document.getElementById('message');
            messageDiv.textContent = text;
            messageDiv.className = 'message ' + type;
            messageDiv.style.display = 'block';
            setTimeout(function() {
                messageDiv.style.display = 'none';
            }, duration);
        }
        // ‚úÖ ‚≠ê Global variable
        var codeListByWorkType = [];

        /**
         * ‚úÖ ‡πÇ‡∏´‡∏•‡∏î Code List ‡πÅ‡∏•‡∏∞ Populate ITP Dropdown
         */
        function loadCodeListForWorkType(workType) {
            if (!workType) {
                clearCodeFields();
                return;
            }

            console.log('üìã Loading Code List for Work Type:', workType);

            // Reset
            var itpSelect = document.getElementById('editITPSelect');
            itpSelect.innerHTML = '<option value="">-- ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î... --</option>';
            itpSelect.disabled = true;

            clearCodeFields();

            google.script.run
                .withSuccessHandler(function(codes) {
                    codeListByWorkType = codes || [];
                    console.log('‚úÖ Loaded', codeListByWorkType.length, 'codes');

                    if (codeListByWorkType.length === 0) {
                        itpSelect.innerHTML = '<option value="">-- ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ITP --</option>';
                        itpSelect.disabled = true;
                        showMessage('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ITP ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Work Type ‡∏ô‡∏µ‡πâ', 'warning', 3000);
                        return;
                    }

                    // ‚úÖ Populate ITP Dropdown
                    itpSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ITP --</option>';

                    codeListByWorkType.forEach(function(code, index) {
                        var option = document.createElement('option');
                        option.value = index; // ‡πÉ‡∏ä‡πâ index ‡πÄ‡∏õ‡πá‡∏ô value
                        option.textContent = code.displayText; // ITP - QC Code - ITEM
                        option.setAttribute('data-itp', code.itp);
                        option.setAttribute('data-qccode', code.qcCode);
                        option.setAttribute('data-item', code.item);
                        option.setAttribute('data-description', code.descriptionCode);
                        itpSelect.appendChild(option);
                    });

                    itpSelect.disabled = false;

                    console.log('‚úÖ ITP Dropdown populated with', codeListByWorkType.length, 'options');
                })
                .withFailureHandler(function(error) {
                    console.error('‚ùå Error loading codes:', error);
                    itpSelect.innerHTML = '<option value="">-- ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î --</option>';
                    itpSelect.disabled = true;
                    showMessage('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î Code', 'error');
                })
                .getCodeListByWorkType(workType);
        }

/**
 * ‚úÖ ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ITP ‚Üí Auto-fill ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• + ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö
 */
function onITPSelectChange() {
    var itpSelect = document.getElementById('editITPSelect');
    var selectedIndex = itpSelect.value;
    var deleteBtn = document.getElementById('btnDeleteITP');

    if (!selectedIndex || selectedIndex === '') {
        clearCodeFields();
        if (deleteBtn) deleteBtn.style.display = 'none'; // ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö
        return;
    }

    var selectedOption = itpSelect.options[itpSelect.selectedIndex];

    var itp = selectedOption.getAttribute('data-itp');
    var qcCode = selectedOption.getAttribute('data-qccode');
    var item = selectedOption.getAttribute('data-item');
    var description = selectedOption.getAttribute('data-description');

    // ‚úÖ Fill ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    document.getElementById('editITP').value = itp;
    document.getElementById('editQCCode').value = qcCode;
    document.getElementById('editITEM').value = item;
    document.getElementById('editDescriptionCode').value = description;

    // ‚úÖ ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö
    if (deleteBtn) deleteBtn.style.display = 'inline-flex';

    console.log('‚úÖ Auto-filled:', itp, qcCode, item);
    showMessage('‚úÖ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ITP ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + itp, 'success', 2000);
}
        /**
         * ‚úÖ Clear Code Fields
         */
function clearCodeFields() {
    document.getElementById('editITP').value = '';
    document.getElementById('editQCCode').value = '';
    document.getElementById('editITEM').value = '';
    document.getElementById('editDescriptionCode').value = '';
    document.getElementById('editTagNumber').value = ''; // ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏°
    
    var deleteBtn = document.getElementById('btnDeleteITP');
    if (deleteBtn) deleteBtn.style.display = 'none';
}
        /**
         * ‚úÖ Set ITP ‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ (‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç)
         */
        function setITPFromSavedData(savedITP, savedQCCode, savedITEM) {
            if (!savedITP) return;

            console.log('üîç Setting saved ITP:', savedITP, savedQCCode, savedITEM);

            var itpSelect = document.getElementById('editITPSelect');

            for (var i = 0; i < itpSelect.options.length; i++) {
                var option = itpSelect.options[i];
                var itp = option.getAttribute('data-itp');
                var qcCode = option.getAttribute('data-qccode');
                var item = option.getAttribute('data-item');

                if (itp === savedITP && qcCode === savedQCCode && item === savedITEM) {
                    itpSelect.selectedIndex = i;
                    onITPSelectChange();
                    console.log('‚úÖ ITP selected:', savedITP);
                    return;
                }
            }

            console.log('‚ö†Ô∏è Saved ITP not found');
        }

        /**
 * ‚úÖ ‡πÄ‡∏õ‡∏¥‡∏î Add ITP Modal
 */
function openAddITPModal() {
    // ‡πÇ‡∏´‡∏•‡∏î Work Types
    var workTypeSelect = document.getElementById('addITPWorkType');
    workTypeSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Work Type --</option>';
    
    if (allWorkTypes && allWorkTypes.length > 0) {
        allWorkTypes.forEach(function(wt) {
            var option = document.createElement('option');
            option.value = wt.name;
            option.textContent = wt.qcType + ' ' + wt.name;
            workTypeSelect.appendChild(option);
        });
    } else {
        // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÇ‡∏´‡∏•‡∏î ‡πÉ‡∏´‡πâ‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà
        google.script.run
            .withSuccessHandler(function(workTypes) {
                allWorkTypes = workTypes || [];
                workTypes.forEach(function(wt) {
                    var option = document.createElement('option');
                    option.value = wt.name;
                    option.textContent = wt.qcType + ' ' + wt.name;
                    workTypeSelect.appendChild(option);
                });
            })
            .getWorkTypeList('RFI Work');
    }
    
    // Reset form
    document.getElementById('addITPForm').reset();
    
    // ‡πÅ‡∏™‡∏î‡∏á Modal
    document.getElementById('addITPModal').style.display = 'block';
}

/**
 * ‚úÖ ‡∏õ‡∏¥‡∏î Add ITP Modal
 */
function closeAddITPModal() {
    document.getElementById('addITPModal').style.display = 'none';
    document.getElementById('addITPForm').reset();
}

/**
 * ‚úÖ Submit Add ITP Form
 */
document.addEventListener('DOMContentLoaded', function() {
    var addITPForm = document.getElementById('addITPForm');
    if (addITPForm) {
        addITPForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            var loading = document.getElementById('addITPLoading');
            
            var formData = {
                nameWork: document.getElementById('addITPWorkType').value.trim(),
                itp: document.getElementById('addITPITP').value.trim().toUpperCase(),
                qcCode: document.getElementById('addITPQCCode').value.trim().toUpperCase(),
                item: document.getElementById('addITPItem').value.trim(),
                descriptionCode: document.getElementById('addITPDescription').value.trim()
            };
            
            // Validation
            if (!formData.nameWork || !formData.itp || !formData.qcCode || 
                !formData.item || !formData.descriptionCode) {
                showMessage('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', 'error');
                return;
            }
            
            loading.style.display = 'block';
            
            google.script.run
                .withSuccessHandler(function(result) {
                    loading.style.display = 'none';
                    
                    if (result && result.success) {
                        showMessage(result.message || '‡πÄ‡∏û‡∏¥‡πà‡∏° ITP Code ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success', 5000);
                        closeAddITPModal();
                        
                        // ‚úÖ ‡∏ñ‡πâ‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç RFI ‡πÅ‡∏•‡∏∞ Work Type ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô ‚Üí ‡πÇ‡∏´‡∏•‡∏î ITP ‡πÉ‡∏´‡∏°‡πà
                        var currentWorkType = document.getElementById('editWorkType').value;
                        if (currentWorkType === formData.nameWork) {
                            console.log('üîÑ Reloading ITP list for current Work Type');
                            loadCodeListForWorkType(currentWorkType);
                        }
                    } else {
                        showMessage(result.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error');
                    }
                })
                .withFailureHandler(function(error) {
                    loading.style.display = 'none';
                    showMessage('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + (error.message || error), 'error');
                })
                .addNewITPCode(formData);
        });
    }
});

/**
 * ‚úÖ ‡∏•‡∏ö ITP ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
 */
function deleteSelectedITP() {
    var itpSelect = document.getElementById('editITPSelect');
    var selectedIndex = itpSelect.value;
    
    if (!selectedIndex || selectedIndex === '') {
        showMessage('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ITP ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö', 'error');
        return;
    }
    
    var selectedOption = itpSelect.options[itpSelect.selectedIndex];
    var itp = selectedOption.getAttribute('data-itp');
    var qcCode = selectedOption.getAttribute('data-qccode');
    var item = selectedOption.getAttribute('data-item');
    var workType = document.getElementById('editWorkType').value;
    
    // ‚úÖ Confirm
    var confirmMsg = '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö ITP?\n\n' +
                    'ITP: ' + itp + '\n' +
                    'QC Code: ' + qcCode + '\n' +
                    'ITEM: ' + item + '\n\n' +
                    '‚ö†Ô∏è ‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ';
    
    if (!confirm(confirmMsg)) {
        return;
    }
    
    // ‚úÖ ‡πÅ‡∏™‡∏î‡∏á Loading
    var deleteBtn = document.getElementById('btnDeleteITP');
    var originalHTML = deleteBtn.innerHTML;
    deleteBtn.innerHTML = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö...';
    deleteBtn.disabled = true;
    
    google.script.run
        .withSuccessHandler(function(result) {
            deleteBtn.innerHTML = originalHTML;
            deleteBtn.disabled = false;
            
            if (result && result.success) {
                showMessage(result.message || '‡∏•‡∏ö ITP ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success', 5000);
                
                // ‚úÖ Clear fields
                clearCodeFields();
                deleteBtn.style.display = 'none';
                
                // ‚úÖ Reload ITP list
                loadCodeListForWorkType(workType);
            } else {
                showMessage(result.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error');
            }
        })
        .withFailureHandler(function(error) {
            deleteBtn.innerHTML = originalHTML;
            deleteBtn.disabled = false;
            showMessage('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + (error.message || error), 'error');
        })
        .deleteITPCode(workType, itp, qcCode, item);
}

/**
 * ‚≠ê ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï: ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô Limited Edit Mode
 */
function enableLimitedEditMode(status, type) {
    console.log('üîí Enabling Limited Edit Mode');
    console.log('   Type:', type);
    console.log('   Status:', status);
    
    // ‚úÖ ‡πÅ‡∏™‡∏î‡∏á Warning
    var editInfoNote = document.getElementById('editInfoNote');
    if (editInfoNote) {
        editInfoNote.innerHTML = '<div class="limited-edit-warning">' +
            '<strong>‚ö†Ô∏è ‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏ö‡∏ö‡∏à‡∏≥‡∏Å‡∏±‡∏î (Limited Edit Mode)</strong><br>' +
            'Type: <strong>' + type + '</strong><br>' +
            'Status: <strong>' + status + '</strong><br><br>' +
            '‚úÖ ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞:<br>' +
            '<ul>' +
            '<li>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ITP / QC Code / TAG NUMBER</li>' +
            '<li>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î RFI</li>' +
            '<li>‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</li>' +
            '</ul>' +
            'üîí ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: Work Type, ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà, ‡πÄ‡∏ß‡∏•‡∏≤, ‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô, ‡∏ú‡∏π‡πâ‡∏Ç‡∏≠' +
            '</div>';
    }
    
    // üîí Disable ‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ
    document.getElementById('editWorkType').disabled = true;
    document.getElementById('editRequestDate').disabled = true;
    document.getElementById('editStartTime').disabled = true;
    document.getElementById('editEndTime').disabled = true;
    
    // üîí Disable ‡∏™‡πà‡∏ß‡∏ô Team Selection
    var teamContainer = document.getElementById('editAssignedInspectorContainer');
    if (teamContainer) {
        teamContainer.style.opacity = '0.5';
        teamContainer.style.pointerEvents = 'none';
        var checkboxes = teamContainer.querySelectorAll('input[type="checkbox"]');
        checkboxes.forEach(function(cb) {
            cb.disabled = true;
        });
    }
    
    // üîí Disable Survey/Lab Report
    var surveyReport = document.getElementById('editRequireSurveyReport');
    var labReport = document.getElementById('editRequireLabReport');
    if (surveyReport) surveyReport.disabled = true;
    if (labReport) labReport.disabled = true;
    
    // ‚úÖ Enable ‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ
    document.getElementById('editITPSelect').disabled = false;
    document.getElementById('editTagNumber').disabled = false;
    document.getElementById('editDescription').disabled = false;
    document.getElementById('editLocation').disabled = false;
    
    console.log('‚úÖ Limited Edit Mode enabled');
}

/**
 * ‚≠ê ‡∏õ‡∏¥‡∏î Limited Edit Mode (‡πÇ‡∏´‡∏°‡∏î‡∏õ‡∏Å‡∏ï‡∏¥)
 */
function disableLimitedEditMode() {
    console.log('üîì Disabling Limited Edit Mode (Normal mode)');
    
    // ‚úÖ ‡∏ã‡πà‡∏≠‡∏ô Warning
    var editInfoNote = document.getElementById('editInfoNote');
    if (editInfoNote) {
        editInfoNote.innerHTML = '<strong>‚ö†Ô∏è ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç RFI NO ‡πÅ‡∏•‡∏∞ Work Type ‡πÑ‡∏î‡πâ</strong>';
    }
    
    // ‚úÖ Enable ‡∏ó‡∏∏‡∏Å‡∏ü‡∏¥‡∏•‡∏î‡πå (‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏Å‡∏ï‡∏¥)
    document.getElementById('editRequestDate').disabled = false;
    document.getElementById('editStartTime').disabled = false;
    document.getElementById('editEndTime').disabled = false;
    
    // ‚úÖ Enable ‡∏™‡πà‡∏ß‡∏ô Team Selection
    var teamContainer = document.getElementById('editAssignedInspectorContainer');
    if (teamContainer) {
        teamContainer.style.opacity = '1';
        teamContainer.style.pointerEvents = 'auto';
        var checkboxes = teamContainer.querySelectorAll('input[type="checkbox"]');
        checkboxes.forEach(function(cb) {
            cb.disabled = false;
        });
    }
    
    // ‚úÖ Enable Survey/Lab Report
    var surveyReport = document.getElementById('editRequireSurveyReport');
    var labReport = document.getElementById('editRequireLabReport');
    if (surveyReport) surveyReport.disabled = false;
    if (labReport) labReport.disabled = false;
    
    console.log('‚úÖ Normal Edit Mode enabled');
}
    </script>
</body>

</html>
